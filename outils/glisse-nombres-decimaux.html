<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Glisse-nombres (décimaux)</title>
<style>
  :root{ --gap:8px; --cell:60px; --headH:32px; }

  *{box-sizing:border-box}
  html,body{height:100%}
  html{-webkit-text-size-adjust:100%} /* évite les zooms auto iOS */
  body{
    margin:0;
    font:18px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial;
    background:#f7f7f7; color:#0b0b0b;
    display:flex; justify-content:center;
    padding: clamp(12px, 3vw, 28px);
    padding-left:max(12px, env(safe-area-inset-left));
    padding-right:max(12px, env(safe-area-inset-right));
    -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
  }

  .app{
    width:min(1100px,100%);
    overflow-x:auto; -webkit-overflow-scrolling:touch; overscroll-behavior:contain;
    padding-right:max(10px, env(safe-area-inset-right));
  }
  .card{
    background:#fff; border:1.5px solid #444; border-radius:16px;
    padding:18px; margin-bottom:18px; box-shadow:0 2px 10px rgba(0,0,0,.10)
  }
  h1{ margin:0 0 8px; font-weight:900; font-size:clamp(20px,3.2vw,28px) }

  .controls{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:10px }
  .btn{
    border:1.5px solid #444; background:#f2f2f2; border-radius:12px; padding:8px 12px;
    font-size:clamp(16px,2.8vw,18px); font-weight:700; cursor:pointer; line-height:1
  }
  .btn.active{ background:#0ea5e9; color:#fff; border-color:#0ea5e9 }
  .seg{ display:flex; border:1.5px solid #444; border-radius:12px; overflow:hidden }
  .seg button{ padding:8px 12px; font-weight:700; border:0; background:#e9e9e9; cursor:pointer; font-size:clamp(16px,2.6vw,18px) }
  .seg button+button{ border-left:1.5px solid #444 }
  .seg .active{ background:#0ea5e9; color:#fff }

  .grid{
    display:grid;
    grid-template-columns:repeat(12, var(--cell));
    gap:var(--gap); justify-content:center; margin-top:12px;
    min-width: calc(12*var(--cell) + 11*var(--gap) + 6px); /* slack pour éviter la morsure du bord */
    scroll-padding-right:24px;
  }

  .head{
    height:var(--headH); text-align:center; font-weight:800; background:#ececec;
    border-radius:14px; user-select:none; padding:0 6px; display:flex; align-items:center; justify-content:center
  }
  .head .lbl{ display:flex; flex-direction:column; font-size:clamp(10px, calc(var(--cell)*0.15), 12px); line-height:1.05 }

  .cell{
    height:var(--cell); border:1.5px solid #4a4a4a; border-radius: clamp(8px, calc(var(--cell)*0.16), 12px);
    display:flex; align-items:center; justify-content:center; background:#fff; position:relative; overflow:hidden
  }
  .cell.comma{ background:#e0f2fe; border-color:#2563eb }
  .cell.comma span{ font-size:clamp(16px, calc(var(--cell)*0.36), 28px); font-weight:900; color:#2563eb }

  .digit{
    width:100%; height:100%; border:0; outline:none; background:transparent; text-align:center;
    font:800 clamp(16px, calc(var(--cell)*0.40), 30px)/1 system-ui,-apple-system,Segoe UI,Roboto,Arial; caret-color:#2563eb
  }
  .digit::placeholder{ color:#bfbfbf }
  button, input, select { font-size:16px; touch-action:manipulation; }

  .ghost{
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
    font:800 clamp(16px, calc(var(--cell)*0.40), 30px)/1 system-ui,-apple-system,Segoe UI,Roboto,Arial; color:#000; pointer-events:none
  }

  #status{ margin-top:8px; font-weight:800; font-size:clamp(14px, 2.2vw, 18px) }

  @media (max-width:420px){
    .btn, .seg button{ padding:6px 9px }
    .head .lbl{ line-height:1.0; letter-spacing:0 }
  }
  /* léger ajustement en “compact” (auto <420 px ou forcé) */
  .compact .head .lbl{ font-size:clamp(10px, calc(var(--cell)*0.14), 11px); }
</style>
</head>
<body>
<main class="app" id="app">
  <form class="card" onsubmit="return false;" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false">
    <h1>Glisse-nombres (décimaux)</h1>

    <div class="controls">
      <button class="btn" id="resetBtn" type="button">Réinitialiser</button>
      <button class="btn" id="times10" type="button">×10</button>
      <button class="btn" id="div10" type="button">÷10</button>

      <div class="seg" id="zerosSeg" role="group" aria-label="Affichage des zéros">
        <button data-mode="none" class="active" type="button">Zéros : Aucun</button>
        <button data-mode="needed" type="button">Zéros : Nécessaires</button>
        <button data-mode="all" type="button">Zéros : Partout</button>
      </div>

      <button class="btn" id="exitZerosBtn" type="button" title="Zéros côté débordement">Gestion de la sortie</button>
      <button class="btn" id="toggleCompact" type="button" title="Abréger les libellés">Affichage compact</button>
    </div>

    <section class="card" style="z-index:1;">
      <div class="grid" id="grid">
        <!-- En-têtes -->
        <div class="head" data-col="0"><div class="lbl"><span>Centaines</span><span>de milliers</span></div></div>
        <div class="head" data-col="1"><div class="lbl"><span>Dizaines</span><span>de milliers</span></div></div>
        <div class="head" data-col="2"><div class="lbl"><span>Milliers</span></div></div>
        <div class="head" data-col="3"><div class="lbl"><span>Centaines</span></div></div>
        <div class="head" data-col="4"><div class="lbl"><span>Dizaines</span></div></div>
        <div class="head" data-col="5"><div class="lbl"><span>Unités</span></div></div>
        <div class="head" data-col="6"><div class="lbl"><span>,</span></div></div>
        <div class="head" data-col="7"><div class="lbl"><span>Dixièmes</span></div></div>
        <div class="head" data-col="8"><div class="lbl"><span>Centièmes</span></div></div>
        <div class="head" data-col="9"><div class="lbl"><span>Millièmes</span></div></div>
        <div class="head" data-col="10"><div class="lbl"><span>Dix</span><span>millièmes</span></div></div>
        <div class="head" data-col="11"><div class="lbl"><span>Cent</span><span>millièmes</span></div></div>

        <!-- Saisie (6 entiers, virgule visuelle, 5 décimales) -->
        <div class="cell"><input class="digit" maxlength="1" inputmode="numeric" id="c00" aria-label="Centaines de milliers" /></div>
        <div class="cell"><input class="digit" maxlength="1" inputmode="numeric" id="c0"  aria-label="Dizaines de milliers" /></div>
        <div class="cell"><input class="digit" maxlength="1" inputmode="numeric" id="c1"  aria-label="Milliers" /></div>
        <div class="cell"><input class="digit" maxlength="1" inputmode="numeric" id="c2"  aria-label="Centaines" /></div>
        <div class="cell"><input class="digit" maxlength="1" inputmode="numeric" id="c3"  aria-label="Dizaines" /></div>
        <div class="cell"><input class="digit" maxlength="1" inputmode="numeric" id="c4"  aria-label="Unités" /></div>
        <div class="cell comma" aria-hidden="true"><span>,</span></div>
        <div class="cell"><input class="digit" maxlength="1" inputmode="numeric" id="c6"  aria-label="Dixièmes" /></div>
        <div class="cell"><input class="digit" maxlength="1" inputmode="numeric" id="c7"  aria-label="Centièmes" /></div>
        <div class="cell"><input class="digit" maxlength="1" inputmode="numeric" id="c8"  aria-label="Millièmes" /></div>
        <div class="cell"><input class="digit" maxlength="1" inputmode="numeric" id="c9"  aria-label="Dix millièmes" /></div>
        <div class="cell"><input class="digit" maxlength="1" inputmode="numeric" id="c10" aria-label="Cent millièmes" /></div>
      </div>

      <div id="status">×1</div>
    </section>
  </form>
</main>

<script>
(() => {
  // Mapping des colonnes
  const ids=["c00","c0","c1","c2","c3","c4",null,"c6","c7","c8","c9","c10"]; // 12 colonnes (6 entiers, virgule, 5 décimales)
  const INT=[0,1,2,3,4,5];  // indices des entiers
  const DEC=[7,8,9,10,11];  // indices des décimales
  const UNITS=5;
  const COMMA=6;
  const order=[0,1,2,3,4,5,7,8,9,10,11]; // uniquement les inputs (sans la virgule)

  // DOM
  const app=document.getElementById('app');
  const grid=document.getElementById('grid');
  const zerosSeg=document.getElementById('zerosSeg');
  const resetBtn=document.getElementById('resetBtn');
  const times10=document.getElementById('times10');
  const div10=document.getElementById('div10');
  const status=document.getElementById('status');
  const toggleCompact=document.getElementById('toggleCompact');
  const exitZerosBtn=document.getElementById('exitZerosBtn');

  const inputs=order.map(i=>document.getElementById(ids[i]));

  // État
  let zeroMode='none'; // 'none' | 'needed' | 'all'
  let exp10=0;         // cumul ×10/÷10
  let exitZeros=false; // afficher des zéros fantômes du côté du débordement
  const leftStack=[];  // ce qui sort à gauche (×10)
  const rightStack=[]; // ce qui sort à droite (÷10)
  let overflowSide=null; // 'left' | 'right' | null
  let forceCompact=false;

  // Libellés normal/compact
  const labelsNormal = [
    ['Centaines','de milliers'],
    ['Dizaines','de milliers'],
    ['Milliers'],
    ['Centaines'],
    ['Dizaines'],
    ['Unités'],
    [','],
    ['Dixièmes'],
    ['Centièmes'],
    ['Millièmes'],
    ['Dix','millièmes'],
    ['Cent','millièmes']
  ];
  const labelsCompact = [
    ['Cent.','de mill.'],
    ['Diz.','de mill.'],
    ['Milliers'],
    ['Cent.'],
    ['Diz.'],
    ['Unités'],
    [','],
    ['Dixièmes'],
    ['Centièmes'],
    ['Millièmes'],
    ['Dix','mill.'],
    ['Cent','mill.']
  ];
  function renderLabels(useCompact){
    document.querySelectorAll('.head').forEach((head, idx)=>{
      const lbl=head.querySelector('.lbl');
      const set=useCompact?labelsCompact:labelsNormal;
      const parts=set[idx]||[''];
      lbl.innerHTML=parts.map(t=>`<span>${t}</span>`).join('');
    });
    grid.classList.toggle('compact', !!useCompact);
  }
  function applyCompactAutoOrForced(){
    if(forceCompact){ renderLabels(true); return; }
    const w=Math.min(window.innerWidth, document.documentElement.clientWidth || window.innerWidth);
    renderLabels(w < 420);
  }

  // Sizing robuste (portrait/paysage, iOS)
  function calcCell(){
    const root=document.documentElement;
    const cs=getComputedStyle(root);
    const gap=parseFloat(cs.getPropertyValue('--gap'))||8;

    const vv=window.visualViewport;
    const vvWidth=vv?vv.width:window.innerWidth;
    const usable=Math.min(app.clientWidth, vvWidth);
    const inner=Math.max(0, usable - 36); // marge interne estimée (carte/paddings)

    const MIN=36, MAX=78;
    let c=Math.floor((inner - 11*gap) / 12); // 12 colonnes, 11 interstices
    c=Math.max(MIN, Math.min(MAX, c));

    root.style.setProperty('--cell', c+'px');
    root.style.setProperty('--headH', Math.max(28, Math.min(40, Math.round(c*0.52)))+'px');
  }
  function initLayoutWatchers(){
    calcCell();
    if(window.visualViewport){
      visualViewport.addEventListener('resize', calcCell);
      visualViewport.addEventListener('scroll', calcCell);
    }
    window.addEventListener('resize', calcCell);
    window.addEventListener('orientationchange', ()=>setTimeout(calcCell,50));

    // labels responsives
    applyCompactAutoOrForced();
    window.addEventListener('resize', applyCompactAutoOrForced);
    window.addEventListener('orientationchange', ()=>setTimeout(applyCompactAutoOrForced,50));
  }

  // Helpers I/O
  function sanitizeToDigit(v){ const m=(v||'').toString().match(/[0-9]/); return m?m[0]:''; }
  function indexOfInput(el){ return order.findIndex(i=>ids[i]===el.id); }
  function focusMove(delta){
    const active=document.activeElement; if(!active||!active.classList.contains('digit')) return;
    let idx=indexOfInput(active); if(idx<0) return;
    idx=Math.min(order.length-1, Math.max(0, idx+delta));
    inputs[idx].focus(); inputs[idx].select();
  }
  function readRaw(){ const a=new Array(ids.length).fill(''); for(const i of order){ a[i]=document.getElementById(ids[i]).value; } return a; }
  function writeRaw(arr){ for(const i of order){ document.getElementById(ids[i]).value=arr[i]||''; } }
  function clearGhosts(){ grid.querySelectorAll('.cell .ghost').forEach(g=>g.remove()); }

  // Zéros d'affichage (modes)
  function applyZeroMode(){
    clearGhosts();
    const raw=readRaw();
    const hasInt=INT.some(i=>raw[i]!=='' );
    const hasDec=DEC.some(i=>raw[i]!=='' );
    function addGhost(i){
      const cell=document.getElementById(ids[i]).parentElement;
      if(!cell.querySelector('.ghost')){
        const g=document.createElement('div'); g.className='ghost'; g.textContent='0'; cell.appendChild(g);
      }
    }
    if(zeroMode==='all'){
      for(const i of INT){ if(raw[i]==='') addGhost(i); }
      for(const i of DEC){ if(raw[i]==='') addGhost(i); }
    } else if(zeroMode==='needed'){
      if(hasDec){ for(const i of DEC){ if(raw[i]!=='' ) break; addGhost(i); } }
      if(hasInt){
        let lastInt=-1; for(const i of INT){ if(raw[i]!=='' ) lastInt=i; }
        for(let i=lastInt+1; i<=UNITS; i++){ addGhost(i); }
      } else if(hasDec){ addGhost(UNITS); }
    }
  }

  // Zéros pendant débordement (affichage seulement)
  function ensureExitZeros(){
    if(!exitZeros || !overflowSide) return;
    const raw=readRaw();
    function addGhost(i){
      const cell=document.getElementById(ids[i]).parentElement;
      if(!cell.querySelector('.ghost')){
        const g=document.createElement('div'); g.className='ghost'; g.textContent='0'; cell.appendChild(g);
      }
    }
    if(overflowSide==='left'){ for(const i of INT){ if(raw[i]==='') addGhost(i); } }
    if(overflowSide==='right'){ for(const i of DEC){ if(raw[i]==='') addGhost(i); } }
  }

  // Décalages ×10 / ÷10
  function shift(dir){
    const prev=readRaw();
    const next=prev.slice();
    const orderLinear=[0,1,2,3,4,5,7,8,9,10,11]; // sans la virgule
    const first=orderLinear[0];
    const last =orderLinear[orderLinear.length-1];

    if(dir==='left'){ // ×10
      exp10++;
      const lost=prev[first]; if(lost!=='') leftStack.push(lost);
      for(const i of orderLinear){
        const nxt=(i+1===COMMA)?COMMA+1:(i+1);
        next[i]=(nxt<ids.length)?prev[nxt]:''; // décale vers la gauche, saute la virgule
      }
      if(rightStack.length){ next[last]=rightStack.pop(); }
    } else { // ÷10
      exp10--;
      const lost=prev[last]; if(lost!=='') rightStack.push(lost);
      for(let k=orderLinear.length-1;k>=0;k--){
        const i=orderLinear[k];
        const prv=(i-1===COMMA)?UNITS:(i-1);
        next[i]=(prv>=0)?prev[prv]:''; // décale vers la droite, saute la virgule
      }
      if(leftStack.length){ next[first]=leftStack.pop(); }
    }

    if(overflowSide===null){
      if(leftStack.length>0 && rightStack.length===0) overflowSide='left';
      else if(rightStack.length>0 && leftStack.length===0) overflowSide='right';
    }
    if(leftStack.length===0 && rightStack.length===0) overflowSide=null;

    writeRaw(next);
    applyZeroMode();
    ensureExitZeros();
    updateStatus();
  }

  function resetAll(){
    inputs.forEach(i=>i.value='');
    clearGhosts();
    zeroMode='none';
    zerosSeg.querySelectorAll('button').forEach(x=>x.classList.remove('active'));
    zerosSeg.querySelector('[data-mode="none"]').classList.add('active');
    exp10=0; overflowSide=null; leftStack.length=0; rightStack.length=0;
    updateStatus();
    const isTouch='ontouchstart' in window||navigator.maxTouchPoints>0;
    if(!isTouch) inputs[0].focus();
  }

  function updateStatus(){
    let label='×1';
    if(exp10!==0){
      const n=Math.abs(exp10);
      label = n<=6 ? (exp10>0 ? '×'+(10**n) : '÷'+(10**n)) : (exp10>0 ? '×10^'+n : '÷10^'+n);
    }
    status.textContent=label;
  }

  // Handlers inputs
  inputs.forEach(inp=>{
    inp.addEventListener('focus',()=>{ inp.setAttribute('autocomplete','off'); });
    inp.addEventListener('beforeinput',e=>{
      if(e.inputType==='insertText' || e.inputType==='insertFromPaste'){
        const ch=(e.data||'').replace(/[^0-9]/g,''); if(ch==='') e.preventDefault();
      }
    });
    inp.addEventListener('input',e=>{
      const v=sanitizeToDigit(e.target.value); e.target.value=v;
      if(v!=='') focusMove(+1);
      applyZeroMode(); ensureExitZeros();
    });
    inp.addEventListener('keydown',e=>{
      if(e.key==='ArrowLeft'){ e.preventDefault(); focusMove(-1); }
      if(e.key==='ArrowRight'){ e.preventDefault(); focusMove(+1); }
      if(e.key==='Backspace' && e.target.value===''){ e.preventDefault(); focusMove(-1); }
    });
  });

  // Boutons
  zerosSeg.addEventListener('click',e=>{
    const b=e.target.closest('button'); if(!b) return;
    zerosSeg.querySelectorAll('button').forEach(x=>x.classList.remove('active'));
    b.classList.add('active'); zeroMode=b.dataset.mode;
    applyZeroMode(); ensureExitZeros();
  });
  resetBtn.addEventListener('click',resetAll);
  times10.addEventListener('click',()=>shift('left'));
  div10.addEventListener('click',()=>shift('right'));

  // Toggles
  toggleCompact.addEventListener('click', ()=>{
    forceCompact=!forceCompact;
    toggleCompact.classList.toggle('active', forceCompact);
    toggleCompact.textContent = forceCompact ? 'Affichage compact ✔' : 'Affichage compact';
    applyCompactAutoOrForced();
  });
  exitZerosBtn.addEventListener('click', ()=>{
    exitZeros=!exitZeros;
    exitZerosBtn.classList.toggle('active', exitZeros);
    ensureExitZeros(); // rafraîchit si un débordement est en cours
  });

  // Init
  updateStatus();
  const isTouch='ontouchstart' in window||navigator.maxTouchPoints>0;
  if(!isTouch) inputs[0].focus();
  initLayoutWatchers();
})();
</script>
</body>
</html>
