<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<title>G√©n√©rateur PRO ‚Äî Fractions (Bandes)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  :root { 
      --page-w: 297mm; 
      --page-h: 210mm; 
      --primary-color: #2563eb;
      --bg-color: #f8fafc;
      --panel-bg: #ffffff;
      --border-color: #e2e8f0;
      --text-main: #1e293b;
      --text-muted: #64748b;
  }
  *{ box-sizing:border-box; }
  body{ 
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; 
      margin:0; 
      background-color: var(--bg-color);
      color: var(--text-main);
      height: 100vh;
      display: flex;
      flex-direction: column;
  }
  
  /* --- EN-T√äTE --- */
  header{ 
      padding: 0 1rem; 
      height: 50px;
      background: #1e293b; 
      color: #fff; 
      font-size: 14px; 
      display: flex;
      justify-content: space-between; 
      align-items: center;
      flex-shrink: 0; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      z-index: 10;
  }
  header a {
      color: #cbd5e1;
      text-decoration: none;
      font-weight: 500;
      transition: color 0.2s;
  }
  header a:hover { color: #fff; }
  header span { font-weight: 600; letter-spacing: 0.5px; }
  
  /* --- LAYOUT PRINCIPAL --- */
  main{ 
      display: flex; 
      flex: 1;
      overflow: hidden; /* Emp√™che le scroll global */
  }
  
  /* --- COLONNE DE GAUCHE (CONTR√îLES) --- */
  .sidebar { 
      width: 380px; 
      background: var(--panel-bg);
      border-right: 1px solid var(--border-color);
      display: flex; 
      flex-direction: column; 
      flex-shrink: 0;
      z-index: 5;
  }

  /* Navigation par Onglets */
  .tabs-nav {
      display: flex;
      border-bottom: 1px solid var(--border-color);
      background: #f1f5f9;
  }
  .tab-btn {
      flex: 1;
      padding: 12px 5px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-muted);
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
  }
  .tab-btn:hover { background: #e2e8f0; color: var(--text-main); }
  .tab-btn.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
      background: #fff;
  }

  /* Zone de contenu des r√©glages (Scrollable) */
  .settings-container {
      flex: 1;
      overflow-y: auto; 
      padding: 20px;
      -webkit-overflow-scrolling: touch; 
  }

  /* Masquer les onglets non actifs */
  .tab-content { display: none; }
  .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
  
  @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

  /* Styles des formulaires */
  fieldset { 
      border: 1px solid var(--border-color); 
      border-radius: 8px; 
      margin: 0 0 20px 0; 
      padding: 15px;
      background: #fff;
  }
  legend { 
      padding: 0 8px; 
      font-weight: 600; 
      color: var(--primary-color); 
      font-size: 0.9rem;
  }
  
  label { 
      display: block; 
      font-size: 13px; 
      font-weight: 500;
      margin-bottom: 4px; 
      margin-top: 12px;
      color: var(--text-main);
  }
  fieldset > div:first-child > label:first-child { margin-top: 0; }

  input[type="number"], input[type="text"], select { 
      width: 100%; 
      padding: 8px 10px; 
      font-size: 14px; 
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      background: #fff;
      transition: border-color 0.2s;
  }
  input:focus, select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }
  
  .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .help-text { font-size: 11px; color: var(--text-muted); margin-top: 4px; font-style: italic; }

  /* Zone d'action fixe en bas */
  .action-bar {
      padding: 15px 20px;
      border-top: 1px solid var(--border-color);
      background: #fff;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
  }
  .btn-primary { 
      width: 100%;
      padding: 12px; 
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: 600; 
      font-size: 15px; 
      cursor: pointer; 
      transition: background 0.2s;
      display: flex; justify-content: center; align-items: center; gap: 8px;
  }
  .btn-primary:hover { background: #1d4ed8; }

  /* --- ZONE D'APER√áU (DROITE) --- */
  .preview-area { 
      flex: 1; 
      background: #e2e5e9; 
      padding: 20px; 
      overflow: auto; 
      display: flex;
      flex-direction: column;
      align-items: center;
  }
  
  .page { 
      width: var(--page-w); 
      height: var(--page-h); 
      background: white; 
      margin-bottom: 20px; 
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      /* Zoom responsive pour l'aper√ßu */
      transform-origin: top center;
  }
  
  /* --- PRINT --- */
  @media print{
    header, .sidebar { display:none !important; }
    main { display:block; height:auto; overflow:visible; } 
    .preview-area { background:none; padding:0; height:auto; display:block; }
    .page { 
        box-shadow: none; margin: 0; 
        break-after: page; page-break-after: always; 
        transform: none !important; /* Pas de zoom √† l'impression */
    }
    @page { size: A4 landscape; margin: 0; }
  }


  /* --- APER√áU : barre d'outils + r√©sum√© --- */
  .preview-toolbar{
      width: min(980px, 100%);
      background: rgba(255,255,255,0.92);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 12px 14px;
      margin-bottom: 14px;
      display: flex;
      gap: 12px;
      align-items: flex-start;
      justify-content: space-between;
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
  }
  .preview-toolbar-left{
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      min-width: 220px;
  }
  .preview-label{
      font-weight: 700;
      font-size: 13px;
      color: var(--text-main);
      margin: 0;
  }
  #previewFilter{
      width: 180px;
      max-width: 100%;
  }
  .preview-hint{
      font-size: 12px;
      color: #b45309;
      font-weight: 600;
  }
  .preview-summary{
      font-size: 12px;
      color: var(--text-main);
      line-height: 1.35;
      text-align: right;
  }
  .preview-summary strong{ color: var(--text-muted); font-weight: 700; }
  .preview-pages{ width: 100%; display: flex; flex-direction: column; align-items: center; }

  /* --- Messages d'info dans les onglets --- */
  .notice{
      border: 1px solid #fdba74;
      background: #fff7ed;
      color: #9a3412;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 13px;
      margin-bottom: 14px;
      font-weight: 600;
  }

  /* --- Filtre d'aper√ßu (visuel seulement) --- */
  .preview-hidden{ display: none !important; }

  @media print{
    .preview-toolbar{ display:none !important; }
    .preview-hidden{ display:block !important; }
  }

</style>
</head>
<body>

<header>
    <a href="#" onclick="history.back()" id="return-link">‚Üê Retour</a>
    <span>G√âN√âRATEUR DE BANDES FRACTIONNAIRES</span>
    <div style="width: 60px;"></div> 
</header>

<main>
  <!-- BARRE LAT√âRALE DE CONTR√îLES -->
  <section class="sidebar">
    
    <!-- Navigation des onglets -->
    <nav class="tabs-nav">
        <button class="tab-btn active" onclick="openTab('tab-bases')">üìê Bases</button>
        <button class="tab-btn" onclick="openTab('tab-recto')">üü¶ Recto</button>
        <button class="tab-btn" onclick="openTab('tab-verso')">üü® Verso</button>
        <button class="tab-btn" onclick="openTab('tab-calages')">‚öôÔ∏è Calages</button>
    </nav>

    <!-- Formulaire -->
    <form id="form" class="settings-container">
        
        <!-- ONGLET 1 : BASES -->
        <div id="tab-bases" class="tab-content active">
            <fieldset>
                <legend>Donn√©es & S√©quence</legend>
                <label>D√©nominateurs (s√©par√©s par virgules)</label>
                <input type="text" id="denoms" value="1,2,3,4,5,6,8,10">
                <div class="help-text">Ex: 1,2,3... Le '1' contr√¥le la bande unit√©.</div>

                <label>S√©quence d'impression</label>
                <select id="mode">
                  <option value="recto_verso_alternating" selected>Recto / Verso Altern√© </option> 
                  <option value="recto_only">Recto Seul (Fractions)</option>
                  <option value="verso_only">Verso Seul (Unit√©s/Autres)</option>
                </select>
            </fieldset>

            <fieldset>
                <legend>Apparence Globale</legend>
                <label>Style des fonds</label>
                <select id="colorMode">
                    <option value="white" selected>Uniforme (Blanc - √âco)</option>
                    <option value="colored">Couleurs P√©dagogiques (Style Montessori)</option>
                </select>

                <div class="row">
                  <div>
                    <label>Longueur (mm)</label>
                    <input type="number" id="bandLen" step="0.1" value="210">
                  </div>
                  <div>
                    <label>Hauteur (mm)</label>
                    <input type="number" id="bandHeight" step="0.1" value="55">
                  </div>
                </div>
                <label>√âcart vertical entre bandes (mm)</label>
                <input type="number" id="gapV" step="0.1" value="7">
            </fieldset>
        </div>

        <!-- ONGLET 2 : RECTO (UNIFORMIS√â AVEC LE VERSO) -->
        <div id="tab-recto" class="tab-content">
            <div id="noticeRecto" class="notice" style="display:none;"></div>
            
            <!-- BLOC 1 : BANDE UNIT√â RECTO -->
            <fieldset>
                <legend>Bande UNIT√â (d=1)</legend>
                <label>Contenu affich√©</label>
                <select id="unitModeRecto"> 
                    <option value="unit" selected>Texte "1 unit√©"</option> 
                    <option value="numeric_one">Chiffre "1"</option>
                    <option value="one-on-one">Fraction "1/1"</option>
                    <option value="percent">100%</option>
                    <option value="minutes">60min</option>
                    <option value="hours_unit">1 heure</option> 
                    <option value="degrees_unit">360¬∞</option> 
                    <option value="custom">Texte personnalis√©...</option>
                    <option value="empty">Vide</option>
                </select>
                <input type="text" id="customTextRecto" value="1 unit√©" placeholder="Votre texte..." style="margin-top: 5px; display: none;">
            </fieldset>

            <!-- BLOC 2 : BANDES FRACTIONN√âES RECTO -->
            <fieldset>
                <legend>Bandes FRACTIONN√âES (d>1)</legend>
                <label>Contenu des parts</label>
                <select id="contentRecto"> 
                  <option value="numeric" selected>Fraction (1/2)</option>
                  <option value="numeric_unit">Fraction + unit√© (1/2 u)</option>
                  <option value="decimal">D√©cimal (0,5)</option>
                  <option value="decimal_unit">D√©cimal + unit√© (0,5 u)</option>
                  <option value="percentage">Pourcentage (50 %)</option>
                  <option value="minutes">Temps (30 min)</option>
                  <option value="hours_fractional">Temps fraction (1/2 h)</option> 
                  <option value="letters">En lettres (Un demi)</option>
                  <option value="empty">Vide</option>
                </select>
            </fieldset>

            <!-- BLOC 3 : STYLE RECTO -->
            <fieldset>
                <legend>Style & Traits</legend>
                <div class="row">
                    <div>
                        <label>Taille texte (pt)</label>
                        <input type="number" id="labelPtRecto" step="1" value="12">
                    </div>
                    <div>
                        <label>Orientation</label>
                        <select id="textOrientationRecto">
                          <option value="auto" selected>Auto</option>
                          <option value="vertical">Vertical</option>
                          <option value="horizontal">Horizontal</option>
                        </select>
                    </div>
                </div>
                <label>S√©parations (Bordures int√©rieures)</label>
                <select id="innerBordersRecto">
                    <option value="visible" selected>Visibles</option>
                    <option value="hidden">Masqu√©es</option>
                </select>
                
                <div class="row">
                  <div>
                    <label>√âp. Contour (mm)</label>
                     <input type="number" id="frameWRecto" step="0.01" value="0.10">
                  </div>
                   <div>
                    <label>√âp. S√©paration (mm)</label>
                     <input type="number" id="dotWRecto" step="0.01" value="0.10">
                  </div>
                </div>
                
                <label>Longueur tiret pointill√©s (mm)</label>
                <input type="number" id="dashRectoNum" value="3" min="0" step="0.5">
                <div class="help-text">Mettre 0 pour un trait plein.</div>
            </fieldset>
        </div>

        <!-- ONGLET 3 : VERSO -->
        <div id="tab-verso" class="tab-content">
            <div id="noticeVerso" class="notice" style="display:none;"></div>
            
            <!-- BLOC 1 : BANDE UNIT√â VERSO -->
            <fieldset>
                <legend>Bande UNIT√â (d=1)</legend>
                <label>Contenu affich√©</label>
                <select id="unitModeVersoD1">
                    <option value="same_as_recto" selected>Identique au Recto</option>
                    <option value="unit">Texte "1 unit√©"</option>
                    <option value="numeric_one">Chiffre "1"</option>
                    <option value="one-on-one">Fraction "1/1"</option>
                    <option value="percent">100%</option>
                    <option value="minutes">60min</option>
                    <option value="hours_unit">1 heure</option>
                    <option value="degrees_unit">360¬∞</option>
                    <option value="custom">Texte personnalis√©...</option>
                    <option value="empty">Vide</option>
                </select>
                <input type="text" id="customTextVersoD1" value="1 unit√© (Verso)" style="margin-top: 5px; display: none;">
            </fieldset>

            <!-- BLOC 2 : BANDES FRACTIONN√âES VERSO -->
            <fieldset>
                <legend>Bandes FRACTIONN√âES (d>1)</legend>
                
                <label>Structure de la bande</label>
                <select id="versoStructureDgt1">
                    <option value="unit_center" selected>Unit√© au centre (Non divis√©e)</option>
                    <option value="segmented">Divis√©e en parts (Comme le recto)</option>
                </select>
                <div class="help-text" style="margin-bottom: 12px;">"Unit√© au centre" permet d'avoir '1 unit√©' au dos de toutes les bandes.</div>

                <!-- Options dynamiques D>1 (Unit√© au centre) -->
                <div id="unitCenterVersoOptions">
                    <label>Contenu affich√©</label>
                    <select id="unitModeVersoDgt1">
                        <option value="unit" selected>Texte "1 unit√©"</option> 
                        <option value="numeric_one">Chiffre "1"</option>
                        <option value="one-on-one">Fraction "1/1"</option>
                        <option value="percent">100%</option>
                        <option value="minutes">60min</option>
                        <option value="hours_unit">1 heure</option>
                        <option value="degrees_unit">360¬∞</option>
                        <option value="custom">Texte personnalis√©...</option>
                        <option value="empty">Vide</option>
                    </select>
                    <input type="text" id="customTextVersoDgt1" value="1 unit√©" style="margin-top: 5px; display: none;">
                </div>

                <!-- Options dynamiques D>1 (Segment√©) -->
                <div id="segmentedVersoOptions" style="display: none;">
                    <label>Contenu des parts</label>
                    <select id="contentVersoDgt1">
                        <option value="same_as_recto" selected>Identique au Recto</option>
                        <option value="numeric">Fraction (1/2)</option>
                        <option value="numeric_unit">Fraction + unit√© (1/2 u)</option>
                        <option value="decimal">D√©cimal (0,5)</option>
                        <option value="decimal_unit">D√©cimal + unit√© (0,5 u)</option>
                        <option value="percentage">Pourcentage (50 %)</option>
                        <option value="minutes">Temps (30 min)</option>
                        <option value="hours_fractional">Temps fraction (1/2 h)</option>
                        <option value="letters">En lettres</option>
                        <option value="empty">Vide</option>
                    </select>
                </div>
            </fieldset>

            <!-- BLOC 3 : STYLE VERSO -->
            <fieldset>
                <legend>Style & Traits</legend>
                 <div class="row">
                    <div>
                        <label>Taille texte (pt)</label>
                        <input type="number" id="labelPtVerso" step="1" value="12">
                    </div>
                    <div>
                        <label>Orientation</label>
                        <select id="textOrientationVerso">
                          <option value="auto" selected>Auto</option>
                          <option value="vertical">Vertical</option>
                          <option value="horizontal">Horizontal</option>
                        </select>
                    </div>
                </div>
                
                <div class="row">
                  <div>
                    <label>√âp. Contour (mm)</label>
                     <input type="number" id="frameWVerso" step="0.01" value="0.10">
                  </div>
                   <div>
                    <label>√âp. S√©paration (mm)</label>
                     <input type="number" id="dotWVerso" step="0.01" value="0.10">
                  </div>
                </div>

                <label>Longueur tiret pointill√©s (mm)</label>
                <input type="number" id="dashVersoNum" value="3" min="0" step="0.5">
                <div class="help-text">Mettre 0 pour un trait plein.</div>

            </fieldset>
        </div>

        <!-- ONGLET 4 : CALAGES (AVANC√â) -->
        <div id="tab-calages" class="tab-content">
            <fieldset>
                <legend>Ajustements Imprimante (mm)</legend>
                <div class="help-text" style="margin-bottom: 10px;">Utilisez ces valeurs pour aligner parfaitement le recto et le verso si votre imprimante d√©cale le papier.</div>
                
                <div class="row">
                  <div>
                    <label>D√©calage X RECTO</label>
                    <input type="number" id="rectoOffX" step="0.1" value="-2">
                  </div>
                  <div>
                    <label>D√©calage Y RECTO</label>
                    <input type="number" id="rectoOffY" step="0.1" value="0">
                  </div>
                </div>
                <div class="row">
                  <div>
                    <label>D√©calage X VERSO</label>
                    <input type="number" id="offX" step="0.1" value="0">
                  </div>
                  <div>
                    <label>D√©calage Y VERSO</label>
                    <input type="number" id="offY" step="0.1" value="0">
                  </div>
                </div>
            </fieldset>

            <div style="display:none;">
                <!-- Champs cach√©s pour garder compatibilit√© JS si n√©cessaire, ou d√©plac√©s -->
                 <select id="innerBordersVerso"><option value="visible" selected>Visibles</option><option value="hidden">Masqu√©es</option></select>
            </div>
        </div>

    </form>
    
    <!-- Bouton Action -->
    <div class="action-bar">
        <button type="button" id="print" class="btn-primary">
            üñ®Ô∏è Imprimer / PDF
        </button>
    </div>
  </section>

  <!-- APER√áU -->
  <section class="preview-area" id="previewShell">
      <div class="preview-toolbar">
          <div class="preview-toolbar-left">
              <label for="previewFilter" class="preview-label">Aper√ßu :</label>
              <select id="previewFilter">
                  <option value="all" selected>Tout</option>
                  <option value="recto">Recto</option>
                  <option value="verso">Verso</option>
              </select>
              <span id="previewFilterHint" class="preview-hint" aria-live="polite"></span>
          </div>
          <div class="preview-summary" id="previewSummary" aria-live="polite"></div>
      </div>
      <div id="preview" class="preview-pages">
          <!-- Les pages SVG seront g√©n√©r√©es ici -->
      </div>
  </section>
</main>

<script>
// --- GESTION DES ONGLETS (UI) ---
function openTab(tabId) {
    // Masquer tous les contenus
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    // D√©sactiver tous les boutons
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    
    // Activer la cible
    document.getElementById(tabId).classList.add('active');
    // Trouver le bouton qui a appel√© (via event ou query) - ici on triche un peu pour simplifier
    const btns = document.querySelectorAll('.tab-btn');
    btns.forEach(btn => {
        if(btn.getAttribute('onclick').includes(tabId)) {
            btn.classList.add('active');
        }
    });
}


// --- LOGIQUE G√âN√âRATEUR (Code original conserv√© et optimis√©) ---

// --- APER√áU : Filtre visuel (Option 2) + R√©sum√© + Messages ---
function getModeLabel(mode){
    if(mode === 'recto_verso_alternating') return 'Recto / Verso altern√©';
    if(mode === 'recto_only') return 'Recto seul';
    if(mode === 'verso_only') return 'Verso seul';
    return mode;
}

function applyPreviewFilter(){
    var sel = document.getElementById('previewFilter');
    if(!sel) return;
    var filter = sel.value || 'all';
    var pages = document.querySelectorAll('#preview .page');
    pages.forEach(function(p){
        var side = (p.dataset && p.dataset.side) ? p.dataset.side : 'recto';
        var shouldHide = (filter !== 'all' && side !== filter);
        p.classList.toggle('preview-hidden', shouldHide);
    });
    updatePreviewFilterHint();
}

function updatePreviewFilterHint(){
    var hint = document.getElementById('previewFilterHint');
    if(!hint) return;
    var modeEl = document.getElementById('mode');
    var mode = modeEl ? modeEl.value : '';
    var sel = document.getElementById('previewFilter');
    var filter = sel ? sel.value : 'all';

    // Indiquer clairement quand le filtre demande un c√¥t√© non g√©n√©r√©
    var noRecto = (mode === 'verso_only');
    var noVerso = (mode === 'recto_only');

    var msg = '';
    if(filter === 'recto' && noRecto) msg = "‚ö†Ô∏è Aucun recto n'est g√©n√©r√© dans la s√©quence actuelle.";
    if(filter === 'verso' && noVerso) msg = "‚ö†Ô∏è Aucun verso n'est g√©n√©r√© dans la s√©quence actuelle.";

    hint.textContent = msg;
}

function updateModeNotices(){
    var form = document.getElementById('form');
    if(!form) return;
    var mode = form.mode.value;
    var nR = document.getElementById('noticeRecto');
    var nV = document.getElementById('noticeVerso');

    if(nR){
        if(mode === 'verso_only'){
            nR.style.display = 'block';
            nR.textContent = "‚ö†Ô∏è Le recto n'est pas g√©n√©r√© dans la s√©quence actuelle (Verso seul).";
        } else {
            nR.style.display = 'none';
            nR.textContent = '';
        }
    }

    if(nV){
        if(mode === 'recto_only'){
            nV.style.display = 'block';
            nV.textContent = "‚ö†Ô∏è Le verso n'est pas g√©n√©r√© dans la s√©quence actuelle (Recto seul).";
        } else {
            nV.style.display = 'none';
            nV.textContent = '';
        }
    }
}

function updatePreviewSummary(){
    var box = document.getElementById('previewSummary');
    if(!box) return;
    var form = document.getElementById('form');
    if(!form) return;

    var { denomsList, includeUnit } = parseDenoms(form.denoms.value);
    var all = [];
    if(includeUnit) all.push(1);
    all = all.concat(denomsList);

    var mode = form.mode.value;
    var pages = 0, rectos = 0, versos = 0;

    if(mode === 'recto_verso_alternating'){
        pages = all.length * 2;
        rectos = all.length;
        versos = all.length;
    } else if(mode === 'recto_only'){
        pages = all.length;
        rectos = all.length;
        versos = 0;
    } else if(mode === 'verso_only'){
        pages = all.length;
        rectos = 0;
        versos = all.length;
    }

    var bandLen = parseFloat(form.bandLen.value);
    var bandHeight = parseFloat(form.bandHeight.value);
    var gapV = parseFloat(form.gapV.value);

    var denomsStr = all.length ? all.join(',') : '‚Äî';
    var sizeStr = (isFinite(bandLen) && isFinite(bandHeight)) ? `${bandLen}√ó${bandHeight} mm` : '‚Äî';
    var gapStr = isFinite(gapV) ? `${gapV} mm` : '‚Äî';

    box.innerHTML = `
      <div><strong>Mode :</strong> ${getModeLabel(mode)}</div>
      <div><strong>D√©nominateurs :</strong> ${denomsStr}</div>
      <div><strong>Bande :</strong> ${sizeStr} ¬∑ <strong>√âcart :</strong> ${gapStr}</div>
      <div><strong>Pages :</strong> ${pages} (recto ${rectos} ¬∑ verso ${versos})</div>
    `.trim();
}

function revealAllPagesForPrint(){
    // Ne PAS d√©pendre du filtre visuel pour l'impression
    var pages = document.querySelectorAll('#preview .page.preview-hidden');
    pages.forEach(function(p){ p.classList.remove('preview-hidden'); });
}

function safePrint(){
    var sel = document.getElementById('previewFilter');
    var filter = sel ? sel.value : 'all';
    if(filter !== 'all') revealAllPagesForPrint();
    window.print();
    // Apr√®s fermeture de la fen√™tre d'impression
    applyPreviewFilter();
}

window.addEventListener('beforeprint', function(){
    var sel = document.getElementById('previewFilter');
    var filter = sel ? sel.value : 'all';
    if(filter !== 'all') revealAllPagesForPrint();
});
window.addEventListener('afterprint', function(){
    applyPreviewFilter();
});


var W = 297; // mm (A4 paysage)
var H = 210; // mm
function mm(v){ return v + "mm"; }
var SVG_NS = "http://www.w3.org/2000/svg";

var denomToLetters = {
    1: "Une unit√©", 2: "Un demi", 3: "Un tiers", 4: "Un quart", 5: "Un cinqui√®me", 
    6: "Un sixi√®me", 7: "Un septi√®me", 8: "Un huiti√®me", 9: "Un neuvi√®me", 
    10: "Un dixi√®me", 11: "Un onzi√®me", 12: "Un douzi√®me", 
};

var denomColors = {
    1: '#fff', 2: '#ffb3b3', 3: '#6699ff', 4: '#b3ffc6', 5: '#ff9966', 
    6: '#e0b3ff', 7: '#99ccff', 8: '#ccff99', 9: '#ffccff', 10: '#ffffb3', 
    11: '#cc99ff', 12: '#99ffff',
};

var FIXED_BAR_RATIO = 80;
var FIXED_BAR_WMM = 0.10; 

function getUnitSymbolFromContentMode(contentMode) {
    if (contentMode === 'numeric_unit' || contentMode === 'decimal_unit') return 'u';
    if (contentMode === 'hours_fractional') return 'h';
    return ''; 
}

function getTextContent(d, contentMode, segmentUnitSymbol){
    var val = 1 / d;
    var partText = '';
    
    if (contentMode === 'percentage') {
        var valStr = Number((val * 100).toFixed(2));
        partText = `${valStr.toString().replace('.', ',')}%`; 
    } else if (contentMode === 'minutes') {
        var minVal = val * 60;
        if (Number.isInteger(minVal)) { 
            partText = `${minVal}min`; 
        } 
        else { 
            partText = `${minVal.toFixed(1)}min`; 
        }
    } else if (contentMode === 'decimal' || contentMode === 'decimal_unit') { 
        var formatter = new Intl.NumberFormat('fr-FR', { 
            minimumFractionDigits: 1, 
            maximumFractionDigits: 3 
        });
        partText = formatter.format(val).replace(/(\.0+)?$/, '');
        
        if (contentMode === 'decimal_unit' && segmentUnitSymbol !== '') { 
            return `${partText}${segmentUnitSymbol}`;
        }
        return partText;
        
    } else if (contentMode === 'letters') {
         return denomToLetters[d] || ("1/"+d);
    } else {
        return '';
    } 
    return partText;
}

function getUnityText(currentUnitMode, currentCustomText, rectoUnitMode, rectoCustomText) {
    var finalMode = currentUnitMode;
    var finalCustomText = currentCustomText;
    
    if (currentUnitMode === 'same_as_recto') {
        finalMode = rectoUnitMode;
        finalCustomText = rectoCustomText;
    }

    if (finalMode === 'numeric_one') return '1';
    if (finalMode === 'unit') return '1 unit√©'; 
    if (finalMode === 'one-on-one') return 'fraction'; 
    if (finalMode === 'percent') return '100%'; 
    if (finalMode === 'minutes') return '60min'; 
    if (finalMode === 'degrees_unit') return '360¬∞';
    if (finalMode === 'hours_unit') return '1 heure'; 
    if (finalMode === 'empty') return ''; 
    return finalCustomText;
}

function getRotation(contentMode, textOrientation) {
    var rotation = 0;
    if (textOrientation === 'horizontal') { rotation = 0; } 
    else if (textOrientation === 'vertical') { rotation = 90; } 
    else { 
        if (contentMode === 'letters') { rotation = 90; } 
        else { rotation = 0; }
    }
    return rotation;
}

function fracSVG(cx, cy, sizePt, d, barRatio, barWmm, contentMode, textOrientation, segmentUnitSymbol, isUnitD1 = false){
    var g = document.createElementNS(SVG_NS,"g");
    
    if(contentMode === "empty" && !isUnitD1){
        return g;
    } 

    var isFractionalContent = contentMode === 'numeric' || contentMode === 'numeric_unit' || contentMode === 'hours_fractional' || (isUnitD1 && contentMode === 'one-on-one');
    
    var gapAboveBar = sizePt * 0.20; 
    var gapBelowBar = sizePt * 0.00; 
    var barRatioFloat = (barRatio ?? FIXED_BAR_RATIO);
    var sizePx = sizePt * 96/72; 
    var halfBar = sizePx * (barRatioFloat / 200);

    var rotation = getRotation(contentMode, textOrientation);
    var rotationTransform = rotation !== 0 ? `rotate(${rotation}, ${cx}, ${cy})` : '';

    if(isFractionalContent){
        var num = isUnitD1 ? "1" : "1";
        var denomStr = isUnitD1 ? "1" : String(d);
        
        var n = document.createElementNS(SVG_NS,"text");
        n.setAttribute("x", cx); 
        n.setAttribute("y", cy - gapAboveBar); 
        n.setAttribute("font-size", sizePt+"pt");
        n.setAttribute("text-anchor","middle");
        n.setAttribute("dominant-baseline","baseline");
        n.setAttribute("transform", rotationTransform); 
        n.textContent = num;

        var dd = document.createElementNS(SVG_NS,"text");
        dd.setAttribute("x", cx); 
        dd.setAttribute("y", cy + gapBelowBar); 
        dd.setAttribute("font-size", sizePt+"pt");
        dd.setAttribute("text-anchor","middle");
        dd.setAttribute("dominant-baseline","hanging");
        dd.setAttribute("transform", rotationTransform); 
        dd.textContent = denomStr;
        
        var line = document.createElementNS(SVG_NS,"line");
        line.setAttribute("x1", cx - halfBar); line.setAttribute("x2", cx + halfBar);
        line.setAttribute("y1", cy); line.setAttribute("y2", cy);
        line.setAttribute("stroke","black");
        line.setAttribute("stroke-width", mm(barWmm ?? FIXED_BAR_WMM));
        line.setAttribute("transform", rotationTransform); 

        g.appendChild(n); g.appendChild(dd); g.appendChild(line);

        var isHoursFractional = contentMode === 'hours_fractional';
        var isNumericUnit = contentMode === 'numeric_unit' && !isUnitD1;
        
        if(isHoursFractional || isNumericUnit){
            var unitText = document.createElementNS(SVG_NS,"text");
            var unitSuffix = isHoursFractional ? 'h' : segmentUnitSymbol; 
            var startX = cx + halfBar + sizePt * 0.05; 
            
            unitText.setAttribute("x", startX); unitText.setAttribute("y", cy);
            unitText.setAttribute("font-size", sizePt+"pt");
            unitText.setAttribute("text-anchor","start");
            unitText.setAttribute("dominant-baseline","middle");
            unitText.setAttribute("transform", rotationTransform); 
            unitText.textContent = unitSuffix; 
            g.appendChild(unitText);
        }
        return g;
    }
    
    var text = getTextContent(d, contentMode, segmentUnitSymbol); 
    
    if (text) {
        var t = document.createElementNS(SVG_NS,"text");
        t.setAttribute("x", cx); t.setAttribute("y", cy);
        t.setAttribute("font-size", sizePt+"pt");
        t.setAttribute("text-anchor","middle");
        t.setAttribute("dominant-baseline","middle");
        t.setAttribute("transform", rotationTransform); 
        t.textContent = text;
        g.appendChild(t);
    }
    return g;
}

function unitSVG(cx, cy, sizePt, unitMode, customText, barWmm, rectoUnitMode, rectoCustomText, textOrientation){ 
    var text = getUnityText(unitMode, customText, rectoUnitMode, rectoCustomText);
    if(text === 'fraction'){
        return fracSVG(cx, cy, sizePt, 1, FIXED_BAR_RATIO, FIXED_BAR_WMM, 'numeric', textOrientation, '', true); 
    }
    if (!text) return document.createElementNS(SVG_NS,"g"); 

    var g = document.createElementNS(SVG_NS,"g");
    var t = document.createElementNS(SVG_NS,"text");
    
    var rotation = getRotation('numeric', textOrientation); 
    var rotationTransform = rotation !== 0 ? `rotate(${rotation}, ${cx}, ${cy})` : '';

    t.setAttribute("x", cx); t.setAttribute("y", cy);
    t.setAttribute("font-size", sizePt+"pt");
    t.setAttribute("text-anchor","middle");
    t.setAttribute("dominant-baseline","middle");
    t.setAttribute("transform", rotationTransform); 
    t.textContent = text;
    g.appendChild(t);
    return g;
}

function drawPage({bandLen, bandHeight, gapV, denom, isVerso, contentMode, colorMode, rectoStyles, versoStyles, rectoUnitInfo, versoUnitInfo}){
  var page = document.createElement("div");
  page.className = "page";
  page.dataset.side = isVerso ? 'verso' : 'recto';

  var svg = document.createElementNS(SVG_NS,"svg");
  svg.setAttribute("xmlns",SVG_NS);
  svg.setAttribute("width", mm(W)); svg.setAttribute("height", mm(H));
  svg.setAttribute("viewBox", `0 0 ${W} ${H}`);

  var safeLen = Math.min(Math.max(10, bandLen), W - 2);
  
  var styles = isVerso ? versoStyles : rectoStyles;
  var unitInfo = isVerso ? versoUnitInfo : rectoUnitInfo; 
  var offset = isVerso ? {x: styles.offX, y: styles.offY} : {x: styles.rectoOffX, y: styles.rectoOffY};
  
  var baseLeft = (W - safeLen)/2;
  var left = baseLeft + offset.x;
  
  var totalH = 3*bandHeight + 2*gapV;
  var baseTop = (H - totalH)/2;
  var top = baseTop + offset.y; 
  
  var y2 = top;
  var y3 = y2 + bandHeight + gapV;
  var y1 = y3 + bandHeight + gapV;
  var ys = [y1, y3, y2]; 
  
  var fillColor = (colorMode === 'colored' && denomColors[denom]) ? denomColors[denom] : 'white';
  var sepDash = styles.dash.trim() === '0' || styles.dash.trim() === '' ? '0' : styles.dash;

  var segmentUnitSymbol = getUnitSymbolFromContentMode(contentMode);

  for(var y0 of ys){
    var rect = document.createElementNS(SVG_NS,"rect");
    rect.setAttribute("x", left); rect.setAttribute("y", y0);
    rect.setAttribute("width", safeLen); rect.setAttribute("height", bandHeight);
    rect.setAttribute("fill", fillColor); 
    rect.setAttribute("stroke","black");
    rect.setAttribute("stroke-width", mm(styles.frameW));
    svg.appendChild(rect);

    var isD1 = denom === 1;
    var renderAsUnitMode = isD1 || (isVerso && versoStyles.versoStructureDgt1 === 'unit_center');

    if(renderAsUnitMode){
      var cx = left + safeLen/2;
      var cy = y0 + bandHeight/2;
      var unitMode, customText;
      if(isD1) {
          unitMode = isVerso ? unitInfo.unitModeD1 : rectoUnitInfo.unitMode;
          customText = isVerso ? unitInfo.customTextD1 : rectoUnitInfo.customText;
      } else {
          unitMode = unitInfo.unitModeDgt1;
          customText = unitInfo.customTextDgt1;
      }
      svg.appendChild(unitSVG(
        cx, cy, styles.labelPt, 
        unitMode, customText, 
        styles.barW,
        rectoUnitInfo.unitMode, rectoUnitInfo.customText, 
        styles.textOrientation
      ));
    }else{
      if (styles.innerBorders === 'visible') {
          for(var k=1;k<denom;k++){
            var x = left + safeLen * k / denom;
            var sep = document.createElementNS(SVG_NS,"line");
            sep.setAttribute("x1", x); sep.setAttribute("x2", x);
            sep.setAttribute("y1", y0); sep.setAttribute("y2", y0 + bandHeight);
            sep.setAttribute("stroke","black"); 
            sep.setAttribute("stroke-width", mm(styles.dotW));
            sep.setAttribute("stroke-dasharray", sepDash); 
            svg.appendChild(sep);
          }
      }
      for(var k=0;k<denom;k++){
        var cx = left + safeLen*(k+0.5)/denom;
        var cy = y0 + bandHeight/2;
        svg.appendChild(fracSVG(
          cx, cy, 
          styles.labelPt, 
          denom, 
          styles.barRatio, styles.barW, 
          contentMode, styles.textOrientation, 
          segmentUnitSymbol, 
          false
        ));
      }
    }
  }
  page.appendChild(svg);
  return page;
}

function parseDenoms(s){ 
    var allNumbers = s.split(",").map(v=>parseInt(v.trim(),10)).filter(v=>!isNaN(v) && v > 0).sort((a, b) => a - b);
    var denomsList = allNumbers.filter(d => d > 1); 
    var includeUnit = allNumbers.includes(1); 
    return { denomsList, includeUnit };
}

function generate(){
  var form = document.getElementById('form');
  var bandLen = parseFloat(form.bandLen.value);
  var bandHeight = parseFloat(form.bandHeight.value);
  var gapV = parseFloat(form.gapV.value);
  var colorMode = form.colorMode.value; 
  var { denomsList: denoms, includeUnit } = parseDenoms(form.denoms.value);
  
  // Logic pour convertir le selecteur num√©rique en string de pointill√©s
  var dashRNum = parseFloat(form.dashRectoNum.value);
  var dashRStr = (isNaN(dashRNum) || dashRNum <= 0) ? "0" : `${dashRNum},${dashRNum}`;

  var rectoStyles = {
      frameW: parseFloat(form.frameWRecto.value),
      labelPt: parseFloat(form.labelPtRecto.value),
      innerBorders: form.innerBordersRecto.value,
      dotW: parseFloat(form.dotWRecto.value),
      dash: dashRStr,
      barRatio: FIXED_BAR_RATIO,
      barW: FIXED_BAR_WMM, 
      textOrientation: form.textOrientationRecto.value,
      rectoOffX: parseFloat(form.rectoOffX.value)||0,
      rectoOffY: parseFloat(form.rectoOffY.value)||0,
  };
  var contentRecto = form.contentRecto.value;
  var rectoUnitInfo = {
      unitMode: form.unitModeRecto.value,
      customText: form.customTextRecto.value || '1 unit√©',
  };

  // Logic pour pointill√©s verso
  var dashVNum = parseFloat(form.dashVersoNum.value);
  var dashVStr = (isNaN(dashVNum) || dashVNum <= 0) ? "0" : `${dashVNum},${dashVNum}`;

  var innerBordersVersoEl = document.getElementById('innerBordersVerso');
  var innerBordersVersoVal = innerBordersVersoEl ? innerBordersVersoEl.value : 'visible';

  var versoStyles = {
      frameW: parseFloat(form.frameWVerso.value),
      labelPt: parseFloat(form.labelPtVerso.value),
      innerBorders: innerBordersVersoVal,
      dotW: parseFloat(form.dotWVerso.value),
      dash: dashVStr,
      barRatio: FIXED_BAR_RATIO,
      barW: FIXED_BAR_WMM, 
      textOrientation: form.textOrientationVerso.value,
      offX: parseFloat(form.offX.value)||0,
      offY: parseFloat(form.offY.value)||0,
      versoStructureDgt1: form.versoStructureDgt1.value,
  };
  
  var contentVersoSelected = form.contentVersoDgt1.value;
  var contentVersoDgt1 = contentVersoSelected === 'same_as_recto' ? contentRecto : contentVersoSelected;

  var versoUnitInfo = {
      unitModeD1: form.unitModeVersoD1.value,
      customTextD1: form.customTextVersoD1.value || '1 unit√© (Verso D=1)',
      unitModeDgt1: form.unitModeVersoDgt1.value, 
      customTextDgt1: form.customTextVersoDgt1.value || '1 unit√© (Verso D>1)',
  };

  var mode = form.mode.value;
  var preview = document.getElementById("preview");
  preview.innerHTML = "";

  var push = (el)=>preview.appendChild(el);

  var draw = (d, isVerso) => {
      var isD1 = d === 1;
      var contentMode = '';
      if(isVerso){
          if(!isD1 && versoStyles.versoStructureDgt1 === 'segmented'){
             contentMode = contentVersoDgt1;
          }
      } else {
          if(!isD1){
             contentMode = contentRecto;
          }
      }
      return drawPage({
          bandLen, bandHeight, gapV, denom: d, isVerso, 
          contentMode, colorMode, 
          rectoStyles: rectoStyles, versoStyles: versoStyles, 
          rectoUnitInfo: rectoUnitInfo, versoUnitInfo: versoUnitInfo, 
      });
  };

  if (mode === "recto_verso_alternating") {
      if(includeUnit){ push(draw(1, false)); push(draw(1, true)); }
      for(var d of denoms){ push(draw(d, false)); push(draw(d, true)); }
  } else if(mode==="recto_only"){
      if(includeUnit){ push(draw(1, false)); }
      for(var d of denoms){ push(draw(d, false)); }
  } else if(mode==="verso_only"){
      if(includeUnit){ push(draw(1, true)); }
      for(var d of denoms){ push(draw(d, true)); }
  }
}

document.getElementById("print").addEventListener("click", safePrint);

function updateUI() {
    var form = document.getElementById('form');
    
    // UI Logic
    form.customTextRecto.style.display = form.unitModeRecto.value === 'custom' ? 'block' : 'none';
    form.customTextVersoD1.style.display = form.unitModeVersoD1.value === 'custom' ? 'block' : 'none';

    var versoStructureDgt1 = form.versoStructureDgt1.value;
    var segmentedVersoOptions = document.getElementById('segmentedVersoOptions');
    var unitCenterVersoOptions = document.getElementById('unitCenterVersoOptions');
    
    var isRenderedAsUnitDgt1 = (versoStructureDgt1 === 'unit_center');

    if (isRenderedAsUnitDgt1) {
        segmentedVersoOptions.style.display = 'none';
        unitCenterVersoOptions.style.display = 'block';
        form.customTextVersoDgt1.style.display = form.unitModeVersoDgt1.value === 'custom' ? 'block' : 'none';
    } else {
        segmentedVersoOptions.style.display = 'block';
        unitCenterVersoOptions.style.display = 'none';
    }
    
    // Zoom auto sur la zone d'aper√ßu pour que les pages rentrent
    var preview = document.getElementById('preview');
    if(preview && preview.children.length > 0){
        // Petit hack visuel si n√©cessaire, mais le CSS fait d√©j√† le job
    }

    generate();
    updateModeNotices();
    updatePreviewSummary();
    applyPreviewFilter();

}

document.getElementById('form').addEventListener('change', updateUI);
document.getElementById('form').addEventListener('input', (e) => {
    var targetId = e.target.id;
    // Mise √† jour de la liste des IDs surveill√©s pour les nouveaux inputs de pointill√©s
    if (['bandLen', 'bandHeight', 'gapV', 'denoms', 'customTextRecto', 'customTextVersoD1', 'customTextVersoDgt1', 'dashRectoNum', 'dashVersoNum', 'rectoOffX', 'rectoOffY', 'offX', 'offY', 'labelPtRecto', 'labelPtVerso', 'dotWRecto', 'dotWVerso', 'frameWRecto', 'frameWVerso'].includes(targetId)) {
        updateUI(); 
    }
});

window.addEventListener("load", updateUI);

// Filtre d'aper√ßu : r√©agit imm√©diatement
var pf = document.getElementById('previewFilter');
if(pf){
    pf.addEventListener('change', function(){
        applyPreviewFilter();
    });
}

</script>
</body>
</html>
