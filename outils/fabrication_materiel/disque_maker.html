<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<title>G√©n√©rateur PRO ‚Äî Disques de Fractions</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  :root { 
      --page-w: 297mm; 
      --page-h: 210mm; 
      --primary-color: #2563eb;
      --bg-color: #f8fafc;
      --panel-bg: #ffffff;
      --border-color: #e2e8f0;
      --text-main: #1e293b;
      --text-muted: #64748b;
  }
  *{ box-sizing:border-box; }
  body{ 
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; 
      margin:0; 
      background-color: var(--bg-color);
      color: var(--text-main);
      height: 100vh;
      display: flex;
      flex-direction: column;
  }
  
  /* --- EN-T√äTE --- */
  header{ 
      padding: 0 1rem; 
      height: 50px;
      background: #1e293b; 
      color: #fff; 
      font-size: 14px; 
      display: flex;
      justify-content: space-between; 
      align-items: center;
      flex-shrink: 0; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      z-index: 10;
  }
  header a {
      color: #cbd5e1;
      text-decoration: none;
      font-weight: 500;
      transition: color 0.2s;
  }
  header a:hover { color: #fff; }
  header span { font-weight: 600; letter-spacing: 0.5px; }
  
  /* --- LAYOUT PRINCIPAL --- */
  main{ 
      display: flex; 
      flex: 1;
      overflow: hidden; /* Emp√™che le scroll global */
  }
  
  /* --- COLONNE DE GAUCHE (CONTR√îLES) --- */
  .sidebar { 
      width: 380px; 
      background: var(--panel-bg);
      border-right: 1px solid var(--border-color);
      display: flex; 
      flex-direction: column; 
      flex-shrink: 0;
      z-index: 5;
  }

  /* Navigation par Onglets */
  .tabs-nav {
      display: flex;
      border-bottom: 1px solid var(--border-color);
      background: #f1f5f9;
  }
  .tab-btn {
      flex: 1;
      padding: 12px 5px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-muted);
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
  }
  .tab-btn:hover { background: #e2e8f0; color: var(--text-main); }
  .tab-btn.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
      background: #fff;
  }

  /* Zone de contenu des r√©glages (Scrollable) */
  .settings-container {
      flex: 1;
      overflow-y: auto; 
      padding: 20px;
      -webkit-overflow-scrolling: touch; 
  }

  /* Masquer les onglets non actifs */
  .tab-content { display: none; }
  .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
  
  @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

  /* Styles des formulaires */
  fieldset { 
      border: 1px solid var(--border-color); 
      border-radius: 8px; 
      margin: 0 0 20px 0; 
      padding: 15px;
      background: #fff;
  }
  legend { 
      padding: 0 8px; 
      font-weight: 600; 
      color: var(--primary-color); 
      font-size: 0.9rem;
  }
  
  label { 
      display: block; 
      font-size: 13px; 
      font-weight: 500;
      margin-bottom: 4px; 
      margin-top: 12px;
      color: var(--text-main);
  }
  fieldset > div:first-child > label:first-child { margin-top: 0; }

  input[type="number"], input[type="text"], select { 
      width: 100%; 
      padding: 8px 10px; 
      font-size: 14px; 
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      background: #fff;
      transition: border-color 0.2s;
  }
  input:focus, select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }
  
  .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .help-text { font-size: 11px; color: var(--text-muted); margin-top: 4px; font-style: italic; }

  /* Zone d'action fixe en bas */
  .action-bar {
      padding: 15px 20px;
      border-top: 1px solid var(--border-color);
      background: #fff;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
  }
  .btn-primary { 
      width: 100%;
      padding: 12px; 
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: 600; 
      font-size: 15px; 
      cursor: pointer; 
      transition: background 0.2s;
      display: flex; justify-content: center; align-items: center; gap: 8px;
  }
  .btn-primary:hover { background: #1d4ed8; }

  /* --- ZONE D'APER√áU (DROITE) --- */
  .preview-area { 
      flex: 1; 
      background: #e2e5e9; 
      padding: 20px; 
      overflow: auto; 
      display: flex;
      flex-direction: column;
      align-items: center;
  }
  
  .page { 
      width: var(--page-w); 
      height: var(--page-h); 
      background: white; 
      margin-bottom: 20px; 
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      /* Zoom responsive pour l'aper√ßu */
      transform-origin: top left; /* Zoom depuis le coin */
      transform: scale(0.85); /* Zoom par d√©faut pour voir la page */
  }
  
  /* --- PRINT --- */
  @media print{
    header, .sidebar { display:none !important; }
    main { display:block; height:auto; overflow:visible; } 
    .preview-area { background:none; padding:0; height:auto; display:block; }
    .page { 
        box-shadow: none; margin: 0; 
        break-after: page; page-break-after: always; 
        transform: none !important; /* Pas de zoom √† l'impression */
    }
    @page { size: A4 landscape; margin: 0; }
  }


  /* --- APER√áU : CONTROLES (Filtre + r√©sum√©) --- */
  .preview-controls {
      width: 100%;
      max-width: calc(var(--page-w) + 40px);
      margin-bottom: 14px;
  }
  .preview-toolbar {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      background: rgba(255,255,255,0.85);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.04);
      backdrop-filter: blur(4px);
  }
  .preview-toolbar-title {
      font-weight: 700;
      color: var(--text-main);
      font-size: 13px;
      letter-spacing: 0.2px;
      white-space: nowrap;
  }
  .segmented {
      display: inline-flex;
      border: 1px solid #cbd5e1;
      border-radius: 999px;
      overflow: hidden;
      background: #fff;
  }
  .seg-btn {
      border: none;
      background: transparent;
      padding: 7px 12px;
      font-size: 13px;
      font-weight: 700;
      color: var(--text-muted);
      cursor: pointer;
      transition: background 0.15s, color 0.15s;
  }
  .seg-btn:hover { background: #f1f5f9; color: var(--text-main); }
  .seg-btn.active { background: var(--primary-color); color: #fff; }

  .preview-warning {
      margin-left: auto;
      font-size: 12px;
      font-weight: 600;
      color: #b45309; /* amber */
      min-height: 1em;
  }

  .preview-summary {
      margin-top: 10px;
      padding: 10px 12px;
      background: #fff;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      font-size: 12px;
      color: var(--text-main);
      box-shadow: 0 2px 10px rgba(0,0,0,0.04);
      line-height: 1.35;
  }
  .preview-summary .muted { color: var(--text-muted); font-weight: 600; }

  /* --- Notices dans les onglets --- */
  .notice {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border-color);
      background: #fff;
      font-size: 12px;
      font-weight: 600;
      margin: 0 0 14px 0;
      line-height: 1.35;
  }
  .notice-warn { border-color: rgba(245,158,11,0.35); background: rgba(255,251,235,0.9); color: #92400e; }

  /* Helpers */
  .no-print { }


</style>
</head>
<body>

<header>
    <a href="#" onclick="history.back()" id="return-link">‚Üê Retour</a>
    <span>G√âN√âRATEUR DE DISQUES DE FRACTIONS</span>
    <div style="width: 60px;"></div> 
</header>

<main>
  <!-- BARRE LAT√âRALE DE CONTR√îLES -->
  <section class="sidebar">
    
    <!-- Navigation des onglets -->
    <nav class="tabs-nav">
        <button class="tab-btn active" onclick="openTab('tab-bases')">üìê Bases</button>
        <button class="tab-btn" onclick="openTab('tab-recto')">üü¶ Recto</button>
        <button class="tab-btn" onclick="openTab('tab-verso')">üü® Verso</button>
        <button class="tab-btn" onclick="openTab('tab-calages')">‚öôÔ∏è Calages</button>
    </nav>

    <!-- Formulaire -->
    <form id="form" class="settings-container">
        
        <!-- ONGLET 1 : BASES -->
        <div id="tab-bases" class="tab-content active">
            <fieldset>
                <legend>Donn√©es & S√©quence</legend>
                <label>D√©nominateurs (s√©par√©s par virgules)</label>
                <input type="text" id="denoms" value="1,2,3,4,5,6,8,10">
                <div class="help-text">Le '1' g√©n√®re le disque entier.</div>

                <label>S√©quence d'impression</label>
                <select id="mode">
                  <option value="interleaved" selected>Recto / Verso Altern√©</option> 
                  <option value="recto_only">Recto Seul</option>
                  <option value="verso_only">Verso Seul</option>
                </select>
            </fieldset>

            <fieldset>
                <legend>Mise en page</legend>
                <div class="row">
                    <div>
                        <label>Cols</label>
                        <input type="number" id="N_cols" step="1" min="1" value="2">
                    </div>
                    <div>
                        <label>Lignes</label>
                        <input type="number" id="N_rows" step="1" min="1" value="2">
                    </div>
                </div>
                
                <label>√âcart minimum (mm)</label>
                <input type="number" id="discGap" step="0.1" value="5">
                <div class="help-text">Diam√®tre calcul√© automatiquement.</div>

                <label style="margin-top:12px;">Style des fonds</label>
                <select id="colorMode">
                    <option value="white" selected>Uniforme (Blanc - √âco)</option>
                    <option value="colored">Couleurs P√©dagogiques</option>
                </select>
            </fieldset>
            
            <fieldset>
                 <legend>Cadre Global</legend>
                 <label>√âpaisseur contour disque (mm)</label>
                 <input type="number" id="frameW" step="0.01" value="0.10">
            </fieldset>
        </div>

        <!-- ONGLET 2 : RECTO -->
        <div id="tab-recto" class="tab-content">
            <div class="notice notice-warn" id="modeNoticeRecto" style="display:none;"></div>
            <fieldset>
                <legend>Bande UNIT√â (d=1)</legend>
                <label>Contenu affich√©</label>
                <select id="unitModeRecto"> 
                    <option value="unit" selected>Texte "1 unit√©"</option> 
                    <option value="numeric_one">Chiffre "1"</option>
                    <option value="one-on-one">Fraction "1/1"</option>
                    <option value="percent">100 %</option>
                    <option value="minutes">60 min</option>
                    <option value="hours_unit">1 heure</option> 
                    <option value="degrees_unit">360 degr√©s</option> 
                    <option value="custom">Texte personnalis√©...</option>
                    <option value="empty">Vide</option>
                </select>
                <input type="text" id="customTextRecto" value="1 unit√©" placeholder="Votre texte..." style="margin-top: 5px; display: none;">
            </fieldset>

            <fieldset>
                <legend>Segments (d>1)</legend>
                <label>Contenu des parts</label>
                <select id="contentRecto">
                    <option value="numeric" selected>Fraction (1/d)</option>
                    <option value="numeric_unit">Fraction + unit√© (1/d u)</option>
                    <option value="decimal">D√©cimal (0,X)</option>
                    <option value="decimal_unit">D√©cimal + unit√© (0,X u)</option>
                    <option value="percentage">Pourcentage (X %)</option>
                    <option value="minutes">Temps (X min)</option>
                    <option value="hours_fractional">Temps (1/d h)</option>
                    <option value="degrees">Angle (X ¬∞)</option>
                    <option value="letters">En lettres</option>
                    <option value="empty">Vide</option>
                </select>
            </fieldset>

            <fieldset>
                <legend>Style & Traits (Recto)</legend>
                <div class="row">
                    <div>
                        <label>Taille texte (pt)</label>
                        <input type="number" id="labelPtRecto" step="1" value="10">
                    </div>
                    <div>
                        <label>Pos. Texte (%)</label>
                        <input type="number" id="textDistRatioRecto" step="1" value="50">
                    </div>
                </div>
                
                <label>Orientation du texte</label>
                <select id="textOrientationRecto">
                    <option value="aligned_rayon">Rayonnant (Vers l'ext√©rieur)</option>
                    <option value="aligned_rayon_inversed" selected>Rayonnant (Vers le centre)</option>
                    <option value="polygonal">Polygonal (Suivant la corde)</option>
                </select>

                <div class="row" style="margin-top:10px;">
                    <div>
                        <label>S√©parations</label>
                        <select id="innerBordersRecto">
                            <option value="visible" selected>Visibles</option>
                            <option value="hidden">Masqu√©es</option>
                        </select>
                    </div>
                    <div>
                        <label>√âpaisseur (mm)</label>
                        <input type="number" id="dotWRecto" step="0.01" value="0.10">
                    </div>
                </div>
                
                <label>Longueur tiret pointill√©s (mm)</label>
                <input type="number" id="dashRectoNum" value="3" min="0" step="0.5">
                <div class="help-text">Mettre 0 pour un trait plein.</div>
            </fieldset>
        </div>

        <!-- ONGLET 3 : VERSO -->
        <div id="tab-verso" class="tab-content">
            <div class="notice notice-warn" id="modeNoticeVerso" style="display:none;"></div>
            
            <fieldset>
                <legend>Bande UNIT√â (d=1)</legend>
                <label>Contenu affich√©</label>
                <select id="unitModeVersoD1">
                    <option value="same_as_recto" selected>Identique au Recto</option>
                    <option value="unit">Texte "1 unit√©"</option>
                    <option value="numeric_one">Chiffre "1"</option>
                    <option value="one-on-one">Fraction "1/1"</option>
                    <option value="percent">100 %</option>
                    <option value="minutes">60 min</option>
                    <option value="hours_unit">1 heure</option>
                    <option value="degrees_unit">360 degr√©s</option>
                    <option value="custom">Texte personnalis√©...</option>
                    <option value="empty">Vide</option>
                </select>
                <input type="text" id="customTextVersoD1" value="1 unit√© (Verso)" style="margin-top: 5px; display: none;">
            </fieldset>

            <fieldset>
                <legend>Segments (d>1)</legend>
                <label>Structure Verso</label>
                <select id="versoContentType">
                    <option value="unit_center" selected>Unit√© au centre (Non divis√©)</option>
                    <option value="segmented">Divis√© en parts (Comme le recto)</option>
                </select>

                <!-- Options dynamiques D>1 (Unit√© au centre) -->
                <div id="unitCenterVersoOptions">
                    <label>Contenu affich√©</label>
                    <select id="unitModeVersoDgt1">
                        <option value="unit" selected>Texte "1 unit√©"</option> 
                        <option value="numeric_one">Chiffre "1"</option>
                        <option value="one-on-one">Fraction "1/1"</option>
                        <option value="percent">100 %</option>
                        <option value="minutes">60 min</option>
                        <option value="hours_unit">1 heure</option>
                        <option value="degrees_unit">360 degr√©s</option>
                        <option value="custom">Texte personnalis√©...</option>
                        <option value="empty">Vide</option>
                    </select>
                    <input type="text" id="customTextVersoDgt1" value="1 unit√©" style="margin-top: 5px; display: none;">
                </div>

                <!-- Options dynamiques D>1 (Segment√©) -->
                <div id="segmentedVersoOptions" style="display: none;">
                    <label>Contenu des parts</label>
                    <select id="contentVerso">
                        <option value="numeric">Fraction (1/d)</option>
                        <option value="numeric_unit">Fraction + unit√© (1/d u)</option>
                        <option value="decimal">D√©cimal (0,X)</option>
                        <option value="decimal_unit">D√©cimal + unit√© (0,X u)</option>
                        <option value="percentage" selected>Pourcentage (X %)</option>
                        <option value="minutes">Temps (X min)</option>
                        <option value="hours_fractional">Temps (1/d h)</option>
                        <option value="degrees">Angle (X ¬∞)</option>
                        <option value="letters">En lettres</option>
                        <option value="empty">Vide</option>
                    </select>
                </div>
            </fieldset>

            <!-- Ce bloc sera masqu√© si "Unit√© au centre" est choisi -->
            <div id="versoStyleContainer">
                <fieldset>
                    <legend>Style & Traits (Verso)</legend>
                    <div class="row">
                        <div>
                            <label>Taille texte (pt)</label>
                            <input type="number" id="labelPtVerso" step="1" value="10">
                        </div>
                        <div>
                            <label>Pos. Texte (%)</label>
                            <input type="number" id="textDistRatioVerso" step="1" value="50">
                        </div>
                    </div>
                    
                    <label>Orientation du texte</label>
                    <select id="textOrientationVerso">
                        <option value="aligned_rayon">Rayonnant (Vers l'ext√©rieur)</option>
                        <option value="aligned_rayon_inversed" selected>Rayonnant (Vers le centre)</option>
                        <option value="polygonal">Polygonal (Suivant la corde)</option>
                    </select>

                    <div class="row" style="margin-top:10px;">
                        <div>
                            <label>S√©parations</label>
                            <select id="innerBordersVerso">
                                <option value="visible" selected>Visibles</option>
                                <option value="hidden">Masqu√©es</option>
                            </select>
                        </div>
                        <div>
                            <label>√âpaisseur (mm)</label>
                            <input type="number" id="dotWVerso" step="0.01" value="0.10">
                        </div>
                    </div>

                    <label>Longueur tiret pointill√©s (mm)</label>
                    <input type="number" id="dashVersoNum" value="3" min="0" step="0.5">
                    <div class="help-text">Mettre 0 pour un trait plein.</div>
                </fieldset>
            </div>
        </div>

        <!-- ONGLET 4 : CALAGES -->
        <div id="tab-calages" class="tab-content">
            <fieldset>
                <legend>Ajustements Imprimante (mm)</legend>
                <div class="help-text" style="margin-bottom: 10px;">Utilisez ces valeurs pour aligner parfaitement le recto et le verso si votre imprimante d√©cale le papier.</div>
                
                <div class="row">
                  <div>
                    <label>D√©calage X RECTO</label>
                    <input type="number" id="rectoOffX" step="0.1" value="0">
                  </div>
                  <div>
                    <label>D√©calage Y RECTO</label>
                    <input type="number" id="rectoOffY" step="0.1" value="0">
                  </div>
                </div>
                <div class="row">
                  <div>
                    <label>D√©calage X VERSO</label>
                    <input type="number" id="offX" step="0.1" value="0">
                  </div>
                  <div>
                    <label>D√©calage Y VERSO</label>
                    <input type="number" id="offY" step="0.1" value="0">
                  </div>
                </div>
            </fieldset>
        </div>

    </form>
    
    <!-- Bouton Action -->
    <div class="action-bar">
        <button type="button" id="print" class="btn-primary">
            üñ®Ô∏è Imprimer / PDF
        </button>
    </div>
  </section>

  <!-- APER√áU -->
  <section class="preview-area" id="preview">
      <div class="preview-controls no-print" id="previewControls">
          <div class="preview-toolbar">
              <span class="preview-toolbar-title">Aper√ßu</span>
              <div class="segmented" role="group" aria-label="Filtre d'aper√ßu">
                  <button type="button" class="seg-btn active" data-filter="all">Tout</button>
                  <button type="button" class="seg-btn" data-filter="recto">Recto</button>
                  <button type="button" class="seg-btn" data-filter="verso">Verso</button>
              </div>
              <span class="preview-warning" id="previewWarning" aria-live="polite"></span>
          </div>
          <div class="preview-summary" id="printSummary"></div>
      </div>
      <div id="pagesContainer"></div>
  </section>
</main>

<script>
// --- GESTION DES ONGLETS (UI) ---
function openTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    const btns = document.querySelectorAll('.tab-btn');
    btns.forEach(btn => {
        if(btn.getAttribute('onclick').includes(tabId)) {
            btn.classList.add('active');
        }
    });
}



// --- APER√áU : filtre manuel + infos (ergonomie uniquement) ---
let previewFilter = 'all'; // 'all' | 'recto' | 'verso'
let _restoreFilterAfterPrint = null;

function getModeValue(){
    const m = document.getElementById('mode');
    return m ? m.value : 'interleaved';
}

function setPreviewFilter(filter, opts={}){
    previewFilter = (filter === 'recto' || filter === 'verso') ? filter : 'all';

    // Boutons UI
    const btns = document.querySelectorAll('.seg-btn');
    btns.forEach(b => {
        const f = b.getAttribute('data-filter');
        b.classList.toggle('active', f === previewFilter);
    });

    applyPreviewFilter();
    updatePreviewWarning();
}

function applyPreviewFilter(){
    const pages = document.querySelectorAll('#pagesContainer .page');
    pages.forEach(p => {
        const side = p.dataset.side || 'recto';
        const show = (previewFilter === 'all') || (side === previewFilter);
        p.style.display = show ? '' : 'none';
    });
}

function updatePreviewWarning(){
    const el = document.getElementById('previewWarning');
    if(!el) return;

    const mode = getModeValue();
    let msg = '';

    if (previewFilter === 'recto' && mode === 'verso_only') {
        msg = "‚ö†Ô∏è S√©quence = ‚ÄòVerso seul‚Äô : aucun recto n‚Äôest g√©n√©r√©.";
    }
    if (previewFilter === 'verso' && mode === 'recto_only') {
        msg = "‚ö†Ô∏è S√©quence = ‚ÄòRecto seul‚Äô : aucun verso n‚Äôest g√©n√©r√©.";
    }

    el.textContent = msg;
}

function updateModeNotices(){
    const mode = getModeValue();
    const nRecto = document.getElementById('modeNoticeRecto');
    const nVerso = document.getElementById('modeNoticeVerso');

    if(nRecto){
        if(mode === 'verso_only'){
            nRecto.style.display = 'block';
            nRecto.textContent = "‚ö†Ô∏è Info : la s√©quence d‚Äôimpression est r√©gl√©e sur ‚ÄòVerso seul‚Äô. Les pages recto ne seront pas g√©n√©r√©es dans l‚Äôaper√ßu ni √† l‚Äôimpression.";
        } else {
            nRecto.style.display = 'none';
            nRecto.textContent = '';
        }
    }

    if(nVerso){
        if(mode === 'recto_only'){
            nVerso.style.display = 'block';
            nVerso.textContent = "‚ö†Ô∏è Info : la s√©quence d‚Äôimpression est r√©gl√©e sur ‚ÄòRecto seul‚Äô. Les pages verso ne seront pas g√©n√©r√©es dans l‚Äôaper√ßu ni √† l‚Äôimpression.";
        } else {
            nVerso.style.display = 'none';
            nVerso.textContent = '';
        }
    }
}

function updatePrintSummary(actualDenoms){
    const el = document.getElementById('printSummary');
    if(!el) return;

    const mode = getModeValue();
    const modeLabel = (mode === 'interleaved') ? 'Recto / Verso altern√©'
                    : (mode === 'recto_only') ? 'Recto seul'
                    : 'Verso seul';

    const denomsText = (actualDenoms && actualDenoms.length) ? actualDenoms.join(', ') : '‚Äî';

    const cols = Number(document.getElementById('N_cols')?.value || 0);
    const rows = Number(document.getElementById('N_rows')?.value || 0);
    const gap  = Number(document.getElementById('discGap')?.value || 0);

    const rectoPages = (mode === 'verso_only') ? 0 : (actualDenoms?.length || 0);
    const versoPages = (mode === 'recto_only') ? 0 : (actualDenoms?.length || 0);
    const totalPages = (mode === 'interleaved') ? (rectoPages + versoPages) : Math.max(rectoPages, versoPages);

    el.innerHTML = `
      <div><span class="muted">Mode :</span> ${modeLabel}</div>
      <div><span class="muted">D√©nominateurs :</span> ${denomsText}</div>
      <div><span class="muted">Grille :</span> ${cols} √ó ${rows} ‚Äî <span class="muted">√âcart :</span> ${isFinite(gap) ? gap : '‚Äî'} mm</div>
      <div><span class="muted">Pages :</span> ${totalPages} (recto ${rectoPages} / verso ${versoPages})</div>
    `;
}

function initPreviewControls(){
    const btns = document.querySelectorAll('.seg-btn');
    btns.forEach(b => {
        b.addEventListener('click', () => {
            const f = b.getAttribute('data-filter') || 'all';
            setPreviewFilter(f, {fromUser:true});
        });
    });
    setPreviewFilter('all');
}

function safePrint(){
    // Important : le filtre d'aper√ßu ne doit pas impacter l'impression
    _restoreFilterAfterPrint = previewFilter;
    setPreviewFilter('all', {fromUser:false});

    // Lance l'impression
    window.print();

    // Fallback : certains navigateurs ne d√©clenchent pas afterprint
    setTimeout(() => {
        if(_restoreFilterAfterPrint){
            setPreviewFilter(_restoreFilterAfterPrint, {fromUser:false});
            _restoreFilterAfterPrint = null;
        }
    }, 500);
}

window.addEventListener('afterprint', () => {
    if(_restoreFilterAfterPrint){
        setPreviewFilter(_restoreFilterAfterPrint, {fromUser:false});
        _restoreFilterAfterPrint = null;
    }
});


// --- MOTEUR DE G√âN√âRATION (Code Original) ---

// Modification: 'const' -> 'var' pour √©viter l'erreur "Identifier has already been declared"
var W = 297; // mm (A4 paysage)
var H = 210; // mm
function mm(v){ return v + "mm"; }
var RADIAN = Math.PI / 180;
var FRAC_ONE_ON_ONE = 'FRAC_ONE_ON_ONE_MARKER'; 

var HARDCODED_FRAC = {
    NUM_PADDING_RATIO: 12.7, 
    DENOM_PADDING_RATIO: -3.2,
    BAR_RATIO: 70, 
    BAR_W_MM: 0.15,
};

var denomToLetters = {
    1: "Une unit√©", 2: "un demi", 3: "un tiers", 4: "un quart", 5: "un cinqui√®me",
    6: "un sixi√®me", 7: "un septi√®me", 8: "un huiti√®me", 9: "un neuvi√®me", 
    10: "un dixi√®me", 11: "un onzi√®me", 12: "un douzi√®me", 
};

var denomColors = {
    1: '#fff', 2: '#ffb3b3', 3: '#6699ff', 4: '#b3ffc6', 5: '#ff9966', 
    6: '#e0b3ff', 7: '#99ccff', 8: '#ccff99', 9: '#ffccff', 10: '#ffffb3', 
    11: '#cc99ff', 12: '#99ffff',
};

function getUnitSymbolFromContentMode(contentMode) {
    if (contentMode === 'numeric_unit' || contentMode === 'decimal_unit') return 'u';
    if (contentMode === 'hours_fractional') return 'h'; 
    return ''; 
}

function getUnitText(unitMode, customText, rectoUnitMode, rectoCustomText) {
    let finalMode = unitMode;
    let finalCustomText = customText;
    
    if (unitMode === 'same_as_recto') {
        finalMode = rectoUnitMode;
        finalCustomText = rectoCustomText;
    }
    
    if (finalMode === 'numeric_one') return '1';
    if (finalMode === 'unit') return '1 unit√©'; 
    if (finalMode === 'one-on-one') return FRAC_ONE_ON_ONE; 
    if (finalMode === 'percent') return '100 %';
    if (finalMode === 'minutes') return '60 min';
    if (finalMode === 'hours_unit') return '1 heure'; 
    if (finalMode === 'degrees_unit') return '360 ¬∞';
    if (finalMode === 'empty') return ''; 
    return finalCustomText;
}

function fracSVG(x, y, d, sizePt, contentMode){
    const g = document.createElementNS("http://www.w3.org/2000/svg","g");
    const sizePx = sizePt * 96/72;
    const numPadding = sizePx * (HARDCODED_FRAC.NUM_PADDING_RATIO / 100); 
    const denomPadding = sizePx * (HARDCODED_FRAC.DENOM_PADDING_RATIO / 100); 
    const halfBar = sizePx * (HARDCODED_FRAC.BAR_RATIO) / 200;
    
    const n = document.createElementNS("http://www.w3.org/2000/svg","text");
    n.setAttribute("x", x); n.setAttribute("y", y - numPadding); 
    n.setAttribute("font-size", sizePt+"pt");
    n.setAttribute("text-anchor","middle");
    n.setAttribute("dominant-baseline","baseline");
    n.textContent = "1";

    const dd = document.createElementNS("http://www.w3.org/2000/svg","text");
    dd.setAttribute("x", x); dd.setAttribute("y", y + denomPadding); 
    dd.setAttribute("font-size", sizePt+"pt");
    dd.setAttribute("text-anchor","middle");
    dd.setAttribute("dominant-baseline","hanging");
    dd.textContent = (d === 1 && contentMode === FRAC_ONE_ON_ONE) ? "1" : String(d);

    const line = document.createElementNS("http://www.w3.org/2000/svg","line");
    line.setAttribute("x1", x - halfBar); line.setAttribute("x2", x + halfBar);
    line.setAttribute("y1", y); line.setAttribute("y2", y);
    line.setAttribute("stroke","black");
    line.setAttribute("stroke-width", mm(HARDCODED_FRAC.BAR_W_MM)); 

    g.appendChild(n); g.appendChild(dd); g.appendChild(line);

    const isNumericUnit = contentMode === 'numeric_unit';
    const isHoursFractional = contentMode === 'hours_fractional';

    if(isHoursFractional || isNumericUnit){
        const unitText = document.createElementNS("http://www.w3.org/2000/svg","text");
        const unitSuffix = isHoursFractional ? 'h' : getUnitSymbolFromContentMode(contentMode); 
        const startX = x + sizePx * 0.45; 
        
        unitText.setAttribute("x", startX); unitText.setAttribute("y", y); 
        unitText.setAttribute("font-size", sizePt+"pt");
        unitText.setAttribute("text-anchor","start"); 
        unitText.setAttribute("dominant-baseline","middle"); 
        unitText.textContent = unitSuffix;
        g.appendChild(unitText);
    }
    return g;
}

function textContent(d, textMode){
    const val = 1 / d;
    const unitSymbol = getUnitSymbolFromContentMode(textMode);
    const decimalFormatter = new Intl.NumberFormat('fr-FR', { 
        minimumFractionDigits: 1, maximumFractionDigits: 3 
    });

    if (textMode === 'percentage') {
        let valStr = Number((val * 100).toFixed(2));
        return `${valStr.toString().replace('.', ',')}%`; 
    } else if (textMode === 'minutes') {
        const minVal = val * 60;
        if (Number.isInteger(minVal)) { return `${minVal}min`; } 
        else { return `${minVal.toFixed(1).replace('.', ',')}min`; } 
    } else if (textMode === 'degrees') {
        const valDeg = 360 / d;
        let degText;
        if (Number.isInteger(valDeg)) { degText = valDeg.toString(); } 
        else { degText = decimalFormatter.format(valDeg).replace(/(\.0+)?$/, ''); }
        return `${degText}¬∞`; 
    } else if (textMode === 'letters') {
        return denomToLetters[d] || ("1/"+d);
    } else if (textMode === 'decimal' || textMode === 'decimal_unit') { 
        let partText = decimalFormatter.format(val).replace(/(\.0+)?$/, '');
        if (textMode === 'decimal_unit' && unitSymbol !== '') { 
            return `${partText}${unitSymbol}`; 
        }
        return partText;
    }
    return ''; 
}

function textInSector(cx, cy, r, d, k, styles, contentMode, textDistRatio){
  const g = document.createElementNS("http://www.w3.org/2000/svg","g");
  if (contentMode === "empty") return g; 
  
  const { labelPt, textOrientation } = styles; 
  const sectorAngle = 360 / d;
  const dist = r * (textDistRatio / 100); 
  let x, y, rotation;
  const bisectriceAngle = (k * sectorAngle + sectorAngle / 2) - 90; 

  if (textOrientation === 'polygonal') {
      const A_start = (k * sectorAngle - 90); 
      const A_end = ((k + 1) * sectorAngle - 90);
      const x1 = cx + dist * Math.cos(A_start * RADIAN);
      const y1 = cy + dist * Math.sin(A_start * RADIAN);
      const x2 = cx + dist * Math.cos(A_end * RADIAN);
      const y2 = cy + dist * Math.sin(A_end * RADIAN);
      x = (x1 + x2) / 2;
      y = (y1 + y2) / 2;
      rotation = bisectriceAngle + 90; 
  } else {
      x = cx + dist * Math.cos(bisectriceAngle * RADIAN);
      y = cy + dist * Math.sin(bisectriceAngle * RADIAN);

      const isFractionalOrHours = (contentMode === "numeric" || contentMode === "numeric_unit" || contentMode === "hours_fractional" || contentMode === FRAC_ONE_ON_ONE);
      
      let baseAngleForAlignment; 
      if (isFractionalOrHours) {
          baseAngleForAlignment = (textOrientation === 'aligned_rayon') ? 90 : 270;
      } else {
          baseAngleForAlignment = (textOrientation === 'aligned_rayon') ? 0 : 180;
      }
      
      let normalizedBisectrice = (bisectriceAngle + 90 + 360) % 360; 
      const isLowerHalf = normalizedBisectrice > 90 && normalizedBisectrice < 270;

      if (isLowerHalf) {
          if (isFractionalOrHours) {
              baseAngleForAlignment = (baseAngleForAlignment === 90) ? 270 : 90;
          } else {
              baseAngleForAlignment = (baseAngleForAlignment === 0) ? 180 : 0;
          }
      }
      
      rotation = bisectriceAngle + baseAngleForAlignment;

      if (isLowerHalf) {
          rotation += 180;
      }
  }
  
  const rotationTransform = `rotate(${rotation}, ${x}, ${y})`;
  const useFractionalRendering = (contentMode === "numeric" || contentMode === "numeric_unit" || contentMode === "hours_fractional" || contentMode === FRAC_ONE_ON_ONE);

  if (useFractionalRendering) {
    const fractionGroup = fracSVG(x, y, d, labelPt, contentMode); 
    fractionGroup.setAttribute("transform", rotationTransform);
    g.appendChild(fractionGroup);
  } else { 
    const t = document.createElementNS("http://www.w3.org/2000/svg","text");
    t.setAttribute("x", x); t.setAttribute("y", y); 
    t.setAttribute("font-size", labelPt+"pt");
    t.setAttribute("text-anchor","middle");
    t.setAttribute("dominant-baseline","middle");
    t.setAttribute("transform", rotationTransform);
    t.textContent = textContent(d, contentMode);
    g.appendChild(t);
  }
  return g;
}

function discSVG(r, cx, cy, d, contentMode, commonStyles, currentStyles, rectoUnitInfo, versoUnitInfo, isVerso) {
  const g = document.createElementNS("http://www.w3.org/2000/svg","g");
  const { frameW, colorMode } = commonStyles;
  const { labelPt, textDistRatio, innerBorders, dashStyle, dotW, versoStructureDgt1 } = currentStyles;
  
  const fillColor = (colorMode === 'colored' && denomColors[d]) ? denomColors[d] : 'white';
  const dash = dashStyle.trim() === '0' || dashStyle.trim() === '' ? '0' : dashStyle;
  
  const circle = document.createElementNS("http://www.w3.org/2000/svg","circle");
  circle.setAttribute("cx", cx); circle.setAttribute("cy", cy); circle.setAttribute("r", r);
  circle.setAttribute("fill", fillColor); 
  circle.setAttribute("stroke","black");
  circle.setAttribute("stroke-width", mm(frameW));
  g.appendChild(circle);

  const isD1 = d === 1;
  const renderAsUnitMode = isD1 || (isVerso && versoStructureDgt1 === 'unit_center');

  if (renderAsUnitMode) { 
    let unitMode, customText;
    if (isD1) {
        unitMode = isVerso ? versoUnitInfo.unitModeD1 : rectoUnitInfo.unitMode;
        customText = isVerso ? versoUnitInfo.customTextD1 : rectoUnitInfo.customText;
    } else {
        unitMode = versoUnitInfo.unitModeDgt1;
        customText = versoUnitInfo.customTextDgt1;
    }

    const unitText = getUnitText(unitMode, customText, rectoUnitInfo.unitMode, rectoUnitInfo.customText);
        
    if (unitText) {
        if (unitText === FRAC_ONE_ON_ONE) {
             const fracGroup = fracSVG(cx, cy, 1, currentStyles.labelPt * 1.5, FRAC_ONE_ON_ONE);
             g.appendChild(fracGroup);
        } else {
             const t = document.createElementNS("http://www.w3.org/2000/svg","text");
             t.setAttribute("x", cx); t.setAttribute("y", cy);
             t.setAttribute("text-anchor","middle"); t.setAttribute("dominant-baseline","middle");
             t.setAttribute("font-size", currentStyles.labelPt * 1.5 +"pt");
             t.textContent = unitText;
             g.appendChild(t);
        }
    }

  } else {
    if (innerBorders === 'visible') {
        for (let k = 0; k < d; k++) {
          const angle = k * (360 / d) - 90; 
          const x2 = cx + r * Math.cos(angle * RADIAN);
          const y2 = cy + r * Math.sin(angle * RADIAN);

          const line = document.createElementNS("http://www.w3.org/2000/svg","line");
          line.setAttribute("x1", cx); line.setAttribute("y1", cy);
          line.setAttribute("x2", x2); line.setAttribute("y2", y2);
          line.setAttribute("stroke","black");
          line.setAttribute("stroke-width", mm(dotW));
          line.setAttribute("stroke-dasharray", dash);
          g.appendChild(line);
        }
    }
    if (contentMode !== 'empty') {
      for (let k = 0; k < d; k++) {
        g.appendChild(textInSector(cx, cy, r, d, k, currentStyles, contentMode, textDistRatio));
      }
    }
  }
  return g;
}

function drawPage(discs, options, isVersoPage){
  const page = document.createElement("div");
  page.className = "page";
  page.style.width = mm(W);
  page.style.height = mm(H);

  const { N_cols, N_rows, discGap, rectoOffX, rectoOffY, versoOff, commonStyles, rectoStyles, versoStyles, rectoUnitInfo, versoUnitInfo } = options;
  const totalSlots = N_cols * N_rows;
  
  if (totalSlots === 0 || discs.length === 0) return page;
  
  const maxDiscDiameterW = (W - (N_cols + 1) * discGap) / N_cols;
  const maxDiscDiameterH = (H - (N_rows + 1) * discGap) / N_rows;
  const discDiameter = Math.min(maxDiscDiameterW, maxDiscDiameterH);

  if (discDiameter < 10) {
     page.innerHTML = `<div style="text-align:center; padding-top: 10mm; font-size: 14pt; color: #888;">Les disques sont trop petits. R√©duisez les colonnes/lignes.</div>`;
     return page;
  }
  
  const radius = discDiameter / 2;
  const unitSize = discDiameter + discGap;
  const totalUsedW = N_cols * unitSize + discGap;
  const totalUsedH = N_rows * unitSize + discGap;
  
  let startX = (W - totalUsedW) / 2;
  let startY = (H - totalUsedH) / 2;
  
  const currentOffset = isVersoPage ? versoOff : {x: rectoOffX, y: rectoOffY};
  startX += currentOffset.x;
  startY += currentOffset.y;

  const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
  svg.setAttribute("xmlns","http://www.w3.org/2000/svg");
  svg.setAttribute("width", mm(W)); svg.setAttribute("height", mm(H));
  svg.setAttribute("viewBox", `0 0 ${W} ${H}`);
  
  const currentStyles = isVersoPage ? versoStyles : rectoStyles;

  discs.forEach((disc, index) => {
    const i = index % N_cols;
    const j = Math.floor(index / N_cols);
    const cx = startX + i * unitSize + radius + discGap;
    const cy = startY + j * unitSize + radius + discGap;
    
    const discEl = discSVG(
      radius, cx, cy, disc.denom, disc.contentMode, commonStyles, currentStyles, rectoUnitInfo, versoUnitInfo, isVersoPage
    );
    svg.appendChild(discEl);
  });
  
  page.appendChild(svg);
  return page;
}

function parseDenoms(s){ return s.split(",").map(v=>parseInt(v.trim(),10)).filter(v=>!isNaN(v) && v > 0); }

function generate(){
  const form = document.getElementById('form');

  const N_cols = parseInt(form.N_cols.value);
  const N_rows = parseInt(form.N_rows.value);
  const discGap = parseFloat(form.discGap.value);
  const rectoOffX = parseFloat(form.rectoOffX.value)||0;
  const rectoOffY = parseFloat(form.rectoOffY.value)||0;
  const offX = parseFloat(form.offX.value)||0;
  const offY = parseFloat(form.offY.value)||0;
  const denoms = parseDenoms(form.denoms.value);
  const mode = form.mode.value; 

  const commonStyles = {
    frameW: parseFloat(form.frameW.value),
    colorMode: form.colorMode.value, 
  };
  const versoOff = {x: offX, y: offY};

  // Traitement des pointill√©s num√©riques
  var dashRNum = parseFloat(form.dashRectoNum.value);
  var dashRStr = (isNaN(dashRNum) || dashRNum <= 0) ? "0" : `${dashRNum},${dashRNum}`;

  const rectoStyles = {
      labelPt: parseFloat(form.labelPtRecto.value),
      textDistRatio: parseFloat(form.textDistRatioRecto.value),
      innerBorders: form.innerBordersRecto.value,
      dashStyle: dashRStr, // Nouveau format
      dotW: parseFloat(form.dotWRecto.value),
      textOrientation: form.textOrientationRecto.value,
  };
  const contentRecto = form.contentRecto.value; 
  const rectoUnitInfo = {
      unitMode: form.unitModeRecto.value,
      customText: form.customTextRecto.value || '1 unit√©',
  };

  // Traitement des pointill√©s verso
  var dashVNum = parseFloat(form.dashVersoNum.value);
  var dashVStr = (isNaN(dashVNum) || dashVNum <= 0) ? "0" : `${dashVNum},${dashVNum}`;

  const versoStyles = {
      labelPt: parseFloat(form.labelPtVerso.value),
      textDistRatio: parseFloat(form.textDistRatioVerso.value),
      innerBorders: form.innerBordersVerso.value,
      dashStyle: dashVStr, // Nouveau format
      dotW: parseFloat(form.dotWVerso.value),
      textOrientation: form.textOrientationVerso.value,
      versoStructureDgt1: form.versoContentType.value,
  };
  const contentVerso = form.contentVerso.value; 
  
  const versoUnitInfo = {
      unitModeD1: form.unitModeVersoD1.value,
      customTextD1: form.customTextVersoD1.value || '1 unit√© (Verso D=1)',
      unitModeDgt1: form.unitModeVersoDgt1.value, 
      customTextDgt1: form.customTextVersoDgt1.value || '1 unit√© (Verso D>1)',
  };
  
  const pagesContainer = document.getElementById("pagesContainer");
  if (!pagesContainer) return;
  pagesContainer.innerHTML = "";
  const push = (el)=>pagesContainer.appendChild(el);
  
  const totalDiscsPerPage = N_cols * N_rows;
  if (totalDiscsPerPage === 0 || isNaN(N_cols) || isNaN(N_rows)) return;
  
  const baseOptions = { N_cols, N_rows, discGap, rectoOffX, rectoOffY, versoOff, commonStyles, rectoStyles, versoStyles, rectoUnitInfo, versoUnitInfo };

  let actualDenoms = [...new Set(denoms)].sort((a,b) => a - b);
  
  const generatePage = (denom, contentMode, isVersoPage) => {
    const discs = Array(totalDiscsPerPage).fill(null).map(() => ({
        denom: denom, 
        contentMode: contentMode, 
    }));
    const pageEl = drawPage(discs, baseOptions, isVersoPage);
    pageEl.dataset.side = isVersoPage ? 'verso' : 'recto';
    return pageEl;
  };
  
  for(const d of actualDenoms){
      let rectoMode, versoMode;
      if (d === 1) {
          rectoMode = `unit_${rectoUnitInfo.unitMode}`; 
          versoMode = `unit_${versoUnitInfo.unitModeD1}`; 
      } else { 
          rectoMode = contentRecto;
          if (versoStyles.versoStructureDgt1 === 'unit_center') {
            versoMode = `unit_${versoUnitInfo.unitModeDgt1}`;
          } else { 
            versoMode = contentVerso;
          }
      }

      if (mode === "recto_only") {
          push(generatePage(d, rectoMode, false));
      } else if (mode === "verso_only") {
          push(generatePage(d, versoMode, true));
      } else if (mode === "interleaved") { 
          push(generatePage(d, rectoMode, false)); 
          push(generatePage(d, versoMode, true)); 
      }
  }

  // Ergonomie : filtre d'aper√ßu + r√©sum√© + notices
  updateModeNotices();
  updatePrintSummary(actualDenoms);
  applyPreviewFilter();
  updatePreviewWarning();
}

document.getElementById("print").addEventListener("click", ()=>{ safePrint(); });

function updateUI() {
    const form = document.getElementById('form');
    
    // Champs Recto
    form.customTextRecto.style.display = form.unitModeRecto.value === 'custom' ? 'block' : 'none';
    
    // Champs Verso D=1
    form.customTextVersoD1.style.display = form.unitModeVersoD1.value === 'custom' ? 'block' : 'none';
    
    // Champs Verso D>1
    const versoContentType = form.versoContentType.value;
    const segmentedVersoOptions = document.getElementById('segmentedVersoOptions');
    const unitCenterVersoOptions = document.getElementById('unitCenterVersoOptions');
    const customTextVersoDgt1_input = document.getElementById('customTextVersoDgt1');

    segmentedVersoOptions.style.display = versoContentType === 'segmented' ? 'block' : 'none';
    unitCenterVersoOptions.style.display = versoContentType === 'unit_center' ? 'block' : 'none';
    
    customTextVersoDgt1_input.style.display = (form.unitModeVersoDgt1.value === 'custom' && versoContentType === 'unit_center') ? 'block' : 'none';
        
    // Masquer le style des traits Verso si "Unit√© au centre" car pas de traits
    const versoStyleContainer = document.getElementById('versoStyleContainer');
    if (versoContentType === 'unit_center') {
        versoStyleContainer.style.display = 'none';
    } else {
        versoStyleContainer.style.display = 'block';
    }
        
    generate();
}

document.getElementById('form').addEventListener('change', updateUI);
document.getElementById('form').addEventListener('input', (e) => {
    const targetId = e.target.id;
    // Liste mise √† jour avec les nouveaux IDs (dashNum au lieu de Style)
    if (['N_cols', 'N_rows', 'discGap', 'denoms', 'customTextRecto', 'customTextVersoD1', 'customTextVersoDgt1', 'rectoOffX', 'rectoOffY', 'offX', 'offY', 'labelPtRecto', 'labelPtVerso', 'textDistRatioRecto', 'textDistRatioVerso', 'dotWRecto', 'dotWVerso', 'frameW', 'dashRectoNum', 'dashVersoNum'].includes(targetId)) {
        generate();
    }
});

window.addEventListener("load", () => { initPreviewControls(); updateUI(); });
</script>
</body>
</html>
