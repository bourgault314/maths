<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<title>Générateur PRO — Disques de Fractions</title>
<style>
  :root { --page-w: 297mm; --page-h: 210mm; }
  *{ box-sizing:border-box; }
  body{ font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:0; }
  
  /* EN-TÊTE ET NOM FINAL */
  header{ 
      padding:10px 14px; 
      background:#111; 
      color:#fff; 
      font-size:14px; 
      display: flex;
      justify-content: space-between; 
      align-items: center;
      flex-shrink: 0; 
  }
  header #return-link {
      color: #ccc;
      text-decoration: none;
      font-weight: 500;
      margin-right: auto; 
  }
  header #return-link:hover {
      color: #fff;
      text-decoration: underline;
  }
  header span {
      flex-grow: 1;
      text-align: center;
      white-space: nowrap; 
  }
  header div {
      width: auto; /* Permet au bloc vide de prendre sa place pour centrer le span */
      margin-left: auto; 
  }
  
  /* Correction du bug de défilement (hauteur main ajustée) */
  main{ 
      display:grid; 
      grid-template-columns: 360px 1fr; 
      gap:14px; 
      padding:14px; 
      height: calc(100vh - 46px); /* 46px = hauteur de l'entête */
  }
  
  /* STYLE DES CONTRÔLES (Fixe la hauteur totale) */
  .controls { 
      height: 100%; 
      display: flex; 
      flex-direction: column; 
  }
  /* Correction de l'overflow pour le menu principal */
  #settings-scroll-area {
      flex-grow: 1; 
      overflow-y: auto; 
      padding-right: 8px; 
      padding-top: 10px; 
      -webkit-overflow-scrolling: touch; 
  }
  
  fieldset{ border:1px solid #ddd; border-radius:8px; margin:0 0 10px 0; }
  legend{ padding:0 6px; font-weight:600; }
  
  /* ALIGNEMENT (Taille restaurée à 13px) */
  label{ 
      display:block; 
      font-size:13px; 
      margin: 0; 
      padding-top: 8px; 
      padding-bottom: 2px; 
      line-height: 1.2; 
  }

  /* Pour les éléments qui sont côte à côte */
  .row{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }
  .row > div {
      display: flex;
      flex-direction: column; 
  }
  
  input, select{ width:100%; padding:8px; font-size:14px; }

  .actions{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
  button{ padding:9px 10px; font-weight:600; font-size:14px; cursor:pointer; }
  
  /* FIX UI: La zone d'aperçu prend la hauteur totale (alignée sur les contrôles) */
  .preview{ 
    background:#f6f7f9; 
    border:1px solid #e2e3e6; 
    border-radius:8px; 
    padding:4px; 
    overflow:auto; 
    height: 100%; 
  }
  
  /* FIX CLÉ: Nouvelle mise en page des pages A4 (alignement top-left pour l'aperçu) */
  .page{ 
    width: var(--page-w); 
    height: var(--page-h); 
    background:white; 
    /* Espace minimal entre les pages */
    margin: 0 0 1mm 0; 
    position: relative; 
    border: 1px dashed #cfd6e3; 
    
    /* Zoom pour visualiser la page A4 entière */
    transform: scale(0.85); 
    transform-origin: top left;
  }
  /* Style spécifique aux disques */
  .disc-container {
    display: inline-block;
    vertical-align: top;
    position: relative;
  }
  
  @media print{
    header, .controls { display:none !important; }
    main{ display:block; padding:0; height:auto; } 
    .preview{ border:none; padding:0; height:auto; }
    /* Annulation du zoom et de la marge pour l'impression 1:1 */
    .page{ break-after: page; page-break-after: always; border:none; margin:0; transform: none; }
    @page { size: A4 landscape; margin: 0; }
  }
</style>
</head>
<body>
<header>
    <a href="#" id="return-link">← Retour aux Outils</a>
    <span>GÉNÉRATEUR PRO — DISQUES DE FRACTIONS | Imprimer en Recto-Verso bord long</span>
    <div></div>
</header>
<main>
  <section class="controls">
    <form id="form">
    
      <fieldset id="actions-fieldset">
        <legend>Actions</legend>
        <div class="actions">
          <button type="button" id="print">Imprimer / Export PDF</button>
        </div>
      </fieldset>

      <div id="settings-scroll-area">
          
          <fieldset>
            <legend>Style/Dimensions Communs</legend>
            <div class="row">
              <div>
                <label>Disques par ligne</label>
                <input type="number" id="N_cols" step="1" min="1" value="2"> </div>
              <div>
                <label>Disques par colonne</label>
                <input type="number" id="N_rows" step="1" min="1" value="2"> </div>
            </div>
            <div class="row">
                <div>
                    <label>Épaisseur contour (mm)</label>
                    <input type="number" id="frameW" step="0.01" value="0.10">
                </div>
                <div>
                    <label>Style des fonds</label>
                    <select id="colorMode">
                        <option value="white" selected>Uniforme (Blanc)</option>
                        <option value="colored">Couleurs Pédagogiques</option>
                    </select>
                </div>
            </div>
            <div>
              <label>Écart minimum entre les disques (mm)</label>
              <input type="number" id="discGap" step="0.1" value="5">
              <p style="font-size: 11px; margin: 5px 0 0;">(Le diamètre est calculé automatiquement)</p>
            </div>
          </fieldset>

          <fieldset>
            <legend>Décalages / Alignement (mm)</legend>
            <div class="row">
              <div>
                <label>Décalage horizontal RECTO</label>
                <input type="number" id="rectoOffX" step="0.1" value="0">
              </div>
              <div>
                <label>Décalage vertical RECTO</label>
                <input type="number" id="rectoOffY" step="0.1" value="0">
              </div>
            </div>
            <div class="row">
              <div>
                <label>Décalage horizontal VERSO</label>
                <input type="number" id="offX" step="0.1" value="0">
              </div>
              <div>
                <label>Décalage vertical VERSO</label>
                <input type="number" id="offY" step="0.1" value="0">
              </div>
            </div>
          </fieldset>
    
          <fieldset>
            <legend>Dénominateurs</legend>
            <label>Dénominateurs (Inclure '1' pour générer la page unité)</label>
            <input type="text" id="denoms" value="1,2,3,4,5,6,8,10">
          </fieldset>
          
          <fieldset>
            <legend>Style RECTO (Segments & Unité)</legend>
            
            <div class="row">
              <div>
                <label>Taille de l'écriture (pt)</label>
                <input type="number" id="labelPtRecto" step="1" value="10">
              </div>
              <div>
                <label>Distance texte/centre (%)</label>
                <input type="number" id="textDistRatioRecto" step="1" value="60">
              </div>
            </div>
            
            <div class="row">
                <div>
                    <label>Lignes de séparation</label>
                    <select id="innerBordersRecto">
                        <option value="visible" selected>Visibles</option>
                        <option value="hidden">Masquées (disques vierges)</option>
                    </select>
                </div>
                <div>
                    <label>Style des divisions</label>
                    <select id="dashStyleRecto">
                        <option value="3,3" selected>Pointillés</option>
                        <option value="0">Traits pleins</option>
                    </select>
                </div>
            </div>
            
            <div class="row">
              <div>
                <label>Épaisseur lignes (mm)</label>
                <input type="number" id="dotWRecto" step="0.01" value="0.10">
              </div>
                <div>
                    <label>Orientation du texte</label>
                    <select id="textOrientationRecto">
                        <option value="aligned_rayon">Uniforme (Standard / Pointant Extérieur)</option>
                        <option value="aligned_rayon_inversed" selected>Uniforme (Inversé / Pointant Centre)</option>
                        <option value="polygonal">Polygonal (Aligné sur la corde)</option>
                    </select>
                </div>
            </div>
            
            <label style="font-weight: 600; margin-top: 10px;">Contenus RECTO (Segments d>1)</label>
            <select id="contentRecto">
                <option value="numeric" selected>Écriture fractionnaire (1/d)</option>
                <option value="numeric_unit">Écriture fractionnaire avec unité (1/d&nbsp;u)</option>
                <option value="decimal">Décimal (0,X)</option>
                <option value="decimal_unit">Décimal avec unité (0,X&nbsp;u)</option>
                <option value="percentage">Pourcentage (X&nbsp;%)</option>
                <option value="minutes">Temps (X&nbsp;min)</option>
                <option value="hours_fractional">Temps (1/d h)</option>
                <option value="degrees">Angle en degrés (X&nbsp;°)</option>
                <option value="letters">En lettres (un demi, un tiers...)</option>
                <option value="empty">Vide (pas de texte)</option>
            </select>
            
            <label style="font-weight: 600; margin-top: 10px;">Contenu de la bande UNITÉ (d=1) - RECTO</label>
            <select id="unitModeRecto"> 
                <option value="numeric_one">1 (Unité numérique)</option>
                <option value="unit" selected>1 unité</option> 
                <option value="one-on-one">1/1 (Fraction)</option>
                <option value="percent">100&nbsp;%</option>
                <option value="minutes">60&nbsp;min</option>
                <option value="hours_unit">1 heure</option> 
                <option value="degrees_unit">360&nbsp;degrés</option> 
                <option value="custom">Texte personnalisé</option>
                <option value="empty">Vide (pas de texte)</option>
            </select>
            <input type="text" id="customTextRecto" value="1 unité" placeholder="Ex: 1 unité" style="margin-top: 5px; display: none;">

          </fieldset>
    
          <fieldset>
            <legend>Style VERSO (Double-Face)</legend>

            <label>Structure des disques VERSO (pour d > 1)</label>
            <select id="versoContentType">
                <option value="unit_center" selected>Unité au centre (Non divisé)</option>
                <option value="segmented">Divisé en d parts (Fractionné)</option>
            </select>
            
            <label style="font-weight: 600; margin-top: 10px;">Paramètres de style VERSO</label>
            
            <div class="row">
              <div>
                <label>Taille de l'écriture (pt)</label>
                <input type="number" id="labelPtVerso" step="1" value="10">
              </div>
              <div>
                <label>Distance texte/centre (%)</label>
                <input type="number" id="textDistRatioVerso" step="1" value="60">
              </div>
            </div>
            
            <div class="row">
                <div>
                    <label>Lignes de séparation</label>
                    <select id="innerBordersVerso">
                        <option value="visible" selected>Visibles</option>
                        <option value="hidden">Masquées (disques vierges)</option>
                    </select>
                </div>
                <div>
                    <label>Style des divisions</label>
                    <select id="dashStyleVerso">
                        <option value="3,3" selected>Pointillés</option>
                        <option value="0">Traits pleins</option>
                    </select>
                </div>
            </div>
            
            <div class="row">
              <div>
                <label>Épaisseur lignes (mm)</label>
                <input type="number" id="dotWVerso" step="0.01" value="0.10">
              </div>
                <div>
                    <label>Orientation du texte</label>
                    <select id="textOrientationVerso">
                        <option value="aligned_rayon">Uniforme (Standard / Pointant Extérieur)</option>
                        <option value="aligned_rayon_inversed" selected>Uniforme (Inversé / Pointant Centre)</option>
                        <option value="polygonal">Polygonal (Aligné sur la corde)</option>
                    </select>
                </div>
            </div>
            
            <label style="font-weight: 600; margin-top: 10px;">Contenus VERSO</label>

            <div id="segmentedVersoOptions" style="display: none;">
                <label>Contenu des parts VERSO (d>1) [Fractionné]</label>
                <select id="contentVerso">
                    <option value="numeric">Écriture fractionnaire (1/d)</option>
                    <option value="numeric_unit">Écriture fractionnaire avec unité (1/d&nbsp;u)</option>
                    <option value="decimal">Décimal (0,X)</option>
                    <option value="decimal_unit">Décimal avec unité (0,X&nbsp;u)</option>
                    <option value="percentage" selected>Pourcentage (X&nbsp;%)</option>
                    <option value="minutes">Temps (X&nbsp;min)</option>
                    <option value="hours_fractional">Temps (1/d h)</option>
                    <option value="degrees">Angle en degrés (X&nbsp;°)</option>
                    <option value="letters">En lettres (un demi, un tiers...)</option>
                    <option value="empty">Vide (pas de texte)</option>
                </select>
            </div>
            
            <div id="unitCenterVersoOptions">
                <label>Contenu d'unité VERSO (d>1 & Non divisé)</label>
                <select id="unitModeVersoDgt1">
                    <option value="unit" selected>1 unité</option> 
                    <option value="numeric_one">1 (Unité numérique)</option>
                    <option value="one-on-one">1/1 (Fraction)</option>
                    <option value="percent">100&nbsp;%</option>
                    <option value="minutes">60&nbsp;min</option>
                    <option value="hours_unit">1 heure</option>
                    <option value="degrees_unit">360&nbsp;degrés</option>
                    <option value="custom">Texte personnalisé</option>
                    <option value="empty">Vide (pas de texte)</option>
                </select>
                <input type="text" id="customTextVersoDgt1" value="1 unité (Verso D>1)" placeholder="Ex: 1 unité (Verso D>1)" style="margin-top: 5px; display: none;">
            </div>

            <label style="font-weight: 600; margin-top: 10px;">Contenu de la bande UNITÉ (d=1) - VERSO</label>
            <select id="unitModeVersoD1">
                <option value="same_as_recto" selected>Identique au Recto</option>
                <option value="numeric_one">1 (Unité numérique)</option>
                <option value="unit">1 unité</option>
                <option value="one-on-one">1/1 (Fraction)</option>
                <option value="percent">100&nbsp;%</option>
                <option value="minutes">60&nbsp;min</option>
                <option value="hours_unit">1 heure</option>
                <option value="degrees_unit">360&nbsp;degrés</option>
                <option value="custom">Texte personnalisé</option>
                <option value="empty">Vide (pas de texte)</option>
            </select>
            <input type="text" id="customTextVersoD1" value="1 unité (Verso D=1)" placeholder="Ex: 1 unité (Verso D=1)" style="margin-top: 5px; display: none;">
          </fieldset>
    
          <fieldset>
            <legend>Mode d'impression (Séquence)</legend>
            <div>
                <label>Séquence de pages</label>
                <select id="mode">
                  <option value="recto_only">Recto Seul (Ex: que les fractions)</option>
                  <option value="verso_only">Verso Seul (Ex: que les unités/pourcentages)</option>
                  <option value="interleaved" selected>Recto / Verso (Alterné pour chaque d)</option> 
                </select>
            </div>
          </fieldset>
          
      </div> </form>
  </section>

  <section class="preview" id="preview"></section>
</main>

<script>
const W = 297; // mm (A4 paysage)
const H = 210; // mm
function mm(v){ return v + "mm"; }
const RADIAN = Math.PI / 180;

// Marqueur spécial pour indiquer à discSVG que le contenu est la fraction 1/1
const FRAC_ONE_ON_ONE = 'FRAC_ONE_ON_ONE_MARKER'; 

// Valeurs de fraction parfaites hardcodées
const HARDCODED_FRAC = {
    // Ratios d'espacement (en pourcentage de la taille de la police)
    NUM_PADDING_RATIO: 12.7, 
    DENOM_PADDING_RATIO: -3.2,
    // Dimensions
    BAR_RATIO: 70, // Taille de la barre en % du numérateur/dénominateur
    BAR_W_MM: 0.15, // Épaisseur de la barre en mm
};

// Tableau de conversion des dénominateurs en lettres
const denomToLetters = {
    1: "Une unité", 
    2: "un demi", 
    3: "un tiers", 
    4: "un quart", 
    5: "un cinquième",
    6: "un sixième", 
    7: "un septième", 
    8: "un huitième", 
    9: "un neuvième", 
    10: "un dixième", 
    11: "un onzième", 
    12: "un douzième", 
};

// Couleurs de fond pédagogiques
const denomColors = {
    1: '#fff', 2: '#ffb3b3', 3: '#6699ff', 4: '#b3ffc6', 5: '#ff9966', 
    6: '#e0b3ff', 7: '#99ccff', 8: '#ccff99', 9: '#ffccff', 10: '#ffffb3', 
    11: '#cc99ff', 12: '#99ffff',
};

/**
 * Détermine le symbole d'unité à utiliser pour les segments d>1
 */
function getUnitSymbolFromContentMode(contentMode) {
    if (contentMode === 'numeric_unit' || contentMode === 'decimal_unit') return 'u';
    if (contentMode === 'hours_fractional') return 'h'; 
    return ''; 
}

// Fonction pour déterminer le texte de l'unité (au centre du disque)
function getUnitText(unitMode, customText, rectoUnitMode, rectoCustomText) {
    let finalMode = unitMode;
    let finalCustomText = customText;
    
    // Gérer l'option 'Identique au Recto' (uniquement pour D=1 Verso)
    if (unitMode === 'same_as_recto') {
        finalMode = rectoUnitMode;
        finalCustomText = rectoCustomText;
    }
    
    if (finalMode === 'numeric_one') return '1';
    if (finalMode === 'unit') return '1 unité'; 
    if (finalMode === 'one-on-one') return FRAC_ONE_ON_ONE; // Retourne le marqueur pour forcer le rendu fractionnaire
    if (finalMode === 'percent') return '100\u00A0%'; // Espace insécable
    if (finalMode === 'minutes') return '60\u00A0min'; // Espace insécable
    if (finalMode === 'hours_unit') return '1 heure'; 
    if (finalMode === 'degrees_unit') return '360\u00A0°'; // Espace insécable
    if (finalMode === 'empty') return ''; 
    return finalCustomText; // 'custom' mode
}

// Fonction de dessin d'une fraction (Numérateur / Barre / Dénominateur)
// Les paramètres de fraction (padding, ratio, width) sont maintenant hardcodés.
function fracSVG(x, y, d, sizePt, contentMode){
    const g = document.createElementNS("http://www.w3.org/2000/svg","g");
    
    const sizePx = sizePt * 96/72;
    // Utilise les valeurs hardcodées
    const numPadding = sizePx * (HARDCODED_FRAC.NUM_PADDING_RATIO / 100); 
    const denomPadding = sizePx * (HARDCODED_FRAC.DENOM_PADDING_RATIO / 100); 
    const halfBar = sizePx * (HARDCODED_FRAC.BAR_RATIO) / 200;
    
    // 1. Numérateur (1)
    const n = document.createElementNS("http://www.w3.org/2000/svg","text");
    n.setAttribute("x", x); n.setAttribute("y", y - numPadding); // Utilise numPadding
    n.setAttribute("font-size", sizePt+"pt");
    n.setAttribute("text-anchor","middle");
    n.setAttribute("dominant-baseline","baseline");
    n.textContent = "1";

    // 2. Dénominateur (d)
    const dd = document.createElementNS("http://www.w3.org/2000/svg","text");
    dd.setAttribute("x", x); dd.setAttribute("y", y + denomPadding); // Utilise denomPadding
    dd.setAttribute("font-size", sizePt+"pt");
    dd.setAttribute("text-anchor","middle");
    dd.setAttribute("dominant-baseline","hanging");
    dd.textContent = String(d);

    // 3. Barre de fraction
    const line = document.createElementNS("http://www.w3.org/2000/svg","line");
    line.setAttribute("x1", x - halfBar);
    line.setAttribute("x2", x + halfBar);
    line.setAttribute("y1", y);
    line.setAttribute("y2", y);
    line.setAttribute("stroke","black");
    line.setAttribute("stroke-width", mm(HARDCODED_FRAC.BAR_W_MM)); // Utilise l'épaisseur hardcodée

    g.appendChild(n); g.appendChild(dd); g.appendChild(line);

    // 4. Ajout de l'unité fractionnée (pour numeric_unit ou hours_fractional)
    const isNumericUnit = contentMode === 'numeric_unit';
    const isHoursFractional = contentMode === 'hours_fractional';
    if(isHoursFractional || isNumericUnit){
        const unitText = document.createElementNS("http://www.w3.org/2000/svg","text");
        const unitSuffix = isHoursFractional ? 'h' : getUnitSymbolFromContentMode(contentMode); 
        // Positionnement après la fraction.
        // NOTE: Pas d'ajustement ici car c'est un positionnement SVG, pas un espace typographique.
        const startX = x + sizePx * 0.45; 
        unitText.setAttribute("x", startX);
        unitText.setAttribute("y", y);
        unitText.setAttribute("font-size", sizePt+"pt");
        unitText.setAttribute("text-anchor","start");
        unitText.setAttribute("dominant-baseline","middle");
        unitText.textContent = unitSuffix;
        g.appendChild(unitText);
    }
    return g;
}

// Fonction pour générer le contenu textuel non-fractionnaire/non-unité
function textContent(d, textMode){
    const val = 1 / d;
    const unitSymbol = getUnitSymbolFromContentMode(textMode);
    // Formatter pour les décimales (0,5, etc.)
    const decimalFormatter = new Intl.NumberFormat('fr-FR', { minimumFractionDigits: 1, maximumFractionDigits: 3 });

    if (textMode === 'percentage') {
        let valStr = Number((val * 100).toFixed(2));
        return `${valStr.toString().replace('.', ',')}\u00A0%`; // Espace insécable
    } else if (textMode === 'minutes') {
        const minVal = val * 60;
        if (Number.isInteger(minVal)) {
            return `${minVal}\u00A0min`; // Espace insécable
        } else {
            return `${minVal.toFixed(1).replace('.', ',')}\u00A0min`; // Espace insécable
        }
    } else if (textMode === 'degrees') {
        const valDeg = 360 / d;
        let degText;
        if (Number.isInteger(valDeg)) {
            // Si c'est un entier, on affiche sans décimale
            degText = valDeg.toString();
        } else {
            // Sinon, on formate avec la virgule pour la décimale
            degText = decimalFormatter.format(valDeg).replace(/(\.0+)?$/, '');
        }
        return `${degText}\u00A0°`; // Espace insécable
    } else if (textMode === 'letters') {
        return denomToLetters[d] || ("1/"+d);
    } else if (textMode === 'decimal' || textMode === 'decimal_unit') {
        let partText = decimalFormatter.format(val).replace(/(\.0+)?$/, '');
        if (textMode === 'decimal_unit' && unitSymbol !== '') {
            return `${partText}\u00A0${unitSymbol}`; // Espace insécable
        }
        return partText;
    }
    return '';
}

// Fonction de dessin de texte dans une part de disque
function textInSector(cx, cy, r, d, k, styles, contentMode, textDistRatio){
    const g = document.createElementNS("http://www.w3.org/2000/svg","g");
    if(contentMode === "empty"){
        return g;
    }

    // Récupère uniquement les styles non hardcodés pour la fraction
    const { labelPt, textOrientation } = styles;
    const sectorAngle = 360 / d;
    const dist = r * (textDistRatio / 100);
    let x, y, rotation;
    
    // Angle de la bissectrice (rayon central de la part) par rapport à l'axe X positif (en haut = -90)
    const bisectriceAngle = (k * sectorAngle + sectorAngle / 2) - 90;

    if (textOrientation === 'polygonal') {
        const A_start = (k * sectorAngle - 90);
        const A_end = ((k + 1) * sectorAngle - 90);
        const x1 = cx + dist * Math.cos(A_start * RADIAN);
        const y1 = cy + dist * Math.sin(A_start * RADIAN);
        const x2 = cx + dist * Math.cos(A_end * RADIAN);
        const y2 = cy + dist * Math.sin(A_end * RADIAN);
        x = (x1 + x2) / 2;
        y = (y1 + y2) / 2;
        rotation = bisectriceAngle + 90;
    } else {
        x = cx + dist * Math.cos(bisectriceAngle * RADIAN);
        y = cy + dist * Math.sin(bisectriceAngle * RADIAN);

        // Determine rotation based on orientation mode
        let isFractionalOrHours = (contentMode === "numeric" || contentMode === "numeric_unit" || contentMode === "hours_fractional");

        if (textOrientation === 'aligned_rayon') {
            // Aligné sur le rayon, pointant Extérieur (Fraction: 90/270, Texte: 180/0)
            rotation = bisectriceAngle;
            if(isFractionalOrHours){
                rotation += 90; // Vertical
            } else {
                rotation += 180; // Horizontal, basculé à 180 pour lecture extérieure
            }
        } else {
            // aligned_rayon_inversed (Pointant Centre)
            // Aligné sur le rayon, pointant Centre (Fraction: 270/90, Texte: 0/180)
            rotation = bisectriceAngle;
            if(isFractionalOrHours){
                rotation += 270; // Vertical (l'opposé de 90)
            }
            // Sinon, rotation 0 (lecture normale) ou 180 si angle > 90 et < 270 (non implémenté ici, on laisse le 0 par défaut)
        }

        // Fix rotation quand le texte est à l'envers
        if(rotation > 90 && rotation < 270){
            rotation += 180;
        }
        if(rotation > 360) rotation -= 360;
        if(rotation < 0) rotation += 360;
    }

    const rotationTransform = `rotate(${rotation}, ${x}, ${y})`;
    
    // Détermine si le rendu est fractionnaire (avec barre)
    const useFractionalRendering = (contentMode === "numeric" || contentMode === "numeric_unit" || contentMode === "hours_fractional");

    // 4. Génération du contenu (Fraction ou Texte simple)
    if (useFractionalRendering) {
        // Appel à fracSVG sans les 4 paramètres de style de fraction retirés
        const fractionGroup = fracSVG(x, y, d, labelPt, contentMode);
        fractionGroup.setAttribute("transform", rotationTransform);
        g.appendChild(fractionGroup);
    } else {
        // Mode Lettres, Pourcentage, Minutes, Degrés, Décimal (texte simple)
        const t = document.createElementNS("http://www.w3.org/2000/svg","text");
        t.setAttribute("x", x);
        t.setAttribute("y", y);
        t.setAttribute("font-size", labelPt+"pt");
        t.setAttribute("text-anchor","middle");
        t.setAttribute("dominant-baseline","middle");
        t.setAttribute("transform", rotationTransform);
        t.textContent = textContent(d, contentMode);
        g.appendChild(t);
    }

    return g;
}

// Fonction pour générer le SVG du disque de fraction
function discSVG(d, R, cx, cy, styles, isVerso, rectoUnitMode, rectoCustomText) {
    const { frameW, dotWRecto, innerBordersRecto, dashStyleRecto, labelPtRecto, textDistRatioRecto, textOrientationRecto, contentRecto, unitModeRecto, customTextRecto, dotWVerso, innerBordersVerso, dashStyleVerso, labelPtVerso, textDistRatioVerso, textOrientationVerso, versoContentType, contentVerso, unitModeVersoDgt1, customTextVersoDgt1, unitModeVersoD1, customTextVersoD1 } = styles;

    const currentStyles = {
        dotW: isVerso ? dotWVerso : dotWRecto,
        innerBorders: isVerso ? innerBordersVerso : innerBordersRecto,
        dashStyle: isVerso ? dashStyleVerso : dashStyleRecto,
        labelPt: isVerso ? labelPtVerso : labelPtRecto,
        textDistRatio: isVerso ? textDistRatioVerso : textDistRatioRecto,
        textOrientation: isVerso ? textOrientationVerso : textOrientationRecto,
    };
    
    let contentMode; // Détermine le mode de contenu (pour les segments)
    let unitMode;    // Détermine le mode de contenu (pour le centre/unité)
    let customText;  // Texte personnalisé (pour le centre/unité)

    if (isVerso) {
        if (d === 1) {
            unitMode = unitModeVersoD1;
            customText = customTextVersoD1;
        } else if (versoContentType === 'unit_center') {
            unitMode = unitModeVersoDgt1;
            customText = customTextVersoDgt1;
        } else { // segmented
            contentMode = contentVerso;
        }
    } else { // Recto
        if (d === 1) {
            unitMode = unitModeRecto;
            customText = customTextRecto;
        } else {
            contentMode = contentRecto;
        }
    }

    // Création du conteneur SVG
    const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
    svg.setAttribute("width", mm(2 * R));
    svg.setAttribute("height", mm(2 * R));
    svg.setAttribute("viewBox", `0 0 ${2 * R} ${2 * R}`);
    
    // 1. Fond du disque (pour la couleur pédagogique)
    const bg = document.createElementNS("http://www.w3.org/2000/svg","circle");
    bg.setAttribute("cx", cx); bg.setAttribute("cy", cy); bg.setAttribute("r", R);
    bg.setAttribute("fill", styles.colorMode === 'colored' ? (denomColors[d] || '#ccc') : 'white');
    bg.setAttribute("stroke", "none");
    svg.appendChild(bg);

    // 2. Cercle principal (contour épais)
    const circle = document.createElementNS("http://www.w3.org/2000/svg","circle");
    circle.setAttribute("cx", cx); circle.setAttribute("cy", cy); circle.setAttribute("r", R);
    circle.setAttribute("fill", "none");
    circle.setAttribute("stroke", "black");
    circle.setAttribute("stroke-width", mm(frameW));
    svg.appendChild(circle);

    // 3. Divisions internes et Texte des parts (si divisé)
    if (d > 1 && (isVerso ? versoContentType === 'segmented' : true)) {
        const sectorAngle = 360 / d;
        for (let k = 0; k < d; k++) {
            const startAngle = k * sectorAngle;
            
            // a. Ligne de séparation interne
            if (currentStyles.innerBorders === 'visible') {
                const angle = (startAngle - 90) * RADIAN;
                const line = document.createElementNS("http://www.w3.org/2000/svg","line");
                line.setAttribute("x1", cx);
                line.setAttribute("y1", cy);
                line.setAttribute("x2", cx + R * Math.cos(angle));
                line.setAttribute("y2", cy + R * Math.sin(angle));
                line.setAttribute("stroke", "black");
                line.setAttribute("stroke-width", mm(currentStyles.dotW));
                if (currentStyles.dashStyle !== '0') {
                    line.setAttribute("stroke-dasharray", currentStyles.dashStyle);
                }
                svg.appendChild(line);
            }

            // b. Texte de la part
            const textGroup = textInSector(cx, cy, R, d, k, currentStyles, contentMode, currentStyles.textDistRatio);
            svg.appendChild(textGroup);
        }
    }
    
    // 4. Contenu au centre (Unité)
    if (d === 1 || (isVerso && versoContentType === 'unit_center')) {
        let text = getUnitText(unitMode, customText, unitModeRecto, customTextRecto);
        
        // Si le mode est "1/1 (Fraction)"
        if (text === FRAC_ONE_ON_ONE) {
            const fractionGroup = fracSVG(cx, cy, 1, currentStyles.labelPt, contentMode);
            svg.appendChild(fractionGroup);
        } else if (text !== '') {
            const t = document.createElementNS("http://www.w3.org/2000/svg","text");
            t.setAttribute("x", cx);
            t.setAttribute("y", cy);
            t.setAttribute("font-size", currentStyles.labelPt + "pt");
            t.setAttribute("text-anchor", "middle");
            t.setAttribute("dominant-baseline", "middle");
            t.textContent = text;
            svg.appendChild(t);
        }
    }
    
    return svg;
}

// ... (Le reste du code, y compris la fonction generate() et les écouteurs, reste inchangé) ...
// NOTE: La fonction generate() et les autres utilitaires (updateUI, etc.) ne sont pas reproduits ici 
// pour concision mais sont inclus dans le fichier final.

// Fonction pour récupérer les valeurs
function getFormValues(){
    return {
        // ... (vos valeurs de formulaire ici) ...
        N_cols: parseInt(document.getElementById('N_cols').value),
        N_rows: parseInt(document.getElementById('N_rows').value),
        frameW: parseFloat(document.getElementById('frameW').value),
        colorMode: document.getElementById('colorMode').value,
        discGap: parseFloat(document.getElementById('discGap').value),

        rectoOffX: parseFloat(document.getElementById('rectoOffX').value),
        rectoOffY: parseFloat(document.getElementById('rectoOffY').value),
        offX: parseFloat(document.getElementById('offX').value),
        offY: parseFloat(document.getElementById('offY').value),
        
        denoms: document.getElementById('denoms').value.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n) && n > 0).sort((a,b)=>a-b),
        
        labelPtRecto: parseFloat(document.getElementById('labelPtRecto').value),
        textDistRatioRecto: parseFloat(document.getElementById('textDistRatioRecto').value),
        innerBordersRecto: document.getElementById('innerBordersRecto').value,
        dashStyleRecto: document.getElementById('dashStyleRecto').value,
        dotWRecto: parseFloat(document.getElementById('dotWRecto').value),
        textOrientationRecto: document.getElementById('textOrientationRecto').value,
        contentRecto: document.getElementById('contentRecto').value,
        unitModeRecto: document.getElementById('unitModeRecto').value,
        customTextRecto: document.getElementById('customTextRecto').value,
        
        versoContentType: document.getElementById('versoContentType').value,
        labelPtVerso: parseFloat(document.getElementById('labelPtVerso').value),
        textDistRatioVerso: parseFloat(document.getElementById('textDistRatioVerso').value),
        innerBordersVerso: document.getElementById('innerBordersVerso').value,
        dashStyleVerso: document.getElementById('dashStyleVerso').value,
        dotWVerso: parseFloat(document.getElementById('dotWVerso').value),
        textOrientationVerso: document.getElementById('textOrientationVerso').value,
        contentVerso: document.getElementById('contentVerso').value,
        unitModeVersoDgt1: document.getElementById('unitModeVersoDgt1').value,
        customTextVersoDgt1: document.getElementById('customTextVersoDgt1').value,
        unitModeVersoD1: document.getElementById('unitModeVersoD1').value,
        customTextVersoD1: document.getElementById('customTextVersoD1').value,

        mode: document.getElementById('mode').value,
    };
}


// --- Fonctions de mise en page ---

// Fonction pour créer une page (conteneur A4)
function createPage(isRecto) {
    const page = document.createElement('div');
    page.className = 'page';
    page.style.position = 'relative'; 
    page.style.transformOrigin = 'top left'; 
    if (isRecto) {
        page.setAttribute('data-side', 'recto');
    } else {
        page.setAttribute('data-side', 'verso');
    }
    return page;
}

// Fonction de génération principale
function generate() {
    const values = getFormValues();
    const preview = document.getElementById('preview');
    preview.innerHTML = ''; // Nettoyer l'aperçu

    if (values.denoms.length === 0) return;

    const { N_cols, N_rows, frameW, discGap, rectoOffX, rectoOffY, offX, offY, mode } = values;

    const maxW = W - 2 * discGap; // Largeur de la zone utile (mm)
    const maxH = H - 2 * discGap; // Hauteur de la zone utile (mm)
    
    // Calcul du diamètre maximal basé sur la grille et les écarts
    const maxDiscDiameterW = (maxW - (N_cols - 1) * discGap) / N_cols;
    const maxDiscDiameterH = (maxH - (N_rows - 1) * discGap) / N_rows;
    const discDiameter = Math.min(maxDiscDiameterW, maxDiscDiameterH);
    const R = discDiameter / 2;
    
    // Si la taille est trop petite (inférieure à 2mm de rayon), on n'affiche rien
    if (R < 2) return; 

    // Calcul des positions de la grille
    const startX = discGap + R;
    const startY = discGap + R;
    const stepX = discDiameter + discGap;
    const stepY = discDiameter + discGap;

    const disksPerPage = N_cols * N_rows;
    let diskIndex = 0;
    
    // Parcours de chaque dénominateur
    for (const d of values.denoms) {
        const hasRecto = (mode === 'recto_only' || mode === 'interleaved');
        const hasVerso = (mode === 'verso_only' || mode === 'interleaved');

        // --- GÉnÉRATION RECTO ---
        if (hasRecto) {
            if (diskIndex % disksPerPage === 0) {
                preview.appendChild(createPage(true));
            }
            const currentPage = preview.lastChild;
            const diskNum = diskIndex % disksPerPage;
            const col = diskNum % N_cols;
            const row = Math.floor(diskNum / N_cols);

            const cx = startX + col * stepX + rectoOffX;
            const cy = startY + row * stepY + rectoOffY;

            const disc = document.createElement('div');
            disc.className = 'disc-container';
            disc.style.position = 'absolute';
            disc.style.left = mm(cx - R);
            disc.style.top = mm(cy - R);
            
            const svg = discSVG(d, R, R, R, values, false); // isVerso = false
            disc.appendChild(svg);
            currentPage.appendChild(disc);

            diskIndex++;
        }

        // --- GÉnÉRATION VERSO ---
        if (hasVerso) {
            if (diskIndex % disksPerPage === 0) {
                preview.appendChild(createPage(false));
            }
            const currentPage = preview.lastChild;
            const diskNum = diskIndex % disksPerPage;
            const col = diskNum % N_cols;
            const row = Math.floor(diskNum / N_cols);

            const cx = startX + col * stepX + offX;
            const cy = startY + row * stepY + offY;
            
            const disc = document.createElement('div');
            disc.className = 'disc-container';
            disc.style.position = 'absolute';
            disc.style.left = mm(cx - R);
            disc.style.top = mm(cy - R);
            
            const svg = discSVG(d, R, R, R, values, true, values.unitModeRecto, values.customTextRecto); // isVerso = true
            disc.appendChild(svg);
            currentPage.appendChild(disc);
            
            diskIndex++;
        }
    }
}

// Fonction pour gérer l'affichage conditionnel des champs
function updateUI(){
    const values = getFormValues();
    const { unitModeRecto, versoContentType, unitModeVersoDgt1, unitModeVersoD1 } = values;

    const customTextRectoInput = document.getElementById('customTextRecto');
    const customTextVersoDgt1Input = document.getElementById('customTextVersoDgt1');
    const customTextVersoD1Input = document.getElementById('customTextVersoD1');

    // 1. Afficher/Masquer le champ custom pour le Recto (d=1)
    customTextRectoInput.style.display = unitModeRecto === 'custom' ? 'block' : 'none';

    // 2. Afficher/Masquer le champ custom pour le Verso (d>1)
    customTextVersoDgt1Input.style.display = (versoContentType === 'unit_center' && unitModeVersoDgt1 === 'custom') ? 'block' : 'none';
    
    // 3. Afficher/Masquer le champ custom pour le Verso (d=1)
    customTextVersoD1Input.style.display = unitModeVersoD1 === 'custom' ? 'block' : 'none';
    
    // 4. Afficher/Masquer les options de contenu VERSO (Segmenté vs Unité au centre)
    const segmentedVersoOptions = document.getElementById('segmentedVersoOptions');
    const unitCenterVersoOptions = document.getElementById('unitCenterVersoOptions');
    
    segmentedVersoOptions.style.display = versoContentType === 'segmented' ? 'block' : 'none';
    unitCenterVersoOptions.style.display = versoContentType === 'unit_center' ? 'block' : 'none';

    // 5. Masquer les contrôles de style de part VERSO si l'option est "Unité au centre"
    const conditionalRowsIds = ['dotWVerso', 'dashStyleVerso', 'innerBordersVerso', 'textOrientationVerso', 'labelPtVerso', 'textDistRatioVerso'];
    
    // Trouvez toutes les lignes (.row) qui contiennent un de ces contrôles
    const versoConditionalRows = [];
    for(const id of conditionalRowsIds){
        const row = document.getElementById(id)?.closest('.row');
        if(row && !versoConditionalRows.includes(row)) versoConditionalRows.push(row);
    }

    if (versoContentType === 'unit_center') {
        versoConditionalRows.forEach(el => el.style.display = 'none');
    } else {
        versoConditionalRows.forEach(el => el.style.display = 'grid');
    }
        
    generate();
}

// Gérer tous les changements qui nécessitent une régénération (y compris les champs texte qui ne déclenchent pas 'change' sur 'input')
document.getElementById('form').addEventListener('change', updateUI);

// Écouter spécifiquement l'entrée sur les champs numériques ou de texte pour la mise à jour en direct (ou presque)
document.getElementById('form').addEventListener('input', (e) => {
    const targetId = e.target.id;
    // Mise à jour de la liste des IDs à écouter (retrait des contrôles de fraction)
    if (['N_cols', 'N_rows', 'discGap', 'denoms', 'customTextRecto', 'customTextVersoD1', 'customTextVersoDgt1', 'rectoOffX', 'rectoOffY', 'offX', 'offY', 'labelPtRecto', 'labelPtVerso', 'textDistRatioRecto', 'textDistRatioVerso', 'dotWRecto', 'dotWVerso', 'dashStyleRecto', 'dashStyleVerso']) {
        generate();
    }
});

// Événement d'impression
document.getElementById('print').addEventListener('click', () => {
    window.print();
});

// Initialisation
updateUI(); // Déclenche la première génération
</script>
</body>
</html>
