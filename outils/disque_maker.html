
<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<title>Générateur PRO — Disques de Fractions</title>
<style>
  :root { --page-w: 297mm; --page-h: 210mm; }
  *{ box-sizing:border-box; }
  body{ font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:0; }
  
  /* EN-TÊTE ET NOM FINAL (SIMPLIFIÉ) */
  header{ padding:10px 14px; background:#111; color:#fff; font-size:14px; }
  
  /* Correction du bug de défilement (hauteur main ajustée) */
  main{ 
      display:grid; 
      grid-template-columns: 360px 1fr; 
      gap:14px; 
      padding:14px; 
      height: calc(100vh - 46px); 
  }
  
  /* STYLE DES CONTRÔLES (Fixe la hauteur totale) */
  .controls { 
      height: 100%; 
      display: flex; 
      flex-direction: column; 
  }
  /* Correction de l'overflow pour le menu principal */
  #settings-scroll-area {
      flex-grow: 1; 
      overflow-y: auto; 
      padding-right: 8px; 
      padding-top: 10px; 
      -webkit-overflow-scrolling: touch; 
  }
  
  fieldset{ border:1px solid #ddd; border-radius:8px; margin:0 0 10px 0; }
  legend{ padding:0 6px; font-weight:600; }
  
  /* ALIGNEMENT (Taille restaurée à 13px) */
  label{ 
      display:block; 
      font-size:13px; 
      margin: 0; 
      padding-top: 8px; 
      padding-bottom: 2px; 
      line-height: 1.2; 
  }

  /* Pour les éléments qui sont côte à côte */
  .row{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }
  .row > div {
      display: flex;
      flex-direction: column; 
  }
  
  input, select{ width:100%; padding:8px; font-size:14px; }

  .actions{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
  button{ padding:9px 10px; font-weight:600; font-size:14px; cursor:pointer; }
  
  /* FIX UI: La zone d'aperçu prend la hauteur totale (alignée sur les contrôles) */
  .preview{ 
    background:#f6f7f9; 
    border:1px solid #e2e3e6; 
    border-radius:8px; 
    padding:4px; 
    overflow:auto; 
    height: 100%; 
  }
  
  /* FIX CLÉ: Nouvelle mise en page des pages A4 (alignement top-left pour l'aperçu) */
  .page{ 
    width: var(--page-w); 
    height: var(--page-h); 
    background:white; 
    /* Espace minimal entre les pages */
    margin: 0 0 1mm 0; 
    position: relative; 
    border: 1px dashed #cfd6e3; 
    
    /* Zoom pour visualiser la page A4 entière */
    transform: scale(0.85); 
    transform-origin: top left;
  }
  /* Style spécifique aux disques */
  .disc-container {
    display: inline-block;
    vertical-align: top;
    position: relative;
  }
  
  @media print{
    header, .controls { display:none !important; }
    main{ display:block; padding:0; height:auto; } 
    .preview{ border:none; padding:0; height:auto; }
    /* Annulation du zoom et de la marge pour l'impression 1:1 */
    .page{ break-after: page; page-break-after: always; border:none; margin:0; transform: none; }
    @page { size: A4 landscape; margin: 0; }
  }
</style>
</head>
<body>
<header>GÉNÉRATEUR PRO — DISQUES DE FRACTIONS | Imprimer en Recto-Verso bord long</header>
<main>
  <section class="controls">
    <form id="form">
    
      <fieldset id="actions-fieldset">
        <legend>Actions</legend>
        <div class="actions">
          <button type="button" id="print">Imprimer / Export PDF</button>
        </div>
      </fieldset>

      <div id="settings-scroll-area">
          
          <fieldset>
            <legend>Disposition / Décalages (A4 paysage)</legend>
            <div class="row">
              <div>
                <label>Disques par ligne</label>
                <input type="number" id="N_cols" step="1" min="1" value="2"> </div>
              <div>
                <label>Disques par colonne</label>
                <input type="number" id="N_rows" step="1" min="1" value="2"> </div>
            </div>
            <div>
              <label>Écart minimum entre les disques (mm)</label>
              <input type="number" id="discGap" step="0.1" value="5">
              <p style="font-size: 11px; margin: 5px 0 0;">(Le diamètre est calculé automatiquement)</p>
            </div>
            <div class="row">
              <div>
                <label>Décalage horizontal RECTO</label>
                <input type="number" id="rectoOffX" step="0.1" value="0">
              </div>
              <div>
                <label>Décalage vertical RECTO</label>
                <input type="number" id="rectoOffY" step="0.1" value="0">
              </div>
            </div>
            <div class="row">
              <div>
                <label>Décalage horizontal VERSO</label>
                <input type="number" id="offX" step="0.1" value="0">
              </div>
              <div>
                <label>Décalage vertical VERSO</label>
                <input type="number" id="offY" step="0.1" value="0">
              </div>
            </div>
          </fieldset>
    
          <fieldset>
            <legend>Style des disques</legend>
            <div class="row">
              <div>
                <label>Épaisseur contour (mm)</label>
                <input type="number" id="frameW" step="0.01" value="0.10">
              </div>
              <div>
                <label>Style des fonds</label>
                <select id="colorMode">
                    <option value="white" selected>Uniforme (Blanc)</option>
                    <option value="colored">Couleurs Pédagogiques</option>
                </select>
              </div>
            </div>
          </fieldset>

          <fieldset>
            <legend>Dénominateurs</legend>
            <label>Dénominateurs (Inclure '1' pour générer la page unité)</label>
            <input type="text" id="denoms" value="1,2,3,4,5,6,8,10">
          </fieldset>
          
          <fieldset>
            <legend>Style RECTO (Segments)</legend>
            
            <div class="row">
              <div>
                <label>Taille de l'écriture (pt)</label>
                <input type="number" id="labelPt" step="1" value="10">
              </div>
              <div>
                <label>Distance texte/centre (%)</label>
                <input type="number" id="textDistRatio" step="1" value="60">
              </div>
            </div>
            
            <div class="row">
                <div>
                    <label>Lignes de séparation</label>
                    <select id="innerBorders">
                        <option value="visible" selected>Visibles</option>
                        <option value="hidden">Masquées (disques vierges)</option>
                    </select>
                </div>
                <div>
                    <label>Style des divisions</label>
                    <select id="dashStyle">
                        <option value="3,3" selected>Pointillés</option>
                        <option value="0">Traits pleins</option>
                    </select>
                </div>
            </div>
            
            <div class="row">
              <div>
                <label>Épaisseur lignes (mm)</label>
                <input type="number" id="dotW" step="0.01" value="0.10">
              </div>
                <div>
                    <label>Taille barre fraction (%)</label>
                    <input type="number" id="barRatio" step="1" value="70">
                </div>
            </div>
            
            <div class="row">
                <div>
                    <label>Épaisseur de la barre (mm)</label>
                    <input type="number" id="barW" step="0.01" value="0.15">
                </div>
                <div>
                    <label>Orientation du texte</label>
                    <select id="textOrientation">
                        <option value="aligned_rayon">Uniforme (Standard / Pointant Extérieur)</option>
                        <option value="aligned_rayon_inversed" selected>Uniforme (Inversé / Pointant Centre)</option>
                        <option value="polygonal">Polygonal (Aligné sur la corde)</option>
                    </select>
                </div>
            </div>
            
            <label>Contenu des parts RECTO (Segments)</label>
            <select id="contentRecto">
                <option value="numeric" selected>Écriture fractionnaire (1/d) avec barre</option>
                <option value="degrees">Angle en degrés (X °)</option>
                <option value="percentage">Pourcentage (X % ou X.XX %)</option>
                <option value="minutes">Temps (X min ou X.X min)</option>
                <option value="hours">Temps (1/d h) - Fractionnaire</option>
                <option value="letters">En lettres (un demi, un tiers...)</option>
                <option value="empty">Vide (pas de texte)</option>
            </select>
            
            <div id="unitPartDisplayContainer">
                <label>Affichage des parts (d>1) avec unité</label>
                <select id="unitPartDisplay">
                    <option value="standalone" selected>Unité seule (ex: 1 u | 1/4)</option>
                    <option value="fractional">Unité fractionnée (ex: 1 u | 1/4 u)</option>
                </select>
            </div>
          </fieldset>
    
          <fieldset>
            <legend>Style VERSO (Double-Face)</legend>

            <label>Structure du disque VERSO (pour chaque dénominateur d > 1)</label>
            <select id="versoContentType">
                <option value="unit_center" selected>Unité (Texte au centre, pas de division)</option>
                <option value="segmented">Disque Fractionné (Segments)</option>
            </select>
            
            <div id="segmentedVersoOptions">
                <label>Contenu des parts VERSO (Si "Disque Fractionné")</label>
                <select id="contentVerso">
                    <option value="numeric">Écriture fractionnaire (1/d) avec barre</option>
                    <option value="degrees">Angle en degrés (X °)</option>
                    <option value="percentage" selected>Pourcentage (X % ou X.XX %)</option>
                    <option value="minutes">Temps (X min ou X.X min)</option>
                    <option value="hours">Temps (1/d h) - Fractionnaire</option>
                    <option value="letters">En lettres (un demi, un tiers...)</option>
                    <option value="empty">Vide (pas de texte)</option>
                </select>
            </div>
            
            <div id="unitCenterVersoOptions">
                <label>Contenu de l'Unité / Verso (Au centre des disques d > 1)</label>
                <select id="unitCenterModeD_greater_than_1">
                    <option value="same_as_recto_unit" selected>Identique à l'unité Recto</option>
                    <option value="numeric">1 (Unité numérique)</option>
                    <option value="unit_standard">1 unité</option>
                    <option value="degrees">360 degrés</option>
                    <option value="percent">100 %</option>
                    <option value="minutes">60 min</option>
                    <option value="hours_unit">1 heure</option>
                    <option value="custom">Texte personnalisé</option>
                </select>
                <input type="text" id="customTextD_greater_than_1" value="1 unité" placeholder="Ex: 1 unité" style="margin-top: 5px; display: none;">
            </div>

            <label style="font-weight: 600; margin-top: 10px;">Contenu du VERSO de l'unité (d=1)</label>
            <select id="unitD1VersoContentMode">
                <option value="same_as_recto" selected>Identique au Recto (dérivé de "Contenu des parts RECTO")</option>
                <option value="numeric">1 (Unité numérique)</option>
                <option value="unit_standard">1 unité</option>
                <option value="degrees">360 degrés</option>
                <option value="percent">100 %</option>
                <option value="minutes">60 min</option>
                <option value="hours_unit">1 heure</option>
                <option value="custom">Texte personnalisé</option>
            </select>
            <input type="text" id="customTextD1" value="1 unité" placeholder="Ex: 1 unité (unité d=1)" style="margin-top: 5px; display: none;">
          </fieldset>
    
          <fieldset>
            <legend>Mode d'impression (Séquence)</legend>
            <div>
                <label>Séquence de pages</label>
                <select id="mode">
                  <option value="recto_only">Recto Seul (Ex: que les fractions)</option>
                  <option value="verso_only">Verso Seul (Ex: que les unités/pourcentages)</option>
                  <option value="interleaved" selected>Recto / Verso (Alterné pour chaque d)</option> 
                </select>
            </div>
          </fieldset>
          
      </div> </form>
  </section>

  <section class="preview" id="preview"></section>
</main>

<script>
const W = 297; // mm (A4 paysage)
const H = 210; // mm
function mm(v){ return v + "mm"; }
const RADIAN = Math.PI / 180;

// Tableau de conversion des dénominateurs en lettres
const denomToLetters = {
    1: "Une unité", 
    2: "un demi", 
    3: "un tiers", 
    4: "un quart", 
    5: "un cinquième",
    6: "un sixième", 
    7: "un septième", 
    8: "un huitième", 
    9: "un neuvième", 
    10: "un dixième", 
    11: "un onzième", 
    12: "un douzième", 
};

// Couleurs de fond pédagogiques
const denomColors = {
    1: '#fff', 2: '#ffb3b3', 3: '#6699ff', 4: '#b3ffc6', 5: '#ff9966', 
    6: '#e0b3ff', 7: '#99ccff', 8: '#ccff99', 9: '#ffccff', 10: '#ffffb3', 
    11: '#cc99ff', 12: '#99ffff',
};

/**
 * Extrait le suffixe d'unité du texte personnalisé (ex: "1 heure" -> "h")
 */
function getUnitySuffix(customText) {
    const suffix = customText.replace(/^1\s*/i, '').trim();
    if (suffix.length > 2 && suffix.toLowerCase().includes('unité')) return 'u';
    return suffix || 'u'; 
}

// Fonction pour déterminer le texte de l'unité (au centre du disque)
function getUnitCenterText(unitCenterMode, customText) {
    if (unitCenterMode === 'percent') return '100 %';
    if (unitCenterMode === 'minutes') return '60 min';
    if (unitCenterMode === 'degrees') return '360 °';
    if (unitCenterMode === 'numeric') return '1'; 
    if (unitCenterMode === 'hours_unit') return '1 heure'; 
    if (unitCenterMode === 'unit_standard') return '1 unité'; 
    return customText; // 'custom' mode
}

// Fonction de dessin d'une fraction (Numérateur / Barre / Dénominateur)
function fracSVG(x, y, d, sizePt, barRatio, barWmm, unitPartDisplay, fracUnitSuffix){
    const g = document.createElementNS("http://www.w3.org/2000/svg","g");
    
    const sizePx = sizePt * 96/72;
    const padding = sizePx * 0.15; 
    const halfBar = sizePx * (barRatio ?? 70) / 200;
    
    // 1. Numérateur (1)
    const n = document.createElementNS("http://www.w3.org/2000/svg","text");
    n.setAttribute("x", x); n.setAttribute("y", y - padding);
    n.setAttribute("font-size", sizePt+"pt");
    n.setAttribute("text-anchor","middle");
    n.setAttribute("dominant-baseline","baseline");
    n.textContent = "1";

    // 2. Dénominateur (d)
    const dd = document.createElementNS("http://www.w3.org/2000/svg","text");
    dd.setAttribute("x", x); dd.setAttribute("y", y + padding);
    dd.setAttribute("font-size", sizePt+"pt");
    dd.setAttribute("text-anchor","middle");
    dd.setAttribute("dominant-baseline","hanging");
    dd.textContent = String(d);

    // 3. Barre de fraction
    const line = document.createElementNS("http://www.w3.org/2000/svg","line");
    line.setAttribute("x1", x - halfBar);
    line.setAttribute("x2", x + halfBar);
    line.setAttribute("y1", y);
    line.setAttribute("y2", y);
    line.setAttribute("stroke","black");
    line.setAttribute("stroke-width", mm(barWmm ?? 0.15));

    g.appendChild(n); g.appendChild(dd); g.appendChild(line);

    // 4. Ajout de l'unité fractionnée
    if(unitPartDisplay === 'fractional'){
        const unitySuffix = fracUnitSuffix; 
        // Positionnement après la fraction. La fraction est centrée en (x,y).
        const startX = x + sizePx * 0.45; // Décalage vers la droite du centre de la fraction
        
        const uText = document.createElementNS("http://www.w3.org/2000/svg","text");
        uText.setAttribute("x", startX); 
        uText.setAttribute("y", y); 
        uText.setAttribute("font-size", sizePt+"pt");
        uText.setAttribute("text-anchor","start"); 
        uText.setAttribute("dominant-baseline","middle"); 
        uText.textContent = unitySuffix;
        g.appendChild(uText);
    }

    return g;
}

// Fonction pour générer le contenu textuel non-fractionnaire
function textContent(d, textMode){
    if (textMode === 'percentage') {
        const val = 1 / d * 100;
        let valStr = Number(val.toFixed(2));
        return `${valStr} %`;
    } else if (textMode === 'minutes') {
        const val = 1 / d * 60;
        if (Number.isInteger(val)) {
             return `${val} min`;
        }
        return `${val.toFixed(1)} min`;
    } else if (textMode === 'degrees') {
        const val = 360 / d;
        return `${Number(val.toFixed(1))} °`;
    } else if (textMode === 'letters') {
        return denomToLetters[d] || ("1/"+d);
    }
    return ''; 
}

// Fonction de dessin de texte dans une part de disque
function textInSector(cx, cy, r, d, k, sizePt, textMode, textDistRatio, barRatio, barWmm, textOrientation, unitPartDisplay, customText){
  const g = document.createElementNS("http://www.w3.org/2000/svg","g");
  
  if(textMode === "empty"){
    return g; 
  }

  const sectorAngle = 360 / d;
  const dist = r * (textDistRatio / 100); 
  
  let x, y, rotation;
  
  // Angle de la bissectrice (rayon central de la part) par rapport à l'axe X positif (en haut = -90)
  const bisectriceAngle = (k * sectorAngle + sectorAngle / 2) - 90; 

  if (textOrientation === 'polygonal') {
      const A_start = (k * sectorAngle - 90); 
      const A_end = ((k + 1) * sectorAngle - 90);

      const x1 = cx + dist * Math.cos(A_start * RADIAN);
      const y1 = cy + dist * Math.sin(A_start * RADIAN);
      const x2 = cx + dist * Math.cos(A_end * RADIAN);
      const y2 = cy + dist * Math.sin(A_end * RADIAN);

      x = (x1 + x2) / 2;
      y = (y1 + y2) / 2;
      rotation = bisectriceAngle + 90; 
      
  } else {
      x = cx + dist * Math.cos(bisectriceAngle * RADIAN);
      y = cy + dist * Math.sin(bisectriceAngle * RADIAN);

      if (textOrientation === 'aligned_rayon') {
          rotation = (textMode === "numeric" || textMode === "hours") ? bisectriceAngle + 90 : bisectriceAngle + 180;
          
      } else { // aligned_rayon_inversed (Pointant Centre)
          rotation = (textMode === "numeric" || textMode === "hours") ? bisectriceAngle + 270 : bisectriceAngle;
      }
  }

  // Détermine si le rendu est fractionnaire
  const useFractionalRendering = (textMode === "numeric" || textMode === "hours");
  
  // Définit le suffixe d'unité pour le rendu fractionnaire (si unitPartDisplay === 'fractional')
  let fracUnitSuffix = useFractionalRendering ? getUnitySuffix(customText) : null;

  if (textMode === "hours") {
      fracUnitSuffix = 'h'; // Force le suffixe 'h' pour le mode heures
  } 

  // 4. Génération du contenu (Fraction ou Texte simple)
  if (useFractionalRendering) {
    // customText est ignoré ici car fracSVG utilise son propre suffixe (ou celui forcé par 'hours')
    const fractionGroup = fracSVG(x, y, d, sizePt, barRatio, barWmm, unitPartDisplay, fracUnitSuffix);
    fractionGroup.setAttribute("transform", `rotate(${rotation}, ${x}, ${y})`);
    g.appendChild(fractionGroup);

  } else { 
    // Mode Lettres, Pourcentage, Minutes, Degrés (texte simple)
    const t = document.createElementNS("http://www.w3.org/2000/svg","text");
    t.setAttribute("x", x); 
    t.setAttribute("y", y); 
    t.setAttribute("font-size", sizePt+"pt");
    t.setAttribute("text-anchor","middle");
    t.setAttribute("dominant-baseline","middle");
    t.setAttribute("transform", `rotate(${rotation}, ${x}, ${y})`);
    
    t.textContent = textContent(d, textMode);
    g.appendChild(t);
  }

  return g;
}

// Fonction de dessin du disque
// Ajout de customTextD1 et customTextD_greater_than_1 pour différencier les textes personnalisés
function discSVG(r, cx, cy, d, contentMode, labelPt, dash, frameW, dotW, colorMode, innerBorders, customTextD1, customTextD_greater_than_1, textDistRatio, barRatio, barWmm, textOrientation, unitPartDisplay) {
  const g = document.createElementNS("http://www.w3.org/2000/svg","g");
  
  const fillColor = (colorMode === 'colored' && denomColors[d]) ? denomColors[d] : 'white';
  
  // Déterminer si on est en mode Unité au centre (unit_*)
  const isCenterUnit = contentMode.startsWith('unit_');
  
  // 1. Cercle de fond (Contour)
  const circle = document.createElementNS("http://www.w3.org/2000/svg","circle");
  circle.setAttribute("cx", cx); circle.setAttribute("cy", cy); circle.setAttribute("r", r);
  circle.setAttribute("fill", fillColor); 
  circle.setAttribute("stroke","black");
  circle.setAttribute("stroke-width", mm(frameW));
  g.appendChild(circle);

  // 2. Divisions et Texte dans les parts
  // N'affiche les divisions que si d > 1 ET si le contenu n'est pas "unité au centre"
  if (!isCenterUnit && d > 1) {
    // LIGNES DE SÉPARATION (Bordures intérieures)
    if (innerBorders === 'visible') {
        for (let k = 0; k < d; k++) {
          const angle = k * (360 / d) - 90; 
          
          const x2 = cx + r * Math.cos(angle * RADIAN);
          const y2 = cy + r * Math.sin(angle * RADIAN);

          const line = document.createElementNS("http://www.w3.org/2000/svg","line");
          line.setAttribute("x1", cx); line.setAttribute("y1", cy);
          line.setAttribute("x2", x2); line.setAttribute("y2", y2);
          line.setAttribute("stroke","black");
          line.setAttribute("stroke-width", mm(dotW));
          line.setAttribute("stroke-dasharray", dash);
          g.appendChild(line);
        }
    }
    // TEXTE dans chaque part (seulement si ce n'est pas "empty")
    if (contentMode !== 'empty') {
      // Pour les parts d>1, on utilise customTextD_greater_than_1 SEULEMENT si on est en mode numérique ET qu'on veut afficher une unité personnalisée fractionnelle
      // Cependant, le mode 'hours' force déjà 'h' et le mode 'numeric' utilise customTextD_greater_than_1 pour déterminer le suffixe 'u' (via getUnitySuffix).
      // On passe customTextD_greater_than_1 (même si non utilisé directement pour le texte fractionnaire) pour garder la cohérence de l'appel.
      const customTextForParts = customTextD_greater_than_1; 
      for (let k = 0; k < d; k++) {
        g.appendChild(textInSector(cx, cy, r, d, k, labelPt, contentMode, textDistRatio, barRatio, barWmm, textOrientation, unitPartDisplay, customTextForParts));
      }
    }
  }

  // 3. Texte Unité (au centre)
  // S'affiche si c'est un disque d=1 OU si c'est un Verso d>1 en mode Unité au centre (isCenterUnit=true)
  if (isCenterUnit || d === 1) { 
    
    // Si c'est d=1, on utilise le mode d=1 et son customTextD1
    // Si c'est d>1, on utilise le mode d>1 et son customTextD_greater_than_1
    const modeToUse = contentMode.replace('unit_', '');
    const customTextToUse = (d === 1) ? customTextD1 : customTextD_greater_than_1;

    // Déterminer le contenu affiché (le customTextToUse est ignoré sauf si modeToUse === 'custom')
    const unitText = getUnitCenterText(modeToUse, customTextToUse);
        
    const t = document.createElementNS("http://www.w3.org/2000/svg","text");
    t.setAttribute("x", cx); t.setAttribute("y", cy);
    t.setAttribute("text-anchor","middle"); t.setAttribute("dominant-baseline","middle");
    t.setAttribute("font-size", labelPt * 1.5 +"pt"); // Texte central 1.5x plus grand
    t.textContent = unitText;
    g.appendChild(t);
  }

  return g;
}

// Fonction de dessin de la page 
function drawPage(discs, {N_cols, N_rows, discGap, rectoOffX, rectoOffY, versoOff, isVersoPage, ...opts}){
  const page = document.createElement("div");
  page.className = "page";
  page.style.width = mm(W);
  page.style.height = mm(H);

  const totalSlots = N_cols * N_rows;
  
  if (totalSlots === 0 || discs.length === 0) {
      page.innerHTML = `<div style="text-align:center; padding-top: 10mm; font-size: 14pt; color: #888;">Configuration de disques (Lignes/Colonnes) invalide.</div>`;
      return page;
  }
  
  // CALCUL du diamètre des disques pour qu'ils rentrent tous
  const maxDiscDiameterW = (W - (N_cols + 1) * discGap) / N_cols;
  const maxDiscDiameterH = (H - (N_rows + 1) * discGap) / N_rows;
  const discDiameter = Math.min(maxDiscDiameterW, maxDiscDiameterH);

  if (discDiameter < 10) {
     page.innerHTML = `<div style="text-align:center; padding-top: 10mm; font-size: 14pt; color: #888;">Les disques sont trop petits. Réduisez le nombre de lignes/colonnes ou l'écart. (Diamètre calculé: ${discDiameter.toFixed(1)}mm)</div>`;
     return page;
  }
  
  const radius = discDiameter / 2;
  const unitSize = discDiameter + discGap;

  // Espace inutilisé à distribuer pour le centrage
  const totalUsedW = N_cols * unitSize + discGap;
  const totalUsedH = N_rows * unitSize + discGap;
  
  let startX = (W - totalUsedW) / 2;
  let startY = (H - totalUsedH) / 2;
  
  // LOGIQUE D'OFFSET: utilisation de isVersoPage
  const currentOffset = isVersoPage ? versoOff : {x: rectoOffX, y: rectoOffY};
  startX += currentOffset.x;
  startY += currentOffset.y;

  const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
  svg.setAttribute("xmlns","http://www.w3.org/2000/svg");
  svg.setAttribute("width", mm(W)); svg.setAttribute("height", mm(H));
  svg.setAttribute("viewBox", `0 0 ${W} ${H}`);

  discs.forEach((disc, index) => {
    const i = index % N_cols;
    const j = Math.floor(index / N_cols);
    
    // Centre du disque
    const cx = startX + i * unitSize + radius + discGap;
    const cy = startY + j * unitSize + radius + discGap;
    
    // disc.contentMode est le mode de contenu pour ce disque spécifique
    const discEl = discSVG(
      radius, cx, cy, disc.denom, disc.contentMode, opts.labelPt, opts.dash, opts.frameW, opts.dotW, opts.colorMode, 
      opts.innerBorders, opts.customTextD1, opts.customTextD_greater_than_1, 
      opts.textDistRatio, opts.barRatio, opts.barW, opts.textOrientation, opts.unitPartDisplay
    );
    svg.appendChild(discEl);
  });
  
  page.appendChild(svg);
  return page;
}

function parseDenoms(s){ return s.split(",").map(v=>parseInt(v.trim(),10)).filter(v=>!isNaN(v) && v > 0); }

// Détermine le mode d'unité Recto basé sur le contenu des segments
function getUnitD1CenterMode(contentRecto) {
    if (contentRecto === 'percentage') return 'percent';
    if (contentRecto === 'degrees') return 'degrees';
    if (contentRecto === 'minutes') return 'minutes';
    if (contentRecto === 'hours') return 'hours_unit'; 
    if (contentRecto === 'numeric') return 'numeric'; 
    return 'unit_standard';
}


function generate(){
  // Récupération des paramètres
  const N_cols = parseInt(document.getElementById("N_cols").value);
  const N_rows = parseInt(document.getElementById("N_rows").value);
  const discGap = parseFloat(document.getElementById("discGap").value);
  const rectoOffX = parseFloat(document.getElementById("rectoOffX").value)||0;
  const rectoOffY = parseFloat(document.getElementById("rectoOffY").value)||0;
  const denoms = parseDenoms(document.getElementById("denoms").value);
  
  // Styles uniformes (utilisés par Recto et Verso)
  const labelPt = parseFloat(document.getElementById("labelPt").value);
  const dashStyle = document.getElementById("dashStyle").value; 
  const dash = dashStyle;
  const frameW = parseFloat(document.getElementById("frameW").value);
  const dotW = parseFloat(document.getElementById("dotW").value);
  const colorMode = document.getElementById("colorMode").value; 
  const innerBorders = document.getElementById("innerBorders").value; 
  
  // Paramètres Recto
  const contentRecto = document.getElementById("contentRecto").value; 
  const barRatio = parseFloat(document.getElementById("barRatio").value);
  const barW = parseFloat(document.getElementById("barW").value);
  const textDistRatio = parseFloat(document.getElementById("textDistRatio").value);
  const textOrientation = document.getElementById("textOrientation").value;
  const unitPartDisplay = document.getElementById("unitPartDisplay").value;
  
  // Paramètres Verso
  const versoContentType = document.getElementById("versoContentType").value; // unit_center ou segmented
  const contentVerso = document.getElementById("contentVerso").value; // numeric, percentage, etc. (si segmented)
  const unitCenterModeD_greater_than_1 = document.getElementById("unitCenterModeD_greater_than_1").value; // d > 1 Verso (si unit_center)
  const unitD1VersoContentMode = document.getElementById("unitD1VersoContentMode").value; // d = 1 Verso (spécifique)
  
  // MODES D'IMPRESSION
  const mode = document.getElementById("mode").value; 
  
  // NOUVEAUX CHAMPS TEXTE PERSONNALISÉS
  const customTextD_greater_than_1 = document.getElementById("customTextD_greater_than_1").value || '1 unité';
  const customTextD1 = document.getElementById("customTextD1").value || '1 unité';


  const offX = parseFloat(document.getElementById("offX").value)||0;
  const offY = parseFloat(document.getElementById("offY").value)||0;
  const versoOff = {x: offX, y: offY};

  const preview = document.getElementById("preview");
  preview.innerHTML = "";
  const push = (el)=>preview.appendChild(el);
  
  const totalDiscsPerPage = N_cols * N_rows;
  if (totalDiscsPerPage === 0 || isNaN(N_cols) || isNaN(N_rows)) {
     preview.innerHTML = `<div style="text-align:center; padding-top: 10mm; font-size: 14pt; color: #888;">Veuillez spécifier un nombre valide de Disques par ligne et par colonne.</div>`;
     return;
  }
  
  const baseOptions = { N_cols, N_rows, discGap, rectoOffX, rectoOffY, versoOff, labelPt, dash, frameW, dotW, colorMode, innerBorders, customTextD1, customTextD_greater_than_1, textDistRatio, barRatio, barW, textOrientation, unitPartDisplay };

  // Filtrer et trier les dénominateurs uniques
  let actualDenoms = [...new Set(denoms)].sort((a,b) => a - b);
  
  // Déterminer le mode d'unité Recto basé sur le contenu des segments
  const unitD1RectoMode = getUnitD1CenterMode(contentRecto);

  // Logique de génération par page
  const generatePage = (denom, contentMode, isVersoPage) => {
    const discs = Array(totalDiscsPerPage).fill(null).map(() => ({
        denom: denom, 
        contentMode: contentMode,
    }));
    return drawPage(discs, {...baseOptions, isVersoPage: isVersoPage});
  };
  
  // --- DÉBUT DE LA LOGIQUE DE GÉNÉRATION ---
  
  for(const d of actualDenoms){
      
      let rectoContent, versoContent;
      
      if (d === 1) {
          // 1. D=1 RECTO: Toujours 'unit_' basé sur contentRecto
          rectoContent = `unit_${unitD1RectoMode}`; 
          
          // 2. D=1 VERSO: Basé sur le sélecteur spécifique unitD1VersoContentMode
          let actualUnitD1VersoMode;
          if (unitD1VersoContentMode === 'same_as_recto') {
              actualUnitD1VersoMode = unitD1RectoMode;
          } else {
              actualUnitD1VersoMode = unitD1VersoContentMode;
          }
          versoContent = `unit_${actualUnitD1VersoMode}`; 

      } else { // d > 1
          // 3. D>1 RECTO: ContentRecto (Segments)
          rectoContent = contentRecto;
          
          // 4. D>1 VERSO: Segmenté ou Unité au centre (avec héritage si nécessaire)
          if (versoContentType === 'unit_center') {
            let unitModeDgt1 = unitCenterModeD_greater_than_1;
            if(unitModeDgt1 === 'same_as_recto_unit'){
                unitModeDgt1 = unitD1RectoMode; 
            }
            versoContent = `unit_${unitModeDgt1}`;
          } else { // Segmented
            versoContent = contentVerso;
          }
      }

      // Génération des pages selon le mode d'impression
      if (mode === "recto_only") {
          push(generatePage(d, rectoContent, false));
      } else if (mode === "verso_only") {
          push(generatePage(d, versoContent, true));
      } else if (mode === "interleaved") { 
          push(generatePage(d, rectoContent, false)); 
          push(generatePage(d, versoContent, true)); 
      }
  }
}


document.getElementById("print").addEventListener("click", ()=>{ window.print(); });

// Gérer l'affichage conditionnel des sous-options
function updateUI() {
    const unitD1VersoContentMode = document.getElementById('unitD1VersoContentMode').value;
    const unitCenterModeD_greater_than_1 = document.getElementById('unitCenterModeD_greater_than_1').value;
    const contentRecto = document.getElementById('contentRecto').value;
    const versoContentType = document.getElementById('versoContentType').value;
    const mode = document.getElementById('mode').value;
    
    const unitPartDisplayContainer = document.getElementById('unitPartDisplayContainer');
    
    // NOUVEAUX CHAMPS
    const customTextD_greater_than_1_input = document.getElementById('customTextD_greater_than_1');
    const customTextD1_input = document.getElementById('customTextD1');

    const segmentedVersoOptions = document.getElementById('segmentedVersoOptions');
    const unitCenterVersoOptions = document.getElementById('unitCenterVersoOptions');
    
    // 1. Affichage du champ de texte personnalisé D > 1
    customTextD_greater_than_1_input.style.display = (unitCenterModeD_greater_than_1 === 'custom' && versoContentType === 'unit_center') ? 'block' : 'none';
    
    // 2. Affichage du champ de texte personnalisé D = 1
    customTextD1_input.style.display = (unitD1VersoContentMode === 'custom') ? 'block' : 'none';
    
    // 3. Affichage conditionnel de l'option "Unité fractionnée" 
    const isFractionCompatible = (contentRecto === 'numeric' || contentRecto === 'hours');
    const isRectoMode = (mode === 'recto_only' || mode === 'interleaved');

    if (isFractionCompatible && isRectoMode) {
        unitPartDisplayContainer.style.display = 'block';
    } else {
        unitPartDisplayContainer.style.display = 'none';
    }

    // 4. Affichage conditionnel des options de contenu VERSO (Segmenté ou Unité au centre)
    segmentedVersoOptions.style.display = versoContentType === 'segmented' ? 'block' : 'none';
    unitCenterVersoOptions.style.display = versoContentType === 'unit_center' ? 'block' : 'none';
    
    // Si on passe de unit_center à segmented, masquer le champ d>1 au cas où il était custom.
    if(versoContentType === 'segmented'){
       customTextD_greater_than_1_input.style.display = 'none';
    }
        
    generate();
}

// Gérer tous les changements qui nécessitent une régénération (y compris les champs texte qui ne déclenchent pas 'change' sur 'input')
document.getElementById('form').addEventListener('change', updateUI);

// Écouter spécifiquement l'entrée sur les champs numériques ou de texte pour la mise à jour en direct (ou presque)
document.getElementById('form').addEventListener('input', (e) => {
    const targetId = e.target.id;
    if (['N_cols', 'N_rows', 'discGap', 'denoms', 'customTextD_greater_than_1', 'customTextD1', 'rectoOffX', 'rectoOffY', 'offX', 'offY', 'labelPt', 'textDistRatio', 'barRatio', 'barW', 'dotW', 'frameW'].includes(targetId)) {
        generate();
    }
});


// Générer au chargement
window.addEventListener("load", updateUI);
</script>
</body>
</html>
