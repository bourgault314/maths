<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<title>Générateur PRO — Fractions (Bandes)</title>
<style>
  :root { --page-w: 297mm; --page-h: 210mm; }
  *{ box-sizing:border-box; }
  body{ font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:0; }
  
  /* EN-TÊTE ET NOM FINAL */
  header{ 
      padding:10px 14px; 
      background:#111; 
      color:#fff; 
      font-size:14px; 
      display: flex;
      justify-content: space-between; 
      align-items: center;
      flex-shrink: 0; 
  }
  header #return-link {
      color: #ccc;
      text-decoration: none;
      font-weight: 500;
      margin-right: auto; 
  }
  header #return-link:hover {
      color: #fff;
      text-decoration: underline;
  }
  header span {
      flex-grow: 1;
      text-align: center;
      white-space: nowrap; 
  }
  header div {
      width: auto; 
      margin-left: auto; 
  }
  
  /* Correction du bug de défilement (hauteur main ajustée) */
  main{ 
      display:grid; 
      grid-template-columns: 360px 1fr; 
      gap:14px; 
      height: calc(100vh - 46px); 
  }
  
  /* STYLE DES CONTRÔLES (Fixe la hauteur totale) */
  .controls { 
      height: 100%; 
      display: flex; 
      flex-direction: column; 
  }
  /* Correction de l'overflow pour le menu principal */
  #settings-scroll-area {
      flex-grow: 1; 
      overflow-y: auto; 
      padding-right: 8px; 
      padding-top: 10px; 
      -webkit-overflow-scrolling: touch; 
  }
  
  fieldset{ border:1px solid #ddd; border-radius:8px; margin:0 0 10px 0; }
  legend{ padding:0 6px; font-weight:600; }
  
  label{ 
      display:block; 
      font-size:13px; 
      margin: 0; 
      padding-top: 8px; 
      padding-bottom: 2px; 
      line-height: 1.2; 
  }

  .row{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }
  .row > div {
      display: flex;
      flex-direction: column; 
  }
  
  input, select{ width:100%; padding:8px; font-size:14px; }

  .actions{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
  button{ padding:9px 10px; font-weight:600; font-size:14px; cursor:pointer; }
  
  /* FIX UI: La zone d'aperçu prend la hauteur totale (alignée sur les contrôles) */
  .preview{ 
    background:#f6f7f9; 
    border:1px solid #e2e3e6; 
    border-radius:8px; 
    padding:4px; /* Rétablit l'espace gris autour */
    overflow:auto; 
    height: 100%; 
  }
  
  /* FIX CLÉ: Nouvelle mise en page des pages A4 (alignement top-left pour l'aperçu) */
  .page{ 
    width: var(--page-w); 
    height: var(--page-h); 
    background:white; 
    /* Espace minimal entre les pages */
    margin: 0 0 1mm 0; 
    position: relative; 
    border: 1px dashed #cfd6e3; 
    
    /* Zoom pour visualiser la page A4 entière */
    transform: scale(0.85); 
    transform-origin: top left;
  }
  
  @media print{
    header, .controls { display:none !important; }
    main{ display:block; padding:0; height:auto; } 
    .preview{ border:none; padding:0; height:auto; }
    /* Annulation du zoom et de la marge pour l'impression 1:1 */
    .page{ break-after: page; page-break-after: always; border:none; margin:0; transform: none; }
    @page { size: A4 landscape; margin: 0; }
  }
</style>
</head>
<body>
<header>
    <a href="https://bourgault314.github.io/maths/outils/" id="return-link">← Index des outils</a>
    <span>GÉNÉRATEUR PRO — FRACTIONS | Imprimer en Recto-Verso bord long</span>
    <div style="width: auto; margin-left: auto;"></div> 
</header>
<main>
  <section class="controls">
    <form id="form">
    
      <fieldset id="actions-fieldset">
        <legend>Actions</legend>
        <div class="actions">
          <button type="button" id="print">Imprimer / Export PDF</button>
        </div>
      </fieldset>

      <div id="settings-scroll-area">
          
          <fieldset>
            <legend>Style/Dimensions Communs</legend>
            <div class="row">
              <div>
                <label>Longueur bande (mm)</label>
                <input type="number" id="bandLen" step="0.1" value="210">
              </div>
              <div>
                <label>Hauteur de la bande (mm)</label>
                <input type="number" id="bandHeight" step="0.1" value="55">
              </div>
            </div>
            <div>
              <label>Écart vertical entre les bandes (mm)</label>
              <input type="number" id="gapV" step="0.1" value="7">
            </div>
            <div>
                <label>Style des fonds</label>
                <select id="colorMode">
                    <option value="white" selected>Uniforme (Blanc)</option>
                    <option value="colored">Couleurs Pédagogiques</option>
                </select>
            </div>
          </fieldset>
    
          <fieldset>
            <legend>Décalages / Alignement (mm)</legend>
            <div class="row">
              <div>
                <label>Décalage horizontal RECTO</label>
                <input type="number" id="rectoOffX" step="0.1" value="-2">
              </div>
              <div>
                <label>Décalage vertical RECTO</label>
                <input type="number" id="rectoOffY" step="0.1" value="0">
              </div>
            </div>
            <div class="row">
              <div>
                <label>Décalage horizontal VERSO</label>
                <input type="number" id="offX" step="0.1" value="0">
              </div>
              <div>
                <label>Décalage vertical VERSO</label>
                <input type="number" id="offY" step="0.1" value="0">
              </div>
            </div>
          </fieldset>

          <fieldset>
            <legend>Dénominateurs</legend>
            <label>Dénominateurs (ex: 1,2,3,4,5,6,8,10)</label>
            <input type="text" id="denoms" value="1,2,3,4,5,6,8,10">
            <p style="font-size: 11px; margin: 5px 0 0;">(Le '1' inclut ou exclut la bande unité)</p>
          </fieldset>
    
          <fieldset>
            <legend>Style RECTO (Première Face)</legend>
            
            <div class="row">
              <div>
                <label>Épaisseur contour (mm)</label>
                <input type="number" id="frameWRecto" step="0.01" value="0.10">
              </div>
              <div>
                <label>Taille de l'écriture (pt)</label>
                <input type="number" id="labelPtRecto" step="1" value="12">
              </div>
            </div>

            <div class="row">
              <div>
                <label>Bordures intérieures</label>
                <select id="innerBordersRecto">
                    <option value="visible" selected>Visibles</option>
                    <option value="hidden">Masquées (bandes vierges)</option>
                </select>
              </div>
              <div>
                <label>Orientation du texte</label>
                <select id="textOrientationRecto">
                  <option value="auto" selected>Automatique (Vertical pour En lettres)</option>
                  <option value="vertical">Vertical (90°)</option>
                  <option value="horizontal">Horizontal (0°)</option>
                </select>
              </div>
            </div>
            
            <div class="row">
              <div>
                <label>Épaisseur pointillés (mm)</label>
                <input type="number" id="dotWRecto" step="0.01" value="0.10">
              </div>
              <div>
                <label>Pointillés (motif, ex: 3,3)</label>
                <input type="text" id="dashRecto" value="3,3">
                <p style="font-size: 11px; margin: 5px 0 0;">(Mettre '0' ou vide pour un trait plein)</p>
              </div>
            </div>
            
            <label style="font-weight: 600; margin-top: 10px;">Style des fractions (d>1, d=1)</label>
            <div style="font-size: 11px; padding: 5px 0;">
                (Longueur barre: 80%, Épaisseur barre: 0.10mm, Espacements auto.)
            </div>
            
            <label style="font-weight: 600; margin-top: 10px;">Contenus RECTO</label>
            
            <label>Contenu de la bande UNITÉ (d=1) - RECTO</label>
            <select id="unitModeRecto"> 
                <option value="numeric_one">1 (Unité numérique)</option>
                <option value="unit" selected>1 unité</option> 
                <option value="one-on-one">1/1 (Fraction)</option>
                <option value="percent">100 %</option>
                <option value="minutes">60 min</option>
                <option value="hours_unit">1 heure</option> 
                <option value="degrees_unit">360 degrés</option> 
                <option value="custom">Texte personnalisé</option>
                <option value="empty">Vide (pas de texte)</option>
            </select>
            <input type="text" id="customTextRecto" value="1 unité" placeholder="Ex: 1 unité" style="margin-top: 5px; display: none;">

            <label>Contenu des parts RECTO (d>1)</label>
            <select id="contentRecto"> 
              <option value="numeric" selected>Écriture fractionnaire (1/2, 1/4)</option>
              <option value="numeric_unit">Écriture fractionnaire avec unité (1/2 u)</option>
              <option value="decimal">Décimal (0,5, 0,25)</option>
              <option value="decimal_unit">Décimal avec unité (0,5 u)</option>
              <option value="percentage">Pourcentage (X %)</option>
              <option value="minutes">Temps (X min)</option>
              <option value="hours_fractional">Temps (1/d h)</option> 
              <option value="letters">En lettres (Un demi, Un tiers...)</option>
              <option value="empty">Vide (pas de texte)</option>
            </select>
            </fieldset>
    
          <fieldset>
            <legend>Style VERSO (Double-Face)</legend>
            
            <label>Structure des bandes (d>1)</label>
            <select id="versoStructureDgt1">
                <option value="unit_center" selected>Unité au centre (Non divisée)</option>
                <option value="segmented">Divisée en d parts (Fractionnée)</option>
            </select>

            <label style="font-weight: 600; margin-top: 10px;">Paramètres de style VERSO</label>
            <div class="row">
              <div>
                <label>Épaisseur contour (mm)</label>
                <input type="number" id="frameWVerso" step="0.01" value="0.10">
              </div>
              <div>
                <label>Taille de l'écriture (pt)</label>
                <input type="number" id="labelPtVerso" step="1" value="12">
              </div>
            </div>

            <div class="row">
              <div>
                <label>Bordures intérieures (Séparations)</label>
                <select id="innerBordersVerso">
                    <option value="visible" selected>Visibles</option>
                    <option value="hidden">Masquées (bandes vierges)</option>
                </select>
              </div>
              <div>
                <label>Orientation du texte</label>
                <select id="textOrientationVerso">
                  <option value="auto" selected>Automatique (Vertical pour En lettres)</option>
                  <option value="vertical">Vertical (90°)</option>
                  <option value="horizontal">Horizontal (0°)</option>
                </select>
              </div>
            </div>
            
            <div class="row">
              <div>
                <label>Épaisseur pointillés (mm)</label>
                <input type="number" id="dotWVerso" step="0.01" value="0.10">
              </div>
              <div>
                <label>Pointillés (motif, ex: 3,3)</label>
                <input type="text" id="dashVerso" value="3,3">
                <p style="font-size: 11px; margin: 5px 0 0;">(Mettre '0' ou vide pour un trait plein)</p>
              </div>
            </div>
            
            <label>Style des fractions (d>1, d=1)</label>
            <div style="font-size: 11px; padding: 5px 0;">
                (Longueur barre: 80%, Épaisseur barre: 0.10mm, Espacements auto.)
            </div>
            
            
            <label style="font-weight: 600; margin-top: 10px;">Contenus VERSO</label>
            
            <label>Contenu de la bande UNITÉ (d=1) - VERSO</label>
            <select id="unitModeVersoD1">
                <option value="same_as_recto" selected>Identique au Recto</option>
                <option value="numeric_one">1 (Unité numérique)</option>
                <option value="unit">1 unité</option>
                <option value="one-on-one">1/1 (Fraction)</option>
                <option value="percent">100 %</option>
                <option value="minutes">60 min</option>
                <option value="hours_unit">1 heure</option>
                <option value="degrees_unit">360 degrés</option>
                <option value="custom">Texte personnalisé</option>
                <option value="empty">Vide (pas de texte)</option>
            </select>
            <input type="text" id="customTextVersoD1" value="1 unité (Verso D=1)" placeholder="Ex: 1 unité (Verso D=1)" style="margin-top: 5px; display: none;">

            
            <div id="segmentedVersoOptions" style="display: none;">
                <label>Contenu des parts VERSO (d>1) [Fractionnée]</label>
                <select id="contentVersoDgt1">
                    <option value="same_as_recto" selected>Identique au Recto</option>
                    <option value="numeric">Écriture fractionnaire (1/2, 1/4)</option>
                    <option value="numeric_unit">Écriture fractionnaire avec unité (1/2 u)</option>
                    <option value="decimal">Décimal (0,5, 0,25)</option>
                    <option value="decimal_unit">Décimal avec unité (0,5 u)</option>
                    <option value="percentage">Pourcentage (X %)</option>
                    <option value="minutes">Temps (X min)</option>
                    <option value="hours_fractional">Temps (1/d h)</option>
                    <option value="letters">En lettres (Un demi, Un tiers...)</option>
                    <option value="empty">Vide (pas de texte)</option>
                </select>
            </div>

            <div id="unitCenterVersoOptions">
                <label>Contenu d'unité VERSO (d>1 & Non divisé)</label>
                <select id="unitModeVersoDgt1">
                    <option value="unit" selected>1 unité</option> <option value="numeric_one">1 (Unité numérique)</option>
                    <option value="one-on-one">1/1 (Fraction)</option>
                    <option value="percent">100 %</option>
                    <option value="minutes">60 min</option>
                    <option value="hours_unit">1 heure</option>
                    <option value="degrees_unit">360 degrés</option>
                    <option value="custom">Texte personnalisé</option>
                    <option value="empty">Vide (pas de texte)</option>
                </select>
                <input type="text" id="customTextVersoDgt1" value="1 unité (Verso D>1)" placeholder="Ex: 1 unité (Verso D>1)" style="margin-top: 5px; display: none;">
            </div>
          </fieldset>
          
          <fieldset>
            <legend>Mode d'impression (Séquence)</legend>
            <div class="row">
              <div>
                <label>Séquence de bandes</label>
                <select id="mode">
                  <option value="recto_only">Recto Seul (Fractions)</option>
                  <option value="verso_only">Verso Seul (Unités/Autres)</option>
                  <option value="recto_verso_alternating" selected>Recto / Verso Alterné (R/V pour chaque d)</option> 
                </select>
              </div>
              <div style="visibility: hidden;"> 
                <label>&nbsp;</label>
                <select disabled><option></option></select>
              </div>
            </div>
          </fieldset>
          
      </div> </form>
  </section>

  <section class="preview" id="preview"></section>
</main>

<script>
const W = 297; // mm (A4 paysage)
const H = 210; // mm
function mm(v){ return v + "mm"; }
const SVG_NS = "http://www.w3.org/2000/svg";

const denomToLetters = {
    1: "Une unité", 2: "Un demi", 3: "Un tiers", 4: "Un quart", 5: "Un cinquième", 
    6: "Un sixième", 7: "Un septième", 8: "Un huitième", 9: "Un neuvième", 
    10: "Un dixième", 11: "Un onzième", 12: "Un douzième", 
};

const denomColors = {
    1: '#fff', 2: '#ffb3b3', 3: '#6699ff', 4: '#b3ffc6', 5: '#ff9966', 
    6: '#e0b3ff', 7: '#99ccff', 8: '#ccff99', 9: '#ffccff', 10: '#ffffb3', 
    11: '#cc99ff', 12: '#99ffff',
};

// VALEURS DE STYLE DE FRACTION FIXES
const FIXED_BAR_RATIO = 80;
const FIXED_BAR_WM M = 0.10;


/**
 * Détermine le symbole d'unité à utiliser pour les segments d>1
 */
function getUnitSymbolFromContentMode(contentMode) {
    if (contentMode === 'numeric_unit' || contentMode === 'decimal_unit') return 'u';
    if (contentMode === 'hours_fractional') return 'h';
    return ''; 
}

/**
 * Récupère le texte de la part fractionnaire (d>1) pour les modes non-fractionnaires.
 */
function getTextContent(d, contentMode, segmentUnitSymbol){
    const val = 1 / d;
    let partText = '';
    
    if (contentMode === 'percentage') {
        let valStr = Number((val * 100).toFixed(2));
        // MODIFICATION: Collage du %
        partText = `${valStr.toString().replace('.', ',')}%`; 
    } else if (contentMode === 'minutes') {
        const minVal = val * 60;
        if (Number.isInteger(minVal)) { 
            // MODIFICATION: Collage du min
            partText = `${minVal}min`; 
        } 
        else { 
            // MODIFICATION: Collage du min
            partText = `${minVal.toFixed(1)}min`; 
        }
    } else if (contentMode === 'decimal' || contentMode === 'decimal_unit') { 
        const formatter = new Intl.NumberFormat('fr-FR', { 
            minimumFractionDigits: 1, 
            maximumFractionDigits: 3 
        });
        partText = formatter.format(val).replace(/(\.0+)?$/, '');
        
        // Applique le suffixe d'unité uniquement pour decimal_unit
        if (contentMode === 'decimal_unit' && segmentUnitSymbol !== '') { 
            // MODIFICATION: Collage du u
            return `${partText}${segmentUnitSymbol}`;
        }
        return partText;
        
    } else if (contentMode === 'letters') {
         return denomToLetters[d] || ("1/"+d);
    } else {
        return '';
    } 

    return partText;
}

/**
 * Récupère le texte de la bande UNITE.
 */
function getUnityText(currentUnitMode, currentCustomText, rectoUnitMode, rectoCustomText) {
    let finalMode = currentUnitMode;
    let finalCustomText = currentCustomText;
    
    // Gérer l'option 'Identique au Recto'. Cette option n'existe que pour D=1 Verso.
    if (currentUnitMode === 'same_as_recto') {
        finalMode = rectoUnitMode;
        finalCustomText = rectoCustomText;
    }

    if (finalMode === 'numeric_one') return '1';
    if (finalMode === 'unit') return '1 unité'; 
    if (finalMode === 'one-on-one') return 'fraction'; // Signal pour utiliser fracSVG (1/1)
    
    // MODIFICATIONS: Collage des unités
    if (finalMode === 'percent') return '100%'; 
    if (finalMode === 'minutes') return '60min'; 
    if (finalMode === 'degrees_unit') return '360°';

    if (finalMode === 'hours_unit') return '1 heure'; 
    if (finalMode === 'empty') return ''; 
    return finalCustomText; // 'custom' mode
}

/**
 * Détermine la rotation à appliquer au texte.
 */
function getRotation(contentMode, textOrientation) {
    let rotation = 0;
    if (textOrientation === 'horizontal') { rotation = 0; } 
    else if (textOrientation === 'vertical') { rotation = 90; } 
    else { // auto
        if (contentMode === 'letters') { rotation = 90; } 
        else { rotation = 0; }
    }
    return rotation;
}

/**
 * Génère le groupe SVG pour une part de fraction (y compris la barre horizontale)
 * Les paramètres gapTop et gapBottom sont fixés à 0.20 et 0.00 (facteurs de sizePt).
 */
function fracSVG(cx, cy, sizePt, d, barRatio, barWmm, contentMode, textOrientation, segmentUnitSymbol, isUnitD1 = false){
    const g = document.createElementNS(SVG_NS,"g");
    
    if(contentMode === "empty" && !isUnitD1){
        return g;
    } 

    const isFractionalContent = contentMode === 'numeric' || contentMode === 'numeric_unit' || contentMode === 'hours_fractional' || (isUnitD1 && contentMode === 'one-on-one');
    
    // VALEURS OPTIMALES FIXÉES : Numérateur 0.20, Dénominateur 0.00
    const gapAboveBar = sizePt * 0.20; 
    const gapBelowBar = sizePt * 0.00; 
    
    const barRatioFloat = (barRatio ?? FIXED_BAR_RATIO);
    const sizePx = sizePt * 96/72; // Conversion pt -> px (approximatif pour le ratio)
    const halfBar = sizePx * (barRatioFloat / 200);

    const rotation = getRotation(contentMode, textOrientation);
    const rotationTransform = rotation !== 0 ? `rotate(${rotation}, ${cx}, ${cy})` : '';

    // CAS 1: Mode Fractionnaire
    if(isFractionalContent){
        
        const num = isUnitD1 ? "1" : "1";
        const denomStr = isUnitD1 ? "1" : String(d);
        
        // Numérateur
        const n = document.createElementNS(SVG_NS,"text");
        n.setAttribute("x", cx); 
        n.setAttribute("y", cy - gapAboveBar); 
        n.setAttribute("font-size", sizePt+"pt");
        n.setAttribute("text-anchor","middle");
        n.setAttribute("dominant-baseline","baseline");
        n.setAttribute("transform", rotationTransform); 
        n.textContent = num;

        // Dénominateur
        const dd = document.createElementNS(SVG_NS,"text");
        dd.setAttribute("x", cx); 
        dd.setAttribute("y", cy + gapBelowBar); 
        dd.setAttribute("font-size", sizePt+"pt");
        dd.setAttribute("text-anchor","middle");
        dd.setAttribute("dominant-baseline","hanging");
        dd.setAttribute("transform", rotationTransform); 
        dd.textContent = denomStr;
        
        // Barre de fraction
        const line = document.createElementNS(SVG_NS,"line");
        line.setAttribute("x1", cx - halfBar); line.setAttribute("x2", cx + halfBar);
        line.setAttribute("y1", cy); line.setAttribute("y2", cy);
        line.setAttribute("stroke","black");
        line.setAttribute("stroke-width", mm(barWmm ?? FIXED_BAR_WM M));
        line.setAttribute("transform", rotationTransform); 

        g.appendChild(n); g.appendChild(dd); g.appendChild(line);

        // Ajout de l'unité
        const isHoursFractional = contentMode === 'hours_fractional';
        const isNumericUnit = contentMode === 'numeric_unit' && !isUnitD1;
        
        if(isHoursFractional || isNumericUnit){
            const unitText = document.createElementNS(SVG_NS,"text");
            // MODIFICATION: Collage du 'h' / 'u'
            const unitSuffix = isHoursFractional ? 'h' : segmentUnitSymbol; 
            
            const startX = cx + halfBar + sizePt * 0.05; 
            
            unitText.setAttribute("x", startX); unitText.setAttribute("y", cy);
            unitText.setAttribute("font-size", sizePt+"pt");
            unitText.setAttribute("text-anchor","start");
            unitText.setAttribute("dominant-baseline","middle");
            unitText.setAttribute("transform", rotationTransform); 
            unitText.textContent = unitSuffix; 
            g.appendChild(unitText);
        }

        return g;
    }
    
    // CAS 2: Mode Texte Simple
    
    const text = getTextContent(d, contentMode, segmentUnitSymbol); 
    
    if (text) {
        const t = document.createElementNS(SVG_NS,"text");
        t.setAttribute("x", cx); t.setAttribute("y", cy);
        t.setAttribute("font-size", sizePt+"pt");
        t.setAttribute("text-anchor","middle");
        t.setAttribute("dominant-baseline","middle");
        t.setAttribute("transform", rotationTransform); 
        t.textContent = text;
        g.appendChild(t);
    }
    
    return g;
}

/**
 * Fonction qui génère le contenu de la bande UNITE.
 */
function unitSVG(cx, cy, sizePt, unitMode, customText, barWmm, rectoUnitMode, rectoCustomText, textOrientation){ 
    const text = getUnityText(unitMode, customText, rectoUnitMode, rectoCustomText);
    
    // Cas spécial: 1/1 (fraction)
    if(text === 'fraction'){
        // fracSVG utilise désormais ses propres valeurs hardcodées pour les gaps
        return fracSVG(cx, cy, sizePt, 1, FIXED_BAR_RATIO, FIXED_BAR_WM M, 'numeric', textOrientation, '', true); 
    }
    
    // Cas général: Texte simple
    if (!text) {
        return document.createElementNS(SVG_NS,"g"); 
    }

    const g = document.createElementNS(SVG_NS,"g");
    const t = document.createElementNS(SVG_NS,"text");
    
    const rotation = getRotation('numeric', textOrientation); 
    const rotationTransform = rotation !== 0 ? `rotate(${rotation}, ${cx}, ${cy})` : '';

    t.setAttribute("x", cx); t.setAttribute("y", cy);
    t.setAttribute("font-size", sizePt+"pt");
    t.setAttribute("text-anchor","middle");
    t.setAttribute("dominant-baseline","middle");
    t.setAttribute("transform", rotationTransform); 
    t.textContent = text;
    g.appendChild(t);
    return g;
}


function drawPage({bandLen, bandHeight, gapV, denom, isVerso, contentMode, colorMode, rectoStyles, versoStyles, rectoUnitInfo, versoUnitInfo}){
  const page = document.createElement("div");
  page.className = "page";

  const svg = document.createElementNS(SVG_NS,"svg");
  svg.setAttribute("xmlns",SVG_NS);
  svg.setAttribute("width", mm(W)); svg.setAttribute("height", mm(H));
  svg.setAttribute("viewBox", `0 0 ${W} ${H}`);

  const safeLen = Math.min(Math.max(10, bandLen), W - 2);
  
  // LOGIQUE DE SÉLECTION DU STYLE R/V
  const styles = isVerso ? versoStyles : rectoStyles;
  const unitInfo = isVerso ? versoUnitInfo : rectoUnitInfo; 
  const offset = isVerso ? {x: styles.offX, y: styles.offY} : {x: styles.rectoOffX, y: styles.rectoOffY};
  
  // LOGIQUE DE CENTRAGE DU CONTENU DANS LA PAGE A4 (MM)
  const baseLeft = (W - safeLen)/2;
  const left = baseLeft + offset.x;
  
  const totalH = 3*bandHeight + 2*gapV;
  const baseTop = (H - totalH)/2;
  const top = baseTop + offset.y; 
  
  const y2 = top;
  const y3 = y2 + bandHeight + gapV;
  const y1 = y3 + bandHeight + gapV;
  const ys = [y1, y3, y2]; 
  
  // COULEUR (basée sur le paramètre commun colorMode)
  const fillColor = (colorMode === 'colored' && denomColors[denom]) ? denomColors[denom] : 'white';
  
  const sepDash = styles.dash.trim() === '0' || styles.dash.trim() === '' ? '0' : styles.dash;

  // DÉTERMINATION DU SYMBOLE D'UNITÉ POUR LES SEGMENTS D>1
  const segmentUnitSymbol = getUnitSymbolFromContentMode(contentMode);

  for(const y0 of ys){
    // 1. DESSIN DE LA BANDE (Contour et Fond)
    const rect = document.createElementNS(SVG_NS,"rect");
    rect.setAttribute("x", left); rect.setAttribute("y", y0);
    rect.setAttribute("width", safeLen); rect.setAttribute("height", bandHeight);
    rect.setAttribute("fill", fillColor); 
    rect.setAttribute("stroke","black");
    rect.setAttribute("stroke-width", mm(styles.frameW));
    svg.appendChild(rect);

    const isD1 = denom === 1;
    const renderAsUnitMode = isD1 || (isVerso && versoStyles.versoStructureDgt1 === 'unit_center');

    if(renderAsUnitMode){
      // 2. CONTENU: Bande unité (d=1) ou Verso non divisé (d>1)
      const cx = left + safeLen/2;
      const cy = y0 + bandHeight/2;
      
      let unitMode, customText;
      
      if(isD1) {
          unitMode = isVerso ? unitInfo.unitModeD1 : rectoUnitInfo.unitMode;
          customText = isVerso ? unitInfo.customTextD1 : rectoUnitInfo.customText;
      } else {
          unitMode = unitInfo.unitModeDgt1;
          customText = unitInfo.customTextDgt1;
      }

      svg.appendChild(unitSVG(
        cx, cy, styles.labelPt, 
        unitMode, customText, 
        styles.barW,
        rectoUnitInfo.unitMode, rectoUnitInfo.customText, 
        styles.textOrientation
      ));
      
    }else{
      // 3. CONTENU: Bandes divisées (Recto d>1 OU Verso d>1 segmented)
      
      // Affichage conditionnel des lignes de séparation (Divisions)
      if (styles.innerBorders === 'visible') {
          for(let k=1;k<denom;k++){
            const x = left + safeLen * k / denom;
            const sep = document.createElementNS(SVG_NS,"line");
            sep.setAttribute("x1", x); sep.setAttribute("x2", x);
            sep.setAttribute("y1", y0); sep.setAttribute("y2", y0 + bandHeight);
            sep.setAttribute("stroke","black"); 
            sep.setAttribute("stroke-width", mm(styles.dotW));
            sep.setAttribute("stroke-dasharray", sepDash); 
            svg.appendChild(sep);
          }
      }

      // Dessin des parts (texte)
      for(let k=0;k<denom;k++){
        const cx = left + safeLen*(k+0.5)/denom;
        const cy = y0 + bandHeight/2;
        
        svg.appendChild(fracSVG(
          cx, cy, 
          styles.labelPt, 
          denom, 
          styles.barRatio, styles.barW, // Ces valeurs sont les FIXED pour le Verso/Recto
          contentMode, styles.textOrientation, 
          segmentUnitSymbol, 
          false
        ));
      }
    }
  }

  page.appendChild(svg);
  return page;
}

/**
 * Lit la liste des dénominateurs et détermine s'il faut inclure la bande unité (1).
 */
function parseDenoms(s){ 
    const allNumbers = s.split(",").map(v=>parseInt(v.trim(),10)).filter(v=>!isNaN(v) && v > 0).sort((a, b) => a - b);
    const denomsList = allNumbers.filter(d => d > 1); 
    const includeUnit = allNumbers.includes(1); 
    return { denomsList, includeUnit };
}

function generate(){
  const form = document.getElementById('form');
  
  // Paramètres Communs
  const bandLen = parseFloat(form.bandLen.value);
  const bandHeight = parseFloat(form.bandHeight.value);
  const gapV = parseFloat(form.gapV.value);
  const colorMode = form.colorMode.value; 
  const { denomsList: denoms, includeUnit } = parseDenoms(form.denoms.value);
  
  // --- PARAMÈTRES RECTO ---
  const rectoStyles = {
      frameW: parseFloat(form.frameWRecto.value),
      labelPt: parseFloat(form.labelPtRecto.value),
      innerBorders: form.innerBordersRecto.value,
      dotW: parseFloat(form.dotWRecto.value),
      dash: form.dashRecto.value,
      // Paramètres de fraction fixés
      barRatio: FIXED_BAR_RATIO,
      barW: FIXED_BAR_WM M,
      
      textOrientation: form.textOrientationRecto.value,
      rectoOffX: parseFloat(form.rectoOffX.value)||0,
      rectoOffY: parseFloat(form.rectoOffY.value)||0,
  };
  const contentRecto = form.contentRecto.value;
  const rectoUnitInfo = {
      unitMode: form.unitModeRecto.value,
      customText: form.customTextRecto.value || '1 unité',
  };

  // --- PARAMÈTRES VERSO ---
  const versoStyles = {
      frameW: parseFloat(form.frameWVerso.value),
      labelPt: parseFloat(form.labelPtVerso.value),
      innerBorders: form.innerBordersVerso.value,
      dotW: parseFloat(form.dotWVerso.value),
      dash: form.dashVerso.value,
      // Paramètres de fraction fixés (même pour le verso)
      barRatio: FIXED_BAR_RATIO,
      barW: FIXED_BAR_WM M,
      
      textOrientation: form.textOrientationVerso.value,
      offX: parseFloat(form.offX.value)||0,
      offY: parseFloat(form.offY.value)||0,
      versoStructureDgt1: form.versoStructureDgt1.value,
  };
  
  const contentVersoSelected = form.contentVersoDgt1.value;
  const contentVersoDgt1 = contentVersoSelected === 'same_as_recto' ? contentRecto : contentVersoSelected;

  // Récupération des deux sets de paramètres d'unité pour le VERSO
  const versoUnitInfo = {
      // D=1 (bande blanche)
      unitModeD1: form.unitModeVersoD1.value,
      customTextD1: form.customTextVersoD1.value || '1 unité (Verso D=1)',
      // D>1 (bandes colorées, mode "Unité au centre")
      unitModeDgt1: form.unitModeVersoDgt1.value, 
      customTextDgt1: form.customTextVersoDgt1.value || '1 unité (Verso D>1)',
  };


  const mode = form.mode.value;
  const preview = document.getElementById("preview");
  preview.innerHTML = "";

  const push = (el)=>preview.appendChild(el);

  // Fonction utilitaire pour générer une page avec le style R ou V
  const draw = (d, isVerso) => {
      const isD1 = d === 1;
      
      let contentMode = '';
      
      if(isVerso){
          if(!isD1 && versoStyles.versoStructureDgt1 === 'segmented'){
             contentMode = contentVersoDgt1;
          }
      } else {
          if(!isD1){
             contentMode = contentRecto;
          }
      }
      
      
      return drawPage({
          bandLen, bandHeight, gapV, denom: d, isVerso, 
          contentMode, 
          colorMode, 
          rectoStyles: rectoStyles, 
          versoStyles: versoStyles, 
          rectoUnitInfo: rectoUnitInfo, 
          versoUnitInfo: versoUnitInfo, 
      });
  };


  // Logique de génération par mode
  
  if (mode === "recto_verso_alternating") {
      if(includeUnit){
          push(draw(1, false)); 
          push(draw(1, true));  
      }
      for(const d of denoms){
          push(draw(d, false)); 
          push(draw(d, true));  
      }
  } 
  
  else if(mode==="recto_only"){
      if(includeUnit){ push(draw(1, false)); }
      for(const d of denoms){ push(draw(d, false)); }
  }
  
  else if(mode==="verso_only"){
      if(includeUnit){ push(draw(1, true)); }
      for(const d of denoms){ push(draw(d, true)); }
  }
}

document.getElementById("print").addEventListener("click", ()=>{ window.print(); });

// Gérer l'affichage du champ de texte personnalisé et l'affichage conditionnel du Verso
function updateUI() {
    const form = document.getElementById('form');
    
    // 1. Affichage des champs de texte personnalisés (D=1 Recto)
    form.customTextRecto.style.display = form.unitModeRecto.value === 'custom' ? 'block' : 'none';
    
    // 2. Affichage des champs de texte personnalisés (D=1 Verso)
    form.customTextVersoD1.style.display = form.unitModeVersoD1.value === 'custom' ? 'block' : 'none';

    // 3. Affichage des options VERSO conditionnelles D>1
    const versoStructureDgt1 = form.versoStructureDgt1.value;
    const segmentedVersoOptions = document.getElementById('segmentedVersoOptions');
    const unitCenterVersoOptions = document.getElementById('unitCenterVersoOptions');
    
    const isRenderedAsUnitDgt1 = (versoStructureDgt1 === 'unit_center');

    if (isRenderedAsUnitDgt1) {
        // En mode "Unité au centre" (Non divisée), on affiche la sélection d'unité D>1
        segmentedVersoOptions.style.display = 'none';
        unitCenterVersoOptions.style.display = 'block';
        // 4. Affichage du champ de texte personnalisé (D>1 Verso - Unité au centre)
        form.customTextVersoDgt1.style.display = form.unitModeVersoDgt1.value === 'custom' ? 'block' : 'none';
    } else {
        // En mode "Divisée en d parts" (Fractionnée), on affiche la sélection de contenu des parts D>1
        segmentedVersoOptions.style.display = 'block';
        unitCenterVersoOptions.style.display = 'none';
    }
    
    // Les paramètres de fraction Verso ont été supprimés du HTML/DOM.
    // L'ancienne logique pour cacher/afficher ces paramètres n'est plus nécessaire.

    // Régénère l'aperçu
    generate();
}

// Écouteurs pour la régénération automatique
document.getElementById('form').addEventListener('change', updateUI);
document.getElementById('form').addEventListener('input', (e) => {
    const targetId = e.target.id;
    // La liste des champs d'écoute a été mise à jour (retrait de tous les réglages de barre de fraction)
    if (['bandLen', 'bandHeight', 'gapV', 'denoms', 'customTextRecto', 'customTextVersoD1', 'customTextVersoDgt1', 'dashRecto', 'dashVerso', 'rectoOffX', 'rectoOffY', 'offX', 'offY', 'labelPtRecto', 'labelPtVerso', 'dotWRecto', 'dotWVerso'].includes(targetId)) {
        updateUI(); 
    }
});


// Initialisation : on charge l'interface et génère l'aperçu
window.addEventListener("load", updateUI);
</script>
</body>
</html>
