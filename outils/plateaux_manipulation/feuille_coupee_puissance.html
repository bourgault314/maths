<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exposants : Narration de Recherche</title>
    <style>
        :root {
            /* --- COULEURS ET DESIGN --- */
            --bg-color: #ffffff;
            --text-color: #0f172a;
            --paper-color: #fbbf24; 
            --paper-border: #92400e; 
            --gap-size: 6px;         
            --toolbar-bg: #f8fafc;
            --btn-radius: 8px;
            --stack-line: #334155; /* Gris fonc√© bleut√©, tr√®s net */
        }

        body.dark-mode {
            --bg-color: #0f172a;
            --text-color: #f1f5f9;
            --paper-color: #facc15;
            --paper-border: #e2e8f0;
            --toolbar-bg: #1e293b;
            --stack-line: #cbd5e1;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- BARRE D'OUTILS --- */
        .toolbar {
            background-color: var(--toolbar-bg);
            padding: 0 20px;
            border-bottom: 2px solid rgba(128,128,128,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 96px;
            flex-shrink: 0;
            box-sizing: border-box;
        }

        .stats-group { display: flex; gap: 20px; align-items: center; }
        .stat-box { display: flex; flex-direction: column; justify-content: center; }
        .stat-label { font-size: clamp(0.85rem, 1.1vw, 1rem); opacity: 0.7; text-transform: uppercase; font-weight: bold; }
        .stat-val { font-size: clamp(1.8rem, 2.2vw, 2.5rem); font-weight: 800; line-height: 1; }
        .math { color: #6366f1; font-family: 'Courier New', monospace; }
        .thick { color: #10b981; }

        .actions-group { display: flex; gap: 12px; align-items: center; }

        button { font-family: 'Segoe UI', sans-serif; transition: all 0.2s; cursor: pointer;}
        
        .btn-enonce {
            background-color: #e0f2fe; color: #0284c7; border: 1px solid #7dd3fc;
            padding: 10px 20px; font-size: 1rem; font-weight: bold; border-radius: var(--btn-radius);
        }
        .btn-enonce:hover { background-color: #bae6fd; transform: translateY(-1px); }

        .btn-cut {
            background-color: #2563eb; color: white; border: none;
            padding: 12px 30px; font-size: 1.1rem; font-weight: bold; 
            border-radius: var(--btn-radius);
            box-shadow: 0 4px 6px rgba(37, 99, 235, 0.3);
        }
        .btn-cut:hover { background-color: #1d4ed8; transform: translateY(-2px); }
        .btn-cut:disabled { background: #94a3b8; cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none;}

        .btn-icon {
            background: transparent; border: 1px solid rgba(128,128,128,0.4); 
            padding: 10px 14px; border-radius: var(--btn-radius); 
            color: var(--text-color); font-weight: 600; font-size: 1rem;
        }
        .btn-icon:hover { background: rgba(128,128,128,0.1); }
        .btn-danger { color: #ef4444; border-color: #ef4444; }

        /* --- ZONE VISUELLE --- */
        .visual-area {
            flex-grow: 1;
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
        }

        /* --- VUE GRILLE --- */
        #paper-container {
            width: 100%; height: 100%;
            aspect-ratio: 1.3 / 1; 
            display: grid;
            gap: var(--gap-size);
            justify-content: center; align-content: center;
        }

        .sheet {
            background-color: var(--paper-color);
            border: 1px solid var(--paper-border);
            display: flex; justify-content: center; align-items: center;
            color: #78350f; font-weight: bold; font-size: 1rem;
            position: relative;
            width: 100%; height: 100%;
        }
        .cut-v { position: absolute; top:0; left:50%; width:0; height:100%; border-left: 2px dashed #ef4444; opacity: 0; }
        .cut-h { position: absolute; top:50%; left:0; width:100%; height:0; border-top: 2px dashed #ef4444; opacity: 0; }
        .animating .cut-v, .animating .cut-h { opacity: 1; }
        .animating { animation: tremble 0.4s ease-in-out; }
        @keyframes tremble { 0%,100%{transform:rotate(0deg);} 25%{transform:rotate(1deg);} 75%{transform:rotate(-1deg);} }

        /* --- VUE PILE (Nouvelle config large et a√©r√©e) --- */
        .btn-stack {
            background-color: #fef3c7; color: #92400e;
            border: 1px solid #fcd34d; padding: 10px 16px;
            font-size: 1rem; font-weight: 800; border-radius: var(--btn-radius);
        }
        .btn-stack:hover { background-color: #fde68a; transform: translateY(-1px); }
        .btn-stack.active { box-shadow: inset 0 0 0 2px rgba(146, 64, 14, 0.35); }
        
        body.dark-mode .btn-stack {
            background-color: rgba(252, 211, 77, 0.15); border-color: rgba(252, 211, 77, 0.35); color: #fde68a;
        }

        #stack-container {
            width: 100%; height: 100%;
            display: none; justify-content: center; align-items: center; box-sizing: border-box;
        }

        .stack-wrap {
            width: 100%; height: 100%;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            gap: 20px; padding: 10px; box-sizing: border-box;
        }

        #stack-drawing {
            width: 100%; height: 75vh;
            display: flex; align-items: flex-end; justify-content: center;
            position: relative;
        }

        /* --- CONFIGURATION DES FEUILLES --- */
        .line-pack {
            position: relative;
            /* LARGEUR AUGMENT√âE (√©tait 300px) */
            width: 540px; 
            display: flex; flex-direction: column-reverse; /* Empile vers le haut */
        }

        .line {
            width: 100%;
            /* HAUTEUR FINE MAIS VISIBLE */
            height: 2px;
            background: var(--stack-line);
            border-radius: 2px;
            /* GRAND √âCART POUR √âVITER L'EFFET BIZARRE */
            margin-bottom: 3px; 
            flex-shrink: 0;
        }

        /* Animation de coupe */
        .stack-anim-container {
            position: absolute; bottom: 0; left: 50%;
            transform: translateX(-50%);
            width: 540px; /* Doit matcher line-pack */
            height: auto;
            display: flex; align-items: flex-end; justify-content: center;
            pointer-events: none;
        }

        .anim-half {
            width: 270px; /* Moiti√© de 540px */
            display: flex; flex-direction: column-reverse;
            position: relative;
        }
        
        .anim-lift {
            animation: liftOver 0.9s cubic-bezier(0.45, 0, 0.55, 1) forwards;
        }

        @keyframes liftOver {
            0% { transform: translate(0, 0); }
            50% { transform: translate(0, -110%); } 
            100% { transform: translate(-270px, -100%); } /* -270px pour poser pile dessus */
        }

        .stack-meta {
            text-align: center; font-family: 'Segoe UI', sans-serif;
            background: rgba(255,255,255,0.9); padding: 8px 24px; border-radius: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 50; border: 1px solid rgba(0,0,0,0.05);
        }
        body.dark-mode .stack-meta { background: rgba(30, 41, 59, 0.9); border-color: rgba(255,255,255,0.1); }

        .stack-count { font-weight: 900; font-size: 1.8rem; line-height: 1.1; }
        .stack-sub { font-weight: 700; opacity: 0.75; font-size: 1rem; }
        .stack-warning { color: #ef4444; font-size: 0.85rem; margin-top: 4px; font-weight: bold; opacity: 0; transition: opacity 0.3s;}

        .limit-msg {
            position: absolute; bottom: 20px; background: rgba(0,0,0,0.8); color: white;
            padding: 8px 16px; border-radius: 20px; display: none; pointer-events: none; z-index: 999;
        }

        /* MODALE */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,1); z-index: 2000;
            display: none; justify-content: center; align-items: flex-start;
            overflow-y: auto; padding: 20px;
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: white; color: #0f172a; width: 90%; max-width: 850px; 
            padding: 20px; font-family: 'Georgia', serif; 
        }
        .close-modal {
            position: fixed; top: 20px; right: 30px; font-size: 2.5rem; cursor: pointer; color: #94a3b8;
            background: white; border: 1px solid #cbd5e1; border-radius: 50%; width: 50px; height: 50px;
            display: flex; align-items: center; justify-content: center;
        }
        .close-modal:hover { color: #ef4444; border-color: #ef4444; }
        
        .exo-title { text-align: center; border-bottom: 3px solid #334155; padding-bottom: 15px; margin-bottom: 25px; color: #1e293b; text-transform: uppercase; letter-spacing: 1px; margin-top: 0; }
        .main-question { background-color: #fef2f2; border: 2px solid #fecaca; color: #b91c1c; padding: 20px; border-radius: 12px; text-align: center; font-weight: bold; font-size: 1.3rem; margin: 30px 0; }
        .bonus-q { margin-top: 20px; padding: 20px; background: #eff6ff; border: 2px solid #bfdbfe; border-radius: 8px; font-size: 1.1rem; color: #1e3a8a; }
        .print-btn { display: block; margin: 40px auto 0; background: #334155; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 1rem; }

        @media print {
            .toolbar, .visual-area, .limit-msg { display: none !important; }
            #modal-exo { display: block !important; position: static !important; width: 100% !important; background: white !important;}
            .close-modal, .print-btn { display: none !important; }
            body { background: white; height: auto; overflow: visible; }
        }
    </style>
</head>
<body>

    <div id="modal-exo" class="modal-overlay">
        <div class="modal-content">
            <button class="close-modal" onclick="closeExo()">√ó</button>
            <h1 class="exo-title">Exercice de la feuille coup√©e</h1>
            <p style="text-align:center; font-style:italic; margin-bottom:30px; font-family:'Segoe UI', sans-serif; color:#475569;">
                Vous allez r√©aliser cet exercice sous forme de narration de recherche.
            </p>
            <ol style="font-size:1.1rem; line-height:1.8; margin-left:20px;">
                <li>Prendre une feuille de papier (son √©paisseur est de l'ordre de 0,1 mm en g√©n√©ral).</li>
                <li>Couper cette feuille en deux et superposer les deux parties obtenues.</li>
                <li>Couper de nouveau en deux puis superposer, couper, superposer...</li>
                <li>Imaginer que la feuille soit assez grande...</li>
            </ol>
            <div class="main-question">Quelle √©paisseur totale de papier obtient-on quand on coupe vingt fois ?</div>
            <div class="bonus-q"><strong>Bonus :</strong> Il para√Æt qu'en coupant 50 fois on atteindrait la lune.. qu'en penses-tu?</div>
            <button class="print-btn" onclick="window.print()">üñ®Ô∏è Imprimer la fiche</button>
        </div>
    </div>

    <div class="toolbar">
        <div class="stats-group">
            <div class="stat-box">
                <span class="stat-label">Coupes</span>
                <span class="stat-val" id="d-n">0</span>
            </div>
            <div class="stat-box">
                <span class="stat-label">Puissance</span>
                <span class="stat-val math" id="d-exp">2‚Å∞</span>
            </div>
            <div class="stat-box">
                <span class="stat-label">Feuilles</span>
                <span class="stat-val" id="d-tot">1</span>
            </div>
            <div class="stat-box">
                <span class="stat-label">√âpaisseur</span>
                <span class="stat-val thick" id="d-th">0,1 mm</span>
            </div>
        </div>

        <div class="actions-group">
            <button class="btn-enonce" onclick="openExo()">üìÑ √ânonc√©</button>
            <button class="btn-stack" id="btn-stack" onclick="toggleStack()" title="Vue empilement (profil)">üìö Pile</button>
            <button class="btn-cut" id="btn-cut" onclick="goCut()">‚úÇÔ∏è COUPER</button>
            <button class="btn-icon btn-danger" onclick="reset()" title="Effacer">üóëÔ∏è</button>
            <button class="btn-icon" onclick="toggleTheme()" title="Mode Sombre">üåó</button>
            <button class="btn-icon" onclick="toggleFull()" title="Plein √âcran">‚õ∂</button>
        </div>
    </div>

    <div class="visual-area">
        <div id="paper-container">
            <div class="sheet">1<div class="cut-v"></div></div>
        </div>

        <div id="stack-container">
            <div class="stack-wrap">
                <div id="stack-drawing">
                    <div class="line-pack" id="line-pack"></div>
                </div>
                <div class="stack-meta">
                    <div class="stack-count" id="stack-count">√ó 1 feuille</div>
                    <div class="stack-sub" id="stack-thick">√âpaisseur : 0,1 mm</div>
                    <div class="stack-warning" id="stack-warning">(Dessin limit√© √† 128 feuilles)</div>
                </div>
            </div>
        </div>
        
        <div id="limit-msg" class="limit-msg">Limite atteinte (4096)</div>
    </div>

<script>
    let n = 0;
    const MAX_N = 15;
    const THICKNESS = 0.1;
    // LIMITE VISUELLE DEMAND√âE : 128 (soit n=7)
    const VISUAL_CAP = 128; 

    let viewMode = 'grid';

    const gridContainer = document.getElementById('paper-container');
    const stackContainer = document.getElementById('stack-container');
    const stackDrawing = document.getElementById('stack-drawing');
    const linePack = document.getElementById('line-pack');
    const btnCut = document.getElementById('btn-cut');
    const btnStack = document.getElementById('btn-stack');
    const stackWarning = document.getElementById('stack-warning');
    const modal = document.getElementById('modal-exo');

    function openExo() { modal.classList.add('active'); }
    function closeExo() { modal.classList.remove('active'); }

    // --- UTILS ---
    function updateLimitState() {
        if (n >= MAX_N) {
            btnCut.disabled = true;
            btnCut.innerText = "MAX";
            document.getElementById('limit-msg').style.display = 'block';
        } else {
            btnCut.disabled = false;
            btnCut.innerText = "‚úÇÔ∏è COUPER";
            document.getElementById('limit-msg').style.display = 'none';
        }
    }

    function updateUI() {
        document.getElementById('d-n').innerText = n;
        document.getElementById('d-exp').innerHTML = `2<sup>${n}</sup>`;
        let total = Math.pow(2, n);
        document.getElementById('d-tot').innerText = total.toLocaleString('fr-FR');
        document.getElementById('d-th').innerText = formatThick(total);

        document.getElementById('stack-count').innerText = `√ó ${total.toLocaleString('fr-FR')} feuille${total>1?'s':''}`;
        document.getElementById('stack-thick').innerText = `√âpaisseur : ${formatThick(total)}`;
        
        // Affiche un petit message si on d√©passe la limite visuelle
        if (total > VISUAL_CAP) {
            stackWarning.style.opacity = '1';
        } else {
            stackWarning.style.opacity = '0';
        }
    }

    function formatThick(cnt) {
        let mm = cnt * THICKNESS;
        if (mm < 10) return mm.toFixed(1).replace('.', ',') + " mm";
        if (mm < 1000) return (mm / 10).toFixed(1).replace('.', ',') + " cm";
        if (mm < 1000000) return (mm / 1000).toFixed(2).replace('.', ',') + " m";
        return (mm / 1000000).toFixed(3).replace('.', ',') + " km";
    }

    // --- RENDER ---
    function render() {
        if (viewMode === 'grid') {
            document.body.classList.remove('stack-mode');
            gridContainer.style.display = 'grid';
            stackContainer.style.display = 'none';
            btnStack.classList.remove('active');
            renderGrid();
        } else {
            document.body.classList.add('stack-mode');
            gridContainer.style.display = 'none';
            stackContainer.style.display = 'flex';
            btnStack.classList.add('active');
            renderStackStatic(); 
        }
    }

    function renderGrid() {
        if (n === 0) {
            gridContainer.style.gridTemplateColumns = '1fr';
            gridContainer.style.gridTemplateRows = '1fr';
            gridContainer.style.gap = '6px';
            gridContainer.innerHTML = '<div class="sheet">1<div class="cut-v"></div></div>';
            return;
        }

        let cols = Math.pow(2, Math.ceil(n / 2));
        let rows = Math.pow(2, Math.floor(n / 2));
        gridContainer.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
        gridContainer.style.gridTemplateRows = `repeat(${rows}, 1fr)`;

        if (n <= 4) gridContainer.style.gap = '8px';
        else gridContainer.style.gap = '4px';

        let total = Math.pow(2, n);
        if (total > 2048) {
            gridContainer.innerHTML = `<div style="grid-column:1/-1; grid-row:1/-1; display:flex; justify-content:center; align-items:center; color:gray;">Limite d'affichage mosa√Øque atteinte.<br>Voir la Pile.</div>`;
            return;
        }

        let divs = [];
        let showNum = (n <= 5);
        let cutLine = (n < 9) ? ((n % 2 === 0) ? '<div class="cut-v"></div>' : '<div class="cut-h"></div>') : '';

        for (let i = 0; i < total; i++) {
            divs.push(`<div class="sheet">${showNum ? i + 1 : ''}${cutLine}</div>`);
        }
        gridContainer.innerHTML = divs.join('');
    }

    // --- PILE STABLE ---
    function renderStackStatic() {
        const total = Math.pow(2, n);
        
        // ON BLOQUE L'AFFICHAGE A 128
        const countToDraw = Math.min(total, VISUAL_CAP);

        linePack.innerHTML = '';
        
        let html = '';
        for(let i=0; i<countToDraw; i++) {
            html += `<div class="line"></div>`;
        }
        linePack.innerHTML = html;
    }

    // --- ACTIONS ---
    function goCut() {
        if (n >= MAX_N) return;

        if (viewMode === 'stack') {
            // Animation seulement si le r√©sultat final ne d√©passe pas la limite
            // Donc si on est actuellement < 128 (n < 7)
            if (n < 7) {
                btnCut.disabled = true;
                animateStackCut(() => {
                    doCutLogic();
                    btnCut.disabled = (n >= MAX_N);
                });
            } else {
                // Au-del√† de 128 feuilles, on incr√©mente juste les chiffres, le dessin ne bouge plus
                doCutLogic();
            }
        } else {
            if (n < 8) {
                document.querySelectorAll('.sheet').forEach(s => s.classList.add('animating'));
                btnCut.disabled = true;
                setTimeout(() => {
                    doCutLogic();
                    btnCut.disabled = (n >= MAX_N);
                }, 450);
            } else {
                doCutLogic();
            }
        }
    }

    function doCutLogic() {
        n++;
        updateUI();
        if(viewMode === 'stack') renderStackStatic();
        else renderGrid();
        updateLimitState();
    }

    function animateStackCut(onComplete) {
        const currentHTML = linePack.innerHTML;
        linePack.innerHTML = ''; 

        const animCont = document.createElement('div');
        animCont.className = 'stack-anim-container';
        
        const left = document.createElement('div');
        left.className = 'anim-half';
        left.innerHTML = currentHTML;

        const right = document.createElement('div');
        right.className = 'anim-half right'; // S'√©carte un peu avec margin
        right.innerHTML = currentHTML; 

        animCont.appendChild(left);
        animCont.appendChild(right);
        stackDrawing.appendChild(animCont);

        setTimeout(() => { right.classList.add('anim-lift'); }, 50);

        setTimeout(() => {
            stackDrawing.removeChild(animCont);
            onComplete(); 
        }, 950);
    }

    function toggleStack() {
        viewMode = (viewMode === 'grid') ? 'stack' : 'grid';
        render();
    }

    function reset() {
        n = 0;
        updateUI();
        render();
        updateLimitState();
    }

    function toggleTheme() { document.body.classList.toggle('dark-mode'); }
    function toggleFull() {
        if (!document.fullscreenElement) document.documentElement.requestFullscreen();
        else if (document.exitFullscreen) document.exitFullscreen();
    }

    updateUI();
    render();
    updateLimitState();

</script>
</body>
</html>
