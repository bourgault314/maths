<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Boîte à bonbons — 3D / Cavalière / Patron</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#10162c;
      --line:rgba(255,255,255,.14);
      --text:#e9eefc;
      --muted:#a9b6e6;
      --btn:#172149;
      --btn2:#1d2a5e;
      --accent:#7ee787;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial}
    header{
      display:flex;align-items:center;gap:12px;flex-wrap:wrap;
      padding:10px 12px;border-bottom:1px solid var(--line);
      background:rgba(255,255,255,.03);
    }
    .title{font-weight:800}
    .meta{color:var(--muted);font-size:.95rem}
    .spacer{flex:1}
    .btn{
      background:var(--btn);border:1px solid var(--line);color:var(--text);
      padding:8px 10px;border-radius:10px;cursor:pointer;
    }
    .btn:hover{background:var(--btn2)}
    .tabs{
      display:flex;gap:8px;flex-wrap:wrap;
      padding:10px 12px;border-bottom:1px solid var(--line);
    }
    .tab{
      padding:8px 10px;border-radius:10px;border:1px solid var(--line);
      background:rgba(255,255,255,.02);cursor:pointer;color:var(--muted);
    }
    .tab.active{background:rgba(126,231,135,.10);color:var(--text);border-color:rgba(126,231,135,.35)}
    .wrap{height:calc(100% - 98px);padding:12px;min-height:0;}
    .panel{
      height:100%;
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      display:none;
      min-height:0;
    }
    .panel.active{display:flex;flex-direction:column}
    .bar{
      display:flex;align-items:center;gap:10px;flex-wrap:wrap;
      padding:10px 12px;border-bottom:1px solid var(--line);
      background:rgba(255,255,255,.02);
    }
    .bar .hint{color:var(--muted);font-size:.92rem}
    .bar label{color:var(--muted);font-size:.92rem}
    .bar input[type="range"]{width:160px}
    .toggle{
      display:flex;align-items:center;gap:6px;
      padding:6px 10px;border:1px solid var(--line);border-radius:10px;
      background:rgba(255,255,255,.02);
    }
    .content{flex:1;min-height:0;position:relative;}
    canvas{display:block;width:100%;height:100%}
    .svgWrap{width:100%;height:100%;overflow:auto;background:#0f1733;}
    .note{
      position:absolute;left:10px;bottom:10px;
      max-width:min(720px, calc(100% - 20px));
      padding:8px 10px;border-radius:12px;
      background:rgba(0,0,0,.35);border:1px solid var(--line);
      color:var(--muted);font-size:.92rem;backdrop-filter:blur(6px);
    }
    .note b{color:var(--text)}
    .errorBox{
      padding:12px;border:1px solid rgba(255,180,120,.35);
      background:rgba(255,180,120,.08);
      border-radius:12px;color:#ffd4b0;font-size:.95rem;
    }
    .small{font-size:.9rem;color:var(--muted)}
    code{background:rgba(255,255,255,.06);padding:2px 6px;border-radius:8px}
  </style>
</head>
<body>
  <header>
    <div>
      <div class="title">Boîte à bonbons</div>
      <div class="meta" id="dims"></div>
    </div>
    <div class="spacer"></div>
    <button class="btn" id="printNet">Imprimer le patron</button>
    <button class="btn" id="reset3d">Réinitialiser la vue 3D</button>
  </header>

  <nav class="tabs">
    <button class="tab active" data-tab="t3d">3D</button>
    <button class="tab" data-tab="tcav">Cavalière</button>
    <button class="tab" data-tab="tnet">Patron</button>
  </nav>

  <div class="wrap">
    <!-- 3D -->
    <section class="panel active" id="t3d">
      <div class="bar">
        <div class="hint">Souris : glisser = tourner • molette = zoom</div>
        <div class="toggle"><input id="showCandies" type="checkbox" checked><label for="showCandies">Bonbons</label></div>
        <div class="toggle"><input id="showBox" type="checkbox" checked><label for="showBox">Boîte</label></div>
        <div class="toggle"><input id="showGrid" type="checkbox" checked><label for="showGrid">Grille</label></div>
      </div>
      <div class="content">
        <canvas id="c3d"></canvas>
        <div class="note" id="note3d"></div>
      </div>
    </section>

    <!-- Cavalière -->
    <section class="panel" id="tcav">
      <div class="bar">
        <div class="hint">Étapes : base → profondeur → fermeture</div>
        <label>k</label>
        <input id="k" type="range" min="0.3" max="0.8" step="0.05" value="0.5">
        <span class="small" id="kVal"></span>
        <label>Étape</label>
        <input id="step" type="range" min="1" max="3" step="1" value="3">
        <span class="small" id="stepVal"></span>
      </div>
      <div class="content">
        <canvas id="ccav"></canvas>
        <div class="note" id="noteCav"></div>
      </div>
    </section>

    <!-- Patron -->
    <section class="panel" id="tnet">
      <div class="bar">
        <div class="hint">Échelle 1:1 (mm). Imprimer à 100% (sans ajuster).</div>
        <div class="toggle"><input id="tabsOn" type="checkbox" checked><label for="tabsOn">Languette</label></div>
        <div class="toggle"><input id="grid5" type="checkbox"><label for="grid5">Grille 5 mm</label></div>
      </div>
      <div class="content">
        <div class="svgWrap" id="svgWrap"></div>
      </div>
    </section>
  </div>

<script>
/* ========= Données (mm) =========
   Bonbon: prisme droit base triangle rectangle 3–4–5 cm, épaisseur 6 mm
   Pile: 10 bonbons -> 60 mm = 6 cm
*/
const D = { a:30, b:40, c:50, t:6, n:10, clearXY:1, clearZ:1 };
const H = () => D.n * D.t;

document.getElementById('dims').textContent =
  `Base : 3–4–5 cm • Épaisseur : ${D.t} mm • Pile : ${D.n} → ${H()} mm (= ${(H()/10).toFixed(1)} cm)`;

const $ = (id)=>document.getElementById(id);

/* ========= Tabs ========= */
document.querySelectorAll('.tab').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const target = btn.dataset.tab;
    document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
    $(target).classList.add('active');
    // Resize redraw
    requestAnimationFrame(()=>{ resizeAll(); drawCavaliere(); });
  });
});

/* ========= Cavalière (100% autonome, sans lib) ========= */
const cav = $('ccav');
const ctx = cav.getContext('2d');

function drawGrid2D(w,h,step=20){
  ctx.clearRect(0,0,w,h);
  ctx.fillStyle = '#0f1733';
  ctx.fillRect(0,0,w,h);
  ctx.strokeStyle = 'rgba(255,255,255,.06)';
  ctx.lineWidth = 1;
  for(let x=0;x<=w;x+=step){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke(); }
  for(let y=0;y<=h;y+=step){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke(); }
}

function projectCav(p, k=0.5, theta=Math.PI/4){
  // p = {x,y,z} mm -> projection cavalière
  const dx = k * p.z * Math.cos(theta);
  const dy = k * p.z * Math.sin(theta);
  return { x: p.x + dx, y: p.y - dy };
}

function drawCavaliere(){
  const w = cav.clientWidth, h = cav.clientHeight;
  if(w<10 || h<10) return;

  const k = Number($('k').value);
  const step = Number($('step').value);
  $('kVal').textContent = `k=${k.toFixed(2)}`;
  $('stepVal').textContent = step===1?'1/3':step===2?'2/3':'3/3';

  drawGrid2D(w,h,20);

  const theta = Math.PI/4;
  const A={x:0,y:0,z:0}, B={x:D.a,y:0,z:0}, C={x:0,y:D.b,z:0};
  const Z=H();
  const A2={x:0,y:0,z:Z}, B2={x:D.a,y:0,z:Z}, C2={x:0,y:D.b,z:Z};

  const maxX = D.a + k*Z*Math.cos(theta);
  const maxY = D.b + k*Z*Math.sin(theta);

  const margin = 60;
  const scale = Math.min((w-2*margin)/maxX, (h-2*margin)/maxY);

  function P(p){
    const q=projectCav(p,k,theta);
    return { x: margin + q.x*scale, y: margin + q.y*scale };
  }

  const pA=P(A), pB=P(B), pC=P(C), pA2=P(A2), pB2=P(B2), pC2=P(C2);

  function seg(p,q, col='rgba(233,238,252,.85)', lw=2, dash=false){
    ctx.save();
    ctx.strokeStyle=col; ctx.lineWidth=lw;
    if(dash) ctx.setLineDash([6,6]); else ctx.setLineDash([]);
    ctx.beginPath(); ctx.moveTo(p.x,p.y); ctx.lineTo(q.x,q.y); ctx.stroke();
    ctx.restore();
  }

  // base
  seg(pA,pB);
  seg(pA,pC);
  seg(pB,pC);

  if(step>=2){
    seg(pA,pA2,'rgba(126,231,135,.9)',2);
    seg(pB,pB2,'rgba(126,231,135,.9)',2);
    seg(pC,pC2,'rgba(126,231,135,.9)',2);
  }
  if(step>=3){
    seg(pA2,pB2,'rgba(233,238,252,.65)',2);
    seg(pA2,pC2,'rgba(233,238,252,.65)',2);
    seg(pB2,pC2,'rgba(233,238,252,.65)',2);
    // arêtes cachées en pointillés (petit + pédagogique)
    seg(pB,pB2,'rgba(233,238,252,.35)',2,true);
    seg(pC,pC2,'rgba(233,238,252,.35)',2,true);
  }

  ctx.fillStyle='rgba(233,238,252,.9)';
  ctx.font='14px system-ui';
  ctx.fillText('3 cm', (pA.x+pB.x)/2 - 10, (pA.y+pB.y)/2 - 12);
  ctx.fillText('4 cm', (pA.x+pC.x)/2 - 10, (pA.y+pC.y)/2 + 18);
  ctx.fillText('5 cm', (pB.x+pC.x)/2 + 8, (pB.y+pC.y)/2 + 4);
  ctx.fillStyle='rgba(126,231,135,.95)';
  ctx.fillText(`6 cm`, (pA2.x+pB2.x)/2 - 8, (pA2.y+pB2.y)/2 - 12);

  $('noteCav').innerHTML =
    `<b>Perspective cavalière :</b><br>
     1) Triangle 3–4–5 en vraie grandeur.<br>
     2) Profondeur à 45° avec coefficient k (souvent 0,5).<br>
     3) On ferme en reliant les points du “fond”.`;
}

$('k').addEventListener('input', drawCavaliere);
$('step').addEventListener('input', drawCavaliere);

/* ========= Patron SVG (autonome) ========= */
function buildNetSVG(){
  const tabsOn = $('tabsOn').checked;
  const gridOn = $('grid5').checked;

  // A4 (mm)
  const pageW=210, pageH=297, pad=12;

  const Z=H();
  const w1=D.a, w2=D.c, w3=D.b;
  const x0=pad, y0=60;

  const R1=[x0,y0,w1,Z];
  const R2=[x0+w1,y0,w2,Z];
  const R3=[x0+w1+w2,y0,w3,Z];

  const tab=10;

  const xT = R2[0] + (w2 - D.a)/2;
  const triTop = [[xT, y0],[xT+D.a, y0],[xT, y0-D.b]];
  const triBot = [[xT, y0+Z],[xT+D.a, y0+Z],[xT, y0+Z+D.b]];

  const line=(x1,y1,x2,y2,d=false)=>`<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="rgba(233,238,252,.9)" stroke-width="0.6" ${d?`stroke-dasharray="3 3"`:''}/>`;
  const rect=(x,y,w,h)=>`<rect x="${x}" y="${y}" width="${w}" height="${h}" fill="none" stroke="rgba(233,238,252,.9)" stroke-width="0.8"/>`;
  const poly=(pts)=>`<polygon points="${pts.map(p=>p.join(',')).join(' ')}" fill="none" stroke="rgba(233,238,252,.9)" stroke-width="0.8"/>`;
  const text=(x,y,s,size=4)=>`<text x="${x}" y="${y}" font-size="${size}" fill="rgba(233,238,252,.85)" font-family="system-ui,Segoe UI,Roboto">${s}</text>`;

  let grid='';
  if(gridOn){
    for(let x=0;x<=pageW;x+=5) grid += `<line x1="${x}" y1="0" x2="${x}" y2="${pageH}" stroke="rgba(255,255,255,.05)" stroke-width="0.2"/>`;
    for(let y=0;y<=pageH;y+=5) grid += `<line x1="0" y1="${y}" x2="${pageW}" y2="${y}" stroke="rgba(255,255,255,.05)" stroke-width="0.2"/>`;
  }

  let tabs='';
  if(tabsOn){
    tabs += `<rect x="${x0-tab}" y="${y0}" width="${tab}" height="${Z}" fill="rgba(126,231,135,.08)" stroke="rgba(233,238,252,.7)" stroke-width="0.6" stroke-dasharray="3 3"/>`;
    tabs += text(x0-tab+1, y0+6, 'languette', 3.6);
  }

  const svg = `
  <svg xmlns="http://www.w3.org/2000/svg" width="210mm" height="297mm" viewBox="0 0 210 297">
    <rect x="0" y="0" width="210" height="297" fill="#0f1733"/>
    ${grid}
    ${text(12, 18, 'Patron (1:1) — Rectangles : 6×3, 6×5, 6×4 cm — 2 triangles 3–4–5', 4.2)}
    ${rect(...R1)}${rect(...R2)}${rect(...R3)}
    ${line(R1[0]+R1[2],y0,R1[0]+R1[2],y0+Z,true)}
    ${line(R2[0]+R2[2],y0,R2[0]+R2[2],y0+Z,true)}
    ${poly(triTop)}${poly(triBot)}
    ${tabs}
    ${text(R1[0]+2, y0-2, '6×3 cm', 4)}
    ${text(R2[0]+2, y0-2, '6×5 cm', 4)}
    ${text(R3[0]+2, y0-2, '6×4 cm', 4)}
    ${text(12, 285, 'Imprime à 100% (sans ajuster). Découpe plein, plie pointillés.', 4)}
  </svg>`;
  $('svgWrap').innerHTML = svg;
}
$('tabsOn').addEventListener('change', buildNetSVG);
$('grid5').addEventListener('change', buildNetSVG);

/* ========= Impression patron ========= */
$('printNet').addEventListener('click', ()=>{
  const svg = $('svgWrap').querySelector('svg');
  if(!svg) return;
  const w = window.open('', '_blank');
  const html = `<!doctype html><html><head><meta charset="utf-8">
  <title>Patron — impression</title>
  <style>body{margin:0;background:#fff} svg{width:210mm;height:297mm;display:block}</style>
  </head><body>${svg.outerHTML}
  <script>window.onload=()=>setTimeout(()=>window.print(),200);<\/script>
  </body></html>`;
  w.document.open(); w.document.write(html); w.document.close();
});

/* ========= 3D (optionnelle) : on charge Three.js dynamiquement ========= */
const note3d = $('note3d');
note3d.innerHTML = `<b>3D :</b> chargement… (si le réseau bloque les CDN, la 3D se désactive mais Cavalière/Patron restent OK).`;

function loadScript(src){
  return new Promise((resolve,reject)=>{
    const s=document.createElement('script');
    s.src=src; s.async=true;
    s.onload=resolve;
    s.onerror=()=>reject(new Error('load failed: '+src));
    document.head.appendChild(s);
  });
}

let threeState = null;

async function init3D(){
  // 1) Essai CDN
  try{
    await loadScript('https://unpkg.com/three@0.160.0/build/three.min.js');
  }catch(e){
    // 2) Essai local (au cas où tu mets three.min.js à côté du html)
    try{
      await loadScript('./three.min.js');
    }catch(e2){
      // 3D indisponible -> message, pas de crash
      note3d.innerHTML =
        `<div class="errorBox"><b>3D indisponible.</b><br>
         Le reste de la page fonctionne.<br><br>
         Solution simple : télécharge <code>three.min.js</code> et mets-le dans le même dossier que ce fichier HTML,
         puis recharge la page.</div>`;
      return;
    }
  }

  // Si on est là, THREE est dispo
  const canvas = $('c3d');
  const renderer = new THREE.WebGLRenderer({canvas, antialias:true, alpha:false});
  renderer.setPixelRatio(Math.min(2, window.devicePixelRatio));

  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x0b1020);

  const camera = new THREE.PerspectiveCamera(55, 1, 1, 6000);

  scene.add(new THREE.AmbientLight(0xffffff, 0.7));
  const light = new THREE.DirectionalLight(0xffffff, 0.9);
  light.position.set(200, 260, 160);
  scene.add(light);

  const grid = new THREE.GridHelper(400, 40, 0x6b78b8, 0x2a355f);
  grid.position.y = -40;
  scene.add(grid);

  // Géométrie : prisme triangulaire (extrusion en z puis rotation pour avoir l’empilement vertical en y)
  function makeTriPrism(a,b,depth){
    const shape = new THREE.Shape();
    shape.moveTo(0,0);
    shape.lineTo(a,0);
    shape.lineTo(0,b);
    shape.lineTo(0,0);

    const geo = new THREE.ExtrudeGeometry(shape, {depth, bevelEnabled:false});
    geo.rotateX(-Math.PI/2); // z -> y (vertical)
    geo.computeBoundingBox();
    const bb = geo.boundingBox;
    const cx = (bb.min.x+bb.max.x)/2;
    const cy = (bb.min.y+bb.max.y)/2;
    const cz = (bb.min.z+bb.max.z)/2;
    geo.translate(-cx, -cy, -cz);
    geo.computeVertexNormals();
    return geo;
  }

  const Gcandies = new THREE.Group();
  const Gbox = new THREE.Group();
  scene.add(Gcandies, Gbox);

  function rebuild3D(){
    while(Gcandies.children.length) Gcandies.remove(Gcandies.children[0]);
    while(Gbox.children.length) Gbox.remove(Gbox.children[0]);

    const candyGeo = makeTriPrism(D.a, D.b, D.t);
    const candyMat = new THREE.MeshStandardMaterial({ color: 0x7ee787, roughness:0.5, metalness:0.05 });

    for(let i=0;i<D.n;i++){
      const m = new THREE.Mesh(candyGeo, candyMat);
      m.position.y = (i - (D.n-1)/2) * D.t; // empilement vertical
      Gcandies.add(m);
    }

    const boxGeo = makeTriPrism(D.a+2*D.clearXY, D.b+2*D.clearXY, H()+2*D.clearZ);
    const edges = new THREE.EdgesGeometry(boxGeo, 15);
    const wire = new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: 0xa9b6e6, transparent:true, opacity:0.9 }));
    Gbox.add(wire);

    note3d.innerHTML =
      `<b>Ce que les élèves doivent voir :</b><br>
       • La boîte est un <b>prisme droit</b> de base 3–4–5.<br>
       • La “longueur” de la boîte = <b>10×6 mm = 6 cm</b>.<br>
       (Bonbons verts = pile, filaire = boîte).`;
  }

  // Contrôle orbit maison (simple + robuste)
  let theta = 0.9, phi = 0.55, radius = 260;
  let dragging=false, lastX=0, lastY=0;

  function clamp(v,min,max){ return Math.max(min, Math.min(max,v)); }

  function updateCamera(){
    phi = clamp(phi, 0.12, 1.45);
    radius = clamp(radius, 120, 900);
    const x = radius * Math.cos(phi) * Math.cos(theta);
    const z = radius * Math.cos(phi) * Math.sin(theta);
    const y = radius * Math.sin(phi);
    camera.position.set(x,y,z);
    camera.lookAt(0,0,0);
  }

  canvas.addEventListener('pointerdown', (e)=>{
    dragging=true; lastX=e.clientX; lastY=e.clientY;
    canvas.setPointerCapture(e.pointerId);
  });
  canvas.addEventListener('pointermove', (e)=>{
    if(!dragging) return;
    const dx = e.clientX - lastX;
    const dy = e.clientY - lastY;
    lastX=e.clientX; lastY=e.clientY;
    theta -= dx * 0.006;
    phi   -= dy * 0.006;
    updateCamera();
  });
  canvas.addEventListener('pointerup', ()=> dragging=false);
  canvas.addEventListener('wheel', (e)=>{
    e.preventDefault();
    radius *= (e.deltaY>0) ? 1.08 : 0.92;
    updateCamera();
  }, {passive:false});

  function resize3D(){
    const w = canvas.clientWidth, h = canvas.clientHeight;
    renderer.setSize(w,h,false);
    camera.aspect = w/h;
    camera.updateProjectionMatrix();
  }

  function loop(){
    renderer.render(scene, camera);
    requestAnimationFrame(loop);
  }

  $('showCandies').addEventListener('change', ()=> Gcandies.visible = $('showCandies').checked);
  $('showBox').addEventListener('change', ()=> Gbox.visible = $('showBox').checked);
  $('showGrid').addEventListener('change', ()=> grid.visible = $('showGrid').checked);

  $('reset3d').addEventListener('click', ()=>{
    theta=0.9; phi=0.55; radius=260;
    updateCamera();
  });

  rebuild3D();
  updateCamera();
  resize3D();
  loop();

  // resize global
  window.addEventListener('resize', ()=>{ resize3D(); });
}

/* ========= Resize 2D ========= */
function resizeCav(){
  const w=cav.clientWidth, h=cav.clientHeight;
  if(w<10 || h<10) return;
  cav.width = Math.floor(w * devicePixelRatio);
  cav.height = Math.floor(h * devicePixelRatio);
  ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
}

function resizeAll(){
  resizeCav();
}

function initAll(){
  buildNetSVG();
  resizeAll();
  drawCavaliere();
  init3D(); // optionnel (ne casse pas le reste)
}
window.addEventListener('load', initAll);
</script>
</body>
</html>
