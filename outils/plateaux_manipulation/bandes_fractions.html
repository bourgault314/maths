<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Manipulation - Bandes de Fractions</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Fredoka', sans-serif;
            background-color: #f0f9ff;
            overflow: hidden;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            cursor: default;
        }

        /* --- STYLES DES TUILES (FRACTIONS) --- */
        .token-group {
            position: absolute;
            display: flex;
            align-items: stretch;
            justify-content: flex-start;
            box-shadow: 0 4px 6px rgba(0,0,0,0.15);
            cursor: grab;
            transition: transform 0.1s, box-shadow 0.2s;
            z-index: 10;
            touch-action: none;
            transform-origin: center center;
            border-radius: 2px;
            user-select: none; 
            -webkit-user-select: none;
        }
        
        .token-group.dragging {
            transition: none !important;
            z-index: 1000 !important;
            cursor: grabbing;
            box-shadow: 0 15px 25px rgba(0,0,0,0.3);
            transform: scale(1.02);
        }

        /* Contour Bleu rétabli pour la sélection (même à l'arrêt) */
        .token-group.selected {
            outline: 3px solid #3b82f6;
            z-index: 50;
        }

        /* Une cellule individuelle dans le groupe */
        .token-cell {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #000000;
            box-sizing: border-box;
            border-right: 1px dashed rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .token-cell:last-child {
            border-right: none;
        }

        /* --- FRACTION MATH MODE --- */
        .fraction {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            line-height: 1;
            font-family: 'Times New Roman', serif;
            font-style: normal;
        }
        .numerator {
            border-bottom: 2px solid currentColor;
            padding: 0 2px;
            margin-bottom: 2px;
            text-align: center;
            width: 100%;
        }
        .denominator {
            text-align: center;
            width: 100%;
        }
        
        .number-one {
            font-size: 2rem;
            font-family: 'Fredoka', sans-serif;
            font-weight: 600;
        }

        /* --- COULEURS --- */
        
        /* d-1: Blanc Crème (#fdfbf7) et pas de cadre gris */
        .bg-d-1  { background-color: #fdfbf7; border: none; color: #000000 !important; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .token-group.bg-d-1 { background-color: #fdfbf7; border: none; }

        /* d-2: Jaune Soleil */
        .bg-d-2  { background-color: #FFD700; color: #000000 !important; }
        
        /* d-3: Lilas */
        .bg-d-3  { background-color: #d8b4fe; color: #000000 !important; }
        
        /* d-4: Vert */
        .bg-d-4  { background-color: #4ade80; color: #000000 !important; } 
        
        /* d-5: Bleu Foncé */
        .bg-d-5  { background-color: #3b82f6; color: #000000 !important; } 
        
        /* d-6: Orange Foncé */
        .bg-d-6  { background-color: #f97316; color: #000000 !important; }
        
        /* d-8: Rose */
        .bg-d-8  { background-color: #f472b6; color: #000000 !important; }
        
        /* d-10: Rouge Cardinal */
        .bg-d-10 { background-color: #ef4444; color: #000000 !important; }

        /* Styles spécifiques bordures */
        .bg-d-1 .token-cell { border-top: 1px solid rgba(0,0,0,0.05); border-bottom: 1px solid rgba(0,0,0,0.05); }

        .token-group:not(.bg-d-1) .token-cell { border-top: 1px solid rgba(0,0,0,0.1); border-bottom: 1px solid rgba(0,0,0,0.1); }
        .token-group:not(.bg-d-1) .token-cell:first-child { border-left: 1px solid rgba(0,0,0,0.1); }
        .token-group:not(.bg-d-1) .token-cell:last-child { border-right: 1px solid rgba(0,0,0,0.1); }

        /* État "Retourné" (Verso) */
        .token-group.flipped {
            opacity: 0.95; 
        }
        
        .token-group.flipped .token-cell > * { display: none; }
        .token-group.flipped .token-cell { border-right-color: transparent; }

        .back-label {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            color: #000000;
            z-index: 20; /* Force le 1 à être au dessus de la couleur */
        }

        /* --- INTERFACE --- */
        #custom-cursor { position: fixed; pointer-events: none; z-index: 9999; display: none; }
        .hide-cursor, .hide-cursor * { cursor: none !important; }

        #board-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            overflow: hidden; cursor: grab;
        }
        #board-container.panning { cursor: grabbing; }
        #board-world {
            position: absolute; top: 0; left: 0; transform-origin: 0 0;
            width: 0; height: 0; 
        }
        #drawing-canvas { position: absolute; top: 0; left: 0; pointer-events: none; }

        .sidebar-item { cursor: grab; transition: transform 0.1s; }
        .sidebar-item:active { cursor: grabbing; transform: scale(0.95); }
        
        .sidebar-preview {
            display: flex; height: 36px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); pointer-events: none;
        }
        .sidebar-preview .token-cell { font-size: 0.65rem; border-right: 1px dashed rgba(0,0,0,0.3); }
        
        #drag-ghost {
            position: fixed; pointer-events: none; z-index: 9999;
            opacity: 0.9; box-shadow: 0 10px 20px rgba(0,0,0,0.25);
            display: none; transform-origin: top left;
        }

    </style>
</head>
<body class="h-screen w-screen flex flex-col">

    <!-- HEADER -->
    <header class="bg-white p-2 shadow-sm z-30 flex flex-wrap items-center gap-4 shrink-0 border-b border-slate-200">
        <div class="flex items-center gap-2">
            <button onclick="app.undo()" class="bg-slate-100 text-slate-600 hover:bg-slate-200 p-2 rounded-lg font-bold border border-slate-200 flex items-center gap-1 active:scale-95 transition" title="Annuler">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" /></svg>
            </button>
            <button onclick="app.resetBoard()" class="bg-rose-50 text-rose-600 hover:bg-rose-100 p-2 rounded-lg font-bold border border-rose-100 flex items-center gap-1 active:scale-95 transition" title="Tout effacer">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
            </button>
            <div class="h-6 w-px bg-slate-300 mx-1"></div>
            <button onclick="app.separateSelection()" class="bg-blue-50 text-blue-600 hover:bg-blue-100 px-3 py-2 rounded-lg font-bold border border-blue-200 flex items-center gap-2 active:scale-95 transition" title="Séparer la bande en morceaux">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.121 14.121L19 19m-7-7l7-7m-7 7l-2.879 2.879M12 12L9.121 9.121m0 5.758a3 3 0 10-4.243 4.243 3 3 0 004.243-4.243zm8.486-8.486a3 3 0 10-4.243 4.243 3 3 0 004.243-4.243z" /></svg>
                <span class="hidden sm:inline text-sm">Séparer (Ciseaux)</span>
            </button>
            <button onclick="app.flipSelection()" class="bg-slate-50 text-slate-600 hover:bg-slate-100 px-3 py-2 rounded-lg font-bold border border-slate-200 flex items-center gap-2 active:scale-95 transition" title="Retourner la tuile">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                <span class="hidden sm:inline text-sm">Retourner</span>
            </button>
        </div>
        <div class="flex-1 text-center text-sm text-slate-400 italic hidden md:block">
            Molette: Zoom | Clic-droit: Panoramique
        </div>
        <div class="flex items-center gap-1 bg-slate-100 p-1 rounded-lg">
            <button onclick="app.setTool('hand')" id="tool-hand" class="p-2 rounded bg-white shadow text-blue-600" title="Déplacer (Main)"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11.5V14m0-2.5v-6a1.5 1.5 0 113 0m-3 6a1.5 1.5 0 00-3 0v2a7.5 7.5 0 0015 0v-5a1.5 1.5 0 00-3 0m-6-3V11m0-5.5v-1a1.5 1.5 0 013 0v1m0 0V11m0-5.5a1.5 1.5 0 013 0v3m0 0V11"/></svg></button>
            <button onclick="app.setTool('pen')" id="tool-pen" class="p-2 rounded text-gray-500 hover:bg-gray-200" title="Dessiner (Stylo)"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg></button>
            <button onclick="app.clearDrawing()" class="p-2 rounded text-red-400 hover:bg-red-50" title="Effacer le dessin"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
        <aside class="w-72 bg-white border-r border-slate-200 flex flex-col z-20 shadow-lg shrink-0 h-full">
            <div class="p-3 bg-slate-50 border-b border-slate-200 text-xs font-bold text-slate-500 uppercase tracking-wider text-center">
                Pièces
            </div>
            <div class="overflow-y-auto p-4 flex-1 scrollbar-hide" id="sidebar-list"></div>
        </aside>

        <main id="board" class="flex-1 relative bg-slate-50 overflow-hidden">
            <div class="absolute inset-0 opacity-10 pointer-events-none" style="background-image: linear-gradient(#94a3b8 1px, transparent 1px), linear-gradient(90deg, #94a3b8 1px, transparent 1px); background-size: 20px 20px;"></div>
            <div id="board-container">
                <div id="board-world">
                    <canvas id="drawing-canvas"></canvas>
                </div>
            </div>
            <div id="custom-cursor">
                <svg class="drop-shadow-lg" width="34" height="34" viewBox="0 0 34 34" fill="none">
                    <path d="M27 7 L13 21" stroke="#1d4ed8" stroke-width="6" stroke-linecap="round"/>
                    <path d="M13 21 L8 32" stroke="#0f172a" stroke-width="4" stroke-linecap="round"/>
                    <path d="M8 32 L12 28 L16 32 Z" fill="#111827"/>
                    <circle cx="8" cy="32" r="1" fill="white"/>
                </svg>
            </div>
        </main>
    </div>
    
    <div id="drag-ghost"></div>

    <script>
        const UNIT_WIDTH = 320; 
        const UNIT_HEIGHT = 60; 
        const SNAP_DIST = 30;   
        const SIDEBAR_SCALE = 0.55; 
        
        const FRACTIONS = [
            { d: 1,  colorClass: 'bg-d-1',  label: '1',     count: 1 },
            { d: 2,  colorClass: 'bg-d-2',  label: '1/2',   count: 2 },
            { d: 3,  colorClass: 'bg-d-3',  label: '1/3',   count: 3 },
            { d: 4,  colorClass: 'bg-d-4',  label: '1/4',   count: 4 },
            { d: 5,  colorClass: 'bg-d-5',  label: '1/5',   count: 5 },
            { d: 6,  colorClass: 'bg-d-6',  label: '1/6',   count: 6 },
            { d: 8,  colorClass: 'bg-d-8',  label: '1/8',   count: 8 },
            { d: 10, colorClass: 'bg-d-10', label: '1/10',  count: 10 }
        ];

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination); const now = audioCtx.currentTime;
            if (type === 'pop') { 
                osc.type = 'sine'; osc.frequency.setValueAtTime(400, now); osc.frequency.exponentialRampToValueAtTime(600, now+0.1); 
                gain.gain.setValueAtTime(0.05, now); gain.gain.linearRampToValueAtTime(0, now+0.1); 
                osc.start(now); osc.stop(now+0.1); 
            } else if (type === 'snap') {
                osc.type = 'square'; osc.frequency.setValueAtTime(150, now); osc.frequency.exponentialRampToValueAtTime(50, now+0.05);
                gain.gain.setValueAtTime(0.05, now); gain.gain.linearRampToValueAtTime(0, now+0.05);
                osc.start(now); osc.stop(now+0.05);
            } else if (type === 'flip') { 
                osc.type = 'triangle'; osc.frequency.setValueAtTime(300, now); osc.frequency.linearRampToValueAtTime(200, now+0.15); 
                gain.gain.setValueAtTime(0.05, now); gain.gain.linearRampToValueAtTime(0, now+0.15); 
                osc.start(now); osc.stop(now+0.15); 
            }
        }

        class FractionApp {
            constructor() {
                this.history = [];
                this.groups = [];
                this.nextId = 1;
                this.scale = 1; 
                this.pan = { x: 50, y: 50 }; 
                this.isPanning = false; 
                this.panStart = { x: 0, y: 0 };
                this.currentTool = 'hand'; 
                this.selectedGroupId = null;
                
                this.sidebarDragging = false;
                this.sidebarDragData = null; 
                this.dragGhost = document.getElementById('drag-ghost');
                
                this.boardContainer = document.getElementById('board-container');
                this.boardWorld = document.getElementById('board-world');
                this.canvas = document.getElementById('drawing-canvas');
                this.ctx = this.canvas.getContext('2d');
                
                this.initSidebar();
                this.initListeners();
                this.resizeCanvas();
                this.updateTransform();
            }

            initSidebar() {
                const list = document.getElementById('sidebar-list');
                FRACTIONS.forEach(f => {
                    const wrapper = document.createElement('div');
                    wrapper.className = "mb-4 flex flex-wrap items-center gap-3";
                    if (f.count > 1) {
                        this.createSidebarItem(wrapper, f, f.count);
                        this.createSidebarItem(wrapper, f, 1);
                    } else {
                        this.createSidebarItem(wrapper, f, 1);
                    }
                    list.appendChild(wrapper);
                });
            }

            createSidebarItem(parent, f, count) {
                const item = document.createElement('div');
                item.className = "sidebar-item flex items-center";
                item.title = count === 1 ? `Ajouter 1/${f.d}` : `Ajouter bande ${f.d}`;
                
                const unitW = (UNIT_WIDTH * SIDEBAR_SCALE);
                const pieceW = unitW / f.d;
                const totalW = pieceW * count;
                
                const preview = document.createElement('div');
                preview.className = `sidebar-preview`;
                preview.style.width = totalW + 'px';
                
                for(let i=0; i<count; i++) {
                    const cell = document.createElement('div');
                    cell.className = `token-cell flex-1 h-full ${f.colorClass}`;
                    if (f.d === 1) cell.innerHTML = '<span class="single-number text-[10px]">1</span>';
                    else cell.innerHTML = `<div class="fraction text-[8px]"><span class="numerator">1</span><span class="denominator">${f.d}</span></div>`;
                    preview.appendChild(cell);
                }
                item.appendChild(preview);
                
                item.addEventListener('mousedown', (e) => this.handleSidebarDragStart(e, f, count));
                item.addEventListener('touchstart', (e) => this.handleSidebarDragStart(e, f, count), {passive: false});
                parent.appendChild(item);
            }

            handleSidebarDragStart(e, f, count) {
                e.preventDefault();
                this.sidebarDragging = true;
                this.sidebarDragData = { d: f.d, c: count };
                
                this.dragGhost.innerHTML = '';
                this.dragGhost.style.display = 'block';
                
                const groupEl = document.createElement('div');
                groupEl.className = `token-group ${f.colorClass}`;
                groupEl.style.height = UNIT_HEIGHT + 'px';
                
                const segW = UNIT_WIDTH / f.d;
                const totalW = segW * count;
                groupEl.style.width = totalW + 'px';
                
                for(let i=0; i<count; i++) {
                    const cell = document.createElement('div');
                    cell.className = `token-cell ${f.colorClass}`;
                    cell.style.width = segW + 'px';
                    if (f.d === 1) cell.innerHTML = `<span class="number-one">1</span>`;
                    else cell.innerHTML = `<div class="fraction"><span class="numerator">1</span><span class="denominator">${f.d}</span></div>`;
                    groupEl.appendChild(cell);
                }
                this.dragGhost.appendChild(groupEl);
                
                const cx = e.touches ? e.touches[0].clientX : e.clientX;
                const cy = e.touches ? e.touches[0].clientY : e.clientY;
                this.updateGhostPosition(cx, cy);
            }

            updateGhostPosition(cx, cy) {
                const rect = this.dragGhost.firstElementChild.getBoundingClientRect();
                this.dragGhost.style.left = (cx - rect.width/2) + 'px';
                this.dragGhost.style.top = (cy - rect.height/2) + 'px';
            }

            saveState() {
                if (this.history.length > 20) this.history.shift();
                this.history.push(JSON.stringify(this.groups));
            }
            undo() {
                if (!this.history.length) return;
                this.groups.forEach(g => g.element.remove());
                this.groups = JSON.parse(this.history.pop()).map(data => this.restoreGroup(data));
                this.selectGroup(null);
            }

            addGroup(d, count, x = null, y = null) {
                this.saveState();
                playSound('pop');
                if (x === null) { x = 50 - this.pan.x + Math.random()*20; y = 100 - this.pan.y + Math.random()*20; }
                const g = { id: this.nextId++, d: d, count: count, x: x, y: y, flipped: false, element: null };
                this.renderGroup(g);
                this.groups.push(g);
                return g;
            }

            restoreGroup(data) {
                const g = { ...data, element: null };
                this.renderGroup(g);
                return g;
            }

            renderGroup(g) {
                const el = document.createElement('div');
                const f = FRACTIONS.find(fr => fr.d === g.d);
                el.className = `token-group ${f ? f.colorClass : ''}`; 
                el.style.height = UNIT_HEIGHT + 'px';
                el.id = `g-${g.id}`;
                
                this.updateGroupVisuals(g, el);
                
                el.addEventListener('mousedown', (e) => this.handleGroupDown(e, g));
                el.addEventListener('touchstart', (e) => this.handleGroupDown(e, g), {passive:false});
                el.addEventListener('dblclick', (e) => { e.stopPropagation(); this.flipGroup(g); });

                this.boardWorld.appendChild(el);
                g.element = el;
            }

            updateGroupVisuals(g, el = g.element) {
                if(!el) return;
                const segW = UNIT_WIDTH / g.d;
                const totalW = segW * g.count;
                
                el.style.width = totalW + 'px';
                el.style.left = g.x + 'px';
                el.style.top = g.y + 'px';
                
                if (g.flipped) el.classList.add('flipped');
                else el.classList.remove('flipped');
                
                el.innerHTML = ''; 
                const isFullUnit = (g.count % g.d === 0);
                if (g.flipped && isFullUnit) {
                    const lbl = document.createElement('div');
                    lbl.className = 'back-label number-one'; 
                    lbl.innerText = (g.count / g.d);
                    el.appendChild(lbl);
                }

                const colorClass = FRACTIONS.find(f => f.d === g.d)?.colorClass || 'bg-white';
                for(let i=0; i<g.count; i++) {
                    const cell = document.createElement('div');
                    cell.className = `token-cell ${colorClass}`;
                    cell.style.width = segW + 'px';
                    
                    if (g.d === 1) cell.innerHTML = `<span class="number-one">1</span>`;
                    else cell.innerHTML = `
                        <div class="fraction">
                            <span class="numerator">1</span>
                            <span class="denominator">${g.d}</span>
                        </div>`;
                    el.appendChild(cell);
                }
            }

            flipGroup(g) {
                this.saveState();
                playSound('flip');
                g.flipped = !g.flipped;
                this.updateGroupVisuals(g);
            }
            
            flipSelection() {
                if (this.selectedGroupId) {
                    const g = this.groups.find(x => x.id === this.selectedGroupId);
                    if (g) this.flipGroup(g);
                }
            }

            separateSelection() {
                if (!this.selectedGroupId) return;
                const g = this.groups.find(x => x.id === this.selectedGroupId);
                if (!g || g.count === 1) return;

                this.saveState();
                playSound('pop');

                const segW = UNIT_WIDTH / g.d;
                for(let i=0; i<g.count; i++) {
                    const newG = {
                        id: this.nextId++,
                        d: g.d,
                        count: 1,
                        x: g.x + (i * segW),
                        y: g.y,
                        flipped: g.flipped,
                        element: null
                    };
                    this.renderGroup(newG);
                    this.groups.push(newG);
                }
                g.element.remove();
                this.groups = this.groups.filter(x => x.id !== g.id);
                this.selectGroup(null);
            }

            selectGroup(id) {
                this.selectedGroupId = id;
                this.groups.forEach(g => {
                    if (g.id === id) g.element.classList.add('selected');
                    else g.element.classList.remove('selected');
                });
            }

            resetBoard() {
                this.saveState();
                this.groups.forEach(g => g.element.remove());
                this.groups = [];
                this.clearDrawing();
            }

            handleGroupDown(e, g) {
                if (this.currentTool !== 'hand') return;
                e.stopPropagation();
                if(!e.touches) e.preventDefault(); 
                
                this.selectGroup(g.id);
                g.element.classList.add('dragging');
                g.element.style.zIndex = 100;

                const cx = e.touches ? e.touches[0].clientX : e.clientX;
                const cy = e.touches ? e.touches[0].clientY : e.clientY;
                const startMouse = this.getWorldPos(cx, cy);
                const startX = g.x;
                const startY = g.y;

                const move = (ev) => {
                    ev.preventDefault();
                    const mcx = ev.touches ? ev.touches[0].clientX : ev.clientX;
                    const mcy = ev.touches ? ev.touches[0].clientY : ev.clientY;
                    const curMouse = this.getWorldPos(mcx, mcy);
                    g.x = startX + (curMouse.x - startMouse.x);
                    g.y = startY + (curMouse.y - startMouse.y);
                    g.element.style.left = g.x + 'px';
                    g.element.style.top = g.y + 'px';
                };

                const end = () => {
                    document.removeEventListener('mousemove', move);
                    document.removeEventListener('touchmove', move);
                    document.removeEventListener('mouseup', end);
                    document.removeEventListener('touchend', end);
                    g.element.classList.remove('dragging');
                    g.element.style.zIndex = '';
                    this.checkSnapping(g);
                };

                document.addEventListener('mousemove', move);
                document.addEventListener('touchmove', move, {passive:false});
                document.addEventListener('mouseup', end);
                document.addEventListener('touchend', end);
            }

            checkSnapping(activeG) {
                let snapped = false;
                const segW = UNIT_WIDTH / activeG.d;
                const myW = segW * activeG.count;

                for (let other of this.groups) {
                    if (other.id === activeG.id) continue;
                    const otherSegW = UNIT_WIDTH / other.d;
                    const otherW = otherSegW * other.count;

                    // 1. Fusion Horizontale (Même dénominateur)
                    if (activeG.d === other.d && activeG.flipped === other.flipped) {
                        if (Math.abs(activeG.y - other.y) < SNAP_DIST) {
                            if (Math.abs(activeG.x - (other.x + otherW)) < SNAP_DIST) {
                                this.fuseGroups(other, activeG); return; 
                            }
                            if (Math.abs((activeG.x + myW) - other.x) < SNAP_DIST) {
                                this.fuseGroups(activeG, other); return;
                            }
                        }
                    }

                    // 2. Aimantation Horizontale pour Dénominateurs DIFFÉRENTS (Sans fusion)
                    // (Permet de coller 1/3 et 1/4 côte à côte)
                    if (activeG.d !== other.d) {
                        // Alignement vertical proche
                        if (Math.abs(activeG.y - other.y) < SNAP_DIST) {
                            // Active à Droite de Other
                            if (Math.abs(activeG.x - (other.x + otherW)) < SNAP_DIST) {
                                activeG.y = other.y;
                                activeG.x = other.x + otherW;
                                snapped = true;
                            }
                            // Active à Gauche de Other
                            else if (Math.abs((activeG.x + myW) - other.x) < SNAP_DIST) {
                                activeG.y = other.y;
                                activeG.x = other.x - myW;
                                snapped = true;
                            }
                        }
                    }

                    // 3. Alignement Vertical (Empilement)
                    if (!snapped && Math.abs(activeG.x - other.x) < SNAP_DIST) {
                        if (Math.abs(activeG.y - (other.y + UNIT_HEIGHT)) < SNAP_DIST) {
                            activeG.x = other.x;
                            activeG.y = other.y + UNIT_HEIGHT;
                            snapped = true;
                        }
                        else if (Math.abs((activeG.y + UNIT_HEIGHT) - other.y) < SNAP_DIST) {
                            activeG.x = other.x;
                            activeG.y = other.y - UNIT_HEIGHT;
                            snapped = true;
                        }
                    }
                }

                if (snapped) { playSound('snap'); this.updateGroupVisuals(activeG); }
            }

            fuseGroups(leftG, rightG) {
                this.saveState();
                playSound('snap');
                leftG.count += rightG.count;
                rightG.element.remove();
                this.groups = this.groups.filter(g => g.id !== rightG.id);
                this.updateGroupVisuals(leftG);
                this.selectGroup(leftG.id);
            }

            initListeners() {
                this.boardContainer.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    const delta = -e.deltaY * 0.001;
                    this.scale = Math.min(Math.max(0.2, this.scale + delta), 3);
                    this.updateTransform();
                }, { passive: false });

                this.boardContainer.addEventListener('mousedown', (e) => {
                    const isRightClick = e.button === 2;
                    const isBg = e.target === this.boardContainer || e.target === this.boardWorld;
                    
                    if (this.currentTool === 'pen' && !isRightClick) { this.startDraw(e); return; }
                    
                    if (isRightClick || (this.currentTool === 'hand' && isBg)) {
                        this.isPanning = true;
                        this.panStart = { x: e.clientX - this.pan.x, y: e.clientY - this.pan.y };
                        this.boardContainer.classList.add('panning');
                        this.selectGroup(null);
                    }
                });
                
                this.boardContainer.addEventListener('contextmenu', e => e.preventDefault());
                
                window.addEventListener('mousemove', (e) => {
                    this.moveCursor(e);
                    
                    if (this.sidebarDragging) {
                        const cx = e.touches ? e.touches[0].clientX : e.clientX;
                        const cy = e.touches ? e.touches[0].clientY : e.clientY;
                        this.updateGhostPosition(cx, cy);
                    }
                    else if (this.isPanning) {
                        this.pan.x = e.clientX - this.panStart.x;
                        this.pan.y = e.clientY - this.panStart.y;
                        this.updateTransform();
                    } else if (this.isDrawing) this.draw(e);
                });
                
                window.addEventListener('touchmove', (e) => {
                    if (this.sidebarDragging) {
                        e.preventDefault();
                        const cx = e.touches[0].clientX;
                        const cy = e.touches[0].clientY;
                        this.updateGhostPosition(cx, cy);
                    }
                }, {passive:false});

                const endDrag = (e) => {
                    if (this.sidebarDragging) {
                        this.sidebarDragging = false;
                        this.dragGhost.style.display = 'none';
                        const cx = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
                        const cy = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;
                        
                        const rect = this.boardContainer.getBoundingClientRect();
                        if (cx > rect.left && cx < rect.right && cy > rect.top && cy < rect.bottom) {
                            const pos = this.getWorldPos(cx, cy);
                            const segW = UNIT_WIDTH / this.sidebarDragData.d;
                            const totalW = segW * this.sidebarDragData.c;
                            
                            this.addGroup(this.sidebarDragData.d, this.sidebarDragData.c, pos.x - totalW/2, pos.y - UNIT_HEIGHT/2);
                        }
                        this.sidebarDragData = null;
                    }
                    this.isPanning = false; 
                    this.isDrawing = false; 
                    this.boardContainer.classList.remove('panning'); 
                };

                window.addEventListener('mouseup', endDrag);
                window.addEventListener('touchend', endDrag);
                window.addEventListener('resize', () => this.resizeCanvas());
            }

            updateTransform() { this.boardWorld.style.transform = `translate(${this.pan.x}px, ${this.pan.y}px) scale(${this.scale})`; }
            getWorldPos(cx, cy) {
                const r = this.boardContainer.getBoundingClientRect();
                return { x: (cx - r.left - this.pan.x) / this.scale, y: (cy - r.top - this.pan.y) / this.scale };
            }

            setTool(t){
                this.currentTool=t;
                const p=t==='pen';
                this.boardContainer.classList.toggle('hide-cursor',p);
                document.getElementById('custom-cursor').style.display=p?'block':'none';
                document.getElementById('tool-hand').className = t==='hand' ? "p-2 rounded bg-white shadow text-blue-600" : "p-2 rounded text-gray-500 hover:bg-gray-200";
                document.getElementById('tool-pen').className = t==='pen' ? "p-2 rounded bg-white shadow text-blue-600" : "p-2 rounded text-gray-500 hover:bg-gray-200";
            }
            startDraw(e){this.isDrawing=true;const p=this.getWorldPos(e.touches?e.touches[0].clientX:e.clientX,e.touches?e.touches[0].clientY:e.clientY);this.lastDrawPos=p;this.ctx.beginPath();this.ctx.moveTo(p.x,p.y);}
            draw(e){e.preventDefault();const p=this.getWorldPos(e.touches?e.touches[0].clientX:e.touches?e.touches[0].clientY:e.clientY);this.ctx.lineTo(p.x,p.y);this.ctx.stroke();this.lastDrawPos=p;}
            clearDrawing(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);}
            resizeCanvas(){this.canvas.width=4000;this.canvas.height=4000;this.canvas.style.width='4000px';this.canvas.style.height='4000px';this.ctx.lineWidth=3;this.ctx.lineCap='round';this.ctx.strokeStyle='#2563eb';}
            moveCursor(e){if(this.currentTool!=='pen')return;const c=document.getElementById('custom-cursor');c.style.left=e.clientX+'px';c.style.top=e.clientY+'px';c.style.transform='translate(-6px,-28px)';}
        }

        const app = new FractionApp();
    </script>
</body>
</html>
