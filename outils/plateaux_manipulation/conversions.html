<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Glisse unit√©</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;900&display=swap" rel="stylesheet">
<style>
  :root{ --accent:#1283ff; --accent-dark:#0b67c6; --bg:#fbfbfe; --panel:#fff; --ink:#1b1b1b; --border:#d5d7de }
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:'Nunito',system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .app{max-width:1100px;margin:16px auto;padding:0 12px}
  .topbar{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:10px}
  .left{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .right{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  select{padding:8px 10px;border:1px solid var(--border);border-radius:10px;font-weight:900}
  .btn{border:none;background:var(--accent);color:#fff;font-weight:900;padding:9px 12px;border-radius:10px;cursor:pointer;box-shadow:0 6px 14px color-mix(in srgb, var(--accent) 30%, transparent)}
  .btn.secondary{background:#6b7280}
  .btn.small{padding:7px 10px;border-radius:10px}
  .zoomLabel{font-weight:900;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#fff}
  .btn:active{transform:translateY(1px)}

  .board{background:var(--panel);border:2px solid var(--accent);border-radius:14px;padding:16px 10px 14px;box-shadow:0 10px 26px rgba(0,0,0,.08)}
  .title{font-weight:900;color:color-mix(in srgb, var(--accent-dark) 90%, black);margin:0 0 20px 2px}

  /* espace interne (sans marge qui s'√©crase) pour que la poign√©e ne chevauche pas le titre */
  .inner{position:relative;padding-top:70px}
  .head{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-bottom:6px;position:relative;z-index:2}
  .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;user-select:none;position:relative;z-index:1}

  /* curseur (bandeau) */
  .cursor{
    /* on l'allonge un peu en haut et en bas : effet "bandeau" */
    position:absolute;left:0;top:40px;bottom:-12px;width:calc((100% - 6px*6)/7);
    transform:translateX(var(--x,0));
    background:linear-gradient(to bottom, color-mix(in srgb, var(--accent) 25%, transparent), color-mix(in srgb, var(--accent) 15%, transparent));
    border:3px solid color-mix(in srgb, var(--accent-dark) 60%, transparent);
    border-radius:12px;pointer-events:none;transition:transform .12s ease;z-index:0;
    box-shadow: inset -3px 0 0 color-mix(in srgb, var(--accent-dark) 70%, transparent);
  }
  .cursor::before{
    content:"";position:absolute;top:-12px;left:50%;transform:translateX(-50%);
    border-left:12px solid transparent;border-right:12px solid transparent;border-bottom:12px solid color-mix(in srgb, var(--accent-dark) 60%, transparent);
    filter:drop-shadow(0 2px 2px rgba(0,0,0,.15))
  }
  /* poign√©e de glisse (interactive) */
  .handle{
    position:absolute;left:0;top:12px;
    width:calc((100% - 6px*6)/7);
    transform:translateX(var(--x,0));
    height:28px;
    background:linear-gradient(to bottom, color-mix(in srgb, var(--accent) 92%, #000), color-mix(in srgb, var(--accent-dark) 92%, #000));
    border:2px solid color-mix(in srgb, var(--accent-dark) 60%, transparent);
    border-radius:999px;
    z-index:4;
    display:flex;align-items:center;justify-content:center;
    color:#fff;font-weight:900;
    font-size:16px;line-height:1;
    user-select:none;
    cursor:grab;
    box-shadow:0 10px 20px rgba(0,0,0,.18);
  }
  .handle::before{
    content:"‚ãÆ‚ãÆ";
    position:absolute;left:10px;top:50%;transform:translateY(-50%);
    opacity:.85;font-weight:900;letter-spacing:-2px
  }
  .handle.dragging{cursor:grabbing;filter:drop-shadow(0 10px 14px rgba(0,0,0,.22))}

  .unitBtn{background:color-mix(in srgb, var(--accent) 12%, #fff);border:2px solid var(--accent);border-radius:8px;padding:8px 4px;text-align:center;font-weight:900;cursor:pointer}
  .unitBtn:hover{background:color-mix(in srgb, var(--accent) 18%, #fff)}

  .cell{position:relative;background:#fff;border:2px solid var(--accent);border-radius:8px;min-height:88px;display:flex;align-items:center;justify-content:center}
  /* Suppression du margin-top pour un centrage vertical parfait */
  .slots{margin-top:0;display:flex;gap:0;width:calc(100% - 12px);}
  .digit{box-sizing:border-box;width:calc(100% / var(--S));text-align:center;font-weight:900;font-size:1.75rem;line-height:1.75rem;border:none;outline:none;background:transparent;color:#000;padding:0 4px}
  .slots[data-slots="2"] .digit:nth-child(2),
  .slots[data-slots="3"] .digit:nth-child(2),
  .slots[data-slots="3"] .digit:nth-child(3){border-left:1px solid #000}

  .result{
    display:block;
    width:fit-content;
    max-width:100%;
    margin:10px auto 12px;
    padding:10px 14px;
    border-radius:12px;
    background:#f5f9ff;
    border:1px solid #cfe0ff;
    text-align:center;
  }

  .result .mainLine{
    display:block;
    font-weight:900;
    font-size:2.25rem;
    color:#000;
    line-height:1.12;
  }
  .result .eqLine{
    display:block;
    margin-top:6px;
    font-weight:800;
    font-size:1rem;
    color:#000;
    opacity:.65;
  }

  /* Rep√®res kL / L / mL (mode coupl√©) */
  .subhead{position:relative;height:22px;margin:2px 0 8px;display:none;z-index:3;pointer-events:none}
  .sub-lab{position:absolute;top:0;transform:translateX(-50%);white-space:nowrap;font-weight:900;color:color-mix(in srgb, var(--accent-dark) 90%, black)}

  /* marque les z√©ros auto pour pouvoir les purger proprement */
  .ghost0{}
</style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div class="left">
      <label for="kind"><strong>Grandeur :</strong></label>
      <select id="kind">
        <option value="length" selected>Longueur (m)</option>
        <option value="mass">Masse (g)</option>
        <option value="volL">Volume (L)</option>
        <option value="area">Aire (m¬≤)</option>
        <option value="volM3">Volume (m¬≥)</option>
        <option value="cross">L ‚Üî m¬≥</option>
      </select>
      <button class="btn" id="toggleShow">Afficher</button>
      <button class="btn secondary" id="reset">Remise √† z√©ro</button>
    </div>
    <div class="right" aria-label="Zoom">
      <button class="btn secondary small" id="zoomOut" title="Zoom -" aria-label="Zoom arri√®re">‚àí</button>
      <span class="zoomLabel" id="zoomLabel" aria-label="Niveau de zoom">100%</span>
      <button class="btn secondary small" id="zoomIn" title="Zoom +" aria-label="Zoom avant">+</button>
      <button class="btn secondary small" id="zoomReset" title="R√©initialiser le zoom" aria-label="R√©initialiser le zoom">‚ü≤</button>
    </div>
  </div>

  <div class="board">
    <div class="title" id="title">CONVERSIONS ‚Äì Longueur (m)</div>

    <div class="result" id="result" style="display:none;"></div>

    <div class="inner" id="inner">
      <div class="cursor" id="cursor"></div>
      <div class="handle" id="handle" title="Glisse pour choisir l‚Äôunit√©" aria-label="Glisser pour choisir l‚Äôunit√©">üñêÔ∏è</div>
      <div class="head" id="head"></div>

      <!-- Rep√®res coupl√©s -->
      <div class="subhead" id="subhead">
        <div class="sub-lab" id="labKL">kL</div>
        <div class="sub-lab" id="labL">L</div>
        <div class="sub-lab" id="labML">mL</div>
      </div>

      <div class="grid" id="grid"></div>
    </div>

  </div>
</div>

<script>
(function(){
  const THEMES = {
    length:['#1283ff','#0b67c6'], mass:['#16a34a','#0e7a36'],
    volL:['#06b6d4','#0a8aa3'],   area:['#f59e0b','#b77207'],
    volM3:['#7c3aed','#5a27b0'],  cross:['#db2777','#a81d5a'],
  };
  const SCHEMAS = {
    length:{label:'Longueur (m)', units:['km','hm','dam','m','dm','cm','mm'], base:'m',  slots:1},
    mass:  {label:'Masse (g)',    units:['kg','hg','dag','g','dg','cg','mg'],  base:'g',  slots:1},
    volL:  {label:'Volume (L)',   units:['kL','hL','daL','L','dL','cL','mL'],   base:'L',  slots:1},
    area:  {label:'Aire (m¬≤)',    units:['km¬≤','hm¬≤','dam¬≤','m¬≤','dm¬≤','cm¬≤','mm¬≤'], base:'m¬≤', slots:2},
    volM3: {label:'Volume (m¬≥)',  units:['km¬≥','hm¬≥','dam¬≥','m¬≥','dm¬≥','cm¬≥','mm¬≥'],  base:'m¬≥', slots:3},
    cross: {label:'Litres ‚Üî m√®tres cubes', units:['km¬≥','hm¬≥','dam¬≥','m¬≥','dm¬≥','cm¬≥','mm¬≥'], base:'m¬≥', slots:3},
  };

  const kindSel = document.getElementById('kind');
  const titleEl = document.getElementById('title');
  const head    = document.getElementById('head');
  const grid    = document.getElementById('grid');
  const inner   = document.getElementById('inner');
  const board   = document.querySelector('.board');
  const cursor  = document.getElementById('cursor');
  const handle  = document.getElementById('handle');
  const btnTog  = document.getElementById('toggleShow');
  const btnRst  = document.getElementById('reset');
  const result  = document.getElementById('result');

  // Zoom UI
  const zoomOut   = document.getElementById('zoomOut');
  const zoomIn    = document.getElementById('zoomIn');
  const zoomReset = document.getElementById('zoomReset');
  const zoomLabel = document.getElementById('zoomLabel');

  const subhead = document.getElementById('subhead');
  const labKL   = document.getElementById('labKL');
  const labL    = document.getElementById('labL');
  const labML   = document.getElementById('labML');

  let schema = SCHEMAS.length;
  let targetIdx = 3;
  let currentX = 0;
  let isShown = false;
  let inputs = [];
  let savedStudent = null;

  let zoomScale = 1;

  function applyZoom(){
    if(!board) return;
    // zoom "visuel" sans toucher au fonctionnement : on compense les deltas de glisse en JS
    board.style.transform = `scale(${zoomScale})`;
    board.style.transformOrigin = 'top center';
    if(zoomLabel) zoomLabel.textContent = `${Math.round(zoomScale*100)}%`;
    // Recaler les rep√®res (mode L‚Üîm¬≥) et le bandeau
    positionCoupleLabels();
    setTarget(targetIdx,false);
  }

  function setTheme(kind){
    const [c,cd] = THEMES[kind];
    document.documentElement.style.setProperty('--accent', c);
    document.documentElement.style.setProperty('--accent-dark', cd);
  }

  function rebuild(){
    const kind = kindSel.value;
    schema = SCHEMAS[kind];
    setTheme(kind);
    titleEl.textContent = `CONVERSIONS ‚Äì ${schema.label}`;

    head.innerHTML=''; grid.innerHTML=''; inputs=[];
    schema.units.forEach((u,i)=>{
      const b=document.createElement('div');
      b.className='unitBtn'; b.textContent=u;
      b.addEventListener('click', ()=>setTarget(i,true));
      head.appendChild(b);
    });

    subhead.style.display = (kind==='cross')?'block':'none';

    schema.units.forEach((u,i)=>{
      const cell=document.createElement('div'); cell.className='cell';
      const wrap=document.createElement('div');
      wrap.className='slots'; wrap.dataset.slots=String(schema.slots);
      wrap.style.setProperty('--S', schema.slots);
      const slots=[];
      for(let s=0;s<schema.slots;s++){
        const inp=document.createElement('input');
        inp.className='digit'; inp.maxLength=1; inp.inputMode='numeric';
        inp.addEventListener('input', ()=>{
          const m=inp.value.match(/[0-9]/); inp.value=m?m[0]:'';
          if(isShown){ completeZerosInTable(); updateResult(); }
          if(inp.value){ const [ci,si]=findIndex(inp); focusNext(ci,si); }
        });
        inp.addEventListener('keydown',(e)=>{
          const [ci,si]=findIndex(inp);
          if(e.key==='ArrowLeft'){ e.preventDefault(); focusPrev(ci,si); }
          else if(e.key==='ArrowRight'){ e.preventDefault(); focusNext(ci,si); }
          else if(e.key==='Backspace' && inp.value===''){ e.preventDefault(); focusPrev(ci,si); }
          else if(/^[0-9]$/.test(e.key)){ e.preventDefault(); inp.value=e.key; focusNext(ci,si); if(isShown){ completeZerosInTable(); updateResult(); } }
        });
        inp.addEventListener('focus', ()=>inp.select());
        wrap.appendChild(inp); slots.push(inp);
      }
      cell.appendChild(wrap); grid.appendChild(cell); inputs.push(slots);
    });

    setTarget(schema.units.indexOf(schema.base),false);
    positionCoupleLabels();
    if(isShown){ completeZerosInTable(); updateResult(); }
  }

  /* Rep√®res kL/L/mL centr√©s sur la SOUS-CASE DROITE */
  function positionCoupleLabels(){
    if(kindSel.value!=='cross') return;
    const getCenter = (ci,si)=>{
      const el = inputs?.[ci]?.[si]; if(!el) return 0;
      const r = el.getBoundingClientRect();
      const base = inner.getBoundingClientRect();
      // getBoundingClientRect() donne des px "√©cran" (apr√®s transform:scale). On revient en px logiques.
      return ((r.left - base.left) + r.width/2) / zoomScale;
    };
    const last = schema.slots-1; // sous-case droite
    const nudge = 3;
    labKL.style.left = (getCenter(3,last) + nudge) + 'px'; // m¬≥ ‚Üí kL
    labL .style.left = (getCenter(4,last) + nudge) + 'px'; // dm¬≥ ‚Üí L
    labML.style.left = (getCenter(5,last) + nudge) + 'px'; // cm¬≥ ‚Üí mL
  }
  // Sur redimensionnement, on recale le bandeau sur la colonne choisie
  window.addEventListener('resize', ()=>setTarget(targetIdx,false));

  function findIndex(inp){
    for(let ci=0;ci<inputs.length;ci++){
      const si=inputs[ci].indexOf(inp);
      if(si!==-1) return [ci,si];
    } return [-1,-1];
  }
  function focusNext(ci,si){ if(si<schema.slots-1) inputs[ci][si+1].focus(); else if(ci<inputs.length-1) inputs[ci+1][0].focus(); }
  function focusPrev(ci,si){ if(si>0) inputs[ci][si-1].focus(); else if(ci>0) inputs[ci-1][schema.slots-1].focus(); }

  function setTarget(i,refresh){
    targetIdx=i;
    const colW = head.clientWidth/7;
    currentX = i*colW;
    cursor.style.setProperty('--x', `${currentX}px`);
    // poign√©e (interactive)
    if(handle){
      handle.style.setProperty('--x', `${currentX}px`);
      // on ne r√©√©crit pas l'unit√© dans la poign√©e : l'unit√© est d√©j√† visible dans l'en-t√™te
      handle.textContent = 'üñêÔ∏è';
      handle.setAttribute('aria-label', `Glisser pour choisir l‚Äôunit√© (s√©lection : ${schema.units[targetIdx]})`);
    }
    positionCoupleLabels();
    if(isShown && refresh){ completeZerosInTable(); updateResult(); }
  }

  /* --------- GLISSE DU BANDEAU (POIGN√âE) --------- */
  let isDragging = false;
  let dragStartX = 0;
  let dragStartPx = 0;
  let dragX = 0;

  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

  if(handle){
    handle.addEventListener('pointerdown', (e)=>{
      // emp√™che s√©lection/scroll pendant la glisse
      e.preventDefault();
      isDragging = true;
      dragStartX = e.clientX;
      dragStartPx = currentX;
      dragX = currentX;
      handle.classList.add('dragging');
      cursor.style.transition = 'none';
      try{ handle.setPointerCapture(e.pointerId); }catch(_){/* ignore */}
    });

    handle.addEventListener('pointermove', (e)=>{
      if(!isDragging) return;
      const colW = head.clientWidth/7;
      const maxX = colW*6;
      // si on a zoom√©, on compense le delta souris (en pixels √©cran) pour rester coh√©rent
      dragX = clamp(dragStartPx + ((e.clientX - dragStartX)/zoomScale), 0, maxX);
      cursor.style.setProperty('--x', `${dragX}px`);
      handle.style.setProperty('--x', `${dragX}px`);
    });

    function endDrag(e){
      if(!isDragging) return;
      isDragging = false;
      handle.classList.remove('dragging');
      try{ handle.releasePointerCapture(e.pointerId); }catch(_){/* ignore */}
      // on remet l'animation juste pour le "plop" de snap
      cursor.style.transition = 'transform .12s ease';
      const colW = head.clientWidth/7;
      const i = clamp(Math.round(dragX/colW), 0, 6);
      setTarget(i, true);
    }
    handle.addEventListener('pointerup', endDrag);
    handle.addEventListener('pointercancel', endDrag);
  }

  /* --------- COMPL√âTION DES Z√âROS (CORRIG√âE) --------- */
  function completeZerosInTable(){
    const S = schema.slots;
    const total = schema.units.length * S;
    const slot = (k)=> inputs[Math.floor(k/S)][k%S];

    // (0) purger anciens z√©ros auto
    for(let k=0;k<total;k++){
      const el = slot(k);
      if(el.classList.contains('ghost0')){ el.value=''; el.classList.remove('ghost0'); }
    }

    // rep√©rer 1er et dernier chiffre saisi par l'utilisateur
    let first=-1, last=-1;
    for(let k=0;k<total;k++){
      const v = slot(k).value.trim();
      if(/^[0-9]$/.test(v)){ if(first===-1) first=k; last=k; }
    }
    if(first===-1) return;

    // Unit√© cible : on vise le slot "unit√©s" (le plus √† droite) de la colonne cible
    const targetRightSlot = targetIdx * S + (S - 1);

    // Fin du nombre utilisateur : on vise le slot "unit√©s" de la colonne qui contient le dernier chiffre saisi
    const lastUserCol = Math.floor(last / S);
    const userNumberEnd = lastUserCol * S + (S - 1);

    // Plage √† remplir
    const start = Math.min(first, targetRightSlot);
    const end   = Math.max(userNumberEnd, targetRightSlot);

    for(let k=start; k<=end; k++){
      const el = slot(k);
      if(el.value===''){
        el.value='0';
        el.classList.add('ghost0');
      }
    }
  }

  function saveStudent(){ savedStudent = inputs.map(col=>col.map(inp=>inp.value)); }
  function restoreStudent(){
    if(!savedStudent) return;
    for(let i=0;i<inputs.length;i++)
      for(let s=0;s<inputs[i].length;s++){
        inputs[i][s].value=savedStudent[i][s];
        inputs[i][s].classList.remove('ghost0');
      }
  }

  /* Lecture ‚Üí valeur dans l‚Äôunit√© cible */
  function valueInTarget(){
    const S=schema.slots, baseIdx=schema.units.indexOf(schema.base);
    let sum=0;
    for(let ci=0;ci<schema.units.length;ci++){
      let colVal=0;
      for(let si=0;si<S;si++){
        const ch=inputs[ci][si].value.trim();
        colVal = colVal*10 + (/^[0-9]$/.test(ch)? ch.charCodeAt(0)-48 : 0);
      }
      const pow=(baseIdx-ci)*S;   // vers l‚Äôunit√© de base
      sum += colVal * Math.pow(10, pow);
    }
    const powToTarget=(baseIdx-targetIdx)*S;
    return sum * Math.pow(10, -powToTarget);
  }

  /* ---- D√©cimales minimales n√©cessaires (anti-arrondis) ---- */
  function minFractionDigitsForTarget(){
    const S = schema.slots;
    let minFrac = 0;
    for(let ci=0; ci<inputs.length; ci++){
      let hasUserDigit = false;
      for(let si=0; si<S; si++){
        const el = inputs[ci][si];
        const v  = el.value.trim();
        if(/^[0-9]$/.test(v) && !el.classList.contains('ghost0')){
          hasUserDigit = true; break;
        }
      }
      if(hasUserDigit){
        const delta = (ci - targetIdx) * S; // nb de sous-cases √† droite de la cible
        if(delta > minFrac) minFrac = delta;
      }
    }
    return minFrac;
  }

  function compactFR(str){
    const p = str.split(',');
    if(p.length===1) return str;
    let dec = p[1].replace(/0+$/,'');
    return dec.length ? (p[0]+','+dec) : p[0];
  }

  function formatFR(x){
    const y = Number.isFinite(x) ? Number(x.toFixed(12)) : x;
    return y.toLocaleString('fr-FR', { minimumFractionDigits:0, maximumFractionDigits:12 });
  }

  function addEqLine(txt){
    const eq = document.createElement('span');
    eq.className = 'eqLine';
    eq.textContent = txt;
    result.appendChild(eq);
  }

  function updateResult(){
    const u = schema.units[targetIdx];
    const val = valueInTarget();
    const minFrac = minFractionDigitsForTarget();

    // √âcriture "tableau" (avec z√©ros finaux) puis version compacte (sans z√©ros inutiles √† droite)
    const raw = val.toLocaleString('fr-FR', {
      minimumFractionDigits: minFrac,
      maximumFractionDigits: Math.max(minFrac, 12)
    });
    const compact = compactFR(raw);

    // Affichage : r√©ponse compacte + (si besoin) une ligne d'√©galit√© en petit
    result.innerHTML = '';
    const main = document.createElement('span');
    main.className = 'mainLine';
    main.textContent = `${compact} ${u}`;
    result.appendChild(main);

    if(raw !== compact){
      addEqLine(`${raw} ${u} = ${compact} ${u}`);
    }

    // √âquivalences utiles en mode L ‚Üî m¬≥
    if(kindSel.value === 'cross'){
      if(u === 'm¬≥'){
        const lStr = formatFR(val * 1000);
        addEqLine(`${compact} m¬≥ = ${compact} kL = ${lStr} L`);
      }else if(u === 'dm¬≥'){
        addEqLine(`${compact} dm¬≥ = ${compact} L`);
      }else if(u === 'cm¬≥'){
        addEqLine(`${compact} cm¬≥ = ${compact} mL`);
      }
    }
  }


  document.getElementById('toggleShow').addEventListener('click', ()=>{
    if(!isShown){ saveStudent(); completeZerosInTable(); updateResult(); result.style.display=''; btnTog.textContent='Masquer'; isShown=true; }
    else{ restoreStudent(); result.style.display='none'; btnTog.textContent='Afficher'; isShown=false; savedStudent=null; }
  });
  document.getElementById('reset').addEventListener('click', ()=>{
    inputs.forEach(col=>col.forEach(inp=>{ inp.value=''; inp.classList.remove('ghost0'); }));
    setTarget(schema.units.indexOf(schema.base),false);
    result.style.display='none'; btnTog.textContent='Afficher'; isShown=false; savedStudent=null;
  });
  // Zoom controls
  if(zoomIn) zoomIn.addEventListener('click', ()=>{
    zoomScale = Math.min(1.6, Math.round((zoomScale + 0.1) * 100) / 100);
    applyZoom();
  });
  if(zoomOut) zoomOut.addEventListener('click', ()=>{
    zoomScale = Math.max(0.8, Math.round((zoomScale - 0.1) * 100) / 100);
    applyZoom();
  });
  if(zoomReset) zoomReset.addEventListener('click', ()=>{
    zoomScale = 1;
    applyZoom();
  });

  kindSel.addEventListener('change', ()=>{ rebuild(); applyZoom(); });

  setTheme('length'); rebuild(); applyZoom();
})();
</script>
</body>
</html>
