<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Glisse-entiers</title>
  <style>
    :root{
      --gap: 6px;
      --cell: 72px;       /* recalculé en JS */
      --headH: 38px;      /* recalculé en JS */
      --cols: 10;         /* recalculé en JS */

      --bg-page: #f3f4f6;
      --bg-card: #ffffff;
      --text: #1f2937;
      --border: #e5e7eb;
      --primary: #4f46e5;
      --primary-hover: #4338ca;
      --cell-border: #111827; /* noir */
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    html{ -webkit-text-size-adjust:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: var(--bg-page);
      color: var(--text);
      display:flex;
      flex-direction:column;
      align-items:center;
      padding: clamp(10px, 3vw, 24px);
      -webkit-font-smoothing: antialiased;
      overflow-x:hidden;
      overscroll-behavior-x:none;
    }

    .app{ width:min(1400px, 100%); display:flex; flex-direction:column; gap:16px; }

    .card{
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -1px rgba(0,0,0,0.03);
    }

    .header-card{ display:flex; flex-direction:column; align-items:center; gap:14px; }

    h1{
      margin:0;
      font-weight: 900;
      font-size: clamp(20px, 4vw, 30px);
      color:#111827;
      text-align:center;
    }

    .actions-bar{
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      align-items:center;
      gap:10px;
      width:100%;
    }

    /* Bulle d'opération */
    #opPill{
      background:#e0e7ff;
      color: var(--primary);
      padding: 10px 16px;
      border-radius: 999px;
      font-weight: 900;
      font-size: clamp(18px, 3vw, 24px);
      min-width: 90px;
      text-align:center;
      user-select:none;
    }

    .btn-reset{
      background: #f3f4f6;
      color: #374151;
      border: 1px solid #d1d5db;
      padding: 10px 16px;
      border-radius: 10px;
      font-weight: 800;
      font-size: 16px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content:center;
      gap: 6px;
      user-select:none;
    }
    .btn-reset:hover{ background:#e5e7eb; }

    .settings-bar{
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      align-items:center;
      gap:10px;
      padding-top: 10px;
      border-top: 1px solid #f3f4f6;
      width:100%;
    }

    .picker-container{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 4px 10px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      background:#fff;
      font-size: 14px;
      font-weight: 800;
      color:#4b5563;
      user-select:none;
    }
    .picker-container select{
      border:none;
      background:transparent;
      font-weight: 900;
      font-size: 14px;
      color: var(--primary);
      cursor:pointer;
      outline:none;
    }

    .seg-control{
      display:flex;
      background:#f3f4f6;
      padding:4px;
      border-radius: 10px;
      gap:2px;
      user-select:none;
    }
    .seg-btn{
      border:none;
      background:transparent;
      padding: 6px 12px;
      border-radius: 7px;
      font-size: 13px;
      font-weight: 900;
      color:#6b7280;
      cursor:pointer;
      user-select:none;
    }
    .seg-btn.active{
      background:#fff;
      color: var(--primary);
      box-shadow: 0 1px 2px rgba(0,0,0,0.12);
    }

    .btn-secondary{
      background: transparent;
      border: 1px solid #d1d5db;
      color: #4b5563;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 900;
      cursor: pointer;
      transition: all 0.2s;
      user-select:none;
    }
    .btn-secondary:hover{ background:#f9fafb; border-color:#9ca3af; }
    .btn-secondary.active{
      background: #ecfccb;
      color:#365314;
      border-color:#84cc16;
    }

    .zoom-control{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 4px 10px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      background:#fff;
      user-select:none;
    }
    .zoom-btn{
      width: 34px;
      height: 30px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      background:#f9fafb;
      color:#111827;
      font-weight: 1000;
      font-size: 18px;
      cursor:pointer;
      line-height: 1;
      user-select:none;
    }
    .zoom-btn:hover{ background:#eef2ff; border-color:#a5b4fc; }
    #zoomLabel{
      min-width: 56px;
      text-align:center;
      font-weight: 900;
      font-size: 13px;
      color:#4b5563;
    }

    /* --- Grille --- */
    .grid-container{ width:100%; display:flex; justify-content:center; }

    .grid-shell{ width:max-content; display:flex; flex-direction:column; gap: var(--gap); }

    .grid-row{
      display:grid;
      grid-template-columns: repeat(var(--cols), var(--cell));
      gap: var(--gap);
      align-items:center;
      width: max-content;
    }

    .head{
      height: var(--headH);
      text-align:center;
      background:#e5e7eb;
      color:#374151;
      border-radius: 8px;
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      font-size: 11px;
      line-height: 1.1;
      font-weight: 950;
      padding: 2px;
    }
    .head .lbl{ display:flex; flex-direction:column; }

    /* Titres en long (pivot 90°) */
    .head.long{ padding: 0; }
    .head.long .lbl{ flex-direction:row; justify-content:center; align-items:center; }
    .head.long .lbl span{
      display:block;
      transform: rotate(-90deg);
      white-space: nowrap;
      font-size: clamp(12px, calc(var(--cell)*0.23), 18px);
      font-weight: 1000;
    }

    .cell{
      height: var(--cell);
      background:#fff;
      border: 2px solid var(--cell-border);
      border-radius: 10px;
      display:flex;
      align-items:center;
      justify-content:center;
      position: relative;
      overflow:hidden;
    }
    .cell:focus-within{ border-color: var(--primary); }

    /* Inputs (rangée blanche = repère fixe) */
    form{ display: contents; }
    .digit{
      width:100%;
      height:100%;
      border:none;
      background:transparent;
      text-align:center;
      font: inherit;
      font-weight: 1000;
      font-size: clamp(22px, calc(var(--cell) * 0.50), 40px);
      color:#111827;
      outline:none;
      padding:0;
      margin:0;
      -webkit-appearance:none;
      appearance:none;
    }

    /* Rangée grise (résultat) : fenêtres + bandeau derrière */
    .preview-wrap, .input-wrap{ position: relative; width: 100%; height: var(--cell); }

    .preview-slots{
      position: relative;
      z-index: 4;
      pointer-events: none;
    }
    .preview-slots .cell{ background: rgba(255,255,255,0.08); }

    .preview-viewport{
      position:absolute;
      inset:0;
      overflow:hidden; /* IMPORTANT : effet "ça passe derrière" */
      pointer-events:none;
      z-index: 3;
    }

    .preview-layer{
      position:absolute;
      inset:0;
      display:grid;
      grid-template-columns: repeat(var(--cols), var(--cell));
      gap: var(--gap);
      align-items:center;
      justify-items:center;
      pointer-events:none;
      transform: translateX(0px);
      will-change: transform;
    }

    .pDigit{
      font-weight: 1000;
      font-size: clamp(22px, calc(var(--cell) * 0.50), 40px);
      color:#111827; /* noir */
      line-height: 1;
    }
    .pDigit.ghost0{ color:#111827; opacity: 0.75; }

    /* Bandeau gris (rectangulaire) */
    .drag-bar{
      position:absolute;
      /* +2 cases de chaque cote (environ) */
      left: calc(var(--cell) * -2 - var(--gap) * 2 - 10px);
      right: calc(var(--cell) * -2 - var(--gap) * 2 - 10px);
      top: calc(var(--cell) * 0.08);
      height: calc(var(--cell) * 0.84);
      cursor: grab;
      touch-action: none;
      user-select:none;
      z-index: 2;
      will-change: transform;
      transform: translateX(0px);
    }
    .drag-bar.dragging{ cursor: grabbing; }

    .drag-track{
      width:100%;
      height:100%;
      border-radius: 0px;
      background: rgba(209,213,219,0.62);
      box-shadow: inset 0 2px 3px rgba(0,0,0,0.12), inset 0 -2px 3px rgba(255,255,255,0.55);
      border: 1px solid rgba(107,114,128,0.25);
    }

    .snapping{ transition: transform 140ms cubic-bezier(.2,.9,.2,1); }

    .remainder{
      margin-top: 8px;
      align-self: center;
      background: #fffbeb;
      border: 1px solid #f59e0b;
      color: #92400e;
      padding: 8px 14px;
      border-radius: 999px;
      font-weight: 950;
      user-select:none;
      display: inline-flex;
      align-items:center;
      gap: 8px;
    }

    .credit{
      text-align:center;
      font-size: 12px;
      color:#6b7280;
      margin-top: -6px;
    }
    .credit a{ color:#4b5563; text-decoration:none; border-bottom: 1px dotted #9ca3af; }
    .credit a:hover{ color:#111827; }

    @media (max-width: 600px){
      .settings-bar{ flex-direction: column; align-items: center; }
      .btn-reset{ width:100%; justify-content:center; }
    }
  </style>
</head>
<body>

<main class="app" id="app">

  <section class="card header-card">
    <h1>Glisse-entiers</h1>

    <!-- Bulle de multiplication (sous le titre) -->
    <div class="actions-bar" style="margin-top:-2px;">
      <div id="opPill" aria-live="polite">×1</div>
    </div>

    <div class="actions-bar">
      <button class="btn-reset" id="resetBtn" type="button" aria-label="Réinitialiser">
        Réinitialiser
      </button>
    </div>

    <div class="settings-bar">
      <div class="picker-container">
        <label for="colCount">Colonnes :</label>
        <select id="colCount">
          <option value="6">6</option>
          <option value="7">7</option>
          <option value="8">8</option>
          <option value="9">9</option>
          <option value="10" selected>10</option>
          <option value="11">11</option>
          <option value="12">12</option>
        </select>
      </div>

      <div class="seg-control" id="zerosSeg" role="group" aria-label="Affichage des zéros (rangée grise)">
        <button data-mode="none" class="seg-btn active" type="button">Sans zéros</button>
        <button data-mode="needed" class="seg-btn" type="button">Zéros utiles</button>
        <button data-mode="all" class="seg-btn" type="button">Tous les zéros</button>
      </div>

      <button class="btn-secondary" id="toggleCompact" type="button" title="Abréger les libellés">
        Titres compacts
      </button>
      <button class="btn-secondary" id="toggleLong" type="button" title="Libellés verticaux (pivotés à 90°)">
        Titres en long
      </button>

      <div class="zoom-control" aria-label="Zoom">
        <button class="zoom-btn" id="zoomOut" type="button" aria-label="Dézoomer">−</button>
        <div id="zoomLabel">100%</div>
        <button class="zoom-btn" id="zoomIn" type="button" aria-label="Zoomer">+</button>
      </div>
    </div>
  </section>

  <section class="card" style="padding: 10px 0;" id="gridCard">
    <div class="grid-container">
      <div class="grid-shell" id="gridShell">
        <div class="grid-row" id="headRow"></div>

        <!-- PREVIEW (haut) -->
        <div class="preview-wrap" id="previewWrap">
          <div class="grid-row preview-slots" id="previewSlots" aria-hidden="true"></div>
          <div class="preview-viewport" aria-hidden="true">
            <div class="preview-layer" id="previewLayer" aria-hidden="true"></div>
          </div>
          <div class="drag-bar" id="dragBar" role="slider" aria-label="Glisser" tabindex="0">
            <div class="drag-track"></div>
          </div>
        </div>

        <!-- INPUTS (bas = repère fixe) -->
        <div class="input-wrap" id="inputWrap">
          <form id="inputForm" autocomplete="off" aria-autocomplete="none">
            <div class="grid-row" id="inputRow"></div>
          </form>
        </div>

        <div class="remainder" id="remainderBox" hidden>Reste 0</div>
      </div>
    </div>
  </section>

  <div class="credit">Inspiré de : <a href="https://mathix.org/glisse-nombre/" target="_blank" rel="noopener">mathix.org/glisse-nombre/</a></div>

</main>

<script>
(() => {
  // --- Libellés (12 colonnes max) ---
  const LABELS_LONG = [
    ['Centaines','de milliards'],
    ['Dizaines','de milliards'],
    ['Milliards'],
    ['Centaines','de millions'],
    ['Dizaines','de millions'],
    ['Unités','de million'],
    ['Centaines','de milliers'],
    ['Dizaines','de milliers'],
    ['Milliers'],
    ['Centaines'],
    ['Dizaines'],
    ['Unités']
  ];
  const LABELS_SHORT = [
    ['Cent.','de mrd'],
    ['Diz.','de mrd'],
    ['Mrd'],
    ['Cent.','de M'],
    ['Diz.','de M'],
    ['U.','de M'],
    ['Cent.','de k'],
    ['Diz.','de k'],
    ['k'],
    ['Cent.'],
    ['Diz.'],
    ['U']
  ];

  const root = document.documentElement;
  const app = document.getElementById('app');

  const headRow = document.getElementById('headRow');
  const inputRow = document.getElementById('inputRow');
  const previewSlots = document.getElementById('previewSlots');
  const previewLayer = document.getElementById('previewLayer');
  const dragBar = document.getElementById('dragBar');
  const opPill = document.getElementById('opPill');
  const remainderBox = document.getElementById('remainderBox');

  const resetBtn = document.getElementById('resetBtn');
  const zerosSeg = document.getElementById('zerosSeg');
  const toggleCompact = document.getElementById('toggleCompact');
  const toggleLong = document.getElementById('toggleLong');
  const colSelect = document.getElementById('colCount');

  const zoomInBtn = document.getElementById('zoomIn');
  const zoomOutBtn = document.getElementById('zoomOut');
  const zoomLabel = document.getElementById('zoomLabel');

  // --- Etat ---
  let COL_COUNT = parseInt(colSelect.value, 10) || 10;
  let zeroMode = 'none';  // none | needed | all
  let exp10 = 0;          // exp10>0 => ×10^exp10, exp10<0 => ÷10^|exp10|
  let isCompact = false;  // par défaut désactivé
  let isLong = false;
  let zoomFactor = 1.0;

  let stepPx = 70;
  let inputIds = [];
  let inputs = [];
  let previewDigits = [];
  let activeLabels = [];

  // Anti-historique / autosuggestions
  const INPUT_ATTRS = {
    autocomplete: 'off',
    autocorrect: 'off',
    autocapitalize: 'off',
    spellcheck: 'false',
    inputmode: 'numeric',
    pattern: '[0-9]*',
    'aria-autocomplete': 'none'
  };

  function sanitizeToDigit(v){
    const m = (v||'').toString().match(/[0-9]/);
    return m ? m[0] : '';
  }

  function formatExpLabel(exp){
    if (exp === 0) return '×1';
    const n = Math.abs(exp);
    const pow = (n <= 6) ? (10 ** n).toLocaleString('fr-FR') : ('10^' + n);
    return (exp > 0) ? ('×' + pow) : ('÷' + pow);
  }

  function updateOpLabel(expShown){
    opPill.textContent = formatExpLabel(expShown);
  }

  function setZoomLabel(){
    zoomLabel.textContent = Math.round(zoomFactor * 100) + '%';
  }

  function getStepPx(){
    const cs = getComputedStyle(root);
    const cell = parseFloat(cs.getPropertyValue('--cell')) || 60;
    const gap = parseFloat(cs.getPropertyValue('--gap')) || 6;
    return cell + gap;
  }

  function calcCell(){
    const containerW = app.clientWidth;
    const margin = 40;
    const gap = 6;
    const nbCols = COL_COUNT;

    // Taille maximale qui tient a l'ecran (sans debordement)
    const cFit = Math.max(48, Math.floor((containerW - margin - (nbCols-1)*gap) / nbCols));

    // Base volontairement un peu plus petite pour que le zoom soit utile
    const cBase = Math.max(48, Math.min(110, cFit));

    // Zoom sans depasser la taille qui tient a l'ecran
    let c = Math.round(cBase * zoomFactor);
    c = Math.max(48, Math.min(cFit, c));

    root.style.setProperty('--cell', c + 'px');
    const headFactor = isLong ? 1.35 : 0.60;
    root.style.setProperty('--headH', Math.max(32, Math.round(c * headFactor)) + 'px');

    stepPx = getStepPx();
  }

  function renderHeaders(){
    headRow.innerHTML = '';
    const src = isCompact ? LABELS_SHORT : LABELS_LONG;
    activeLabels = src.slice(src.length - COL_COUNT);

    for (let i=0;i<COL_COUNT;i++){
      const head = document.createElement('div');
      head.className = 'head' + (isLong ? ' long' : '');
      const lbl = document.createElement('div');
      lbl.className = 'lbl';
      const parts = activeLabels[i];
      lbl.innerHTML = parts.map(t => `<span>${t}</span>`).join('');
      head.appendChild(lbl);
      headRow.appendChild(head);
    }
  }

  function buildGrid(){
    root.style.setProperty('--cols', String(COL_COUNT));

    renderHeaders();

    // Inputs
    inputRow.innerHTML = '';
    inputIds = [];
    inputs = [];

    for (let i=0;i<COL_COUNT;i++){
      const cell = document.createElement('div');
      cell.className = 'cell';

      const inp = document.createElement('input');
      inp.className = 'digit';
      inp.maxLength = 1;
      inp.id = 'd' + i;
      inp.setAttribute('aria-label', activeLabels[i].join(' '));

      Object.entries(INPUT_ATTRS).forEach(([k,v]) => inp.setAttribute(k, v));

      cell.appendChild(inp);
      inputRow.appendChild(cell);

      inputIds.push(inp.id);
      inputs.push(inp);
    }

    // Preview slots (fenetres)
    previewSlots.innerHTML = '';
    for (let i=0;i<COL_COUNT;i++){
      const cell = document.createElement('div');
      cell.className = 'cell';
      previewSlots.appendChild(cell);
    }

    // Preview digits
    previewLayer.innerHTML = '';
    previewDigits = [];
    for (let i=0;i<COL_COUNT;i++){
      const d = document.createElement('div');
      d.className = 'pDigit';
      previewLayer.appendChild(d);
      previewDigits.push(d);
    }

    attachInputHandlers();
    calcCell();
    renderAll();
  }

  function readBase(){
    const a = new Array(COL_COUNT).fill('');
    for (let i=0;i<COL_COUNT;i++) a[i] = document.getElementById(inputIds[i]).value;
    return a;
  }

  function shiftedDigits(base, exp){
    const out = new Array(COL_COUNT).fill('');
    for (let i=0;i<COL_COUNT;i++){
      const src = i + exp;
      out[i] = (src >= 0 && src < COL_COUNT) ? (base[src] || '') : '';
    }
    return out;
  }

  function computeGhostSet(raw){
    const ghost = new Set();

    if (zeroMode === 'all'){
      for (let i=0;i<COL_COUNT;i++) if (raw[i] === '') ghost.add(i);
      return ghost;
    }

    if (zeroMode === 'needed'){
      const hasAny = raw.some(v => v !== '');
      if (!hasAny) return ghost;

      let firstFilled = -1;
      for (let i=0;i<COL_COUNT;i++){
        if (raw[i] !== '') { firstFilled = i; break; }
      }
      if (firstFilled === -1) return ghost;

      for (let i=firstFilled+1; i<COL_COUNT; i++){
        if (raw[i] === '') ghost.add(i);
      }
    }

    return ghost;
  }

  function renderPreview(base, expShown){
    const raw = shiftedDigits(base, expShown);
    const ghostSet = computeGhostSet(raw);

    for (let i=0;i<COL_COUNT;i++){
      const el = previewDigits[i];
      const v = raw[i] || '';
      if (v !== ''){
        el.textContent = v;
        el.classList.remove('ghost0');
      } else if (ghostSet.has(i)){
        el.textContent = '0';
        el.classList.add('ghost0');
      } else {
        el.textContent = '';
        el.classList.remove('ghost0');
      }
    }
  }

  function canonicalNumberString(base){
    let first = -1;
    for (let i=0;i<base.length;i++){
      if (base[i] !== '') { first = i; break; }
    }
    if (first === -1) return '0';

    let s = '';
    for (let i=first;i<base.length;i++){
      s += (base[i] !== '' ? base[i] : '0');
    }
    s = s.replace(/^0+(?=\d)/, '');
    return s === '' ? '0' : s;
  }

  function remainderString(base, k){
    if (k <= 0) return '0';
    const s = canonicalNumberString(base);
    if (s === '0') return '0';

    const take = Math.min(k, s.length);
    let r = s.slice(s.length - take);
    r = r.replace(/^0+(?=\d)/, '');
    return r === '' ? '0' : r;
  }

  function renderRemainder(base, expShown){
    if (expShown >= 0){
      remainderBox.hidden = true;
      return;
    }

    const k = Math.abs(expShown);
    const r = remainderString(base, k);
    remainderBox.textContent = 'Reste ' + r;
    remainderBox.hidden = false;
  }

  function renderAll(){
    const base = readBase();
    updateOpLabel(exp10);
    renderPreview(base, exp10);
    renderRemainder(base, exp10);
  }

  // --- Drag logic ---
  let dragging = false;
  let startX = 0;
  let dragDx = 0;
  let tentativeSteps = 0;

  function setTranslate(dx){
    dragBar.style.transform = `translateX(${dx}px)`;
    previewLayer.style.transform = `translateX(${dx}px)`;
  }

  function onDragStart(e){
    dragging = true;
    startX = e.clientX;
    dragDx = 0;
    tentativeSteps = 0;
    dragBar.classList.add('dragging');
    dragBar.classList.remove('snapping');
    previewLayer.classList.remove('snapping');
    dragBar.setPointerCapture?.(e.pointerId);
  }

  function onDragMove(e){
    if (!dragging) return;
    const dx = e.clientX - startX;
    dragDx = dx;
    setTranslate(dragDx);

    tentativeSteps = -Math.round(dragDx / stepPx);
    const expShown = exp10 + tentativeSteps;
    updateOpLabel(expShown);

    // Reste (pendant le glisser)
    const base = readBase();
    renderRemainder(base, expShown);
  }

  function onDragEnd(){
    if (!dragging) return;
    dragging = false;
    dragBar.classList.remove('dragging');

    const steps = tentativeSteps;
    const targetDx = -steps * stepPx;

    dragBar.classList.add('snapping');
    previewLayer.classList.add('snapping');
    setTranslate(targetDx);

    window.setTimeout(() => {
      exp10 += steps;
      dragBar.classList.remove('snapping');
      previewLayer.classList.remove('snapping');
      setTranslate(0);
      renderAll();
    }, 160);
  }

  // --- Inputs ---
  function focusMove(el, delta){
    const idx = inputs.indexOf(el);
    if (idx < 0) return;
    const nextIdx = Math.min(inputs.length - 1, Math.max(0, idx + delta));
    inputs[nextIdx].focus();
    inputs[nextIdx].select?.();
  }

  function attachInputHandlers(){
    inputs.forEach(inp => {
      inp.addEventListener('beforeinput', (e) => {
        if (e.inputType === 'insertText' || e.inputType === 'insertFromPaste'){
          const ch = (e.data || '').replace(/[^0-9]/g, '');
          if (ch === '') e.preventDefault();
        }
      });

      inp.addEventListener('input', (e) => {
        const v = sanitizeToDigit(e.target.value);
        e.target.value = v;
        renderAll();
        if (v !== '') focusMove(e.target, +1);
      });

      inp.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') { e.preventDefault(); focusMove(e.target, -1); }
        if (e.key === 'ArrowRight') { e.preventDefault(); focusMove(e.target, +1); }
        if (e.key === 'Backspace' && e.target.value === '') { e.preventDefault(); focusMove(e.target, -1); }
      });
    });
  }

  // Blur input when clicking elsewhere (bandeau, fond, etc.)
  document.addEventListener('pointerdown', (e) => {
    const a = document.activeElement;
    if (a && a.classList && a.classList.contains('digit')){
      const inputWrap = document.getElementById('inputWrap');
      if (!inputWrap.contains(e.target)){
        a.blur();
      }
    }
  }, true);

  // --- Controls ---
  zerosSeg.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-mode]');
    if (!btn) return;
    zeroMode = btn.dataset.mode;
    zerosSeg.querySelectorAll('button[data-mode]').forEach(b => b.classList.toggle('active', b === btn));
    renderAll();
  });

  toggleCompact.addEventListener('click', () => {
    if (isLong) return;
    isCompact = !isCompact;
    toggleCompact.classList.toggle('active', isCompact);
    buildGrid();
  });

  toggleLong.addEventListener('click', () => {
    isLong = !isLong;
    toggleLong.classList.toggle('active', isLong);
    if (isLong){
      isCompact = false;
      toggleCompact.classList.remove('active');
    }
    buildGrid();
  });

  resetBtn.addEventListener('click', () => {
    exp10 = 0;
    setTranslate(0);
    inputs.forEach(i => i.value = '');
    remainderBox.hidden = true;
    renderAll();
    inputs[0]?.focus();
  });

  colSelect.addEventListener('change', () => {
    COL_COUNT = parseInt(colSelect.value, 10) || 10;
    buildGrid();
  });

  zoomInBtn.addEventListener('click', () => {
    zoomFactor = Math.min(1.8, Math.round((zoomFactor + 0.1) * 10) / 10);
    setZoomLabel();
    calcCell();
  });

  zoomOutBtn.addEventListener('click', () => {
    zoomFactor = Math.max(0.8, Math.round((zoomFactor - 0.1) * 10) / 10);
    setZoomLabel();
    calcCell();
  });

  // Drag events
  dragBar.addEventListener('pointerdown', onDragStart);
  window.addEventListener('pointermove', onDragMove, { passive: true });
  window.addEventListener('pointerup', onDragEnd, { passive: true });
  window.addEventListener('pointercancel', onDragEnd, { passive: true });

  // Init
  setZoomLabel();
  buildGrid();
  window.addEventListener('resize', () => { calcCell(); });
  window.addEventListener('orientationchange', () => setTimeout(calcCell, 100));
})();
</script>

</body>
</html>
