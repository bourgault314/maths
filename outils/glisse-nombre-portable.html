<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Glisse nombre</title>
  <style>
    :root{
      --gap: 8px;
      --cell: clamp(38px, calc((100vw - 32px - 11*var(--gap)) / 12), 78px);
      --headH: clamp(28px, calc(var(--cell)*0.52), 40px);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    html{ -webkit-text-size-adjust:100%; } /* évite les zooms/resize auto iOS */
    body{
      margin:0;
      font:20px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:#f7f7f7; color:#0b0b0b;
      display:flex; justify-content:center;
      padding: clamp(10px, 3vw, 28px);
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;

      /* Safe area pour encoche/bords arrondis */
      padding-left: max(10px, env(safe-area-inset-left));
      padding-right: max(10px, env(safe-area-inset-right));
    }

    .app{
      width:min(1200px,100%);
      overflow-x:auto; /* sécurité si ça déborde */
      -webkit-overflow-scrolling: touch; /* inertie iOS */
      overscroll-behavior: contain;
    }

    .card{
      position:relative;
      background:#fff; border:1.5px solid #444; border-radius:16px;
      padding:18px; margin-bottom:18px; box-shadow:0 2px 8px rgba(0,0,0,.10)
    }
    h1{margin:0 0 8px; font-size:clamp(18px, 2.6vw, 26px); font-weight:800; letter-spacing:.2px}

    .controls{
      position:relative; z-index:2; /* garantit les clics au-dessus */
      display:flex; flex-wrap:wrap; gap:8px; align-items:center
    }

    /* Boutons / contrôles : 16px mini => empêche le zoom iOS */
    .btn{
      border:1.5px solid #444;
      background:#f2f2f2;
      border-radius:12px;
      padding:8px 12px;
      font-size: clamp(16px, 2.8vw, 18px);
      font-weight:700;
      cursor:pointer; line-height:1
    }
    .btn.primary{background:#2563eb; color:#fff; border-color:#2563eb}

    .seg{display:flex; border:1.5px solid #444; border-radius:12px; overflow:hidden}
    .seg button{
      padding:8px 12px; font-weight:700; border:0; background:#e9e9e9; cursor:pointer;
      font-size: clamp(16px, 2.6vw, 18px);
    }
    .seg button+button{border-left:1.5px solid #444}
    .seg .active{background:#0ea5e9; color:#fff}

    /* Grille */
    .grid{
      display:grid;
      grid-template-columns:repeat(12,var(--cell));
      gap:var(--gap);
      justify-content:center;
      margin-top:12px;
      /* +2px de marge pour éviter le pile-poil qui fait sauter une colonne */
      min-width: calc(12*var(--cell) + 11*var(--gap) + 2px);
    }
    .head{
      height:var(--headH); text-align:center; font-weight:800; background:#ececec;
      border-radius:12px; user-select:none; padding:0 6px;
      display:flex; align-items:center; justify-content:center
    }
    .head .lbl{
      display:flex; flex-direction:column;
      font-size: clamp(10px, calc(var(--cell)*0.15), 12px);
      font-weight:800; line-height:1.05; letter-spacing:.05px
    }

    .cell{
      height:var(--cell); border:1.5px solid #4a4a4a;
      border-radius: clamp(8px, calc(var(--cell)*0.16), 12px);
      display:flex; align-items:center; justify-content:center;
      background:#fff; position:relative; overflow:hidden
    }
    .comma{background:#e0f2fe}
    .comma span{font-size: clamp(14px, calc(var(--cell)*0.34), 26px); font-weight:900; color:#2563eb}

    .digit{
      width:100%; height:100%; border:0; outline:none; background:transparent; text-align:center;
      /* mini 16px pour empêcher le zoom iOS */
      font: 800 clamp(16px, calc(var(--cell)*0.40), 30px)/1 system-ui,-apple-system,Segoe UI,Roboto,Arial;
      caret-color:#2563eb
    }
    .digit::placeholder{color:#bfbfbf}
    button, input, select { font-size:16px; touch-action:manipulation; }

    .ghost{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      font: 800 clamp(16px, calc(var(--cell)*0.40), 30px)/1 system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:#000; pointer-events:none
    }

    #status{margin-top:8px; font-weight:800; font-size:clamp(14px, 2.2vw, 18px)}

    input.digit:-webkit-autofill{
      -webkit-box-shadow: 0 0 0 1000px #fff inset !important;
      -webkit-text-fill-color: inherit !important;
      caret-color:#2563eb;
    }

    /* Ajustement paysage mobile : calcul sur vmin pour robustesse */
    @media (orientation: landscape) and (max-width: 900px){
      :root{
        --gap: 6px;
        --cell: clamp(28px, calc((100vmin - 20px - 11*var(--gap)) / 12), 68px);
      }
    }

    @media (max-width:420px){
      .btn, .seg button{ padding:6px 9px }
      .head .lbl{ line-height:1.0; letter-spacing:0 }
    }

    /* Apparence compacte des libellés (quand activée par JS) */
    .compact .head .lbl{
      font-size: clamp(10px, calc(var(--cell)*0.14), 11px);
    }
  </style>
</head>
<body>
  <main class="app">
    <form class="card" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" onsubmit="return false;">
      <h1>Glisse nombre</h1>
      <div class="controls">
        <button class="btn" id="resetBtn" type="button">Réinitialiser</button>
        <button class="btn" id="times10" type="button">×10</button>
        <button class="btn" id="div10" type="button">÷10</button>
        <div class="seg" id="zerosSeg" role="group" aria-label="Affichage des zéros">
          <button data-mode="none" class="active" type="button">Zéros : Aucun</button>
          <button data-mode="needed" type="button">Zéros : Nécessaires</button>
          <button data-mode="all" type="button">Zéros : Partout</button>
        </div>
        <button class="btn" id="exitZerosBtn" type="button" title="Gestion des sorties">Gestion de la sortie</button>
      </div>

      <section class="card" style="z-index:1;">
        <div class="grid" id="grid">
          <!-- En-têtes -->
          <div class="head" data-col="0"><div class="lbl"><span>Centaines</span><span>de milliers</span></div></div>
          <div class="head" data-col="1"><div class="lbl"><span>Dizaines</span><span>de milliers</span></div></div>
          <div class="head" data-col="2"><div class="lbl"><span>Milliers</span></div></div>
          <div class="head" data-col="3"><div class="lbl"><span>Centaines</span></div></div>
          <div class="head" data-col="4"><div class="lbl"><span>Dizaines</span></div></div>
          <div class="head" data-col="5"><div class="lbl"><span>Unités</span></div></div>
          <div class="head" data-col="6"><div class="lbl"><span>,</span></div></div>
          <div class="head" data-col="7"><div class="lbl"><span>Dixièmes</span></div></div>
          <div class="head" data-col="8"><div class="lbl"><span>Centièmes</span></div></div>
          <div class="head" data-col="9"><div class="lbl"><span>Millièmes</span></div></div>
          <div class="head" data-col="10"><div class="lbl"><span>Dix</span><span>millièmes</span></div></div>
          <div class="head" data-col="11"><div class="lbl"><span>Cent</span><span>millièmes</span></div></div>

          <!-- Entrées -->
          <div class="cell"><input class="digit" maxlength="1" inputmode="numeric" id="c00" name="d00" autocomplete="off" aria-label="Centaines de milliers" /></div>
          <div class="cell"><input class="digit" maxlength="1" inputmode="numeric" id="c0"  name="d0"  autocomplete="off" aria-label="Dizaines de milliers" /></div>
          <div class="cell"><input class="digit" maxlength="1" inputmode="numeric" id="c1"  name="d1"  autocomplete="off" aria-label="Milliers" /></div>
          <div class="cell"><input class="digit" maxlength="1" inputmode="numeric" id="c2"  name="d2"  autocomplete="off" aria-label="Centaines" /></div>
          <div class="cell"><input class="digit" maxlength="1" inputmode="numeric" id="c3"  name="d3"  autocomplete="off" aria-label="Dizaines" /></div>
          <div class="cell"><input class="digit" maxlength="1" inputmode="numeric" id="c4"  name="d4"  autocomplete="off" aria-label="Unités" /></div>
          <div class="cell comma" aria-hidden="true"><span>,</span></div>
          <div class="cell"><input class="digit" maxlength="1" inputmode="numeric" id="c6"  name="d6"  autocomplete="off" aria-label="Dixièmes" /></div>
          <div class="cell"><input class="digit" maxlength="1" inputmode="numeric" id="c7"  name="d7"  autocomplete="off" aria-label="Centièmes" /></div>
          <div class="cell"><input class="digit" maxlength="1" inputmode="numeric" id="c8"  name="d8"  autocomplete="off" aria-label="Millièmes" /></div>
          <div class="cell"><input class="digit" maxlength="1" inputmode="numeric" id="c9"  name="d9"  autocomplete="off" aria-label="Dix millièmes" /></div>
          <div class="cell"><input class="digit" maxlength="1" inputmode="numeric" id="c10" name="d10" autocomplete="off" aria-label="Cent millièmes" /></div>
        </div>
        <div id="status">×1</div>
      </section>
    </form>
  </main>

  <script>
    const ids=["c00","c0","c1","c2","c3","c4",null,"c6","c7","c8","c9","c10"]; // 12 colonnes (6 entiers, virgule, 5 décimales)
    const INT=[0,1,2,3,4,5];
    const DEC=[7,8,9,10,11];
    const UNITS=5;
    const COMMA=6;
    const order=[0,1,2,3,4,5,7,8,9,10,11];

    const inputs=order.map(i=>document.getElementById(ids[i]));
    const zerosSeg=document.getElementById('zerosSeg');
    const resetBtn=document.getElementById('resetBtn');
    const times10=document.getElementById('times10');
    const div10=document.getElementById('div10');
    const exitZerosBtn=document.getElementById('exitZerosBtn');
    const status=document.getElementById('status');
    const grid=document.getElementById('grid');

    // État
    let zeroMode='none'; // 'none' | 'needed' | 'all'
    let exp10=0;         // cumul ×10/÷10
    let exitZeros=false; // remplir les trous pendant débordement ? affichage fantôme
    const leftStack=[];  // ce qui sort à gauche (×10)
    const rightStack=[]; // ce qui sort à droite (÷10)
    let overflowSide=null; // 'left' | 'right' | null
    let compact=false;     // libellés compacts auto < 420px

    // Helpers
    function sanitizeToDigit(v){ const m=(v||'').toString().match(/[0-9]/); return m?m[0]:''; }
    function indexOfInput(el){ return order.findIndex(i=>ids[i]===el.id); }
    function focusMove(delta){
      const active=document.activeElement; if(!active||!active.classList.contains('digit')) return;
      let idx=indexOfInput(active); if(idx<0) return;
      idx=Math.min(order.length-1, Math.max(0, idx+delta));
      inputs[idx].focus(); inputs[idx].select();
    }
    function readRaw(){ const a=new Array(ids.length).fill(''); for(const i of order){ a[i]=document.getElementById(ids[i]).value; } return a; }
    function writeRaw(arr){ for(const i of order){ document.getElementById(ids[i]).value=arr[i]||''; } }
    function clearGhosts(){ document.querySelectorAll('.cell .ghost').forEach(g=>g.remove()); }

    // Libellés: normal vs compact
    const labelsNormal = [
      ['Centaines','de milliers'],
      ['Dizaines','de milliers'],
      ['Milliers'],
      ['Centaines'],
      ['Dizaines'],
      ['Unités'],
      [','],
      ['Dixièmes'],
      ['Centièmes'],
      ['Millièmes'],
      ['Dix','millièmes'],
      ['Cent','millièmes']
    ];
    const labelsCompact = [
      ['Cent.','de mill.'],
      ['Diz.','de mill.'],
      ['Milliers'],
      ['Cent.'],
      ['Diz.'],
      ['Unités'],
      [','],
      ['Dixièmes'],
      ['Centièmes'],
      ['Millièmes'],
      ['Dix','mill.'],
      ['Cent','mill.']
    ];
    function renderLabels(useCompact){
      document.querySelectorAll('.head').forEach((head, idx)=>{
        const lbl = head.querySelector('.lbl');
        const set = useCompact ? labelsCompact : labelsNormal;
        const parts = set[idx] || [''];
        lbl.innerHTML = parts.map(t=>`<span>${t}</span>`).join('');
      });
      grid.classList.toggle('compact', !!useCompact);
    }
    function autoCompact(){
      const w = Math.min(window.innerWidth, document.documentElement.clientWidth || window.innerWidth);
      const should = w < 420;
      if(should !== compact){
        compact = should;
        renderLabels(compact);
      }
    }

    // Zéros d'affichage
    function applyZeroMode(){
      clearGhosts();
      const raw=readRaw();
      const hasInt=INT.some(i=>raw[i]!=='' );
      const hasDec=DEC.some(i=>raw[i]!=='' );
      function addGhost(i){ const cell=document.getElementById(ids[i]).parentElement; const g=document.createElement('div'); g.className='ghost'; g.textContent='0'; cell.appendChild(g); }
      if(zeroMode==='all'){
        for(const i of INT){ if(raw[i]==='') addGhost(i); }
        for(const i of DEC){ if(raw[i]==='') addGhost(i); }
      } else if(zeroMode==='needed'){
        if(hasDec){ for(const i of DEC){ if(raw[i]!=='' ) break; addGhost(i); } }
        if(hasInt){
          let lastInt=-1; for(const i of INT){ if(raw[i]!=='' ) lastInt=i; }
          for(let i=lastInt+1; i<=UNITS; i++){ addGhost(i); }
        } else if(hasDec){ addGhost(UNITS); }
      }
    }

    // Zéros pendant débordement (affichage seulement) du côté d'origine
    function ensureExitZeros(){
      if(!exitZeros || !overflowSide) return;
      const raw=readRaw();
      function addGhost(i){
        const cell=document.getElementById(ids[i]).parentElement;
        if(!cell.querySelector('.ghost')){
          const g=document.createElement('div'); g.className='ghost'; g.textContent='0'; cell.appendChild(g);
        }
      }
      if(overflowSide==='left'){ for(const i of INT){ if(raw[i]==='') addGhost(i); } }
      else if(overflowSide==='right'){ for(const i of DEC){ if(raw[i]==='') addGhost(i); } }
    }

    // Décalages ×10 / ÷10
    function shift(dir){
      const prev=readRaw();
      const next=prev.slice();
      const orderLinear=[0,1,2,3,4,5,7,8,9,10,11];
      const first=orderLinear[0];
      const last =orderLinear[orderLinear.length-1];

      if(dir==='left'){
        exp10++;
        const lost=prev[first]; if(lost!=='') leftStack.push(lost);
        for(const i of orderLinear){
          const nxt=(i+1===COMMA)?COMMA+1:(i+1);
          next[i]=(nxt<ids.length)?prev[nxt]:''; // décale vers la gauche (×10)
        }
        if(rightStack.length){ next[last]=rightStack.pop(); }
      } else {
        exp10--;
        const lost=prev[last]; if(lost!=='') rightStack.push(lost);
        for(let k=orderLinear.length-1;k>=0;k--){
          const i=orderLinear[k];
          const prv=(i-1===COMMA)?UNITS:(i-1);
          next[i]=(prv>=0)?prev[prv]:''; // décale vers la droite (÷10)
        }
        if(leftStack.length){ next[first]=leftStack.pop(); }
      }

      if(overflowSide===null){
        if(leftStack.length>0 && rightStack.length===0) overflowSide='left';
        else if(rightStack.length>0 && leftStack.length===0) overflowSide='right';
      }
      if(leftStack.length===0 && rightStack.length===0) overflowSide=null;

      writeRaw(next);
      applyZeroMode();
      ensureExitZeros();
      updateStatus();
    }

    function resetAll(){
      inputs.forEach(i=>i.value='');
      clearGhosts();
      zeroMode='none';
      zerosSeg.querySelectorAll('button').forEach(x=>x.classList.remove('active'));
      zerosSeg.querySelector('[data-mode="none"]').classList.add('active');
      exp10=0; overflowSide=null; leftStack.length=0; rightStack.length=0;
      updateStatus();
      // focus seulement si non tactile (évite l'ouverture du clavier + décalages en paysage)
      const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
      if(!isTouch) { inputs[0].focus(); }
    }

    function updateStatus(){
      let label='×1';
      if(exp10!==0){
        const n=Math.abs(exp10);
        if(n<=6){
          const pow=Math.pow(10,n);
          label=(exp10>0?'×'+pow:'÷'+pow);
        } else {
          label=(exp10>0?'×10^'+n:'÷10^'+n);
        }
      }
      status.textContent=label;
    }

    // Saisie stricte 1 chiffre/case + navigation
    inputs.forEach(inp=>{
      inp.addEventListener('focus', () => { inp.setAttribute('autocomplete','off'); });
      inp.addEventListener('beforeinput',function(e){
        if(e.inputType==='insertText' || e.inputType==='insertFromPaste'){
          var ch=(e.data||'').replace(/[^0-9]/g,''); if(ch==='') e.preventDefault();
        }
      });
      inp.addEventListener('input',function(e){
        var v=sanitizeToDigit(e.target.value); e.target.value=v;
        if(v!=='') focusMove(+1);
        applyZeroMode(); ensureExitZeros();
      });
      inp.addEventListener('keydown',function(e){
        if(e.key==='ArrowLeft'){ e.preventDefault(); focusMove(-1); }
        if(e.key==='ArrowRight'){ e.preventDefault(); focusMove(+1); }
        if(e.key==='Backspace' && e.target.value===''){ e.preventDefault(); focusMove(-1); }
      });
    });

    // Boutons
    zerosSeg.addEventListener('click',function(e){
      const b=e.target.closest('button'); if(!b) return;
      zerosSeg.querySelectorAll('button').forEach(x=>x.classList.remove('active'));
      b.classList.add('active'); zeroMode=b.dataset.mode;
      applyZeroMode(); ensureExitZeros();
    });
    resetBtn.addEventListener('click',resetAll);
    times10.addEventListener('click',function(){ shift('left'); });
    div10.addEventListener('click',function(){ shift('right'); });
    exitZerosBtn.addEventListener('click',function(){
      exitZeros=!exitZeros;
      exitZerosBtn.textContent = "Gestion de la sortie";
      applyZeroMode(); ensureExitZeros();
    });

    // Init
    updateStatus();
    // Évite l'autofocus sur mobile (clavier qui s'ouvre au chargement)
    const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
    if(!isTouch) { inputs[0].focus(); }

    // Labels responsives
    renderLabels(false);
    autoCompact();
    window.addEventListener('resize', autoCompact);
    window.addEventListener('orientationchange', ()=>setTimeout(autoCompact, 50));
  </script>
</body>
</html>
