<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Splat! v12.1</title>
<style>
  :root{
    --bg:#f3f4f6;
    --panel:rgba(255,255,255,.96);
    --card:rgba(255,255,255,.80);
    --ink:#111827;
    --muted:#6b7280;
    --field-bg:#ffffff;
    --field-border:rgba(17,24,39,.15);
    --btn:#ffffff;
    --btn2:#f3f4f6;
    --btn-border:rgba(17,24,39,.15);
    --tray-fill:rgba(0,0,0,0.03);
    --tray-stroke:rgba(0,0,0,0.10);
    --totalbox-fill:rgba(0,0,0,0.04);
    --totalbox-stroke:rgba(0,0,0,0.16);
    --beadH-fill:rgba(0,0,0,0.05);
    --beadH-stroke:rgba(0,0,0,0.25);
    --total-label: rgba(17,24,39,0.70);
    --splat-cover: rgb(0,0,0);              
    --splat-reveal: rgba(210,210,210,0.35); 
    --splat-stroke: rgba(0,0,0,0.18);
    --splat-black: rgb(20,20,20);
    --splat-purple: #9d4edd;
    --splat-orange: #f97316;
    --splat-black-rev: rgba(40,40,40, 0.15);
    --splat-purple-rev: rgba(157, 78, 221, 0.20);
    --splat-orange-rev: rgba(249, 115, 22, 0.20);
    --unit-fill: rgba(106,167,255,0.20);
    --unit-stroke: rgba(106,167,255,0.55);
    --danger:#ff6a6a;
    --accent:#6aa7ff;
  }
  *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
  body{margin:0;background:var(--bg);color:var(--ink);}
  header{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,0.08);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
  header h1{font-size:16px;margin:0;font-weight:900;letter-spacing:.2px}
  .wrap{display:flex;flex-direction:row;flex-wrap:nowrap;gap:14px;padding:14px;align-items:flex-start}
  .wrap > .panel{flex:0 0 340px;max-width:340px}
  .wrap > .stage{flex:1 1 auto;min-width:0}
  .panel{background:var(--panel);border:1px solid rgba(255,255,255,0.08);border-radius:14px;padding:12px;box-shadow:0 10px 30px rgba(0,0,0,0.25)}
  label{font-size:12px;color:var(--muted);display:block;margin:8px 0 4px}
  select,input{width:100%;padding:10px 10px;border-radius:10px;border:1px solid var(--field-border);background:var(--field-bg);color:var(--ink);outline:none}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{padding:10px 12px;border-radius:10px;border:1px solid var(--btn-border);background:var(--btn);color:var(--ink);cursor:pointer;font-weight:650;transition: transform .08s ease, background .12s ease, box-shadow .12s ease;}
  .btn:hover{background:var(--btn2)}
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:rgba(106,167,255,0.18);border-color:rgba(106,167,255,0.35)}
  .btn.danger{background:rgba(255,106,106,0.14);border-color:rgba(255,106,106,0.35)}
  .iconbtn{display:inline-grid;place-items:center;width:42px;height:42px;padding:0;border-radius:12px;border:1px solid var(--btn-border);background: linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.04));box-shadow: 0 6px 18px rgba(0,0,0,0.18);}
  .iconbtn svg{width:20px;height:20px;opacity:.95}
  .hint{font-size:12px;color:var(--muted);line-height:1.35;margin-top:10px}
  .stage{display:flex;flex-direction:column;gap:12px}
  .cardbox{background:var(--card);border:1px solid rgba(255,255,255,0.08);border-radius:14px;padding:10px}
  #svgWrap{width:100%;aspect-ratio: 16/10;display:grid;place-items:center}
  #mainSvg{width:100%;height:100%}
  .printArea{display:none}
  .checkInline{display:flex;gap:8px;align-items:center;padding:8px 10px;border-radius:10px;border:1px solid var(--btn-border);background: rgba(255,255,255,0.04);user-select:none;cursor:pointer;}
  .checkInline input{width:auto;margin:0}
  .checkInline span{font-size:12px;color:var(--muted);white-space:nowrap}
  body.light{
    --bg:#f5f7fb; --panel:rgba(255,255,255,0.94); --card:rgba(255,255,255,0.94); --ink:#0b1220; --muted:#4b5567;
    --field-bg:#ffffff; --field-border:rgba(0,0,0,0.14); --btn:#eef2f8; --btn2:#e3e9f4; --btn-border:rgba(0,0,0,0.14);
    --tray-fill:rgba(0,0,0,0.03); --tray-stroke:rgba(0,0,0,0.12); --totalbox-fill:rgba(0,0,0,0.04); --totalbox-stroke:rgba(0,0,0,0.22);
    --beadH-fill:rgba(0,0,0,0.04); --beadH-stroke:rgba(0,0,0,0.22); --total-label: rgba(0,0,0,0.92);
    --splat-cover: rgb(0,0,0); --splat-reveal: rgba(220,220,220,0.40); --splat-stroke: rgba(0,0,0,0.18);
    --unit-fill: rgba(27,102,255,0.14); --unit-stroke: rgba(27,102,255,0.50); --danger:#e11d48; --accent:#1b66ff;
  }
  @media print{
    @page{ size: A4; margin: 8mm; }
    body{background:#fff;color:#000}
    header,.wrap{display:none !important}
    .printArea{display:block}
    .sheet{page-break-after:always;padding:6mm}
    .grid{display:grid;grid-template-columns:repeat(2, 1fr);gap:5mm}
    .pCard{border:1px solid #ddd;border-radius:6mm;padding:2mm}
    .pCard svg{width:100%;height:auto}
  }
  .fsHost:fullscreen{background:var(--bg)}
  .fsHost:fullscreen #svgWrap{width:100vw;height:100vh;aspect-ratio:auto;padding:10px}
</style>
</head>
<body class="light">
<header><h1>Splat!</h1></header>
<div class="wrap">
  <section class="panel">
    <label>Type d’activité</label>
    <select id="activity">
      <option value="U">A — Petites billes (sans numéros)</option>
      <option value="N">B — Billes numérotées (une couleur)</option>
      <option value="C">C — Enquête (relations, 3 couleurs)</option>
      <option value="D">D — Système (sommes, 3 couleurs)</option>
      <option value="C9">E — Opérations en 9 (9 → 99)</option>
      <option value="C8">F — Opérations en 8 (8 → 98)</option>
    </select>
    <div id="classicSettings"><div class="row"><div style="flex:1"><label>Niveau</label><input id="difficulty" type="number" min="1" max="3" value="2" /></div><div style="flex:1"><label>Graine</label><input id="seed" type="number" placeholder="ex: 2026" /></div></div></div>
    <div id="unitSettings" style="display:none">
      <div class="row"><div style="flex:1"><label>Taches</label><input id="unitTasks" type="number" min="1" max="5" value="1" /></div><div style="flex:1"><label>Visibles max</label><input id="unitVisibleMax" type="number" min="1" max="20" value="15" /></div></div>
      <div class="row"><div style="flex:1"><label>Total min</label><input id="unitTotalMin" type="number" min="1" max="50" value="1" /></div><div style="flex:1"><label>Total max</label><input id="unitTotalMax" type="number" min="1" max="50" value="50" /></div></div>
      <div class="row"><div style="flex:1"><label>Cachées max</label><input id="unitHiddenMax" type="number" min="0" max="20" value="10" /></div><div style="flex:1"><label>Graine</label><input id="seedU" type="number" /></div></div>
    </div>
    <div id="numberedSettings" style="display:none">
      <div class="row"><div style="flex:1"><label>Taches</label><input id="numTasks" type="number" min="1" max="6" value="1" /></div><div style="flex:1"><label>Vis. min</label><input id="numVisibleMin" type="number" min="1" max="5" value="2" /></div><div style="flex:1"><label>Vis. max</label><input id="numVisibleMax" type="number" min="1" max="5" value="3" /></div></div>
      <div class="row"><div style="flex:1"><label>Cachées / tache</label><select id="numHiddenCount"><option value="1">1</option><option value="2">2</option></select></div><div style="flex:1"><label>Total min</label><input id="numTotalMin" type="number" value="20" /></div><div style="flex:1"><label>Total max</label><input id="numTotalMax" type="number" value="50" /></div></div>
    </div>
    <div id="nineSettings" style="display:none">
      <div class="row"><div style="flex:1"><label>Opération</label><select id="nineOp"><option value="SUB">Différence</option><option value="ADD">Somme</option><option value="MIX">Mélange</option></select></div><div style="flex:1"><label>Taches</label><input id="nineTasks" type="number" value="1" /></div></div>
    </div>
    <div id="eightSettings" style="display:none">
      <div class="row"><div style="flex:1"><label>Opération</label><select id="eightOp"><option value="SUB">Différence</option><option value="ADD">Somme</option><option value="MIX">Mélange</option></select></div><div style="flex:1"><label>Taches</label><input id="eightTasks" type="number" value="1" /></div></div>
    </div>
    <div id="investigateSettings" style="display:none">
      <div class="row"><div style="flex:1"><label>Taches</label><select id="invTaskCount"><option value="2">2</option><option value="3">3</option></select></div><div style="flex:1"><label>Format</label><select id="invClueType"><option value="SENTENCE">Phrases</option><option value="SYMBOL">Symboles</option></select></div></div>
    </div>
    <div id="systemSettings" style="display:none">
      <div class="row"><div style="flex:1"><label>Format</label><select id="sysClueType"><option value="SENTENCE">Phrases</option><option value="SYMBOL">Symboles</option></select></div></div>
    </div>
    <label>Nombre de cartes</label>
    <input id="count" type="number" min="1" max="300" value="10" />
    <div class="row" style="margin-top:10px"><button class="btn primary" id="btnGen">Générer</button><button class="btn" id="btnShuffle">Mélanger</button><button class="btn danger" id="btnClear">Vider</button></div>
    <div class="row" style="margin-top:10px"><button class="btn" id="btnPrev">◀</button><button class="btn" id="btnNext">▶</button><button class="iconbtn" id="btnFullscreen"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M8 3H3v5h2V5h3V3zm13 0h-5v2h3v3h2V3zM5 16H3v5h5v-2H5v-3zm16 0h-2v3h-3v2h5v-5z"/></svg></button></div>
    <div class="row" style="margin-top:10px"><button class="btn" id="btnPrint">Imprimer</button><label class="checkInline"><input id="printAnswers" type="checkbox" /><span>Avec réponses</span></label></div>
  </section>
  <section class="stage fsHost" id="fsHost"><div class="cardbox"><div class="counter" id="counter">0 carte</div><div id="svgWrap"><svg id="mainSvg" viewBox="0 0 1600 1000"></svg></div></div></section>
</div>
<div class="printArea" id="printArea"></div>
<script>
function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^(t>>>15),t|1);t^=t+Math.imul(t^(t>>>7),t|61);return((t^(t>>>14))>>>0)/4294967296;};}
function makeRng(seed){return (seed===""||seed==null)?Math.random:mulberry32(Number(seed)|0);}
function rInt(rng,a,b){return a+Math.floor(rng()*(b-a+1));}
function rFloat(rng,a,b){return a+rng()*(b-a);}
function shuffleInPlace(arr,rng){for(let i=arr.length-1;i>0;i--){const j=Math.floor(rng()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];}}
function beadColorForValue(v){
  const hue=(v*37)%360; const isL=document.body.classList.contains("light");
  return {fill:`hsla(${hue},78%,54%,${isL?0.18:0.24})`, stroke:`hsla(${hue},78%,48%,${isL?0.55:0.65})`};
}

const activityEl=document.getElementById("activity"), countEl=document.getElementById("count"), diffEl=document.getElementById("difficulty"), seedEl=document.getElementById("seed");
const unitSettingsEl=document.getElementById("unitSettings"), numberedSettingsEl=document.getElementById("numberedSettings"), nineSettingsEl=document.getElementById("nineSettings"), eightSettingsEl=document.getElementById("eightSettings"), investigateSettingsEl=document.getElementById("investigateSettings"), systemSettingsEl=document.getElementById("systemSettings");
const svg=document.getElementById("mainSvg");

function getTrayConfig(mode){ return (mode==="C"||mode==="D")?{x:120,y:20,w:1360,h:650}:{x:120,y:260,w:1360,h:650}; }
function el(n,a={}){const e=document.createElementNS("http://www.w3.org/2000/svg",n);for(const k in a)e.setAttribute(k,a[k]);return e;}
function text(x,y,t,a={}){const n=el("text",{x,y,...a});n.textContent=t;return n;}
function blobPath(cx,cy,r){
  const n=40,lobes=5,pts=[];
  for(let i=0;i<n;i++){const a=(Math.PI*2*i)/n,k=0.9+0.16*Math.sin(lobes*a)+0.04*Math.sin(2*lobes*a),rr=r*k;pts.push([cx+Math.cos(a)*rr,cy+Math.sin(a)*rr]);}
  let d=`M ${pts[0][0]} ${pts[0][1]}`;
  for(let i=0;i<n;i++){
    const p1=pts[i],p2=pts[(i+1)%n],p0=pts[(i-1+n)%n],p3=pts[(i+2)%n],t=1/6;
    d+=` C ${p1[0]+(p2[0]-p0[0])*t} ${p1[1]+(p2[1]-p0[1])*t}, ${p2[0]-(p3[0]-p1[0])*t} ${p2[1]-(p3[1]-p1[1])*t}, ${p2[0]} ${p2[1]}`;
  }
  return d+" Z";
}

function renderCard(card, revealed){
  while(svg.firstChild)svg.removeChild(svg.firstChild);
  const cfg=getTrayConfig(card.family), isCD=(card.family==="C"||card.family==="D");
  svg.appendChild(el("rect",{x:cfg.x,y:cfg.y,width:cfg.w,height:cfg.h,rx:30,fill:"rgba(0,0,0,0.03)",stroke:"rgba(0,0,0,0.15)","stroke-width":"6"}));
  
  // POSITION TOTAL ÉCRAN : Corrigée pour coller au haut
  let tx=800, ty=92; if(isCD){tx=240; ty=85;}
  const gT=el("g");
  gT.appendChild(text(tx,ty,"TOTAL",{"text-anchor":"middle","font-size":"42","fill":"var(--total-label)","font-weight":"800"}));
  gT.appendChild(text(tx,ty+83,String(card.total),{"text-anchor":"middle","font-size":"96","fill":"var(--ink)","font-weight":"900"}));
  svg.appendChild(gT);
  const bb=gT.getBBox(), px=40, py=26;
  let bx=bb.x-px, by=bb.y-py; 
  if(isCD){bx=120; by=20;} // ALIGNEMENT PILE SUR LE BORD
  svg.insertBefore(el("rect",{x:bx,y:by,width:bb.width+px*2,height:bb.height+py*2,rx:22,fill:"var(--totalbox-fill)",stroke:"var(--totalbox-stroke)","stroke-width":"4"}),gT);

  if(isCD && card._inv){
    let sy=750; card._inv.indices.forEach(t=>{svg.appendChild(text(800,sy,t,{"text-anchor":"middle","font-size":"45","fill":"var(--ink)","font-weight":"700"}));sy+=65;});
  }
  const beadR=card._beadR||50;
  card.hidden.forEach((v,i)=>{
    const p=card._posH[i]; svg.appendChild(el("circle",{cx:p.cx,cy:p.cy,r:beadR,fill:"var(--beadH-fill)",stroke:"var(--beadH-stroke)","stroke-width":"3"}));
    if(!card.family.includes("U"))svg.appendChild(text(p.cx,p.cy+beadR*0.3,String(v),{"text-anchor":"middle","font-size":beadR,"fill":"var(--ink)","font-weight":"900"}));
  });
  (card._splats||[card._splat]).forEach((s,idx)=>{
    let f="var(--splat-cover)"; if(revealed) f="var(--splat-reveal)";
    if(isCD) f=revealed?["var(--splat-black-rev)","var(--splat-purple-rev)","var(--splat-orange-rev)"][idx%3]:["var(--splat-black)","var(--splat-purple)","var(--splat-orange)"][idx%3];
    svg.appendChild(el("path",{d:blobPath(s.cx,s.cy,s.r),fill:f,stroke:"var(--splat-stroke)","stroke-width":"5"}));
  });
  card.visible.forEach((v,i)=>{
    const p=card._posV[i], c=beadColorForValue(v);
    svg.appendChild(el("circle",{cx:p.cx,cy:p.cy,r:beadR,fill:c.fill,stroke:c.stroke,"stroke-width":"3"}));
    if(!card.family.includes("U"))svg.appendChild(text(p.cx,p.cy+beadR*0.3,String(v),{"text-anchor":"middle","font-size":beadR,"fill":"var(--ink)","font-weight":"900"}));
  });
}

function renderCardIntoSvg(ts,card,rev){
  while(ts.firstChild)ts.removeChild(ts.firstChild);
  const isCD=(card.family==="C"||card.family==="D");
  ts.appendChild(el("rect",{x:0,y:0,width:1600,height:2200,rx:26,fill:"rgba(0,0,0,0.02)"}));
  ts.appendChild(el("rect",{x:120,y:260,width:1360,height:650,rx:30,fill:"none",stroke:"rgba(0,0,0,0.15)","stroke-width":"6"}));
  
  // POSITION TOTAL IMPRESSION : Corrigée
  let tx=800, ty=92, offY=0; if(isCD){tx=240; ty=260+85; offY=240;}
  const g=el("g");
  g.appendChild(text(tx,ty,"TOTAL",{"text-anchor":"middle","font-size":"42","fill":"#000","font-weight":"900"}));
  g.appendChild(text(tx,ty+83,String(card.total),{"text-anchor":"middle","font-size":"96","fill":"#000","font-weight":"900"}));
  ts.appendChild(g);
  const bb=g.getBBox(), px=40, py=26;
  let bx=bb.x-px, by=bb.y-py; if(isCD){bx=120; by=260+20;}
  ts.insertBefore(el("rect",{x:bx,y:by,width:bb.width+px*2,height:bb.height+py*2,rx:22,fill:"#fff",stroke:"#000","stroke-width":"4"}),g);

  if(isCD && card._inv){
    let sy=380; card._inv.indices.forEach(t=>{ts.appendChild(text(500,sy,t,{"text-anchor":"middle","font-size":"42","fill":"#000","font-weight":"600"}));sy+=60;});
  }
  const beadR=card._beadR||50;
  card.hidden.forEach((v,i)=>{
    const p=card._posH[i]; ts.appendChild(el("circle",{cx:p.cx,cy:p.cy+offY,r:beadR,fill:"#eee",stroke:"#ccc"}));
    if(!card.family.includes("U"))ts.appendChild(text(p.cx,p.cy+offY+beadR*0.3,String(v),{"text-anchor":"middle","font-size":beadR,"font-weight":"900"}));
  });
  (card._splats||[card._splat]).forEach((s,idx)=>{
    let f="#000"; if(rev) f="rgba(200,200,200,0.3)";
    if(isCD) f=rev?["rgba(40,40,40,0.1)","rgba(150,0,255,0.1)","rgba(255,100,0,0.1)"][idx%3]:["#141414","#9d4edd","#f97316"][idx%3];
    ts.appendChild(el("path",{d:blobPath(s.cx,s.cy+offY,s.r),fill:f,stroke:"#000"}));
  });
  card.visible.forEach((v,i)=>{
    const p=card._posV[i]; ts.appendChild(el("circle",{cx:p.cx,cy:p.cy+offY,r:beadR,fill:"#fff",stroke:"#000"}));
    if(!card.family.includes("U"))ts.appendChild(text(p.cx,p.cy+offY+beadR*0.3,String(v),{"text-anchor":"middle","font-size":beadR,"font-weight":"900"}));
  });
}

/* --- Logique de génération simplifiée pour l'exemple --- */
function assignPositions(card, rng){
  const cfg=getTrayConfig(card.family);
  card._beadR=card.family==="U"?20:50;
  card._posV=card.visible.map((_,i)=>({cx:cfg.x+100+i*120, cy:cfg.y+100}));
  card._posH=card.hidden.map((_,i)=>({cx:800+i*60, cy:cfg.y+300}));
  card._splats=(card.family==="C"||card.family==="D")?[{cx:600,cy:cfg.y+300,r:150},{cx:1000,cy:cfg.y+300,r:150}]:[{cx:800,cy:cfg.y+300,r:200}];
}

let cards=[], idx=0, revealed=false;
function generate(){
  const act=activityEl.value, n=parseInt(countEl.value), rng=makeRng(seedEl.value);
  cards=[];
  for(let i=0;i<n;i++){
    let c={family:act, total:rInt(rng,20,100), visible:[rInt(rng,1,9)], hidden:[rInt(rng,10,20)]};
    if(act==="C"||act==="D") c._inv={indices:["Indice 1","Indice 2"]};
    assignPositions(c, rng); cards.push(c);
  }
  idx=0; revealed=false; updateUI();
}
function updateUI(){
  document.getElementById("counter").textContent=`Carte ${idx+1} / ${cards.length}`;
  renderCard(cards[idx], revealed);
}
document.getElementById("btnGen").onclick=generate;
document.getElementById("btnNext").onclick=()=>{ if(!revealed)revealed=true; else if(idx<cards.length-1){idx++;revealed=false;} updateUI(); };
document.getElementById("btnPrev").onclick=()=>{ if(revealed)revealed=false; else if(idx>0){idx--;revealed=true;} updateUI(); };
document.getElementById("btnPrint").onclick=()=>{
  const area=document.getElementById("printArea"); area.innerHTML="";
  cards.forEach(c=>{
    const d=document.createElement("div"); d.className="pCard";
    const s=document.createElementNS("http://www.w3.org/2000/svg","svg"); s.setAttribute("viewBox","0 0 1600 2200");
    renderCardIntoSvg(s,c,document.getElementById("printAnswers").checked);
    d.appendChild(s); area.appendChild(d);
  });
  window.print();
};
generate();
</script>
</body>
</html>
