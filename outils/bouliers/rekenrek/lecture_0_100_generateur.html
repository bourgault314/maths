<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>REKENREK ‚Äî G√âN√âRATEUR FINAL (Contour Noir)</title>
  <style>
    :root {
      --ink: #111827;
      --bg: #f8fafc;
      --panel: #ffffff;
      --accent: #2563eb;
      --border: #cbd5e1;
      --grid-line: #94a3b8; 
      
      --page-w: 210mm;
      --page-h: 297mm;
      --page-margin: 10mm;
      
      --cols: 3; 
      --rows: 4;
    }
    
    * { box-sizing: border-box; }
    body { margin: 0; font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--ink); display: flex; height: 100vh; overflow: hidden; }

    /* --- SIDEBAR --- */
    aside {
      width: 300px; background: var(--panel); border-right: 1px solid var(--border);
      display: flex; flex-direction: column; z-index: 10; box-shadow: 2px 0 10px rgba(0,0,0,0.05);
    }
    .sb-header { padding: 12px 15px; border-bottom: 1px solid var(--border); background: #fff; }
    
    .sb-title { font-size: 16px; font-weight: 800; color: var(--accent); margin: 0; text-transform: uppercase; }
    .sb-scroll { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; }
    
    .section { border-bottom: 1px solid #f1f5f9; padding-bottom: 12px; }
    .sec-title { font-size: 11px; text-transform: uppercase; color: #64748b; font-weight: 800; margin-bottom: 8px; }
    
    .control { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; font-size: 13px; font-weight: 600; }
    .control label { flex: 1; color: #334155; }
    
    select, input[type="number"] {
      padding: 6px; border: 1px solid var(--border); border-radius: 6px;
      font-size: 12px; font-weight: 600; width: 100%; outline: none; background: #fff;
    }
    select:hover, input:hover { border-color: var(--accent); }

    .flags { display: flex; gap: 10px; margin-bottom: 10px; }
    .flag-btn { font-size: 12px; font-weight: 800; cursor: pointer; opacity: 0.5; padding: 4px 10px; border-radius: 6px; background:#f1f5f9; border: 1px solid #e2e8f0; }
    .flag-btn.active { opacity: 1; background: var(--accent); color: white; border-color: var(--accent); }

    .actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: auto; }
    .btn { padding: 10px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; color: white; font-size: 13px; }
    .btn-new { background: var(--accent); }
    .btn-print { background: #10b981; }

    /* --- MAIN --- */
    main { flex: 1; overflow: auto; padding: 20px; display: flex; flex-direction: column; align-items: center; gap: 20px; background: #e2e8f0; }
    
    .page {
      width: var(--page-w); height: var(--page-h);
      background: white; box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      position: relative; flex-shrink: 0;
      page-break-after: always;
    }
    .page:last-child { page-break-after: auto; }

    .page-inner { 
      position: absolute; top: var(--page-margin); bottom: var(--page-margin); left: var(--page-margin); right: var(--page-margin);
      display: flex; flex-direction: column; 
    }

    .grid {
      flex: 1; 
      display: grid;
      grid-template-columns: repeat(var(--cols), 1fr);
      grid-template-rows: repeat(var(--rows), 1fr);
      border: 2px solid var(--ink);
      gap: 0; 
      min-height: 0; 
    }
    
    .cell {
      border: 1px solid var(--grid-line);
      display: flex; flex-direction: column;
      padding: 3px;
      position: relative;
      overflow: hidden;
    }

    /* ZONE 1: Boulier (Haut) */
    .part-boulier {
      flex: 1; 
      display: flex; align-items: center; justify-content: center;
      border-bottom: 1px dashed #cbd5e1;
      margin-bottom: 2px;
      overflow: hidden; 
      padding: 0;
      min-height: 0;
    }
    .rr-svg { width: 100%; height: 100%; display: block; overflow: visible; }

    /* ZONE 2: Bas (Chiffre | Mot) */
    .part-bottom {
      flex: 0 0 50px; 
      display: flex; gap: 3px;
    }
    
    .sub-box {
      flex: 1; 
      display: flex; align-items: center; justify-content: center;
      border: 1px solid #e2e8f0; border-radius: 6px;
      background: #fdfdfd;
      position: relative;
    }
    
    .val-digit { 
        font-size: 28px; 
        font-weight: 900; 
        color: #000000; 
        font-family: 'Segoe UI', sans-serif; 
    }
    
    .val-word { 
        font-size: 16px; 
        font-weight: 700; 
        color: #000000; 
        font-style: italic; 
        text-align: center; 
        font-family: 'Georgia', serif; 
        line-height: 1.1; 
        padding: 2px; 
    }
    
    .empty-zone { width: 100%; height: 100%; }

    /* --- AJUSTEMENTS SP√âCIFIQUES --- */
    .grid[data-size="2x4"] .part-bottom { flex: 0 0 50px; } 
    .grid[data-size="2x4"] .val-digit { font-size: 28px; } 

    .grid[data-size="3x5"] .part-bottom { flex: 0 0 40px; }
    .grid[data-size="3x5"] .val-digit { font-size: 24px; }
    .grid[data-size="3x5"] .val-word { font-size: 13px; }

    .grid[data-size="4x5"] .part-bottom { flex: 0 0 35px; }
    .grid[data-size="4x5"] .val-digit { font-size: 22px; }
    .grid[data-size="4x5"] .val-word { font-size: 11px; }

    @media print {
      @page { size: A4; margin: 0; } 
      body { display: block; background: white; height: auto; overflow: visible; }
      aside { display: none !important; }
      main { padding: 0; margin: 0; display: block; overflow: visible; height: auto; }
      .page { margin: 0 auto; box-shadow: none; border: none; width: 210mm; height: 297mm; overflow: hidden; page-break-after: always; }
      .grid { border: 2px solid #000; }
      .cell { border: 1px solid #999; page-break-inside: avoid; }
      * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }
  </style>
</head>
<body>

<aside>
  <div class="sb-header">
    <h2 class="sb-title" data-i18n="title">Lecture Nombres</h2>
  </div>
  
  <div class="sb-scroll">
    <div class="section">
        <div class="sec-title" data-i18n="lang">Langue</div>
        <div class="flags">
            <div class="flag-btn active" onclick="setLang('fr', this)">FR</div>
            <div class="flag-btn" onclick="setLang('en', this)">EN</div>
        </div>
    </div>

    <!-- MENU IMPRESSION -->
    <div class="section" style="background:#f0fdf4; border:1px solid #bbf7d0; padding:10px; border-radius:6px; margin-bottom:12px;">
       <div class="sec-title" style="color:#166534;" data-i18n="print_mode">üñ®Ô∏è Mode Impression</div>
       <select id="printMode" onchange="renderPages()">
         <option value="exo" selected data-i18n="pm_exo">Exercice (√âl√®ve)</option>
         <option value="corr" data-i18n="pm_corr">Correction (Prof)</option>
         <option value="sep" data-i18n="pm_sep">Dossier : Exo + Corrig√©</option>
         <option value="rv" data-i18n="pm_rv">Flashcards : Recto-Verso</option>
       </select>
    </div>

    <div class="section">
      <div class="sec-title" data-i18n="layout">Mise en page</div>
      <div class="control" style="flex-direction:column; align-items:flex-start;">
        <label style="margin-bottom:5px;" data-i18n="grid">Grille</label>
        <select id="gridSize" onchange="startGen()">
          <option value="4x5">20 cases (4x5)</option>
          <option value="3x5">15 cases (3x5)</option>
          <option value="3x4" selected>12 cases (3x4)</option>
          <option value="2x4">8 cases (2x4)</option>
        </select>
      </div>
    </div>

    <div class="section">
      <div class="sec-title" data-i18n="content">Contenu</div>
      
      <div class="control" style="flex-direction:column; align-items:flex-start;">
        <label style="margin-bottom:5px;" data-i18n="order">Ordre</label>
        <select id="orderMode" onchange="toggleInputs(); startGen()">
          <option value="random" data-i18n="ord_random">Al√©atoire</option>
          <option value="seq" data-i18n="ord_seq">S√©quentiel</option>
        </select>
      </div>

      <div id="seqInputs" class="control" style="display:none; gap:5px;">
        <div style="flex:1">
            <label style="font-size:10px; display:block; margin-bottom:2px;">D√©but</label>
            <input type="number" id="seqStart" value="0" min="0" max="100" style="width:100%" onchange="startGen()">
        </div>
        <div style="flex:1">
            <label style="font-size:10px; display:block; margin-bottom:2px;">Fin</label>
            <input type="number" id="seqEnd" value="20" min="1" max="100" style="width:100%" onchange="startGen()">
        </div>
      </div>

      <div id="randInputs" class="control" style="flex-direction:column; align-items:flex-start;">
        <label style="margin-bottom:5px;" data-i18n="range">Plage</label>
        <select id="rangeSel" onchange="startGen()">
          <option value="10">0 - 10</option>
          <option value="20">0 - 20</option>
          <option value="100">0 - 100</option>
        </select>
      </div>
      
      <div class="sec-title" style="margin-top:15px;" data-i18n="exercise">Exercice</div>
      <div class="control" style="display:block;">
        <select id="gameMode" onchange="updateDesc(); startGen()" style="height:auto; padding:10px;">
          <optgroup label="2 Indices (Facile)">
            <option value="chiffre" selected data-i18n="mode_digit">1Ô∏è‚É£ Trouver le Chiffre</option>
            <option value="mot" data-i18n="mode_word">abc Trouver le Mot</option>
            <option value="color" data-i18n="mode_color">üé® Coloriage</option>
          </optgroup>
          <optgroup label="1 Indice (Difficile)">
            <option value="only_bead" data-i18n="mode_bead_only">üßÆ Boulier seul</option>
            <option value="only_num" data-i18n="mode_num_only">1Ô∏è‚É£ Chiffres seuls</option>
            <option value="only_word" data-i18n="mode_word_only">abc Mot seul</option>
          </optgroup>
          <optgroup label="Autres">
            <option value="mixte" data-i18n="mode_mix">üî• Mixte (Expert)</option>
            <option value="modele" data-i18n="mode_model">üëÄ Mod√®le</option>
            <option value="dictionary" style="font-weight:bold; color:var(--accent);" data-i18n="mode_dict">üìö Dictionnaire</option>
          </optgroup>
        </select>
        <div style="font-size:11px; color:#64748b; margin-top:8px; line-height:1.3; font-style:italic;" id="descMode"></div>
      </div>
    </div>
    
    <div class="section">
       <div class="sec-title">Style</div>
       <div class="control" style="flex-direction:column; align-items:flex-start;">
        <label style="margin-bottom:5px;" data-i18n="color">Couleur Billes</label>
        <select id="beadColor" onchange="renderPages()">
          <option value="red" data-i18n="opt_red">Rouge / Blanc</option>
          <option value="gray" data-i18n="opt_gray">Rouge / Gris (Clair)</option>
          <option value="blue" data-i18n="opt_blue">Rouge / Bleu</option>
        </select>
      </div>
    </div>

    <div class="actions">
      <button class="btn btn-new" onclick="startGen()" data-i18n="btn_mix">M√âLANGER</button>
      <button class="btn btn-print" onclick="window.print()" data-i18n="btn_print">IMPRIMER</button>
    </div>
  </div>
</aside>

<main id="mainArea">
</main>

<script>
const i18n = {
    fr: {
        title: "Lecture Nombres",
        lang: "Langue",
        print_mode: "üñ®Ô∏è Mode Impression",
        pm_exo: "Exercice (√âl√®ve)",
        pm_corr: "Correction (Prof)",
        pm_sep: "Dossier : Exo + Corrig√©",
        pm_rv: "Flashcards : Recto-Verso",
        layout: "Mise en page",
        grid: "Grille",
        content: "Contenu",
        order: "Ordre",
        ord_random: "Al√©atoire",
        ord_seq: "S√©quentiel",
        range: "Plage",
        exercise: "Exercice",
        mode_digit: "1Ô∏è‚É£ Trouver le Chiffre",
        mode_word: "abc Trouver le Mot",
        mode_color: "üé® Coloriage / Entourer",
        mode_bead_only: "üßÆ Boulier seul",
        mode_num_only: "1Ô∏è‚É£ Chiffres seuls",
        mode_word_only: "abc Mot seul",
        mode_mix: "üî• Mixte (Expert)",
        mode_model: "üëÄ Mod√®le",
        mode_dict: "üìö Dictionnaire (Tout)",
        color: "Couleur Billes",
        opt_red: "Rouge / Blanc",
        opt_gray: "Rouge / Gris (Clair)",
        opt_blue: "Rouge / Bleu",
        btn_mix: "G√âN√âRER / M√âLANGER",
        btn_print: "IMPRIMER",
        desc_digit: "Boulier et mot donn√©s. L'√©l√®ve √©crit le chiffre.",
        desc_word: "Boulier et chiffre donn√©s. L'√©l√®ve √©crit le mot.",
        desc_color: "Le nombre est √©crit. L'√©l√®ve doit entourer ou colorier les billes.",
        desc_bead_only: "Seul le boulier est affich√©. L'√©l√®ve compl√®te tout.",
        desc_num_only: "Seul le chiffre est donn√©. L'√©l√®ve compl√®te tout.",
        desc_word_only: "Seul le mot est donn√©. L'√©l√®ve compl√®te tout.",
        desc_mix: "Un seul indice al√©atoire. L'√©l√®ve compl√®te.",
        desc_model: "Tout est affich√©.",
        desc_dict: "Tout de 0 √† 100."
    },
    en: {
        title: "Reading Numbers",
        lang: "Language",
        print_mode: "üñ®Ô∏è Print Mode",
        pm_exo: "Worksheet (Student)",
        pm_corr: "Answer Key (Teacher)",
        pm_sep: "Bundle: Ex + Key (Separate)",
        pm_rv: "Flashcards: Double-sided",
        layout: "Layout",
        grid: "Grid",
        content: "Content",
        order: "Order",
        ord_random: "Random",
        ord_seq: "Sequential",
        range: "Range",
        exercise: "Mode",
        mode_digit: "1Ô∏è‚É£ Find the Digit",
        mode_word: "abc Find the Word",
        mode_color: "üé® Coloring / Circle",
        mode_bead_only: "üßÆ Beads only",
        mode_num_only: "1Ô∏è‚É£ Digits only",
        mode_word_only: "abc Word only",
        mode_mix: "üî• Mixed",
        mode_model: "üëÄ Model",
        mode_dict: "üìö Dictionary",
        color: "Bead Color",
        opt_red: "Red / White",
        opt_gray: "Red / Gray (Light)",
        opt_blue: "Red / Blue",
        btn_mix: "GENERATE / SHUFFLE",
        btn_print: "PRINT",
        desc_digit: "Rekenrek and word shown. Student writes the digit.",
        desc_word: "Rekenrek and digit shown. Student writes the word.",
        desc_color: "Number written. Student circles/colors beads.",
        desc_bead_only: "Only Beads shown. Student completes all.",
        desc_num_only: "Only Digit shown. Student completes all.",
        desc_word_only: "Only Word shown. Student completes all.",
        desc_mix: "One random clue. Student completes all.",
        desc_model: "Show everything.",
        desc_dict: "All 0 to 100."
    }
};

let currentLang = 'fr';

function setLang(l, el) {
    currentLang = l;
    document.querySelectorAll('.flag-btn').forEach(b => b.classList.remove('active'));
    el.classList.add('active');
    updateUI();
    startGen(); 
}

function updateUI() {
    const dict = i18n[currentLang];
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if(dict[key]) el.innerText = dict[key];
    });
    updateDesc();
}

function toggleInputs() {
    const mode = document.getElementById('orderMode').value;
    if(mode === 'seq') {
        document.getElementById('seqInputs').style.display = 'flex';
        document.getElementById('randInputs').style.display = 'none';
    } else {
        document.getElementById('seqInputs').style.display = 'none';
        document.getElementById('randInputs').style.display = 'flex';
    }
}

function numberToText(n) {
    if (currentLang === 'en') return numberToTextEn(n);
    return numberToTextFr(n);
}

function numberToTextFr(n) {
    const units = ["z√©ro", "un", "deux", "trois", "quatre", "cinq", "six", "sept", "huit", "neuf", "dix", "onze", "douze", "treize", "quatorze", "quinze", "seize"];
    const tens = ["", "", "vingt", "trente", "quarante", "cinquante", "soixante", "soixante", "quatre-vingt", "quatre-vingt"];
    
    if (n <= 16) return units[n];
    if (n < 20) return "dix-" + units[n-10];
    if (n === 20) return "vingt";
    if (n === 71) return "soixante-et-onze";
    if (n === 80) return "quatre-vingts";
    if (n === 100) return "cent";
    
    let t = Math.floor(n / 10);
    let u = n % 10;
    
    let str = "";
    if (t === 7 || t === 9) {
        str = tens[t-1];
        if (t === 7 && u === 1) return "soixante-et-onze";
        if (t === 9 && u === 1) return "quatre-vingt-onze";
        str += "-" + numberToTextFr(10 + u);
    } else {
        str = tens[t];
        if (u === 1) str += "-et-un";
        else if (u > 0) str += "-" + units[u];
    }
    return str;
}

function numberToTextEn(n) {
    const units = ["zero", "one", "two", "three", "four", "five", "six", "seven", "eight", "nine", "ten", "eleven", "twelve", "thirteen", "fourteen", "fifteen", "sixteen", "seventeen", "eighteen", "nineteen"];
    const tens = ["", "", "twenty", "thirty", "forty", "fifty", "sixty", "seventy", "eighty", "ninety"];
    
    if (n < 20) return units[n];
    if (n === 100) return "one hundred";
    
    let t = Math.floor(n / 10);
    let u = n % 10;
    
    let str = tens[t];
    if (u > 0) str += "-" + units[u];
    return str;
}

let state = [];

window.onload = function() {
    updateUI();
    toggleInputs();
    startGen();
};

function updateDesc() {
    const mode = document.getElementById('gameMode').value;
    const desc = document.getElementById('descMode');
    const dict = i18n[currentLang];
    
    if(mode === 'chiffre') desc.innerText = dict.desc_digit;
    else if(mode === 'mot') desc.innerText = dict.desc_word;
    else if(mode === 'color') desc.innerText = dict.desc_color;
    else if(mode === 'only_bead') desc.innerText = dict.desc_bead_only;
    else if(mode === 'only_num') desc.innerText = dict.desc_num_only;
    else if(mode === 'only_word') desc.innerText = dict.desc_word_only;
    else if(mode === 'mixte') desc.innerText = dict.desc_mix;
    else if(mode === 'dictionary') desc.innerText = dict.desc_dict;
    else desc.innerText = dict.desc_model;
}

function startGen() {
  const sizeSelect = document.getElementById('gridSize').value;
  const [cols, rows] = sizeSelect.split('x').map(Number);
  
  document.documentElement.style.setProperty('--cols', cols);
  document.documentElement.style.setProperty('--rows', rows);
  
  const orderMode = document.getElementById('orderMode').value; 
  const gameMode = document.getElementById('gameMode').value;
  
  state = [];
  
  let maxValForLayout = 100;

  if (gameMode === 'dictionary') {
      maxValForLayout = 100;
      for(let i=0; i<=100; i++) {
          state.push(createItem(i, maxValForLayout, 'modele'));
      }
  } 
  else if (orderMode === 'seq') {
      let start = parseInt(document.getElementById('seqStart').value) || 0;
      let end = parseInt(document.getElementById('seqEnd').value) || 20;
      if (start < 0) start = 0;
      if (end > 100) end = 100;
      if (end < start) end = start;
      
      maxValForLayout = end;

      for(let i=start; i<=end; i++) {
          state.push(createItem(i, maxValForLayout, gameMode));
      }
  } else {
      const rangeSel = parseInt(document.getElementById('rangeSel').value);
      maxValForLayout = rangeSel;
      
      const itemsPerPage = cols * rows;
      let pool = [];
      while(pool.length < itemsPerPage) {
          for(let i=0; i<=rangeSel; i++) pool.push(i);
      }
      pool = pool.sort(() => Math.random() - 0.5).slice(0, itemsPerPage);
      
      state = pool.map(val => createItem(val, maxValForLayout, gameMode));
  }
  
  renderPages(sizeSelect);
}

function createItem(val, maxVal, mode) {
    let showBead = true, showNum = true, showWord = true;

    if (mode === 'modele') {
        // tout visible
    } 
    else if (mode === 'chiffre') {
        showBead = true; showNum = false; showWord = true;
    }
    else if (mode === 'mot') {
        showBead = true; showNum = true; showWord = false;
    }
    else if (mode === 'color') {
        showBead = false; showNum = true; showWord = true;
    }
    else if (mode === 'only_bead') {
        showBead = true; showNum = false; showWord = false;
    }
    else if (mode === 'only_num') {
        showBead = false; showNum = true; showWord = false;
    }
    else if (mode === 'only_word') {
        showBead = false; showNum = false; showWord = true;
    }
    else if (mode === 'mixte') {
        const rand = Math.floor(Math.random() * 3); 
        if (rand === 0) { showBead = true; showNum = false; showWord = false; }
        else if (rand === 1) { showBead = false; showNum = true; showWord = false; }
        else { showBead = false; showNum = false; showWord = true; }
    }

    return {
      val: val,
      max: maxVal,
      showBead: showBead,
      showNum: showNum,
      showWord: showWord
    };
}

function renderPages() {
  const sizeSelect = document.getElementById('gridSize').value;
  const main = document.getElementById('mainArea');
  main.innerHTML = ''; 
  
  const printMode = document.getElementById('printMode').value;
  const theme = document.getElementById('beadColor').value;
  // Note: On n'utilise plus isColoringMode ici, car c'est calcul√© par item
  
  const [cols, rows] = sizeSelect.split('x').map(Number);
  const itemsPerPage = cols * rows;
  
  for (let i = 0; i < state.length; i += itemsPerPage) {
      const chunk = state.slice(i, i + itemsPerPage);
      
      if (printMode === 'exo' || printMode === 'sep' || printMode === 'rv') {
          renderOnePage(chunk, sizeSelect, theme, false);
      }
      
      if (printMode === 'corr' || printMode === 'sep' || printMode === 'rv') {
          let itemsToRender = chunk;
          if (printMode === 'rv') {
              itemsToRender = mirrorChunk(chunk, cols, rows);
          }
          renderOnePage(itemsToRender, sizeSelect, theme, true);
      }
  }
}

function mirrorChunk(chunk, cols, rows) {
    let mirrored = new Array(chunk.length).fill(null);
    for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
            let originalIndex = r * cols + c;
            if (originalIndex >= chunk.length) continue;
            let item = chunk[originalIndex];
            let newCol = (cols - 1) - c;
            let newIndex = r * cols + newCol;
            mirrored[newIndex] = item;
        }
    }
    return mirrored.filter(x => x !== null);
}


function renderOnePage(items, sizeSelect, theme, isCorrectionPage) {
  const main = document.getElementById('mainArea');
  const page = document.createElement('div');
  page.className = 'page';
  
  const inner = document.createElement('div');
  inner.className = 'page-inner';
  
  const grid = document.createElement('div');
  grid.className = 'grid';
  grid.setAttribute('data-size', sizeSelect);
  
  items.forEach(item => {
    if (!item) {
         const cell = document.createElement('div');
         cell.className = 'cell';
         grid.appendChild(cell);
         return;
    }

    const cell = document.createElement('div');
    cell.className = 'cell';
    
    // --- NOUVELLE LOGIQUE INTELLIGENTE ---
    // Si les billes sont cach√©es dans l'exo (showBead == false), alors on utilise le style "Template" (billes neutres √† entourer)
    // Si les billes sont visibles dans l'exo (showBead == true), on utilise le style "R√©aliste".
    // Le mode "Correction" respecte ce choix initial.
    
    const useTemplateStyle = !item.showBead;
    
    // Pour l'affichage final (SVG visible ou non) :
    // Si c'est la correction -> Toujours visible.
    // Sinon -> Selon item.showBead OU si c'est un Template (car le Template est toujours visible, c'est l'exercice lui-m√™me).
    // Attends, si useTemplateStyle est vrai, on veut voir les billes neutres m√™me en mode Exercice.
    // Donc isVisible doit √™tre TRUE pour le SVG si on est en mode Template (pour voir les billes neutres) 
    // MAIS le param√®tre isVisible dans getRekenrekSvg contr√¥le "Est-ce qu'on montre la R√âPONSE/CORRECTION ?".
    
    // Regardons getRekenrekSvg :
    // if (isColoringMode) { ... DESSIN DES BILLES (TOUJOURS) ... if (isVisible) { DESSIN REPONSE } }
    // Donc si isColoringMode est true, les billes neutres sont toujours dessin√©es. isVisible sert juste √† entourer la r√©ponse.
    
    // Donc, on passe :
    // isVisible = isCorrectionPage
    // isColoringMode = useTemplateStyle
    
    // Cas R√©aliste :
    // if (!isColoringMode) { if (isVisible) { ... } else { vide } }
    // Ici, isVisible doit √™tre true si item.showBead est true (exo) OU si isCorrectionPage est true.
    
    let isVisibleForSvg = false;
    if (useTemplateStyle) {
        // En mode template, isVisible sert uniquement √† d√©clencher le trac√© de correction (Bleu)
        isVisibleForSvg = isCorrectionPage;
    } else {
        // En mode r√©aliste, isVisible sert √† afficher les billes rouges/blanches
        isVisibleForSvg = (item.showBead || isCorrectionPage);
    }
    
    const topPart = document.createElement('div');
    topPart.className = 'part-boulier';
    topPart.innerHTML = getRekenrekSvg(item.val, isVisibleForSvg, theme, item.max, useTemplateStyle);
    cell.appendChild(topPart);
    
    // 2. BAS
    const botPart = document.createElement('div');
    botPart.className = 'part-bottom';
    
    const digitBox = document.createElement('div');
    digitBox.className = 'sub-box';
    digitBox.style.flex = "1"; 
    
    let showNumLogic = isCorrectionPage ? true : item.showNum;
    if(showNumLogic) {
        digitBox.innerHTML = `<span class="val-digit">${item.val}</span>`;
    } else {
        digitBox.innerHTML = `<div class="empty-zone"></div>`;
    }
    botPart.appendChild(digitBox);
    
    const wordBox = document.createElement('div');
    wordBox.className = 'sub-box';
    wordBox.style.flex = "2.2"; 

    let showWordLogic = isCorrectionPage ? true : item.showWord;
    if(showWordLogic) {
        wordBox.innerHTML = `<span class="val-word">${numberToText(item.val)}</span>`;
    } else {
        wordBox.innerHTML = `<div class="empty-zone"></div>`;
    }
    botPart.appendChild(wordBox);

    cell.appendChild(botPart);
    grid.appendChild(cell);
  });
  
  inner.appendChild(grid);
  page.appendChild(inner);
  main.appendChild(page);
}

function getRekenrekSvg(n, isVisible, theme, maxValSetting, isColoringMode) {
  
  const r = 5;          
  const dia = 2 * r;    
  const frameW = 5;     
  const W = 210;        
  
  let H, rows, spacingY, startY;
  let layoutType = 100;
  if (maxValSetting <= 10) layoutType = 10;
  else if (maxValSetting <= 20) layoutType = 20;
  
  if (layoutType === 100) {
      H = 140; rows = 10; spacingY = 13.5; startY = 10; 
  } else if (layoutType === 20) {
      H = 60; rows = 2; spacingY = 24; startY = 18;
  } else {
      H = 40; rows = 1; spacingY = 0; startY = 20;
  }
  
  let svg = `<svg class="rr-svg" viewBox="0 0 ${W} ${H}" preserveAspectRatio="xMidYMid meet">`;

  const getBeadColor = (idx, inverted) => {
      let isFirstFive = (idx < 5);
      let colMain = '#dc2626'; 
      let colSec = '#f8fafc'; 
      
      if (theme === 'blue') colSec = '#2563eb';
      if (theme === 'gray') colSec = '#e2e8f0'; 

      let fill;
      if (layoutType === 100 && inverted) fill = isFirstFive ? colSec : colMain;
      else fill = isFirstFive ? colMain : colSec;
      return fill;
  };

  if (isColoringMode) {
      const beadsWidth = 10 * dia;
      const startX = (W - beadsWidth) / 2;

      for(let row = 0; row < rows; row++) {
          let y = startY + (row * spacingY);
          svg += `<line x1="20" y1="${y}" x2="${W - 20}" y2="${y}" stroke="#9ca3af" stroke-width="1.5" />`;
          let inverted = (layoutType === 100 && row >= 5);
          for (let i = 0; i < 10; i++) {
              let cx = startX + (i * dia) + r; 
              let fill = getBeadColor(i, inverted);
              let stroke = '#333'; 
              svg += `<circle cx="${cx}" cy="${y}" r="${r}" fill="${fill}" stroke="${stroke}" stroke-width="0.5" />`;
          }
      }

      if (isVisible) {
           let fullRows = Math.floor(n / 10); 
           let remainder = n % 10;           
           const pad = 1.5; 
           const cornerR = 8; 

           const leftX = startX - pad;
           const topY = startY - r - pad;
           const rightX_Full = startX + (10 * dia) + pad;
           const rightX_Rem = startX + (remainder * dia) + pad;
           
           if (remainder === 0 && fullRows > 0) {
                const bottomY = startY + ((fullRows - 1) * spacingY) + r + pad;
                const w = rightX_Full - leftX;
                const h = bottomY - topY;
                // CHANGED: Black stroke
                svg += `<rect x="${leftX}" y="${topY}" width="${w}" height="${h}" rx="${cornerR}" fill="none" stroke="black" stroke-width="2.5" />`;
           }
           else if (fullRows === 0 && remainder > 0) {
               const bottomY = startY + r + pad;
               const w = rightX_Rem - leftX;
               const h = bottomY - topY;
                // CHANGED: Black stroke
               svg += `<rect x="${leftX}" y="${topY}" width="${w}" height="${h}" rx="${cornerR}" fill="none" stroke="black" stroke-width="2.5" />`;
           }
           else if (fullRows > 0 && remainder > 0) {
               const yLastFull = startY + (fullRows - 1) * spacingY;
               const midY = yLastFull + (spacingY / 2);
               const bottomY_Total = startY + (fullRows * spacingY) + r + pad;
               
               let d = "";
               d += `M ${leftX + cornerR} ${topY} `;
               d += `L ${rightX_Full - cornerR} ${topY} `;
               d += `A ${cornerR} ${cornerR} 0 0 1 ${rightX_Full} ${topY + cornerR} `;
               d += `L ${rightX_Full} ${midY} `;
               d += `L ${rightX_Rem} ${midY} `;
               d += `L ${rightX_Rem} ${bottomY_Total - cornerR} `;
               d += `A ${cornerR} ${cornerR} 0 0 1 ${rightX_Rem - cornerR} ${bottomY_Total} `;
               d += `L ${leftX + cornerR} ${bottomY_Total} `;
               d += `A ${cornerR} ${cornerR} 0 0 1 ${leftX} ${bottomY_Total - cornerR} `;
               d += `L ${leftX} ${topY + cornerR} `;
               d += `A ${cornerR} ${cornerR} 0 0 1 ${leftX + cornerR} ${topY} `;
               d += "Z"; 

               // CHANGED: Black stroke
               svg += `<path d="${d}" fill="none" stroke="black" stroke-width="2.5" stroke-linejoin="round" />`;
           }
      }
  }
  else {
      if (isVisible) {
          const brownColor = "#A07846";
          svg += `<rect x="0" y="0" width="${frameW}" height="${H}" fill="${brownColor}" />`;
          svg += `<rect x="${W - frameW}" y="0" width="${frameW}" height="${H}" fill="${brownColor}" />`;

          for(let row = 0; row < rows; row++) {
              let y = startY + (row * spacingY);
              svg += `<line x1="${frameW}" y1="${y}" x2="${W - frameW}" y2="${y}" stroke="#9ca3af" stroke-width="1.5" />`;

              let fullRows = Math.floor(n / 10);
              let remainder = n % 10;
              let activeCount = 0;
              if (row < fullRows) activeCount = 10;
              else if (row === fullRows) activeCount = remainder;
              
              let inactiveCount = 10 - activeCount;
              let inverted = (layoutType === 100 && row >= 5);

              let startXLeft = frameW + r; 
              for (let i = 0; i < activeCount; i++) {
                  let cx = startXLeft + (i * dia);
                  let fill = getBeadColor(i, inverted);
                  let stroke = '#333'; 
                  svg += `<circle cx="${cx}" cy="${y}" r="${r}" fill="${fill}" stroke="${stroke}" stroke-width="0.5" />`;
              }

              let startXRight = W - frameW - r;
              for (let j = 0; j < inactiveCount; j++) {
                  let realIdx = 9 - j; 
                  let cx = startXRight - (j * dia);
                  let fill = getBeadColor(realIdx, inverted);
                  let stroke = '#333'; 
                  svg += `<circle cx="${cx}" cy="${y}" r="${r}" fill="${fill}" stroke="${stroke}" stroke-width="0.5" />`;
              }
          }
      } else {
          const brownColor = "#A07846";
          svg += `<rect x="0" y="0" width="${frameW}" height="${H}" fill="${brownColor}" />`;
          svg += `<rect x="${W - frameW}" y="0" width="${frameW}" height="${H}" fill="${brownColor}" />`;
          for(let row = 0; row < rows; row++) {
              let y = startY + (row * spacingY);
              svg += `<line x1="${frameW}" y1="${y}" x2="${W - frameW}" y2="${y}" stroke="#9ca3af" stroke-width="1.5" />`;
          }
      }
  }
  
  svg += `</svg>`;
  return svg;
}
</script>
</body>
</html>
