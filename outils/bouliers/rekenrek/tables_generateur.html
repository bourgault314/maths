<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>REKENREK — TABLES DE MULTIPLICATION</title>
  <style>
    :root {
      --ink: #111827;
      --sub: #94a3b8;
      --bg: #f8fafc;
      --panel: #ffffff;
      --accent: #2563eb;
      --border: #cbd5e1;
      --grid-line: #d9d9d9; 
      --ok: #16a34a;
      
      --page-w: 210mm;
      --page-h: 297mm;
      /* Marges sécurisées pour que tout rentre */
      --page-margin-top: 10mm;
      --page-margin-bot: 25mm; 
      --page-margin-x: 10mm;
      
      --cols: 5;
      --rows: 6;
    }
    
    * { box-sizing: border-box; }
    body { margin: 0; font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--ink); display: flex; height: 100vh; overflow: hidden; }

    /* --- SIDEBAR --- */
    aside {
      width: 360px;
      background: var(--panel);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      z-index: 10;
      box-shadow: 2px 0 10px rgba(0,0,0,0.05);
    }

    .sb-header { padding: 15px 20px; border-bottom: 1px solid var(--border); background: #fff; }
    .sb-title { font-size: 18px; font-weight: 800; color: var(--accent); margin: 0; text-transform: uppercase; }
    
    .sb-scroll { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; }
    
    .section { }
    .sec-title { font-size: 11px; text-transform: uppercase; color: #64748b; font-weight: 800; margin-bottom: 8px; border-bottom: 2px solid #f1f5f9; padding-bottom: 4px; }
    
    .control { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; font-size: 13px; font-weight: 600; }
    .control label { flex: 1; color: #334155; }
    
    select, input[type="number"] {
      padding: 6px 10px; border: 1px solid var(--border); border-radius: 6px;
      font-size: 13px; font-weight: 600; color: var(--ink); outline: none;
      width: 130px; background: #fff; cursor: pointer;
    }
    select:hover, input:hover { border-color: var(--accent); }
    input[type="checkbox"] { transform: scale(1.3); cursor: pointer; accent-color: var(--accent); }
    
    .flags { display: flex; gap: 10px; }
    .flag-btn { font-size: 14px; font-weight: 800; cursor: pointer; opacity: 0.5; padding: 4px 10px; border-radius: 6px; background:#f1f5f9; }
    .flag-btn.active { opacity: 1; background: var(--accent); color: white; }

    /* Table Selector */
    .table-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; }
    .t-btn {
      font-size: 11px; font-weight: 700; cursor: pointer;
      border: 1px solid var(--border); border-radius: 4px;
      padding: 5px 0; text-align: center; background: #fff;
    }
    .t-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

    .mix-group { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; background: #f1f5f9; padding: 10px; border-radius: 8px; }
    .mix-col { display: flex; flex-direction: column; align-items: center; }
    .mix-col span { font-size: 9px; color: #64748b; margin-bottom: 4px; font-weight: bold; }
    .mix-col input { width: 100%; text-align: center; padding: 6px; font-size: 12px; }

    .actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
    .btn { padding: 12px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; color: white; font-size: 13px; }
    .btn-new { background: var(--accent); }
    .btn-print { background: #10b981; }

    /* --- PAGE PREVIEW --- */
    main { flex: 1; overflow: auto; padding: 20px; display: flex; justify-content: center; align-items: flex-start; background: #e2e8f0; }
    
    .page {
      width: var(--page-w); height: var(--page-h);
      background: white; box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      position: relative; flex-shrink: 0;
    }
    .page-inner { 
      position: absolute; 
      top: var(--page-margin-top);
      bottom: var(--page-margin-bot);
      left: var(--page-margin-x);
      right: var(--page-margin-x);
      display: flex; flex-direction: column; 
    }
    
    /* Header compact */
    .header { margin-bottom: 3mm; padding-bottom: 2mm; text-align: center; border-bottom: 2px solid #000; flex-shrink: 0; }
    .header h1 { margin: 0; font-size: 26px; text-transform: uppercase; font-weight: 900; color: var(--ink); letter-spacing: 1px; }

    .grid {
      flex: 1; 
      display: grid;
      grid-template-columns: repeat(var(--cols), 1fr);
      grid-template-rows: repeat(var(--rows), 1fr);
      border-top: 0.6px solid var(--grid-line); 
      border-left: 0.6px solid var(--grid-line);
      margin-top: 2mm;
      min-height: 0; /* Important pour l'impression */
    }
    .cell {
      border-right: 0.6px solid var(--grid-line); 
      border-bottom: 0.6px solid var(--grid-line);
      position: relative; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      overflow: hidden; padding: 2px;
    }

    .rotate-wrap { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
    
    /* SVG qui s'adapte à la case pour être le plus gros possible */
    .rr-svg { 
      width: 98%; 
      height: 98%; 
      overflow: visible; 
      display: block;
    }
    
    .op-line { font-size: 19px; font-weight: 900; white-space: nowrap; font-family: system-ui; text-align: center; width: 100%; }
    .op-col { font-family: 'Courier New', monospace; font-size: 20px; font-weight: 900; line-height: 1.1; text-align: right; padding-right: 25%; width: 100%; }
    .op-col .bar { height: 2px; background: #000; margin: 4px 0; width: 100%; }

    .num-val { font-size: 34px; font-weight: 900; text-align: center; width: 100%; }
    .u-69 { text-decoration: underline; text-decoration-thickness: 3px; text-underline-offset: 5px; }

    /* CERCLE DE CORRECTION AJUSTÉ (Petit et Centré) */
    .corr-ellipse {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: 60%; height: 60%; 
      border: 2px solid var(--ok);
      border-radius: 50%;
      pointer-events: none;
      z-index: 5;
    }
    .corr-text {
      position: absolute;
      bottom: 2px;
      left: 0; right: 0;
      text-align: center;
      font-size: 13px;
      font-weight: 800;
      color: #000;
      background: rgba(255,255,255,0.9);
      z-index: 6;
      border-radius: 4px;
      pointer-events: none;
    }

    @media print {
      @page { size: A4; margin: 0; } 
      body { display: block; background: white; height: auto; overflow: visible; }
      aside { display: none !important; }
      main { padding: 0; margin: 0; display: block; overflow: visible; height: auto; }
      .page { margin: 0 auto; box-shadow: none; border: none; width: 210mm; height: 297mm; overflow: hidden; page-break-after: always; }
      * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }
  </style>
</head>
<body>

<aside>
  <div class="sb-header">
    <h2 class="sb-title" data-i18n="title_main">Tables Mult & Div</h2>
  </div>
  
  <div class="sb-scroll">
    <div class="actions">
      <button class="btn btn-new" onclick="startGen()" data-i18n="btn_new">NOUVEAU TIRAGE</button>
      <button class="btn btn-print" onclick="window.print()" data-i18n="btn_print">IMPRIMER</button>
    </div>

    <div class="section">
      <div class="sec-title" data-i18n="sec_layout">Mise en page</div>
      <div class="control">
        <label data-i18n="lbl_grid">Grille</label>
        <select id="gridSize" onchange="updateMaxTargets(); startGen()">
          <option value="5x6">30 cases (5x6)</option>
          <option value="4x6">24 cases (4x6)</option>
          <option value="4x5">20 cases (4x5)</option>
          <option value="4x4">16 cases (4x4)</option>
        </select>
      </div>
      <div class="control">
        <label data-i18n="lbl_lang">Langue</label>
        <div class="flags">
          <div class="flag-btn active" onclick="setLang('fr', this)">FR</div>
          <div class="flag-btn" onclick="setLang('en', this)">EN</div>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="sec-title" data-i18n="sec_content">Contenu</div>
      
      <div class="control" style="display:block; margin-bottom:15px;">
        <label style="margin-bottom:6px; display:block;" data-i18n="lbl_tables">Tables à réviser</label>
        <div class="table-grid" id="tableSelector">
          </div>
      </div>

      <div class="control">
        <label data-i18n="lbl_range">Multiplicateurs</label>
        <select id="multRange" onchange="startGen()">
          <option value="10">0 à 10</option>
          <option value="12">0 à 12</option>
        </select>
      </div>

      <div class="control">
        <label data-i18n="lbl_correct">Nb. Justes</label>
        <input type="number" id="targetCount" value="11" min="1" max="30" onchange="startGen()">
      </div>

      <div class="control">
        <label data-i18n="lbl_order">Ordre</label>
        <select id="orderMode" onchange="startGen()">
          <option value="seq" data-i18n="opt_seq">Ordre (x0, x1...)</option>
          <option value="random" data-i18n="opt_random">Désordre</option>
        </select>
      </div>

      <div class="control">
        <label data-i18n="lbl_format">Écriture</label>
        <select id="opFormat" onchange="renderOnly()">
          <option value="MxT" data-i18n="opt_fmt_mxt">M x T (6 x 2)</option>
          <option value="TxM" data-i18n="opt_fmt_txm">T x M (2 x 6)</option>
          <option value="Div" data-i18n="opt_fmt_div">Division (12 ÷ 2)</option>
          <option value="MixMult" data-i18n="opt_fmt_mix_m">Mélange (x)</option>
          <option value="MixAll" data-i18n="opt_fmt_mix_all">Mélange (x et ÷)</option>
        </select>
      </div>

      <div class="control">
        <label data-i18n="lbl_display">Affichage</label>
        <select id="dispType" onchange="toggleMix(); startGen()">
          <option value="rr" data-i18n="opt_rr">Boulier (100%)</option>
          <option value="op" data-i18n="opt_op">Opérations (100%)</option>
          <option value="num" data-i18n="opt_num">Nombres (100%)</option>
          <option value="mix" data-i18n="opt_mix">Mélange (Auto)</option>
        </select>
      </div>
      <div id="mixPanel" style="display:none;">
        <div class="mix-group">
          <div class="mix-col"><span data-i18n="mix_b">Boulier</span><input type="number" id="ratB" value="40" oninput="calcRatio('B')"></div>
          <div class="mix-col"><span data-i18n="mix_o">Opér.</span><input type="number" id="ratO" value="30" oninput="calcRatio('O')"></div>
          <div class="mix-col"><span data-i18n="mix_n">Nombre</span><input type="number" id="ratN" value="30" disabled style="background:transparent; color:#64748b;"></div>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="sec-title" data-i18n="sec_style">Style</div>
      <div class="control">
        <label data-i18n="lbl_opstyle">Opérations</label>
        <select id="opLayout" onchange="renderOnly()">
          <option value="line" data-i18n="opt_line">En ligne</option>
          <option value="col" data-i18n="opt_col">En colonne</option>
        </select>
      </div>
      <div class="control">
        <label data-i18n="lbl_beads">Billes</label>
        <select id="beadColor" onchange="renderOnly()">
          <option value="red" data-i18n="opt_red">Rouge / Blanc</option>
          <option value="blue" data-i18n="opt_blue">Rouge / Bleu</option>
        </select>
      </div>
      <div class="control">
        <label data-i18n="lbl_letters">Lettres (R)</label>
        <input type="checkbox" id="showLetters" onchange="renderOnly()">
      </div>
      <div class="control">
        <label data-i18n="lbl_rot">Rotation</label>
        <input type="checkbox" id="doRot" onchange="renderOnly()">
      </div>
      <div class="control">
        <label style="color:var(--ok); font-weight:800;" data-i18n="lbl_corr">Correction</label>
        <input type="checkbox" id="doCorr" onchange="renderOnly()">
      </div>
    </div>
  </div>
</aside>

<main>
  <div class="page">
    <div class="page-inner">
      <div class="header">
        <h1 id="h-title">TABLES DE MULTIPLICATION</h1>
      </div>
      <div class="grid" id="grid"></div>
    </div>
  </div>
</main>

<script>
const i18n = {
  fr: {
    title_main: "Tables Mult & Div",
    btn_new: "NOUVEAU TIRAGE",
    btn_print: "IMPRIMER",
    sec_layout: "Mise en page",
    lbl_grid: "Grille",
    lbl_lang: "Langue",
    sec_content: "Contenu",
    lbl_correct: "Nb. Justes",
    lbl_tables: "Tables à réviser",
    lbl_range: "Multiplicateurs",
    lbl_order: "Ordre",
    opt_random: "Désordre",
    opt_seq: "Ordre (x0, x1...)",
    lbl_format: "Écriture",
    opt_fmt_mxt: "M x T (6 x 2)",
    opt_fmt_txm: "T x M (2 x 6)",
    opt_fmt_div: "Division (12 ÷ 2)",
    opt_fmt_mix_m: "Mélange (x)",
    opt_fmt_mix_all: "Mélange (x et ÷)",
    lbl_display: "Affichage",
    opt_rr: "Boulier (100%)",
    opt_op: "Opérations (100%)",
    opt_num: "Nombres (100%)",
    opt_mix: "Mélange (Auto)",
    mix_b: "Boulier",
    mix_o: "Opér.",
    mix_n: "Nombre",
    sec_style: "Style",
    lbl_opstyle: "Opérations",
    opt_line: "En ligne",
    opt_col: "En colonne",
    lbl_beads: "Billes",
    opt_red: "Rouge / Blanc",
    opt_blue: "Rouge / Bleu",
    lbl_letters: "Lettres (Rekenrek)",
    lbl_rot: "Rotation",
    lbl_corr: "Correction",
    page_title: "TABLES DE MULTIPLICATION"
  },
  en: {
    title_main: "Mult. Tables",
    btn_new: "SHUFFLE",
    btn_print: "PRINT",
    sec_layout: "Layout",
    lbl_grid: "Grid",
    lbl_lang: "Language",
    sec_content: "Content",
    lbl_correct: "Correct Count",
    lbl_tables: "Select Tables",
    lbl_range: "Multipliers",
    lbl_order: "Order",
    opt_random: "Random",
    opt_seq: "Sequence (x0, x1...)",
    lbl_format: "Format",
    opt_fmt_mxt: "M x T (6 x 2)",
    opt_fmt_txm: "T x M (2 x 6)",
    opt_fmt_div: "12 ÷ 2 (Div)",
    opt_fmt_mix_m: "Mixed (x)",
    opt_fmt_mix_all: "Mixed (x and ÷)",
    lbl_display: "Display",
    opt_rr: "Rekenrek (100%)",
    opt_op: "Operations (100%)",
    opt_num: "Numbers (100%)",
    opt_mix: "Mixed (Auto)",
    mix_b: "Beads",
    mix_o: "Ops",
    mix_n: "Num",
    sec_style: "Style",
    lbl_opstyle: "Operations",
    opt_line: "Linear",
    opt_col: "Column",
    lbl_beads: "Beads",
    opt_red: "Red / White",
    opt_blue: "Red / Blue",
    lbl_letters: "Letters (Rekenrek)",
    lbl_rot: "Rotation",
    lbl_corr: "Answer Key",
    page_title: "MULTIPLICATION TABLES"
  }
};

let currentLang = 'fr';
let state = { data: [] };
let selectedTables = [2]; 

window.onload = function() {
  initTableSelector();
  calcRatio('B');
  updateMaxTargets();
  startGen();
  updateLangUI();
};

function initTableSelector() {
  const container = document.getElementById('tableSelector');
  container.innerHTML = '';
  for(let i=0; i<=12; i++) {
    const btn = document.createElement('div');
    btn.className = 't-btn' + (selectedTables.includes(i) ? ' active' : '');
    btn.innerText = i;
    btn.onclick = () => toggleTable(i, btn);
    container.appendChild(btn);
  }
}

function toggleTable(n, btn) {
  if(selectedTables.includes(n)) {
    if(selectedTables.length > 1) { 
      selectedTables = selectedTables.filter(x => x !== n);
      btn.classList.remove('active');
    }
  } else {
    selectedTables.push(n);
    btn.classList.add('active');
  }
  startGen();
}

function setLang(l, el) {
  currentLang = l;
  document.querySelectorAll('.flag-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  updateLangUI();
  const dict = i18n[currentLang];
  document.getElementById('h-title').innerText = dict.page_title;
}

function updateLangUI() {
  const dict = i18n[currentLang];
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    if(dict[key]) el.innerText = dict[key];
  });
}

function updateMaxTargets() {
  const [cols, rows] = document.getElementById('gridSize').value.split('x').map(Number);
  const total = cols * rows;
  const inp = document.getElementById('targetCount');
  inp.max = total;
  if(parseInt(inp.value) > total) inp.value = total;
}

function calcRatio(src) {
  let b = parseInt(document.getElementById('ratB').value)||0;
  let o = parseInt(document.getElementById('ratO').value)||0;
  if(b < 0) b = 0; if(o < 0) o = 0;
  if(b + o > 100) { if(src === 'B') o = 100 - b; else b = 100 - o; }
  let n = 100 - b - o;
  document.getElementById('ratB').value = b;
  document.getElementById('ratO').value = o;
  document.getElementById('ratN').value = n;
  if(document.getElementById('dispType').value === 'mix') startGen();
}

function toggleMix() {
  const t = document.getElementById('dispType').value;
  document.getElementById('mixPanel').style.display = (t === 'mix') ? 'block' : 'none';
}

function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

function startGen() {
  const [cols, rows] = document.getElementById('gridSize').value.split('x').map(Number);
  document.documentElement.style.setProperty('--cols', cols);
  document.documentElement.style.setProperty('--rows', rows);
  const totalSlots = cols * rows;
  const targetCount = parseInt(document.getElementById('targetCount').value) || 11;
  
  const dispType = document.getElementById('dispType').value;
  const rB = parseInt(document.getElementById('ratB').value);
  const rO = parseInt(document.getElementById('ratO').value);
  
  const multMax = parseInt(document.getElementById('multRange').value);
  const orderMode = document.getElementById('orderMode').value;
  const opFormat = document.getElementById('opFormat').value;

  // Division : Pas de 0
  let isDiv = (opFormat === 'Div' || opFormat === 'MixAll');
  let startMult = isDiv ? 1 : 0;

  state.data = new Array(totalSlots).fill(null);
  
  // 1. GENERATE TARGETS (ORDERED)
  let allPossibleTargets = [];
  selectedTables.sort((a,b)=>a-b);
  
  selectedTables.forEach(t => {
    for(let m=startMult; m<=multMax; m++) {
      allPossibleTargets.push({ t: t, m: m, val: t*m, isTarget: true });
    }
  });

  // 2. SELECT N TARGETS
  let targets = [];
  if (orderMode === 'seq') {
    // Sequential strict
    for(let i=0; i<targetCount; i++) {
        let src = allPossibleTargets[i % allPossibleTargets.length];
        targets.push({ ...src }); 
    }
  } else {
    // Random
    let deck = [];
    const numDecks = Math.ceil(targetCount / allPossibleTargets.length);
    for(let k=0; k<numDecks; k++) deck = deck.concat(allPossibleTargets);
    deck = shuffle(deck);
    for(let i=0; i<targetCount; i++) targets.push({ ...deck[i] });
  }

  // 3. PLACEMENT
  let indices = Array.from({length: totalSlots}, (_, i) => i);
  if (orderMode === 'seq') {
      // PLACEMENT STRICT pour l'ordre
      for(let i=0; i<targets.length; i++) {
          if(i < totalSlots) state.data[i] = targets[i];
      }
  } else {
      // Placement aléatoire
      let chosenIndices = shuffle([...indices]).slice(0, targets.length);
      for(let i=0; i<targets.length; i++) {
          state.data[chosenIndices[i]] = targets[i];
      }
  }

  // 4. PIÈGES
  for(let i=0; i<totalSlots; i++) {
      if(state.data[i] !== null && state.data[i] !== undefined) continue; 

      let ref = targets[Math.floor(Math.random()*targets.length)];
      if(!ref) ref = { val: 10 };
      
      let trapVal = ref.val + (Math.random()>0.5 ? 1 : -1) * (Math.random()>0.7 ? 2 : 1);
      if(trapVal < 0) trapVal = 1;

      let type = 'rr';
      if(dispType !== 'mix') {
          type = dispType;
      } else {
          const roll = Math.random() * 100;
          if(roll < rB) type = 'rr';
          else if(roll < rB + rO) type = 'op';
          else type = 'num';
      }
      
      let trapItem = { val: trapVal, isTarget: false, type: type, angle: Math.random()*360 };
      
      if(type === 'op') {
          let tRand = Math.floor(Math.random()*10);
          let mRand = Math.floor(Math.random()*10);
          trapItem.t = tRand; 
          trapItem.m = mRand;
      }
      
      state.data[i] = trapItem;
  }
  
  // Finalize
  state.data.forEach(item => {
      if(!item.angle) item.angle = Math.random() * 360;
      if(!item.type) {
          let type = 'rr';
          if(dispType !== 'mix') {
              type = dispType;
          } else {
              const roll = Math.random() * 100;
              if(roll < rB) type = 'rr';
              else if(roll < rB + rO) type = 'op';
              else type = 'num';
          }
          item.type = type;
      }
  });

  renderOnly();
}

function renderOnly() {
  const grid = document.getElementById('grid');
  grid.innerHTML = '';
  
  const doRot = document.getElementById('doRot').checked;
  const doCorr = document.getElementById('doCorr').checked;
  const showLetters = document.getElementById('showLetters').checked;
  const opLayout = document.getElementById('opLayout').value;
  const opFormat = document.getElementById('opFormat').value; 
  const theme = document.getElementById('beadColor').value;
  const dict = i18n[currentLang];

  document.getElementById('h-title').innerText = dict.page_title;

  state.data.forEach(item => {
    const cell = document.createElement('div');
    cell.className = 'cell';
    
    const wrap = document.createElement('div');
    wrap.className = 'rotate-wrap';
    if(doRot) wrap.style.transform = `rotate(${item.angle}deg)`;
    
    let currentFmt = opFormat;
    if(opFormat === 'MixMult') {
        currentFmt = (Math.random() > 0.5) ? 'MxT' : 'TxM';
    } else if(opFormat === 'MixAll') {
        let r = Math.random();
        if(r < 0.33) currentFmt = 'MxT';
        else if(r < 0.66) currentFmt = 'TxM';
        else currentFmt = 'Div';
    }

    item.usedFmt = currentFmt;

    let html = '';
    
    if(item.type === 'op') {
      let txt = "";
      // CORRECTION: 0 pris en compte
      let t = (item.t !== undefined) ? item.t : 2; 
      let m = (item.m !== undefined) ? item.m : 2; 
      let v = item.val;

      if(currentFmt === 'Div') {
          let diviseur = t; 
          if(!item.isTarget && selectedTables.length > 0) {
             diviseur = selectedTables[Math.floor(Math.random()*selectedTables.length)];
          }
          if(diviseur===0) diviseur=1;
          item.diviseurUsed = diviseur; 
          txt = `${v} ÷ ${diviseur}`;
      } else if(currentFmt === 'TxM') {
          txt = `${t} x ${m}`;
      } else { 
          txt = `${m} x ${t}`;
      }

      if(opLayout === 'col') {
         if(currentFmt === 'Div') {
             html = `<div class="op-line">${txt} =</div>`;
         } else {
             let parts = txt.split(' x ');
             html = `<div class="op-col"><div>${parts[0]}</div><div>x ${parts[1]}</div><div class="bar"></div></div>`;
         }
      } else {
         html = `<div class="op-line">${txt} =</div>`;
      }
    } 
    else if(item.type === 'num') {
      let val = item.val;
      let displayVal = val;
      if([6,9,66,99].includes(val)) displayVal = `<span class="u-69">${val}</span>`;
      html = `<div class="num-val">${displayVal}</div>`;
    }
    else { 
      html = getSvg(item.val, theme, showLetters);
    }
    
    wrap.innerHTML = html;
    cell.appendChild(wrap);

    if(doCorr && item.isTarget) {
      const el = document.createElement('div');
      el.className = 'corr-ellipse';
      cell.appendChild(el);
      const txt = document.createElement('div');
      txt.className = 'corr-text';
      
      if(item.usedFmt === 'Div') {
          let div = item.diviseurUsed || item.t;
          if(div===0) div=1;
          let quotient = Math.round(item.val/div); 
          txt.innerText = `${item.val} ÷ ${div} = ${quotient}`;
      } else if(item.usedFmt === 'TxM') {
          txt.innerText = `${item.t} x ${item.m} = ${item.val}`;
      } else {
          txt.innerText = `${item.m} x ${item.t} = ${item.val}`;
      }
      
      cell.appendChild(txt);
    }

    grid.appendChild(cell);
  });
}

function getSvg(n, theme, showLetters) {
  const W = 100, H = 100;
  const letters = "REKENREK";
  // preserveAspectRatio pour CENTRAGE PARFAIT (Gros boulier)
  // On utilise une viewBox adaptée à la taille du contenu pour qu'il prenne 100% de la case
  
  const rowsNeeded = Math.ceil(n / 10);
  const rowHeight = 8.5; // Gros style
  const r = 4.0; // Gros rayon
  const spacing = 8.5; 
  
  // Calcul de la hauteur réelle du boulier
  const contentH = Math.max(100, rowsNeeded * rowHeight + 10); // Min 100
  
  // On remplace le svg tag avec la bonne viewBox hauteur
  let svg = `<svg class="rr-svg" viewBox="0 0 ${W} ${contentH}" preserveAspectRatio="xMidYMid meet">`;

  // Centrage vertical dans la viewBox
  const totalH = rowsNeeded * rowHeight;
  const startY = (contentH - totalH) / 2 + (rowHeight/2);

  // Centrage horizontal du groupe de 10
  const groupW = (9 * spacing) + (2 * r); // ~ 84.5
  const leftMargin = (W - groupW) / 2 + r; // Centré

  const fullRows = Math.floor(n / 10);
  const remainder = n % 10;

  for(let row=0; row < rowsNeeded; row++) {
      let y = startY + row * rowHeight;
      let count = (row < fullRows) ? 10 : remainder;
      
      // INVERSION COULEURS (50, 100, 150...)
      let inverted = Math.floor(row / 5) % 2 === 1;

      let cx = leftMargin;
      for(let i=0; i < count; i++) {
          let isFirst5 = (i % 10) < 5;
          let colMain = '#ef4444'; 
          let colSec = (theme === 'blue') ? '#3b82f6' : '#ffffff'; 
          
          let fill;
          if(inverted) {
             fill = isFirst5 ? colSec : colMain;
          } else {
             fill = isFirst5 ? colMain : colSec;
          }
          
          svg += `<circle cx="${cx}" cy="${y}" r="${r}" fill="${fill}" stroke="#111827" stroke-width="0.5" />`;
          
          if(showLetters && i < 8) {
              let txtCol = (fill === '#ffffff') ? 'black' : 'white';
              svg += `<text x="${cx}" y="${y}" font-size="3.5" font-family="Arial, sans-serif" font-weight="900" fill="${txtCol}" text-anchor="middle" dominant-baseline="central">${letters[i]}</text>`;
          }
          cx += spacing;
      }
  }
  
  svg += `</svg>`;
  return svg;
}
</script>
</body>
</html>