<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>REKENREK — SCHÉMAS & COMPLÉMENTS FINAL</title>
  <style>
    :root {
      --ink: #111827;
      --bg: #f8fafc;
      --panel: #ffffff;
      --accent: #2563eb;
      --border: #cbd5e1;
      --grid-line: #94a3b8; 
      --page-w: 210mm;
      --page-h: 297mm;
      --page-margin: 10mm;
      --cols: 3; 
      --rows: 4;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--ink); display: flex; height: 100vh; overflow: hidden; }
    aside { width: 340px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 10; box-shadow: 2px 0 10px rgba(0,0,0,0.05); }
    .sb-header { padding: 15px 20px; border-bottom: 1px solid var(--border); background: #fff; }
    .sb-title { font-size: 18px; font-weight: 800; color: var(--accent); margin: 0; text-transform: uppercase; }
    .sb-scroll { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
    .section { border-bottom: 1px solid #f1f5f9; padding-bottom: 12px; }
    .sec-title { font-size: 11px; text-transform: uppercase; color: #64748b; font-weight: 800; margin-bottom: 8px; }
    select, input[type="number"] { padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; font-weight: 600; width: 100%; outline: none; background: #fff; }
    .flags { display: flex; gap: 10px; margin-bottom: 10px; }
    .flag-btn { font-size: 12px; font-weight: 800; cursor: pointer; opacity: 0.5; padding: 4px 10px; border-radius: 6px; background:#f1f5f9; border: 1px solid #e2e8f0; }
    .flag-btn.active { opacity: 1; background: var(--accent); color: white; border-color: var(--accent); }
    .check-control { display: flex; align-items: center; gap: 10px; background: #f1f5f9; padding: 8px; border-radius: 8px; border: 1px solid #e2e8f0; cursor: pointer; margin-bottom: 5px; }
    .check-control input { width: 17px; height: 17px; cursor: pointer; }
    .check-text { font-size: 12px; font-weight: 700; color: #334155; }
    .actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: auto; padding-top: 10px; }
    .btn { padding: 12px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; color: white; font-size: 13px; }
    .btn-new { background: var(--accent); }
    .btn-print { background: #10b981; }
    main { flex: 1; overflow: auto; padding: 20px; display: flex; flex-direction: column; align-items: center; gap: 20px; background: #e2e8f0; }
    .page { width: var(--page-w); height: var(--page-h); background: white; box-shadow: 0 10px 30px rgba(0,0,0,0.15); position: relative; flex-shrink: 0; page-break-after: always; }
    .page-inner { position: absolute; top: var(--page-margin); bottom: var(--page-margin); left: var(--page-margin); right: var(--page-margin); display: flex; flex-direction: column; }
    .grid { flex: 1; display: grid; grid-template-columns: repeat(var(--cols), 1fr); grid-template-rows: repeat(var(--rows), 1fr); border: 2px solid var(--ink); min-height: 0; }
    .cell { border: 1px solid var(--grid-line); display: flex; flex-direction: column; padding: 4px; position: relative; overflow: hidden; }
    .eq-area { flex: 0 0 auto; display: flex; flex-direction: column; gap: 1px; margin-bottom: 2px; justify-content: center; min-height: 40px; }
    .eq-line { font-size: 15px; font-weight: 800; text-align: center; color: #1e293b; letter-spacing: 1px; }
    .part-boulier { flex: 1; display: flex; align-items: center; justify-content: center; border-bottom: 1px dashed #cbd5e1; margin-bottom: 5px; overflow: hidden; min-height: 0; }
    .rr-svg { width: 100%; height: 100%; display: block; overflow: visible; }
    .diagram-container { flex: 0 0 80px; display: flex; flex-direction: column; width: 85%; margin: 0 auto; }
    .row-top { flex: 1; border: 2px solid #334155; border-bottom: none; display: flex; align-items: center; justify-content: center; font-size: 17px; font-weight: 900; background: #fff; border-radius: 4px 4px 0 0; }
    .row-bottom { flex: 1; display: flex; }
    .part-box { flex: 1; border: 2px solid #334155; display: flex; align-items: center; justify-content: center; font-size: 15px; font-weight: 800; position: relative; }
    .part-left { border-radius: 0 0 0 4px; background: white; }
    .part-right { border-radius: 0 0 4px 0; border-left: none; background-color: white; background-image: radial-gradient(rgba(0, 0, 0, 0.2) 1px, transparent 1px); background-size: 4px 4px; }
    .val-inner { position: relative; z-index: 2; background: white; padding: 0 4px; border-radius: 2px; }
    @media print { @page { size: A4; margin: 0; } body { display: block; background: white; height: auto; overflow: visible; } aside { display: none !important; } main { padding: 0; margin: 0; display: block; overflow: visible; height: auto; } .page { margin: 0 auto; box-shadow: none; border: none; width: 210mm; height: 297mm; overflow: hidden; page-break-after: always; } .grid { border: 2px solid #000; } }
  </style>
</head>
<body>
<aside>
  <div class="sb-header"><h2 class="sb-title" data-i18n="title">Schémas & Équations</h2></div>
  <div class="sb-scroll">
    <div class="section">
        <div class="sec-title" data-i18n="lang">Langue</div>
        <div class="flags">
            <div class="flag-btn active" onclick="setLang('fr', this)">FR</div>
            <div class="flag-btn" onclick="setLang('en', this)">EN</div>
        </div>
    </div>
    <div class="section">
      <div class="sec-title" data-i18n="options">Options</div>
      <label class="check-control"><input type="checkbox" id="showCorr" onchange="renderPages()"><span class="check-text" data-i18n="opt_corr">Correction</span></label>
      <div class="control" style="flex-direction:column; align-items:flex-start; margin-top:8px;">
        <label style="margin-bottom:4px; font-size: 12px;" data-i18n="lbl_eq_mode">Lignes d'équations</label>
        <select id="eqMode" onchange="renderPages()">
            <option value="none" selected data-i18n="eq_none">Aucune</option>
            <option value="plus" data-i18n="eq_plus">Addition (+)</option>
            <option value="both" data-i18n="eq_both">Addition & Soustraction (+/-)</option>
        </select>
      </div>
    </div>
    <div class="section">
      <div class="sec-title" data-i18n="layout">Mise en page</div>
      <select id="gridSize" onchange="startGen()">
          <option value="3x4" selected data-i18n="grid_12">12 cases (3x4)</option>
          <option value="3x5" data-i18n="grid_15">15 cases (3x5)</option>
          <option value="2x4" data-i18n="grid_8">8 cases (Grosses)</option>
      </select>
    </div>
    <div class="section">
      <div class="sec-title" data-i18n="content">Contenu</div>
      <div class="control"><label data-i18n="target">Cible</label><select id="targetVal" onchange="startGen()">
          <option value="10">10</option><option value="20">20</option><option value="100" selected>100</option>
      </select></div>
      <div class="control"><label data-i18n="order">Ordre</label><select id="orderMode" onchange="toggleInputs(); startGen()">
          <option value="random" data-i18n="ord_rand" selected>Aléatoire</option>
          <option value="seq" data-i18n="ord_seq">Séquentiel</option>
      </select></div>
      <div id="seqInputs" class="control" style="display:none; gap:5px;"><input type="number" id="seqStart" value="0" min="0" onchange="startGen()"><input type="number" id="seqEnd" value="20" min="1" onchange="startGen()"></div>
      <div class="sec-title" style="margin-top:10px;" data-i18n="exercise">Exercice</div>
      <select id="gameMode" onchange="startGen()" style="width:100%">
        <option value="find_hidden" selected data-i18n="mode_hidden">Trouver le Caché</option>
        <option value="construct" data-i18n="mode_construct">Tout construire</option>
        <option value="color" data-i18n="mode_color">Colorier</option>
        <option value="mix" data-i18n="mode_mix">Mélanger les types</option>
      </select>
    </div>
    <div class="section">
       <div class="sec-title" data-i18n="bead_color">Couleur Billes</div>
       <select id="beadColor" onchange="renderPages()">
          <option value="red" data-i18n="opt_red">Rouge / Blanc</option>
          <option value="blue" data-i18n="opt_blue">Rouge / Bleu</option>
       </select>
    </div>
    <div class="actions">
      <button class="btn btn-new" onclick="startGen()" data-i18n="btn_mix">MÉLANGER</button>
      <button class="btn btn-print" onclick="window.print()" data-i18n="btn_print">IMPRIMER</button>
    </div>
  </div>
</aside>
<main id="mainArea"></main>
<script>
const i18n = {
    fr: {
        title: "Schémas & Équations", lang: "Langue", options: "Options", opt_corr: "Correction", lbl_eq_mode: "Lignes d'équations",
        eq_none: "Aucune", eq_plus: "Addition (+)", eq_both: "Addition & Soustraction (+/-)",
        layout: "Mise en page", grid: "Grille", grid_12: "12 cases (3x4)", grid_15: "15 cases (3x5)", grid_8: "8 cases (Grosses)",
        content: "Contenu", target: "Cible", order: "Ordre", ord_rand: "Aléatoire", ord_seq: "Séquentiel", exercise: "Exercice",
        mode_hidden: "Trouver le Caché", mode_construct: "Tout construire", mode_color: "Colorier", mode_mix: "Mélanger les types",
        bead_color: "Couleur Billes", opt_red: "Rouge / Blanc", opt_blue: "Rouge / Bleu", btn_mix: "MÉLANGER", btn_print: "IMPRIMER"
    },
    en: {
        title: "Schemes & Equations", lang: "Language", options: "Options", opt_corr: "Answer Key", lbl_eq_mode: "Equation lines",
        eq_none: "None", eq_plus: "Addition only (+)", eq_both: "Add & Sub (+/-)",
        layout: "Layout", grid: "Grid", grid_12: "12 boxes (3x4)", grid_15: "15 boxes (3x5)", grid_8: "8 boxes (Large)",
        content: "Content", target: "Target", order: "Order", ord_rand: "Random", ord_seq: "Sequential", exercise: "Exercise",
        mode_hidden: "Find Hidden", mode_construct: "Construct All", mode_color: "Coloring", mode_mix: "Mixed types",
        bead_color: "Bead Color", opt_red: "Red / White", opt_blue: "Red / Blue", btn_mix: "SHUFFLE", btn_print: "PRINT"
    }
};
let currentLang = 'fr';
function setLang(l, el) { currentLang = l; document.querySelectorAll('.flag-btn').forEach(b => b.classList.remove('active')); el.classList.add('active'); updateUI(); renderPages(); }
function updateUI() {
    const dict = i18n[currentLang];
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if(dict[key]) el.innerText = dict[key];
    });
}
let state = [];
function toggleInputs() { document.getElementById('seqInputs').style.display = (document.getElementById('orderMode').value === 'seq') ? 'flex' : 'none'; }
function startGen() {
  const sizeSelect = document.getElementById('gridSize').value;
  const [cols, rows] = sizeSelect.split('x').map(Number);
  document.documentElement.style.setProperty('--cols', cols);
  document.documentElement.style.setProperty('--rows', rows);
  const targetVal = parseInt(document.getElementById('targetVal').value);
  const orderMode = document.getElementById('orderMode').value;
  const gameMode = document.getElementById('gameMode').value;
  state = [];
  if (orderMode === 'seq') {
      let start = parseInt(document.getElementById('seqStart').value) || 0;
      let end = parseInt(document.getElementById('seqEnd').value) || targetVal;
      for(let i=start; i<=end; i++) state.push(createItem(i, targetVal, gameMode, i-start));
  } else {
      for(let i=0; i<(cols*rows); i++) state.push(createItem(Math.floor(Math.random()*(targetVal+1)), targetVal, gameMode, i));
  }
  renderPages();
}
function createItem(visible, targetVal, mode, index) {
    let actualMode = mode;
    if (mode === 'mix') {
        const types = ['find_hidden', 'construct', 'color'];
        actualMode = types[index % 3];
    }
    return { visible, hidden: targetVal - visible, target: targetVal, mode: actualMode, colorSide: Math.random() > 0.5 ? 'left' : 'right' };
}
function renderPages() {
  const main = document.getElementById('mainArea');
  const isCorr = document.getElementById('showCorr').checked;
  const eqMode = document.getElementById('eqMode').value;
  const theme = document.getElementById('beadColor').value;
  main.innerHTML = ''; 
  const [cols, rows] = document.getElementById('gridSize').value.split('x').map(Number);
  const itemsPerPage = cols * rows;
  for (let i = 0; i < state.length; i += itemsPerPage) {
      const chunk = state.slice(i, i + itemsPerPage);
      const page = document.createElement('div'); page.className = 'page';
      const inner = document.createElement('div'); inner.className = 'page-inner';
      const grid = document.createElement('div'); grid.className = 'grid';
      grid.setAttribute('data-size', document.getElementById('gridSize').value);
      chunk.forEach(item => {
        const cell = document.createElement('div'); cell.className = 'cell';
        if (eqMode !== 'none') {
            const eqArea = document.createElement('div'); eqArea.className = 'eq-area';
            const eqAdd = document.createElement('div'); eqAdd.className = 'eq-line';
            eqAdd.innerText = isCorr ? `${item.visible} + ${item.hidden} = ${item.target}` : '___ + ___ = ___';
            eqArea.appendChild(eqAdd);
            if (eqMode === 'both') {
                const eqSub = document.createElement('div'); eqSub.className = 'eq-line';
                eqSub.innerText = isCorr ? `${item.target} - ${item.visible} = ${item.hidden}` : '___ - ___ = ___';
                eqArea.appendChild(eqSub);
            }
            cell.appendChild(eqArea);
        }
        const topPart = document.createElement('div'); topPart.className = 'part-boulier';
        // Appel de la fonction "parfaite" corrigée
        topPart.innerHTML = getDiagramSvg(item.visible, item.target, (item.mode === 'color'), theme);
        cell.appendChild(topPart);
        const diag = document.createElement('div'); diag.className = 'diagram-container';
        let valT = "", valL = "", valR = "";
        if (isCorr) { valT = item.target; valL = item.visible; valR = item.hidden; }
        else {
            if (item.mode === 'find_hidden') { valT = item.target; valL = item.visible; valR = ""; }
            else if (item.mode === 'color') { valT = item.target; if (item.colorSide === 'left') valL = item.visible; else valR = item.hidden; }
            else { valT = ""; valL = ""; valR = ""; }
        }
        diag.innerHTML = `<div class="row-top">${valT}</div><div class="row-bottom"><div class="part-box part-left">${valL}</div><div class="part-box part-right"><span class="val-inner">${valR}</span></div></div>`;
        cell.appendChild(diag); grid.appendChild(cell);
      });
      inner.appendChild(grid); page.appendChild(inner); main.appendChild(page);
  }
}

function getDiagramSvg(vis, target, isColoringMode, theme) {
  // CONFIG VISUELLE : 21 COLONNES, FORMAT PAYSAGE, MONTANTS MARRONS
  const totalW = 300; 
  const frameW = 8;
  const midPt = totalW / 2;
  const innerW = totalW - (2 * frameW);
  const diameter = innerW / 21; 
  const r = (diameter / 2) - 0.1; 
  const dT = diameter; 

  let H, rows, spY, stY;

  if (target === 100) {
      rows = 10; spY = 15; stY = 15; H = 165;  
  } else if (target === 20) {
      rows = 2; spY = 18; stY = 16; H = 55;
  } else {
      rows = 1; spY = 0; stY = 17.5; H = 35; 
  }

  let svg = `<svg class="rr-svg" viewBox="0 0 ${totalW} ${H}">`;
  
  const brownColor = "#A07846";
  svg += `<rect x="0" y="0" width="${frameW}" height="${H}" fill="${brownColor}" />`;
  svg += `<rect x="${totalW - frameW}" y="0" width="${frameW}" height="${H}" fill="${brownColor}" />`;

  for(let row = 0; row < rows; row++) {
      let y = stY + (row * spY);
      svg += `<line x1="${frameW}" y1="${y}" x2="${totalW - frameW}" y2="${y}" stroke="#9ca3af" stroke-width="1.2" />`;
      
      let startX = frameW + r; 

      if (isColoringMode) {
          // Si Cible = 10 : Fil vide (on ne dessine RIEN).
          // Sinon (20, 100) : On dessine les billes grises.
          if (target !== 10) {
              for(let i=0; i<10; i++) {
                  let fill = (i < 5) ? '#ccc' : '#fff'; 
                  if (target === 100 && row >= 5) fill = (i < 5) ? '#fff' : '#ccc';
                  svg += `<circle cx="${startX + i*dT}" cy="${y}" r="${r}" fill="${fill}" stroke="#333" stroke-width="0.8" />`;
              }
          }
      } else {
          let visOnRow = row < Math.floor(vis/10) ? 10 : (row === Math.floor(vis/10) ? vis%10 : 0);
          for(let i=0; i<visOnRow; i++) {
              let isF5 = (i < 5), inv = (target === 100 && row >= 5);
              let fill = inv ? (isF5 ? (theme === 'blue' ? '#2563eb' : '#ffffff') : '#dc2626') : (isF5 ? '#dc2626' : (theme === 'blue' ? '#2563eb' : '#ffffff'));
              svg += `<circle cx="${startX + i*dT}" cy="${y}" r="${r}" fill="${fill}" stroke="${(fill==='#fff'||fill==='#ffffff')?'#333':'none'}" stroke-width="0.8" />`;
          }
      }
  }
  
  // CORRECTIF ICI : On affiche le rideau SI (billes cachées) OU (mode coloriage actif)
  if (vis < target || isColoringMode) {
      svg += `<rect x="${midPt}" y="0" width="${totalW - frameW - midPt}" height="${H}" fill="#000" />`;
  }
  return svg + `</svg>`;
}
window.onload = () => { startGen(); updateUI(); };
</script>
</body>
</html>
