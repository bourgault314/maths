<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>Rekenrek Cache-Cache - Rideau Millim√©tr√©</title>
<style>
  :root {
    --bg: #1a1a1a; --wood: #b08d57; --rod: #888; --ui: #2a2a2a;
    --accent: #0f6cf9; --success: #4caf50; --error: #f44336;
    --bead-white: #ffffff;
  }

  /* Mode Bleu */
  body.blue-mode { --bead-white: #2196f3; }

  body, html { 
    margin: 0; padding: 0; width: 100%; height: 100%; 
    background: var(--bg); color: white; font-family: sans-serif;
    overflow: hidden; touch-action: none;
  }

  .toolbar {
    position: relative; width: 100%; min-height: 65px;
    background: var(--ui); display: flex; align-items: center; 
    justify-content: space-between; padding: 0 20px; box-sizing: border-box;
    box-shadow: 0 4px 10px rgba(0,0,0,0.5); z-index: 1000;
  }
  
  .toolbar-group { display: flex; align-items: center; gap: 15px; }

  .score-board { display: flex; gap: 20px; font-weight: bold; font-size: 24px; }
  .score-good { color: var(--success); }
  .score-bad { color: var(--error); }

  #main-container {
    position: relative; width: 100%; height: calc(100vh - 65px);
    display: flex; flex-direction: column; align-items: center;
    justify-content: center; overflow: hidden;
  }

  #scaler { display: flex; flex-direction: column; align-items: center; transform-origin: center center; }

  #game-layout { display: flex; align-items: center; justify-content: center; gap: 40px; }

  #abacus-frame {
    position: relative; width: 820px;
    border-left: 30px solid var(--wood); border-right: 30px solid var(--wood);
    box-sizing: content-box; background: transparent;
  }

  #abacus-frame::before, #abacus-frame::after {
    content: ""; position: absolute; top: 0; bottom: 0; width: 30px;
    background: var(--wood); z-index: 20; pointer-events: none;
  }
  #abacus-frame::before { left: -30px; }
  #abacus-frame::after { right: -30px; }

  #curtain {
    position: absolute; right: -30px; top: 0; bottom: 0;
    background: #050505; border-left: 5px solid #333;
    z-index: 100; width: 0;
    display: flex; align-items: center; justify-content: center;
    pointer-events: none;
  }

  .row { position: relative; height: 56px; width: 100%; }
  .rod { position: absolute; width: 100%; height: 4px; background: var(--rod); top: 50%; transform: translateY(-50%); z-index: 1; }
  
  .bead {
    position: absolute; width: 38px; height: 38px; border-radius: 50%;
    top: 50%; transform: translateY(-50%); z-index: 5;
    box-shadow: inset -3px -3px 6px rgba(0,0,0,0.4), 2px 2px 5px rgba(0,0,0,0.5);
  }
  .bead.red { background: radial-gradient(circle at 30% 30%, #ff5f5f, #a00); }
  .bead.white { background: radial-gradient(circle at 30% 30%, var(--bead-white), #bbb); }
  
  /* Ajustement bille blanche en mode bleu */
  body.blue-mode .bead.white { background: radial-gradient(circle at 30% 30%, var(--bead-white), #0d47a1); }

  #feedback { height: 80px; font-size: 48px; font-weight: bold; margin: 10px 0; display: flex; align-items: center; justify-content: center; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }

  .control-panel { display: flex; flex-direction: column; align-items: center; gap: 20px; }

  .keypad { display: grid; gap: 12px; width: 720px; justify-content: center; margin-top: 10px; }
  .grid-10 { grid-template-columns: repeat(6, 1fr); }
  .grid-20 { grid-template-columns: repeat(7, 1fr); }

  .key {
    background: #444; border: none; color: white; height: 80px; min-width: 80px;
    border-radius: 12px; font-size: 32px; font-weight: bold; cursor: pointer;
    box-shadow: 0 5px 0 #222;
  }
  .key:active { transform: translateY(3px); box-shadow: 0 2px 0 #222; }
  .key.correct { background: var(--success) !important; box-shadow: 0 5px 0 #2e7d32; }
  .key.wrong { background: var(--error) !important; box-shadow: 0 5px 0 #c62828; }

  #input-zone { display: none; flex-direction: column; align-items: center; gap: 20px; }
  #input-val {
    width: 200px; height: 120px; font-size: 72px; font-weight: bold;
    text-align: center; border-radius: 20px; border: 6px solid #444;
    background: #000; color: var(--accent); outline: none;
  }
  .btn-check {
    background: var(--accent); color: white; border: none; padding: 20px 40px;
    border-radius: 15px; font-size: 30px; font-weight: bold; cursor: pointer;
    width: 100%; box-shadow: 0 5px 0 #0a4eb3;
  }

  .btn-main {
    background: var(--accent); color: white; border: none; padding: 25px 60px;
    border-radius: 70px; font-size: 34px; font-weight: bold; cursor: pointer;
    box-shadow: 0 8px 0 #0a4eb3; min-width: 320px;
  }
  .btn-main:active { transform: translateY(4px); box-shadow: 0 2px 0 #0a4eb3; }
  .btn-success { background: var(--success) !important; box-shadow: 0 8px 0 #2e7d32 !important; }

  select, .btn-small {
    background: #444; color: white; border: none; padding: 12px;
    border-radius: 8px; font-weight: bold; font-size: 18px; cursor: pointer;
  }
</style>
</head>
<body>

<div class="toolbar">
  <div class="toolbar-group">
    <select id="mode-select" onchange="updateMode()">
      <option value="10">Cache-Cache 10</option>
      <option value="20" selected>Cache-Cache 20</option>
      <option value="100">Cache-Cache 100</option>
    </select>
    <button class="btn-small" onclick="toggleColorMode()">üîµ Bleu</button>
  </div>
  <div style="font-weight: bold; font-size: 28px; color: white;">REKENREK CACHE-CACHE</div>
  <div class="score-board">
    <span class="score-good">‚úÖ <span id="count-good">0</span></span>
    <span class="score-bad">‚ùå <span id="count-bad">0</span></span>
  </div>
</div>

<div id="main-container">
  <div id="scaler">
    <div id="game-layout">
      <div id="abacus-frame">
        <div id="curtain"></div>
      </div>
      <div class="control-panel">
        <button class="btn-main" id="btn-action" onclick="handleMainButton()">Commencer</button>
        <div id="input-zone">
          <input type="number" id="input-val" placeholder="?" min="0" max="100" inputmode="numeric">
          <button class="btn-check" onclick="submitInput()">V√©rifier</button>
        </div>
      </div>
    </div>
    <div id="feedback"></div>
    <div id="keypad" class="keypad"></div>
  </div>
</div>

<script>
  let currentRange = 20, targetNumber = -1, lastNumber = -1, goodScore = 0, badScore = 0;
  let gameState = "IDLE"; 
  let isBlue = false;
  
  const frame = document.getElementById('abacus-frame');
  const curtain = document.getElementById('curtain');
  const keypad = document.getElementById('keypad');
  const inputZone = document.getElementById('input-zone');
  const actionBtn = document.getElementById('btn-action');
  const feedback = document.getElementById('feedback');
  
  const BEAD_W = 38;

  function toggleColorMode() { 
      isBlue = !isBlue; 
      document.body.classList.toggle('blue-mode');
      document.querySelector('.btn-small[onclick="toggleColorMode()"]').textContent = isBlue ? "‚ö™ Blanc" : "üîµ Bleu";
  }

  function updateMode() {
    currentRange = parseInt(document.getElementById('mode-select').value);
    resetGame();
  }

  function resetGame() {
    gameState = "IDLE";
    targetNumber = -1;
    lastNumber = -1;
    feedback.innerText = "";
    actionBtn.innerText = "Commencer";
    actionBtn.classList.remove('btn-success');
    curtain.style.transition = "none";
    curtain.style.width = "0px";
    buildUI();
    autoScale();
  }

  function buildUI() {
    const rowCount = currentRange === 10 ? 1 : (currentRange === 20 ? 2 : 10);
    const layout = document.getElementById('game-layout');
    frame.querySelectorAll('.row').forEach(r => r.remove());

    if (currentRange === 100) {
      layout.style.flexDirection = "row";
      inputZone.style.display = 'flex'; keypad.style.display = 'none';
    } else {
      layout.style.flexDirection = "column";
      inputZone.style.display = 'none'; keypad.style.display = 'grid';
    }

    for (let r = 0; r < rowCount; r++) {
      const row = document.createElement('div'); row.className = 'row';
      row.innerHTML = '<div class="rod"></div>';
      for (let b = 0; b < 10; b++) {
        const bead = document.createElement('div');
        const isRed = (r < 5) ? (b < 5) : (b >= 5);
        bead.className = `bead ${isRed ? 'red' : 'white'}`;
        // Position initiale tout √† droite (masqu√©)
        bead.style.left = (820 - (10 - b) * BEAD_W) + "px"; 
        row.appendChild(bead);
      }
      frame.appendChild(row);
    }

    if (currentRange <= 20) {
      keypad.innerHTML = '';
      keypad.className = `keypad ${currentRange === 10 ? 'grid-10' : 'grid-20'}`;
      for (let i = 0; i <= currentRange; i++) {
        const btn = document.createElement('button');
        btn.className = 'key'; btn.innerText = i;
        btn.onclick = () => checkAnswer(i, btn);
        keypad.appendChild(btn);
      }
    }
  }

  function handleMainButton() {
    if (gameState === "IDLE" || gameState === "WON") {
      startNewTurn();
    }
  }

  function startNewTurn() {
    gameState = "WAITING";
    feedback.innerText = "";
    actionBtn.innerText = "Combien sont cach√©es ?";
    actionBtn.classList.remove('btn-success');
    document.querySelectorAll('.key').forEach(k => k.classList.remove('correct', 'wrong'));
    document.getElementById('input-val').value = '';

    let newTarget;
    do {
      newTarget = Math.floor(Math.random() * (currentRange + 1));
    } while (newTarget === lastNumber);
    lastNumber = newTarget;
    targetNumber = newTarget;
    
    let visibleNumber = currentRange - targetNumber;
    
    const rows = frame.querySelectorAll('.row');
    let remainingVisible = visibleNumber;

    rows.forEach((row) => {
      const beads = row.querySelectorAll('.bead');
      const activeInRow = Math.min(10, remainingVisible);
      remainingVisible -= activeInRow;
      beads.forEach((b, bIdx) => {
        if (bIdx < activeInRow) b.style.left = (bIdx * BEAD_W) + "px";
        else b.style.left = (820 - (10 - bIdx) * BEAD_W) + "px";
      });
    });

    curtain.style.transition = "width 0.2s ease-in";
    curtain.style.width = "420px";
  }

  function checkAnswer(val, element) {
    if (gameState !== "WAITING") return;

    if (val === targetNumber) {
      gameState = "WON";
      goodScore++;
      document.getElementById('count-good').innerText = goodScore;
      feedback.innerHTML = "<span style='color:var(--success)'>Bonne r√©ponse ! ‚úÖ</span>";
      if (element) element.classList.add('correct');
      curtain.style.transition = "width 0.5s ease-out";
      curtain.style.width = "0px";
      actionBtn.innerText = "Suivant ‚ûî";
      actionBtn.classList.add('btn-success');
    } else {
      badScore++;
      document.getElementById('count-bad').innerText = badScore;
      feedback.innerHTML = "<span style='color:var(--error)'>Essaie encore ! ‚ùå</span>";
      if (element) {
        element.classList.add('wrong');
        setTimeout(() => element.classList.remove('wrong'), 800);
      }
    }
  }

  function submitInput() {
    const valInput = document.getElementById('input-val');
    const val = parseInt(valInput.value);
    if (!isNaN(val)) checkAnswer(val, null);
  }

  document.getElementById('input-val').addEventListener('keypress', (e) => { if (e.key === 'Enter') submitInput(); });

  function autoScale() {
    const availableW = window.innerWidth - 40;
    const availableH = window.innerHeight - 80;
    const contentW = currentRange === 100 ? 1250 : 920;
    const contentH = currentRange === 100 ? 750 : 650;
    const scale = Math.min(1.25, availableW / contentW, availableH / contentH);
    document.getElementById('scaler').style.transform = `scale(${scale})`;
  }

  window.addEventListener('resize', autoScale);
  updateMode();
</script>
</body>
</html>
