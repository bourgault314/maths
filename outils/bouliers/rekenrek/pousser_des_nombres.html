<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>Rekenrek Constructeur - Version Pro</title>
<style>
  :root {
    --bg: #1a1a1a; --wood: #b08d57; --rod: #888; --ui: #2a2a2a;
    --accent: #0f6cf9; --success: #4caf50; --error: #f44336;
    --neutral: #444;
    --bead-main: #ff5f5f; --bead-main-dark: #a00;
    --bead-sec: #ffffff; --bead-sec-dark: #bbb;
  }

  body.theme-blue {
    --bead-sec: #3498db; --bead-sec-dark: #2980b9;
  }

  body, html { 
    margin: 0; padding: 0; width: 100%; height: 100%; 
    background: var(--bg); color: white; font-family: sans-serif;
    overflow: hidden; touch-action: none;
  }

  .toolbar {
    position: relative; width: 100%; min-height: 65px;
    background: var(--ui); display: flex; align-items: center; 
    justify-content: space-between; padding: 0 20px; box-sizing: border-box;
    box-shadow: 0 4px 10px rgba(0,0,0,0.5); z-index: 1000;
  }
  
  .toolbar-group { display: flex; gap: 10px; align-items: center; }

  .score-board { display: flex; gap: 20px; font-weight: bold; font-size: 24px; }
  .score-good { color: var(--success); }
  .score-bad { color: var(--error); }

  #main-container {
    position: relative; width: 100%; height: calc(100vh - 65px);
    display: flex; flex-direction: column; align-items: center;
    justify-content: center; overflow: hidden;
  }

  #scaler { display: flex; flex-direction: column; align-items: center; transform-origin: center center; }
  #game-layout { display: flex; align-items: center; justify-content: center; gap: 40px; }
  .control-panel { display: flex; flex-direction: column; align-items: center; gap: 20px; }

  #target-display {
    font-size: 60px; font-weight: bold; color: var(--accent);
    text-shadow: 0 4px 10px black;
    background: rgba(255,255,255,0.05); padding: 10px 40px; border-radius: 20px;
    min-width: 150px; text-align: center;
  }
  
  #target-display.text-mode { font-size: 30px; min-width: 350px; }

  #abacus-frame {
    position: relative; width: 820px;
    border-left: 30px solid var(--wood); border-right: 30px solid var(--wood);
    box-sizing: content-box; background: transparent;
  }

  #abacus-frame::before, #abacus-frame::after {
    content: ""; position: absolute; top: 0; bottom: 0; width: 30px;
    background: var(--wood); z-index: 20; pointer-events: none;
  }
  #abacus-frame::before { left: -30px; }
  #abacus-frame::after { right: -30px; }

  .row { position: relative; height: 56px; width: 100%; }
  .rod { position: absolute; width: 100%; height: 4px; background: var(--rod); top: 50%; transform: translateY(-50%); z-index: 1; }
  
  .bead {
    position: absolute; width: 38px; height: 38px; border-radius: 50%;
    top: 50%; transform: translateY(-50%); z-index: 5;
    box-shadow: inset -3px -3px 6px rgba(0,0,0,0.4), 2px 2px 5px rgba(0,0,0,0.5);
    cursor: grab;
  }
  
  .bead.color-main { background: radial-gradient(circle at 30% 30%, var(--bead-main), var(--bead-main-dark)); }
  .bead.color-sec { background: radial-gradient(circle at 30% 30%, var(--bead-sec), var(--bead-sec-dark)); }

  #feedback { height: 80px; font-size: 48px; font-weight: bold; margin: 10px 0; display: flex; align-items: center; justify-content: center; }

  .btn-main {
    background: var(--accent); color: white; border: none; padding: 20px 40px;
    border-radius: 70px; font-size: 28px; font-weight: bold; cursor: pointer;
    box-shadow: 0 6px 0 #0a4eb3; min-width: 250px; transition: background 0.2s;
  }
  .btn-main:active { transform: translateY(4px); box-shadow: 0 2px 0 #0a4eb3; }
  .btn-success { background: var(--success) !important; box-shadow: 0 6px 0 #2e7d32 !important; }

  select, .btn-small {
    background: #444; color: white; border: none; padding: 10px;
    border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer;
  }
  
  #btn-lang { background: #333; border: 1px solid #555; min-width: 50px; text-transform: uppercase; font-size: 13px; letter-spacing: 0.5px; }

  .btn-listen {
    background: #666; font-size: 20px; padding: 10px 20px; border-radius: 50px;
    color: white; border: none; cursor: pointer; margin-bottom: 10px;
  }
</style>
</head>
<body>

<div class="toolbar">
  <div class="toolbar-group">
    <button class="btn-small" id="btn-lang" onclick="toggleLang()">ENG</button>

    <select id="mode-select" onchange="updateMode()">
      <option value="10" selected>Mode 0-10</option>
      <option value="20">Mode 0-20</option>
      <option value="100">Mode 0-100</option>
    </select>
    
    <select id="display-mode" onchange="newChallenge()">
      <option value="digits">Chiffres</option>
      <option value="letters">Lettres</option>
      <option value="voice">Vocal (Oral)</option>
    </select>

    <button class="btn-small" id="btn-theme" onclick="toggleTheme()">üé® Blanc / Bleu</button>
  </div>
  
  <div id="app-title" style="font-weight: bold; font-size: 18px; color: #aaa;">REKENREK CONSTRUCTEUR</div>
  
  <div class="score-board">
    <span class="score-good">‚úÖ <span id="count-good">0</span></span>
    <span class="score-bad">‚ùå <span id="count-bad">0</span></span>
  </div>
</div>

<div id="main-container">
  <div id="scaler">
    <div id="game-layout">
      <div id="abacus-frame"></div>
      <div class="control-panel">
        <button id="btn-listen" class="btn-listen" style="display:none;" onclick="repeatVoice()">üîä √âcouter</button>
        <div id="target-display">?</div>
        <button class="btn-main" id="btn-action" onclick="handleAction()">Commencer</button>
      </div>
    </div>
    <div id="feedback"></div>
  </div>
</div>

<script>
  let currentRange = 10, targetNumber = -1, goodScore = 0, badScore = 0;
  let states = []; 
  let currentScale = 1;
  let gameState = "IDLE";
  let isBlue = false;
  let deck = []; 
  let currentLang = 'fr'; 

  // --- AUDIO CONTEXT ---
  // On utilise l'API Web Audio pour g√©n√©rer des sons sans fichiers externes
  let audioCtx = null;

  function initAudio() {
    if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if (audioCtx.state === 'suspended') {
        audioCtx.resume();
    }
  }

  function playTone(freq, type, duration, delay=0) {
    if(!audioCtx) return;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    
    osc.type = type;
    osc.frequency.setValueAtTime(freq, audioCtx.currentTime + delay);
    
    // Enveloppe sonore pour √©viter le "clic"
    gain.gain.setValueAtTime(0.01, audioCtx.currentTime + delay);
    gain.gain.linearRampToValueAtTime(0.2, audioCtx.currentTime + delay + 0.05);
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + delay + duration);
    
    osc.start(audioCtx.currentTime + delay);
    osc.stop(audioCtx.currentTime + delay + duration);
  }

  function playSuccessSound() {
    initAudio();
    // Accord Majeur (Do - Mi - Sol) joyeux
    playTone(523.25, 'sine', 0.4, 0);    // C5
    playTone(659.25, 'sine', 0.4, 0.1);  // E5
    playTone(783.99, 'sine', 0.6, 0.2);  // G5
  }

  function playErrorSound() {
    initAudio();
    // Son grave type "Buzzer"
    playTone(150, 'sawtooth', 0.4, 0);
    playTone(130, 'sawtooth', 0.4, 0.1); // L√©g√®re descente
  }

  // --- TRADUCTIONS ---
  const i18n = {
    fr: {
      title: "REKENREK CONSTRUCTEUR",
      mode10: "Mode 0-10",
      mode20: "Mode 0-20",
      mode100: "Mode 0-100",
      dispDigits: "Chiffres",
      dispLetters: "Lettres",
      dispVoice: "Vocal (Oral)",
      themeBtn: "üé® Blanc / Bleu",
      startBtn: "Commencer",
      checkBtn: "V√©rifier",
      nextBtn: "Suivant ‚ûî",
      listenBtn: "üîä √âcouter",
      goodMsg: "Bravo ! Bonne r√©ponse. ‚úÖ",
      badMsg: "Essaie encore ! ‚ùå",
      langBtn: "ENG"
    },
    en: {
      title: "REKENREK BUILDER",
      mode10: "0-10 Mode",
      mode20: "0-20 Mode",
      mode100: "0-100 Mode",
      dispDigits: "Digits",
      dispLetters: "Words",
      dispVoice: "Voice (Oral)",
      themeBtn: "üé® White / Blue",
      startBtn: "Start",
      checkBtn: "Check",
      nextBtn: "Next ‚ûî",
      listenBtn: "üîä Listen",
      goodMsg: "Well done! Correct. ‚úÖ",
      badMsg: "Try again! ‚ùå",
      langBtn: "FR"
    }
  };

  const frame = document.getElementById('abacus-frame');
  const targetDiv = document.getElementById('target-display');
  const actionBtn = document.getElementById('btn-action');
  const feedback = document.getElementById('feedback');
  const listenBtn = document.getElementById('btn-listen');
  
  const BEAD_W = 38, GAP = 0, FRAME_W = 820;

  function toggleLang() {
    currentLang = (currentLang === 'fr') ? 'en' : 'fr';
    updateLanguageUI();
    if (gameState === "ACTIVE") {
        const mode = document.getElementById('display-mode').value;
        if (mode === 'letters') {
            targetDiv.innerText = numberToText(targetNumber);
        }
    }
  }

  function updateLanguageUI() {
    const t = i18n[currentLang];
    document.getElementById('btn-lang').innerText = t.langBtn;
    document.getElementById('app-title').innerText = t.title;
    document.getElementById('btn-theme').innerText = t.themeBtn;

    const modeSel = document.getElementById('mode-select');
    modeSel.options[0].text = t.mode10;
    modeSel.options[1].text = t.mode20;
    modeSel.options[2].text = t.mode100;

    const dispSel = document.getElementById('display-mode');
    dispSel.options[0].text = t.dispDigits;
    dispSel.options[1].text = t.dispLetters;
    dispSel.options[2].text = t.dispVoice;

    listenBtn.innerText = t.listenBtn;
    
    if (gameState === "IDLE") actionBtn.innerText = t.startBtn;
    else if (gameState === "ACTIVE") actionBtn.innerText = t.checkBtn;
    else if (gameState === "WON") actionBtn.innerText = t.nextBtn;

    if (feedback.innerHTML.includes("‚úÖ")) feedback.innerHTML = "<span style='color:var(--success)'>" + t.goodMsg + "</span>";
    if (feedback.innerHTML.includes("‚ùå")) feedback.innerHTML = "<span style='color:var(--error)'>" + t.badMsg + "</span>";
  }

  function toggleTheme() {
    document.body.classList.toggle('theme-blue');
  }

  function updateMode() {
    currentRange = parseInt(document.getElementById('mode-select').value);
    resetGame();
  }

  function buildDeck(max) {
    deck = [];
    for(let i = 0; i <= max; i++) {
        deck.push(i);
    }
    for (let i = deck.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [deck[i], deck[j]] = [deck[j], deck[i]];
    }
  }

  function drawCard(max) {
    if (deck.length === 0 || deck[0] > max) {
        buildDeck(max);
    }
    return deck.pop();
  }

  function resetGame() {
    gameState = "IDLE";
    targetNumber = -1;
    targetDiv.innerText = "?";
    targetDiv.classList.remove('text-mode');
    feedback.innerText = "";
    
    const t = i18n[currentLang];
    actionBtn.innerText = t.startBtn;
    
    actionBtn.classList.remove('btn-success');
    listenBtn.style.display = 'none';
    
    buildDeck(currentRange);

    const rowCount = currentRange === 10 ? 1 : (currentRange === 20 ? 2 : 10);
    const layout = document.getElementById('game-layout');
    layout.style.flexDirection = (currentRange === 100) ? "row" : "column";

    states = Array(rowCount).fill(0);
    frame.innerHTML = '';
    for (let r = 0; r < rowCount; r++) {
      const row = document.createElement('div');
      row.className = 'row'; row.dataset.row = r;
      row.innerHTML = '<div class="rod"></div>';
      for (let b = 0; b < 10; b++) {
        const bead = document.createElement('div');
        const isMainSide = (r < 5) ? (b < 5) : (b >= 5);
        bead.className = `bead ${isMainSide ? 'color-main' : 'color-sec'}`;
        bead.dataset.idx = b;
        bead.onpointerdown = startDrag;
        row.appendChild(bead);
      }
      frame.appendChild(row);
    }
    updateBeads(false);
    autoScale();
  }

  function handleAction() {
    initAudio(); // Initialize audio on first user click
    if (gameState === "IDLE" || gameState === "WON") {
      newChallenge();
    } else if (gameState === "ACTIVE") {
      checkAnswer();
    }
  }

  function numberToText(n) {
    if (currentLang === 'fr') return numberToFrench(n);
    return numberToEnglish(n);
  }

  function numberToFrench(n) {
    if (n === 0) return "z√©ro";
    const units = ["", "un", "deux", "trois", "quatre", "cinq", "six", "sept", "huit", "neuf", "dix", "onze", "douze", "treize", "quatorze", "quinze", "seize"];
    const tens = ["", "dix", "vingt", "trente", "quarante", "cinquante", "soixante", "soixante-dix", "quatre-vingts", "quatre-vingt-dix"];
    
    if (n <= 16) return units[n];
    if (n < 20) return "dix-sept-dix-huit-dix-neuf".split("-")[n-17] ? "dix-" + units[n-10] : units[n];
    
    if (n < 70) {
      let t = Math.floor(n / 10), u = n % 10;
      if (u === 0) return tens[t];
      return tens[t] + (u === 1 ? "-et-un" : "-" + units[u]);
    }
    
    if (n < 80) { 
      let u = n - 60;
      if (u === 10) return "soixante-dix";
      if (u === 11) return "soixante-et-onze";
      return "soixante-" + (u <= 16 ? units[u] : "dix-" + units[u-10]);
    }
    
    if (n < 100) { 
      if (n === 80) return "quatre-vingts";
      let u = n - 80;
      let suffix = (u <= 16) ? units[u] : "dix-" + units[u-10];
      return "quatre-vingt-" + suffix;
    }
    
    if (n === 100) return "cent";
    return n;
  }

  function numberToEnglish(n) {
    if (n === 0) return "zero";
    const units = ["", "one", "two", "three", "four", "five", "six", "seven", "eight", "nine", "ten", "eleven", "twelve", "thirteen", "fourteen", "fifteen", "sixteen", "seventeen", "eighteen", "nineteen"];
    const tens = ["", "", "twenty", "thirty", "forty", "fifty", "sixty", "seventy", "eighty", "ninety"];
    
    if (n < 20) return units[n];
    
    if (n < 100) {
      let t = Math.floor(n / 10), u = n % 10;
      if (u === 0) return tens[t];
      return tens[t] + "-" + units[u];
    }
    
    if (n === 100) return "one hundred";
    return n;
  }

  function speak(text) {
    window.speechSynthesis.cancel();
    const msg = new SpeechSynthesisUtterance(text);
    msg.lang = (currentLang === 'fr') ? 'fr-FR' : 'en-US';
    window.speechSynthesis.speak(msg);
  }

  function repeatVoice() {
    if (targetNumber !== -1) speak(targetNumber.toString());
  }

  function newChallenge() {
    gameState = "ACTIVE";
    targetNumber = drawCard(currentRange);

    const mode = document.getElementById('display-mode').value;
    const t = i18n[currentLang];
    
    targetDiv.classList.remove('text-mode');
    listenBtn.style.display = 'none';

    if (mode === 'digits') {
      targetDiv.innerText = targetNumber;
    } else if (mode === 'letters') {
      targetDiv.innerText = numberToText(targetNumber);
      targetDiv.classList.add('text-mode');
    } else if (mode === 'voice') {
      targetDiv.innerText = "?";
      listenBtn.style.display = 'block';
      speak(targetNumber.toString());
    }

    feedback.innerText = "";
    actionBtn.innerText = t.checkBtn;
    actionBtn.classList.remove('btn-success');
    states.fill(0);
    updateBeads(true);
  }

  let activeDrag = null;

  function startDrag(e) {
    initAudio(); // Init audio aussi au drag pour √™tre s√ªr
    if (gameState === "WON") return;
    const bead = e.target;
    bead.setPointerCapture(e.pointerId);
    activeDrag = { 
      rowIdx: parseInt(bead.parentElement.dataset.row), 
      beadIdx: parseInt(bead.dataset.idx), 
      rowEl: bead.parentElement, 
      startX: e.clientX 
    };
  }

  window.addEventListener('pointermove', (e) => {
    if (!activeDrag) return;
    const { rowIdx, beadIdx, rowEl, startX } = activeDrag;
    const dx = (e.clientX - startX) / currentScale;
    const beads = rowEl.querySelectorAll('.bead');
    if (beadIdx >= states[rowIdx]) { 
      for (let i = states[rowIdx]; i <= beadIdx; i++) moveVisual(beads[i], i, dx, true);
    } else {
      for (let i = beadIdx; i < states[rowIdx]; i++) moveVisual(beads[i], i, dx, false);
    }
  });

  function moveVisual(b, idx, dx, fromRight) {
    let base = fromRight ? (FRAME_W - (10 - idx) * (BEAD_W + GAP)) : (idx * (BEAD_W + GAP));
    b.style.transition = 'none';
    b.style.left = Math.max(idx * (BEAD_W + GAP), Math.min(FRAME_W - (10 - idx) * (BEAD_W + GAP), base + dx)) + "px";
  }

  window.addEventListener('pointerup', () => {
    if (!activeDrag) return;
    const { rowIdx, beadIdx, rowEl } = activeDrag;
    const beads = rowEl.querySelectorAll('.bead');
    const currentPos = parseFloat(beads[beadIdx].style.left);
    
    const targetLeft = beadIdx * (BEAD_W + GAP);
    const targetRight = FRAME_W - (10 - beadIdx) * (BEAD_W + GAP);
    const snapMargin = BEAD_W * 1; 

    if (beadIdx >= states[rowIdx]) { 
      if (currentPos <= targetLeft + snapMargin) states[rowIdx] = beadIdx + 1; 
    } else { 
      if (currentPos >= targetRight - snapMargin) states[rowIdx] = beadIdx; 
    }
    
    activeDrag = null;
    updateBeads(true);
  });

  function updateBeads(animate) {
    document.querySelectorAll('.row').forEach((row, r) => {
      row.querySelectorAll('.bead').forEach((b, i) => {
        b.style.transition = animate ? 'left 0.2s ease-out' : 'none';
        b.style.left = (i < states[r]) ? (i * (BEAD_W + GAP)) + "px" : (FRAME_W - (10 - i) * (BEAD_W + GAP)) + "px";
      });
    });
  }

  function checkAnswer() {
    const currentTotal = states.reduce((a, b) => a + b, 0);
    const t = i18n[currentLang];

    if (currentTotal === targetNumber) {
      playSuccessSound(); // JOUE LE SON GAGNANT
      gameState = "WON";
      goodScore++;
      document.getElementById('count-good').innerText = goodScore;
      feedback.innerHTML = "<span style='color:var(--success)'>" + t.goodMsg + "</span>";
      actionBtn.innerText = t.nextBtn;
      actionBtn.classList.add('btn-success');
      if(document.getElementById('display-mode').value === 'voice') targetDiv.innerText = targetNumber;
    } else {
      playErrorSound(); // JOUE LE SON ERREUR
      badScore++;
      document.getElementById('count-bad').innerText = badScore;
      feedback.innerHTML = "<span style='color:var(--error)'>" + t.badMsg + "</span>";
    }
  }

  function autoScale() {
    const availableW = window.innerWidth - 40;
    const availableH = window.innerHeight - 80;
    const contentW = currentRange === 100 ? 1250 : 920;
    const contentH = currentRange === 100 ? 750 : 650;
    currentScale = Math.min(1.15, availableW / contentW, availableH / contentH);
    document.getElementById('scaler').style.transform = `scale(${currentScale})`;
  }

  window.addEventListener('resize', autoScale);
  buildDeck(currentRange);
  updateMode();
  updateLanguageUI();
</script>
</body>
</html>
