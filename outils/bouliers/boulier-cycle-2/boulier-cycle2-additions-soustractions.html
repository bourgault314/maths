<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Boulier 5+5 + Exerciseur “Opérations” (réponse claire + overlay)</title>
<style>
  :root{
    --rows: 10;
    --beads-per-row: 10;
    --bead-size: 20px;
    --bead-gap: 4px;
    --frame-thickness: 12px;
    --rod-thickness: 4px;

    --color-group-a: #d7263d;
    --color-group-b: #f8f8f8;
    --color-bead-shadow: rgba(0,0,0,.25);
    --color-wood: #e2c48a;
    --color-wood-dark: #a88348;

    --bg: #fffdf8;
    --text: #1b1b1b;
    --ui: #f3f1ea;
    --accent: #0f6cf9;
    --ok: #0f9d58;
    --err: #d93025;
  }

  html,body{height:100%;background:var(--bg);color:var(--text);margin:0;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .app{max-width:920px;margin:10px auto;padding:0 10px}

  .topbar{
    display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:space-between;margin:6px 0 10px
  }
  .btn{
    border:none;background:var(--accent);color:#fff;font-weight:700;
    padding:8px 10px;border-radius:10px;cursor:pointer;
    box-shadow:0 5px 12px rgba(15,108,249,.18);font-size:.92rem
  }
  .btn:active{transform:translateY(1px)}
  .btn.secondary{background:#6b7280}

  /* Bloc exerciseur */
  .exercise{
    display:flex;flex-wrap:wrap;gap:8px;align-items:center;
    background:var(--ui); padding:8px 10px; border-radius:12px; margin-bottom:8px
  }
  .exercise .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:space-between;width:100%}
  .select, .radio-group{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  select{padding:6px 8px;border-radius:8px;border:1px solid #d0d0d0;background:#fff}
  .ops{
    width:100%;background:#fff;border:1px solid #e0e0e0;border-radius:10px;
    padding:6px 8px;font-weight:800;margin-top:4px
  }
  .feedback{min-height:1.3em; font-weight:700}
  .feedback.ok{ color:var(--ok) }
  .feedback.err{ color:var(--err) }

  .score{
    margin-left:auto; display:flex; gap:12px; align-items:center; font-weight:800
  }
  .score .good{ color:var(--ok) }
  .score .bad{ color:var(--err) }

  .answer{display:flex;gap:8px;align-items:center}
  .answer input[type="number"]{
    width:84px;padding:6px 8px;border:1px solid #d0d0d0;border-radius:8px;font-weight:800;text-align:right;background:#fff;
    -moz-appearance: textfield;
    appearance: textfield;
  }
  .answer input[type="number"]::-webkit-outer-spin-button,
  .answer input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance: none; margin: 0; }

  /* Boulier */
  .abacus{
    position:relative;aspect-ratio: 10 / 6.2;width:100%;
    background:linear-gradient(180deg,var(--color-wood) 0%, #efd79d 55%, var(--color-wood) 100%);
    border-radius:12px;box-shadow:0 8px 22px rgba(0,0,0,.11);
    padding: calc(var(--frame-thickness) + 5px) calc(var(--frame-thickness) + 6px);
  }
  .abacus::before, .abacus::after{
    content:"";position:absolute;left:0;right:0;height:var(--frame-thickness);
    background:linear-gradient(#caa367,#9a733c)
  }
  .abacus::before{top:0;border-bottom:2px solid var(--color-wood-dark);border-radius:12px 12px 0 0}
  .abacus::after{bottom:0;border-top:2px solid var(--color-wood-dark);border-radius:0 0 12px 12px}

  .row-line{position:relative;height: calc(100% / var(--rows));}
  .rod{
    position:absolute;left:0;right:0;top:50%;height:var(--rod-thickness);transform:translateY(-50%);
    background:linear-gradient(180deg,#c19a66,#916c3d);border-radius:4px;box-shadow:inset 0 1px 0 rgba(255,255,255,.45), 0 1px 2px rgba(0,0,0,.2);
  }

  .bead{
    position:absolute;top:50%;transform:translate(-50%,-50%);
    width:var(--bead-size);height:var(--bead-size);border-radius:50%;
    box-shadow: 0 2px 5px var(--color-bead-shadow), inset 0 2px 5px rgba(255,255,255,.55);
    border:1px solid rgba(0,0,0,.12);cursor:pointer; user-select:none;
    transition:left .18s cubic-bezier(.2,.65,.35,1), transform .06s ease;
  }
  .bead:active{transform:translate(-50%,-50%) scale(.98)}
  .groupA{ background: radial-gradient(circle at 35% 30%, #ef6a79, var(--color-group-a)); }
  .groupB{ background: radial-gradient(circle at 35% 30%, #ffffff, var(--color-group-b)); }

  /* Overlay géant */
  .overlay{
    position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
    font-size:8rem;font-weight:900;color:white;text-shadow:0 0 30px rgba(0,0,0,.7);
    pointer-events:none;opacity:0;transition:opacity .2s ease;
  }
  .overlay.show{opacity:1;}
  .overlay.ok{color:var(--ok);}
  .overlay.err{color:var(--err);}
</style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn" id="newOps">Nouvelles opérations</button>
        <button class="btn secondary" id="reset">Remise à zéro</button>
      </div>
      <div class="score" id="score">
        <span class="good">✅ : <span id="goodCount">0</span></span>
        <span class="bad">❌ : <span id="badCount">0</span></span>
      </div>
    </div>

    <div class="exercise">
      <div class="row">
        <div class="select">
          <label for="count">Nb d’opérations :</label>
          <select id="count">
            <option>3</option><option selected>5</option><option>6</option><option>7</option><option>8</option>
          </select>
        </div>
        <div class="radio-group">
          <strong>Type :</strong>
          <label><input type="radio" name="mode" value="add" checked> Additions</label>
          <label><input type="radio" name="mode" value="mixed"> Mélange + / −</label>
        </div>
        <div class="answer">
          <label for="typed">Réponse :</label>
          <input id="typed" type="number" min="0" max="100" inputmode="numeric" placeholder="0–100" />
          <button class="btn" id="check">Vérifier</button>
        </div>
      </div>

      <div class="ops" id="ops">—</div>
      <div class="feedback" id="feedback"></div>
    </div>

    <div class="abacus" id="abacus" aria-label="Boulier 5+5"></div>
  </div>

  <div class="overlay" id="overlay"></div>

<script>
(function(){
  const rows = 10, N = 10;

  const abacus   = document.getElementById('abacus');
  const resetBtn = document.getElementById('reset');
  const checkBtn = document.getElementById('check');
  const newOpsBtn= document.getElementById('newOps');
  const countSel = document.getElementById('count');
  const modeRadios = [...document.querySelectorAll('input[name="mode"]')];
  const typedInput = document.getElementById('typed');
  const opsEl    = document.getElementById('ops');
  const feedback = document.getElementById('feedback');
  const goodEl   = document.getElementById('goodCount');
  const badEl    = document.getElementById('badCount');
  const overlay  = document.getElementById('overlay');

  const state = Array.from({length: rows}, () => 0);
  let goodCount = 0, badCount = 0;
  let advancing = false, scoredForSet = false;
  let target = 0, opsList = [];

  const rowEls = [];
  for(let r=0;r<rows;r++){
    const row = el('div','row-line');
    row.dataset.row=r;
    row.appendChild(el('div','rod'));
    const topHalf = r < rows/2;
    for(let j=1;j<=N;j++){
      const cls = topHalf ? (j<=5?'groupA':'groupB') : (j<=5?'groupB':'groupA');
      const bead = el('div','bead '+cls);
      bead.dataset.index = j;
      bead.addEventListener('click', () => onBeadClick(r, j));
      row.appendChild(bead);
    }
    abacus.appendChild(row);
    rowEls.push(row);
  }

  function onBeadClick(r, j){
    if(advancing) return;
    const c = state[r], leftCount = N - c;
    state[r] = (j <= leftCount) ? (N - j + 1) : (N - j);
    state[r] = clamp(state[r], 0, N);
    layoutRow(r);
  }
  function layoutRow(r){
    const row = rowEls[r], c = state[r];
    const size = 20, gap = 4, pad = 8;
    const leftStart  = pad + size/2, rightStart = row.clientWidth - pad - size/2;
    [...row.querySelectorAll('.bead')].forEach(b=>{
      const j = +b.dataset.index;
      b.style.left = (j <= N - c)
        ? leftStart  + (j-1)*(size+gap)+"px"
        : rightStart - (N-j)*(size+gap)+"px";
    });
  }
  function layoutAll(){ for(let r=0;r<rows;r++) layoutRow(r); }
  function currentTotal(){ return state.reduce((a,b)=>a+b,0); }
  function resetAbacus(){ state.fill(0); layoutAll(); }

  function updateScore(){ goodEl.textContent = goodCount; badEl.textContent = badCount; }
  function randomInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

  function generateOps(count, mode){
    let running = 0, list = [];
    for(let k=0;k<count;k++){
      let sign = +1;
      if(mode==='mixed'){
        if(running <= 10) sign=+1; else if(running>=90) sign=-1;
        else sign = Math.random()<0.5?+1:-1;
      }
      const pick = (sign>0)
        ? randomInt(1, Math.max(1, Math.min(20, 100-running)))
        : randomInt(1, Math.max(1, Math.min(20, running)));
      running += sign*pick; list.push(sign*pick);
    }
    return {list,result:running};
  }
  function formatOps(list){
    return list.map(v=> (v>=0?'+':'−')+Math.abs(v)).join('  ');
  }

  function newSet(){
    const count = +countSel.value;
    const mode = modeRadios.find(r=>r.checked).value;
    let gen;
    for(let tries=0;tries<50;tries++){ gen=generateOps(count,mode); if(gen.result!==0) break; }
    opsList=gen.list; target=gen.result;
    opsEl.textContent=formatOps(opsList);
    resetAbacus(); typedInput.value=''; feedback.textContent='';
    scoredForSet=false; advancing=false;
  }
  newOpsBtn.addEventListener('click', newSet);

  function showOverlay(ok){
    overlay.textContent = ok ? "✅" : "❌";
    overlay.className = "overlay show " + (ok?"ok":"err");
    setTimeout(()=> overlay.className="overlay", 800);
  }

  checkBtn.addEventListener('click', ()=>{
    if(advancing) return;
    if(!opsList.length){ feedback.textContent='Clique sur “Nouvelles opérations”.'; return; }
    if(!typedInput.value){ feedback.textContent='Écris ta réponse.'; return; }
    const valAbacus=currentTotal(), valTyped=+typedInput.value;
    const ok=(valAbacus===target)&&(valTyped===target)&&(valAbacus===valTyped);
    if(ok){
      if(!scoredForSet){goodCount++;updateScore();scoredForSet=true;}
      feedback.textContent='Oui, bonne réponse ✅'; feedback.className='feedback ok';
      showOverlay(true);
      advancing=true; setTimeout(newSet,900);
    }else{
      badCount++;updateScore();
      feedback.textContent='Non, mauvaise réponse ❌'; feedback.className='feedback err';
      showOverlay(false);
    }
  });

  resetBtn.addEventListener('click', ()=>{ resetAbacus(); feedback.textContent=''; });

  window.addEventListener('resize', ()=>layoutAll());
  function el(tag,cls){const e=document.createElement(tag);if(cls)e.className=cls;return e;}
  function clamp(x,a,b){return Math.max(a,Math.min(b,x));}

  layoutAll(); newSet();
})();
</script>
</body>
</html>
