<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>Boulier Rekenrek - Version Finale Gold</title>
<style>
  :root {
    --bg: #1a1a1a;
    --wood: #b08d57;
    --rod: #888;
    --ui: #2a2a2a;
    --accent: #0f6cf9;
    --bead-white: #ffffff;
    --bead-blue: #2196f3;
  }

  body, html { 
    margin: 0; padding: 0; width: 100%; height: 100%; 
    background: var(--bg); color: white; font-family: sans-serif;
    overflow: hidden; touch-action: none;
  }

  .toolbar {
    position: relative; width: 100%; min-height: 50px;
    background: var(--ui); display: flex; flex-wrap: wrap; align-items: center; 
    justify-content: center; gap: 15px; z-index: 1000; padding: 5px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.5);
  }

  .toolbar-group { display: flex; align-items: center; gap: 8px; }

  .btn {
    border: none; background: #444; color: white; padding: 6px 10px;
    border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 11px;
  }
  .btn.active { background: var(--accent); outline: 1px solid white; }

  #main-container {
    position: relative; width: 100%; height: calc(100vh - 60px);
    display: flex; flex-direction: column; align-items: center;
    justify-content: flex-start;
    overflow: hidden;
  }

  #scaler {
    margin-top: 5px;
    display: flex; flex-direction: column; align-items: center;
    transform-origin: top center;
    pointer-events: none;
  }

  #total-display { 
    font-size: 38px; font-weight: bold; color: var(--accent); 
    height: 45px; margin-bottom: 2px; text-shadow: 0 2px 4px black;
    display: flex; align-items: center;
  }

  #abacus-frame {
    position: relative; width: 820px; 
    border-left: 30px solid var(--wood); border-right: 30px solid var(--wood);
    pointer-events: auto; box-sizing: content-box;
  }

  .row { position: relative; height: 56px; width: 820px; pointer-events: auto; }
  .rod { position: absolute; width: 100%; height: 4px; background: var(--rod); top: 50%; transform: translateY(-50%); z-index: 1; }

  /* LE CACHE - DERNI√àRE CORRECTION */
  #cache-curtain {
    position: absolute; 
    right: -4px; /* <-- D√âCALAGE: On pousse le rideau de 4px √† droite pour que la bordure soit sur le bois */
    top: 0; bottom: 0; width: 0;
    background: #000; z-index: 20; 
    border-left: 4px solid #444; /* La fameuse bande grise */
    pointer-events: auto;
    display: none; cursor: ew-resize;
  }
  
  #cache-curtain::before { 
    content: "‚Üî"; position: absolute; 
    left: 2px; /* La poign√©e reste bien sur le bois */
    top: 50%; 
    background: #444; border-radius: 50%; width: 44px; height: 44px; 
    display: flex; align-items: center; justify-content: center; 
    font-weight: bold; font-size: 20px; color: white; transform: translateY(-50%);
    box-shadow: 2px 0 5px rgba(0,0,0,0.5);
  }

  .bead {
    position: absolute; width: 38px; height: 38px; border-radius: 50%;
    top: 50%; transform: translateY(-50%); z-index: 5;
    cursor: grab; touch-action: none;
    box-shadow: inset -3px -3px 6px rgba(0,0,0,0.4), 2px 2px 5px rgba(0,0,0,0.5);
  }
  .bead.red { background: radial-gradient(circle at 30% 30%, #ff5f5f, #a00); }
  .bead.white { background: radial-gradient(circle at 30% 30%, var(--bead-white), #bbb); }
  .bead.blue-mode.white { background: radial-gradient(circle at 30% 30%, var(--bead-blue), #0d47a1); }

  #draw-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 500; pointer-events: none; }
  #draw-layer.active { pointer-events: auto; cursor: crosshair; }
  
  .color-dot { width: 22px; height: 22px; border-radius: 50%; cursor: pointer; border: 2px solid #555; }
  .color-dot.active { border-color: white; transform: scale(1.1); }

  @media (orientation: landscape) and (max-height: 450px) {
    #total-display { font-size: 24px; height: 28px; }
    .row { height: 48px; }
    .toolbar { min-height: 40px; padding: 2px; }
    #scaler { margin-top: 2px; }
  }
</style>
</head>
<body>

<div class="toolbar" id="top-bar">
  <div class="toolbar-group">
    <input type="range" id="row-range" min="1" max="10" value="10" style="width:60px">
    <span id="row-val" style="font-weight:bold; font-size:14px; color:var(--accent)">10</span>
  </div>
  <div class="toolbar-group">
    <button class="btn" onclick="allTo(0)">0</button>
    <button class="btn" onclick="set50()">50</button>
    <button class="btn" onclick="allTo(10)">100</button>
  </div>
  <div class="toolbar-group">
    <button class="btn" id="btn-color" onclick="toggleColorMode()">üîµ Bleu</button>
    <button class="btn" id="btn-cache" onclick="toggleCache()">üåë Cache</button>
    <button class="btn" id="btn-val" onclick="toggleVal()">Valeur</button>
  </div>
  <div class="toolbar-group" style="gap:10px">
    <button class="btn" id="btn-pen" onclick="togglePen()">‚úèÔ∏è Stylo</button>
    <div class="color-dot active" style="background:#0f6cf9" onclick="setCol('#0f6cf9', this)"></div>
    <div class="color-dot" style="background:#ffeb3b" onclick="setCol('#ffeb3b', this)"></div>
    <div class="color-dot" style="background:#f44336" onclick="setCol('#f44336', this)"></div>
    <button class="btn btn-clear" onclick="clearDraw()">Effacer</button>
  </div>
</div>

<div id="main-container">
  <canvas id="draw-layer"></canvas>
  <div id="scaler">
    <div id="total-display"></div>
    <div id="abacus-frame">
      <div id="cache-curtain"></div>
    </div>
  </div>
</div>

<script>
  const frame = document.getElementById('abacus-frame');
  const canvas = document.getElementById('draw-layer');
  const scaler = document.getElementById('scaler');
  const ctx = canvas.getContext('2d');
  const totalDiv = document.getElementById('total-display');
  const cache = document.getElementById('cache-curtain');
  const topBar = document.getElementById('top-bar');
  
  let rowsCount = 10, showVal = false, isPen = false, isBlue = false, isCache = false, currentScale = 1;
  let penCol = '#0f6cf9', states = Array.from({length: 10}, () => 0); 

  const BEAD_W = 38, GAP = 2, FRAME_W = 820;

  function init() {
    const curW = cache.style.width;
    frame.innerHTML = '';
    frame.appendChild(cache);
    cache.onpointerdown = startCacheDrag;
    if (isCache) cache.style.width = curW || "0px";

    for (let r = 0; r < rowsCount; r++) {
      const row = document.createElement('div'); row.className = 'row'; row.dataset.row = r;
      row.innerHTML = `<div class="rod"></div>`;
      for (let b = 0; b < 10; b++) {
        const bead = document.createElement('div');
        const isRed = (r < 5) ? (b < 5) : (b >= 5);
        bead.className = `bead ${isRed ? 'red' : 'white'} ${isBlue ? 'blue-mode' : ''}`;
        bead.dataset.idx = b; bead.onpointerdown = startDrag;
        row.appendChild(bead);
      }
      frame.appendChild(row);
    }
    autoScale();
    updateBeads(false);
  }

  function autoScale() {
    const availableW = window.innerWidth - 20;
    const availableH = window.innerHeight - topBar.offsetHeight - 70; 

    const contentW = 880; 
    const isSmallLandscape = window.innerHeight < 450;
    const rH = isSmallLandscape ? 48 : 56;
    const contentH = (isSmallLandscape ? 28 : 50) + (rH * rowsCount);

    const sW = availableW / contentW;
    const sH = availableH / contentH;
    
    currentScale = Math.min(1, sW, sH) * 0.96;

    scaler.style.transform = `scale(${currentScale})`;
    resizeCanvas();
  }

  function startDrag(e) {
    if (isPen) return;
    const bead = e.target;
    bead.setPointerCapture(e.pointerId);
    activeDrag = { rowIdx: parseInt(bead.parentElement.dataset.row), beadIdx: parseInt(bead.dataset.idx), rowEl: bead.parentElement, startX: e.clientX };
  }

  window.addEventListener('pointermove', (e) => {
    if (!activeDrag) return;
    const { rowIdx, beadIdx, rowEl, startX } = activeDrag;
    const dx = (e.clientX - startX) / currentScale;
    const beads = rowEl.querySelectorAll('.bead');
    if (beadIdx >= states[rowIdx]) { 
      for (let i = states[rowIdx]; i <= beadIdx; i++) moveVisual(beads[i], i, dx, true);
    } else {
      for (let i = beadIdx; i < states[rowIdx]; i++) moveVisual(beads[i], i, dx, false);
    }
  });

  function moveVisual(b, idx, dx, fromRight) {
    let base = fromRight ? (FRAME_W - (10 - idx) * (BEAD_W + GAP)) : (idx * (BEAD_W + GAP));
    let pos = base + dx;
    b.style.transition = 'none';
    b.style.left = Math.max(idx * (BEAD_W + GAP), Math.min(FRAME_W - (10 - idx) * (BEAD_W + GAP), pos)) + "px";
  }

  window.addEventListener('pointerup', () => {
    if (!activeDrag) return;
    const { rowIdx, beadIdx, rowEl } = activeDrag;
    const currentPos = parseFloat(rowEl.querySelectorAll('.bead')[beadIdx].style.left);
    if (beadIdx >= states[rowIdx]) { if (currentPos < (FRAME_W/2) + (beadIdx*5)) states[rowIdx] = beadIdx + 1; }
    else { if (currentPos > (FRAME_W/2) - ((10-beadIdx)*5)) states[rowIdx] = beadIdx; }
    activeDrag = null; updateBeads(true);
  });

  function updateBeads(animate) {
    document.querySelectorAll('.row').forEach((row, r) => {
      row.querySelectorAll('.bead').forEach((b, i) => {
        b.style.transition = animate ? 'left 0.2s ease-out' : 'none';
        b.style.left = (i < states[r]) ? (i * (BEAD_W + GAP)) + "px" : (FRAME_W - (10 - i) * (BEAD_W + GAP)) + "px";
      });
    });
    totalDiv.innerText = showVal ? states.reduce((a, b) => a + b, 0) : "";
  }

  function toggleCache() { isCache = !isCache; cache.style.display = isCache ? 'block' : 'none'; document.getElementById('btn-cache').classList.toggle('active', isCache); }
  function startCacheDrag(e) { e.preventDefault(); cache.setPointerCapture(e.pointerId);
    cache.onpointermove = (ev) => { 
      const rect = frame.getBoundingClientRect(); 
      // Calcul corrig√© pour tenir compte du d√©calage de 4px
      const actualFrameW = FRAME_W * currentScale;
      // On ajoute 4px au calcul pour compenser le d√©calage √† droite
      const xOffset = (ev.clientX - rect.left) / currentScale + 4;
      cache.style.width = Math.max(0, Math.min(FRAME_W, FRAME_W - xOffset)) + "px"; 
    };
    cache.onpointerup = () => { cache.onpointermove = null; cache.releasePointerCapture(e.pointerId); };
  }

  function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; ctx.lineCap = 'round'; }
  let drawing = false, activeDrag = null;
  canvas.onpointerdown = (e) => { 
    if (!isPen) return;
    drawing = true; 
    const rect = canvas.getBoundingClientRect();
    ctx.beginPath(); ctx.strokeStyle = penCol; ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top); 
  };
  canvas.onpointermove = (e) => { 
    if (isPen && drawing) { 
      const rect = canvas.getBoundingClientRect();
      ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top); 
      ctx.lineWidth = window.innerWidth < 800 ? 2.5 : 4;
      ctx.stroke(); 
    } 
  };
  canvas.onpointerup = () => drawing = false;

  function allTo(n) { states.fill(n); updateBeads(true); }
  function set50() { for(let i=0; i<10; i++) states[i] = (i < 5) ? 10 : 0; updateBeads(true); }
  function toggleVal() { showVal = !showVal; document.getElementById('btn-val').classList.toggle('active', showVal); updateBeads(false); }
  function togglePen() { isPen = !isPen; canvas.classList.toggle('active', isPen); document.getElementById('btn-pen').classList.toggle('active', isPen); }
  function setCol(c, el) { penCol = c; document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active')); el.classList.add('active'); }
  function clearDraw() { ctx.clearRect(0, 0, canvas.width, canvas.height); }
  function toggleColorMode() { isBlue = !isBlue; document.getElementById('btn-color').textContent = isBlue ? "‚ö™ Blanc" : "üîµ Bleu"; document.querySelectorAll('.bead.white').forEach(b => b.classList.toggle('blue-mode', isBlue)); }

  document.getElementById('row-range').oninput = (e) => { rowsCount = parseInt(e.target.value); document.getElementById('row-val').innerText = rowsCount; init(); };
  window.addEventListener('resize', autoScale);
  init();
</script>
</body>
</html>
