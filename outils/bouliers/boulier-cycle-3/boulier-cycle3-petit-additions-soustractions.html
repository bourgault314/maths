<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Montessori (1/10/100/1000) — Exerciseur “Opérations”</title>
<style>
  :root{
    --rows: 4;
    --beads-per-row: 10;
    --bead-size: 26px;
    --bead-gap: 6px;
    --frame-thickness: 14px;
    --rod-thickness: 4px;

    --color-1: #3cb371;     /* unités */
    --color-10: #40c4ff;    /* dizaines */
    --color-100: #e53935;   /* centaines */
    --color-1000: #2e7d32;  /* milliers */

    --color-wood: #e2c48a;
    --color-wood-dark: #a88348;

    --bg: #fffdf8;
    --text: #1b1b1b;
    --ui: #f3f1ea;
    --accent: #0f6cf9;
    --ok: #0f9d58;
    --err: #d93025;
  }

  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .app{max-width:820px;margin:12px auto;padding:0 12px}

  .topbar{
    display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:space-between;margin:6px 0 10px
  }
  .btn{
    border:none;background:var(--accent);color:#fff;font-weight:700;
    padding:8px 12px;border-radius:10px;cursor:pointer;
    box-shadow:0 5px 12px rgba(15,108,249,.18);font-size:.95rem
  }
  .btn:active{transform:translateY(1px)}
  .btn.secondary{background:#6b7280}

  .score{margin-left:auto;display:flex;gap:12px;align-items:center;font-weight:800}
  .score .good{color:var(--ok)}
  .score .bad{color:var(--err)}

  .exercise{
    display:flex;flex-direction:column;gap:8px;align-items:stretch;
    background:var(--ui);padding:10px 12px;border-radius:12px;margin-bottom:10px
  }
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:space-between}
  .select, .radio-group{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  select{padding:6px 8px;border-radius:8px;border:1px solid #d0d0d0;background:#fff}
  .ops{
    width:100%;background:#fff;border:1px solid #e0e0e0;border-radius:10px;
    padding:6px 8px;font-weight:800
  }
  .answer{display:flex;gap:8px;align-items:center}
  .answer input[type="number"]{
    width:100px;padding:6px 8px;border:1px solid #d0d0d0;border-radius:8px;font-weight:800;text-align:right;background:#fff;
    -moz-appearance: textfield; appearance: textfield;
  }
  .answer input[type="number"]::-webkit-outer-spin-button,
  .answer input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance: none; margin: 0; }
  .feedback{min-height:1.3em;font-weight:700}
  .feedback.ok{color:var(--ok)} .feedback.err{color:var(--err)}

  .abacus-wrapper{display:flex;align-items:stretch}
  .labels{
    display:flex;flex-direction:column;justify-content:space-around;
    padding:10px 6px 10px 0;font-weight:700;font-size:1rem;color:#444;
    background:#f0f0f0;border-radius:10px 0 0 10px;
    box-shadow:inset -1px 0 2px rgba(0,0,0,.1)
  }
  .labels div{flex:1;display:flex;align-items:center;justify-content:center}

  .abacus{
    flex:1;position:relative;aspect-ratio: 10 / 4.5;
    background:linear-gradient(180deg,var(--color-wood) 0%, #efd79d 55%, var(--color-wood) 100%);
    border-radius:0 14px 14px 0;box-shadow:0 8px 20px rgba(0,0,0,.1);
    padding: calc(var(--frame-thickness) + 6px) calc(var(--frame-thickness) + 8px);
  }
  .abacus::before, .abacus::after{
    content:"";position:absolute;left:0;right:0;height:var(--frame-thickness);
    background:linear-gradient(#caa367,#9a733c)
  }
  .abacus::before{top:0;border-bottom:2px solid var(--color-wood-dark);border-radius:0 14px 0 0}
  .abacus::after{bottom:0;border-top:2px solid var(--color-wood-dark);border-radius:0 0 14px 0}

  .row-line{position:relative;height: calc(100% / var(--rows));}
  .rod{
    position:absolute;left:0;right:0;top:50%;height:var(--rod-thickness);transform:translateY(-50%);
    background:linear-gradient(180deg,#c19a66,#916c3d);border-radius:3px;box-shadow:inset 0 1px 0 rgba(255,255,255,.45), 0 1px 2px rgba(0,0,0,.25)
  }
  .bead{
    position:absolute;top:50%;transform:translate(-50%,-50%);
    width:var(--bead-size);height:var(--bead-size);border-radius:50%;
    box-shadow: 0 3px 6px rgba(0,0,0,.25), inset 0 2px 5px rgba(255,255,255,.5);
    border:1px solid rgba(0,0,0,.1);cursor:pointer; user-select:none;
    transition:left .18s ease, transform .06s ease;
  }
  .bead:active{transform:translate(-50%,-50%) scale(.95)}

  .r0 .bead{ background: var(--color-1); }
  .r1 .bead{ background: var(--color-10); }
  .r2 .bead{ background: var(--color-100); }
  .r3 .bead{ background: var(--color-1000); }

  .overlay{
    position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
    font-size:8rem;font-weight:900;color:white;text-shadow:0 0 30px rgba(0,0,0,.7);
    pointer-events:none;opacity:0;transition:opacity .2s ease;
  }
  .overlay.show{opacity:1}
  .overlay.ok{color:var(--ok)}
  .overlay.err{color:var(--err)}
</style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn" id="newOps">Nouvelles opérations</button>
        <button class="btn secondary" id="reset">Remise à zéro</button>
      </div>
      <div class="score">
        <span class="good">✅ : <span id="goodCount">0</span></span>
        <span class="bad">❌ : <span id="badCount">0</span></span>
      </div>
    </div>

    <div class="exercise">
      <div class="row">
        <div class="select">
          <label for="count">Nb d’opérations :</label>
          <select id="count">
            <option>3</option><option selected>5</option><option>6</option><option>7</option><option>8</option>
          </select>
        </div>
        <div class="select">
          <label for="maxStep">Pas max :</label>
          <select id="maxStep">
            <option value="10">10</option>
            <option value="50">50</option>
            <option value="100" selected>100</option>
            <option value="200">200</option>
            <option value="500">500</option>
            <option value="1000">1000</option>
            <option value="2000">2000</option>
          </select>
        </div>
        <div class="radio-group">
          <strong>Type :</strong>
          <label><input type="radio" name="mode" value="add" checked> Additions</label>
          <label><input type="radio" name="mode" value="mixed"> Mélange + / −</label>
        </div>
        <div class="answer">
          <label for="typed">Réponse :</label>
          <input id="typed" type="number" min="0" max="9999" inputmode="numeric" placeholder="0–9999" />
          <button class="btn" id="check">Vérifier</button>
        </div>
      </div>
      <div class="ops" id="ops">—</div>
      <div class="feedback" id="feedback"></div>
    </div>

    <div class="abacus-wrapper">
      <div class="labels">
        <div>1</div><div>10</div><div>100</div><div>1000</div>
      </div>
      <div class="abacus" id="abacus" aria-label="Boulier Montessori"></div>
    </div>
  </div>

  <div class="overlay" id="overlay"></div>

<script>
(function(){
  const rows=4, N=10, values=[1,10,100,1000];
  const abacus=document.getElementById('abacus');
  const newOpsBtn=document.getElementById('newOps');
  const resetBtn=document.getElementById('reset');
  const checkBtn=document.getElementById('check');
  const typedInput=document.getElementById('typed');
  const countSel=document.getElementById('count');
  const maxStepSel=document.getElementById('maxStep');
  const modeRadios=[...document.querySelectorAll('input[name="mode"]')];

  const opsEl=document.getElementById('ops');
  const feedback=document.getElementById('feedback');
  const goodEl=document.getElementById('goodCount');
  const badEl=document.getElementById('badCount');
  const overlay=document.getElementById('overlay');

  const state=Array.from({length:rows},()=>0);
  let good=0,bad=0;
  let advancing=false,scored=false;
  let opsList=[], target=0;

  /* --- Construction du boulier --- */
  const rowEls=[];
  for(let r=0;r<rows;r++){
    const row=el('div','row-line r'+r);
    row.dataset.row=r;
    row.appendChild(el('div','rod'));
    for(let j=1;j<=N;j++){
      const bead=el('div','bead'); bead.dataset.index=j;
      bead.addEventListener('click',()=>onBeadClick(r,j));
      row.appendChild(bead);
    }
    abacus.appendChild(row); rowEls.push(row);
  }

  function onBeadClick(r,j){
    if(advancing) return;
    const c=state[r], left=N-c;
    state[r]=(j<=left)?(N-j+1):(N-j);
    state[r]=clamp(state[r],0,N);
    layoutRow(r);
  }
  function layoutRow(r){
    const row=rowEls[r], c=state[r];
    const size=26, gap=6, pad=10;
    const leftStart=pad+size/2, rightStart=row.clientWidth-pad-size/2;
    [...row.querySelectorAll('.bead')].forEach(b=>{
      const j=+b.dataset.index;
      const x=(j<=N-c) ? leftStart+(j-1)*(size+gap) : rightStart-(N-j)*(size+gap);
      b.style.left = x+"px";
    });
  }
  function layoutAll(){ for(let r=0;r<rows;r++) layoutRow(r); }
  function currentTotal(){ return state.reduce((s,c,r)=> s + c*values[r], 0); }
  function resetAbacus(){ state.fill(0); layoutAll(); }

  /* --- Génération d'énoncé --- */
  function randomInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

  function generateOps(count, mode, maxStep){
    let running=0; const list=[];
    for(let k=0;k<count;k++){
      let sign=+1;
      if(mode==='mixed'){
        if(running<=200) sign=+1;
        else if(running>=9800) sign=-1;
        else sign = Math.random()<0.5?+1:-1;
      }else{
        sign=+1;
      }

      const upCap  = Math.min(maxStep, 9999 - running);
      const dnCap  = Math.min(maxStep, running);
      const step = (sign>0)
        ? randomInt(1, Math.max(1, upCap))
        : randomInt(1, Math.max(1, dnCap));

      running += sign*step;
      list.push(sign*step);
    }
    return { list, result: running };
  }

  function formatOps(list){
    return list.map(v => (v>=0?'+':'−') + Math.abs(v)).join('  ');
  }

  function newSet(){
    const count=+countSel.value;
    const mode=modeRadios.find(r=>r.checked).value;
    const maxStep=+maxStepSel.value;

    let gen;
    for(let tries=0; tries<60; tries++){
      gen = generateOps(count, mode, maxStep);
      if(gen.result>=0 && gen.result<=9999 && gen.result!==0) break;
    }
    opsList=gen.list; target=gen.result;
    opsEl.textContent = formatOps(opsList);

    resetAbacus();
    typedInput.value='';
    feedback.textContent='';
    feedback.className='feedback';
    advancing=false; scored=false;
  }

  /* --- Feedback central --- */
  function showOverlay(ok){
    overlay.textContent = ok ? "✅" : "❌";
    overlay.className = "overlay show " + (ok?"ok":"err");
    setTimeout(()=> overlay.className="overlay", 1000);
  }

  /* --- Interactions --- */
  newOpsBtn.addEventListener('click', newSet);
  resetBtn.addEventListener('click', ()=>{ resetAbacus(); feedback.textContent=''; feedback.className='feedback'; });

  checkBtn.addEventListener('click', ()=>{
    if(advancing) return;
    if(!opsList.length){ feedback.textContent='Clique sur “Nouvelles opérations”.'; feedback.className='feedback err'; return; }
    if(!typedInput.value){ feedback.textContent='Écris ta réponse.'; feedback.className='feedback err'; return; }

    const valAbacus=currentTotal();
    const valTyped=+typedInput.value;
    const ok=(valAbacus===target)&&(valTyped===target)&&(valAbacus===valTyped);

    if(ok){
      if(!scored){ good++; goodEl.textContent=good; scored=true; }
      feedback.textContent='Oui, bonne réponse ✅'; feedback.className='feedback ok';
      showOverlay(true);
      advancing=true; setTimeout(newSet, 1000);
    }else{
      bad++; badEl.textContent=bad;
      feedback.textContent='Non, mauvaise réponse ❌'; feedback.className='feedback err';
      showOverlay(false);
    }
  });

  window.addEventListener('resize', layoutAll);

  function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }
  function el(tag,cls){ const e=document.createElement(tag); if(cls) e.className=cls; return e; }

  /* Init */
  layoutAll();
  newSet();
})();
</script>
</body>
</html>
